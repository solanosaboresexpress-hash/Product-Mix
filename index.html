<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="logo_sabores_real.png">
    <link rel="shortcut icon" type="image/png" href="logo_sabores_real.png">
    <title>Sabores Express - Product Mix V2 Web v4.8</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js?v=4.8"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js?v=4.8"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js?v=4.8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Funciones de zona horaria de Argentina - DEBEN ESTAR ANTES DE REACT -->
    <script>
      // Función para obtener fecha/hora en zona horaria de Argentina (UTC-3)
      window.getFechaArgentina = function() {
        const ahora = new Date();
        // Obtener fecha/hora en zona horaria de Argentina usando Intl.DateTimeFormat
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        const partes = formatter.formatToParts(ahora);
        const año = parseInt(partes.find(p => p.type === 'year').value);
        const mes = parseInt(partes.find(p => p.type === 'month').value) - 1; // Mes es 0-indexed
        const dia = parseInt(partes.find(p => p.type === 'day').value);
        const hora = parseInt(partes.find(p => p.type === 'hour').value);
        const minuto = parseInt(partes.find(p => p.type === 'minute').value);
        const segundo = parseInt(partes.find(p => p.type === 'second').value);
        // Crear nueva fecha con los valores de Argentina (en UTC, pero representando la hora de Argentina)
        return new Date(Date.UTC(año, mes, dia, hora, minuto, segundo));
      };

      // Función para obtener la fecha actual en formato ISO (YYYY-MM-DD) en zona horaria de Argentina
      window.getFechaActualArgentina = function() {
        const ahora = new Date();
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const partes = formatter.formatToParts(ahora);
        const año = partes.find(p => p.type === 'year').value;
        const mes = partes.find(p => p.type === 'month').value;
        const dia = partes.find(p => p.type === 'day').value;
        return `${año}-${mes}-${dia}`;
      };

      // Función para formatear fecha en zona horaria de Argentina
      window.formatearFechaArgentina = function(fecha) {
        if (!fecha) {
          return window.getFechaArgentina();
        }
        // Si ya es una fecha, convertir a zona horaria de Argentina
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        const partes = formatter.formatToParts(fecha);
        const año = parseInt(partes.find(p => p.type === 'year').value);
        const mes = parseInt(partes.find(p => p.type === 'month').value) - 1;
        const dia = parseInt(partes.find(p => p.type === 'day').value);
        const hora = parseInt(partes.find(p => p.type === 'hour').value);
        const minuto = parseInt(partes.find(p => p.type === 'minute').value);
        const segundo = parseInt(partes.find(p => p.type === 'second').value);
        return new Date(Date.UTC(año, mes, dia, hora, minuto, segundo));
      };

      // Función para obtener timestamp ISO en zona horaria de Argentina
      window.getTimestampArgentina = function() {
        const fechaArg = window.getFechaArgentina();
        return fechaArg.toISOString();
      };
    </script>
    
    <style>
        /* ============================================
           ESTILOS GLOBALES - Sin restricciones de ancho
           ============================================ */
        html, body {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: auto !important;
        }
        
        /* ============================================
           PALETA DE COLORES - SABORES EXPRESS (Android App)
           ============================================ */
        :root {
            /* Brand Colors - Dorados (EXACTOS de Android colors.xml) */
            --brand-gold: #C59B34; /* Dorado principal elegante, NO amarillo brillante */
            --brand-gold-light: #E6C874;
            --brand-gold-dark: #967218;
            
            /* Brand Neutrals */
            --brand-black: #1A1A1A;
            --brand-white: #FFFFFF;
            --brand-grey-light: #F4F4F4;
            --brand-grey-medium: #9E9E9E;
            --brand-grey-dark: #424242;
            
            /* Semantic Colors */
            --status-success: #4CAF50;
            --status-warning: #FF9800;
            --status-error: #F44336;
            
            /* Background & Surface */
            --background-color: #F8F9FA;
            --surface-color: #FFFFFF;
            --on-background: #1A1A1A;
            --on-surface: #1A1A1A;
        }
        
        /* ============================================
           ESTILOS DE BOTONES - Android App Style
           ============================================ */
        
        /* Botón Principal (Dorado) - Estado Pendiente */
        .btn-primary {
            background-color: var(--brand-gold) !important;
            color: var(--brand-black) !important;
            border: 1px solid var(--brand-gold-dark) !important;
            border-radius: 12px !important;
            height: 56px !important;
            font-weight: bold !important;
            font-size: 16px !important;
            padding: 0 24px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-primary:hover {
            background-color: var(--brand-gold-dark) !important;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px) !important;
        }
        
        .btn-primary:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Botón Completado (Verde) - Estado con Datos */
        .btn-completed {
            background-color: var(--status-success) !important;
            color: var(--brand-black) !important;
            border: 1px solid var(--brand-gold-dark) !important;
            border-radius: 12px !important;
            height: 56px !important;
            font-weight: bold !important;
            font-size: 16px !important;
            padding: 0 24px !important;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-completed:hover {
            background-color: #45A049 !important;
            box-shadow: 0 6px 8px rgba(76, 175, 80, 0.4) !important;
            transform: translateY(-1px) !important;
        }
        
        /* Botón Secundario */
        .btn-secondary {
            background-color: var(--brand-grey-medium) !important;
            color: var(--brand-white) !important;
            border: 1px solid var(--brand-grey-dark) !important;
            border-radius: 12px !important;
            height: 56px !important;
            font-weight: bold !important;
            font-size: 16px !important;
            padding: 0 24px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        /* ============================================
           CARDS - Material Design Style
           ============================================ */
        .card {
            background-color: var(--surface-color) !important;
            border-radius: 16px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            padding: 16px !important;
            transition: all 0.3s ease !important;
        }
        
        .card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-2px) !important;
        }
        
        /* Card de Selector de Fecha */
        .card-date-selector {
            background-color: var(--surface-color) !important;
            border: 2px solid var(--brand-gold) !important;
            border-radius: 12px !important;
            padding: 12px 16px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* ============================================
           ANIMACIONES
           ============================================ */
        
        /* Animación Shake (para errores) */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 1s ease-in-out;
        }
        
        /* Animación Fade In */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Animación Pulse (para indicadores) */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* ============================================
           CALENDARIO - Colores de Días
           ============================================ */
        .calendar-day-complete {
            background-color: #4CAF50 !important; /* Verde oscuro */
            color: var(--brand-white) !important;
        }
        
        .calendar-day-partial {
            background-color: #FF9800 !important; /* Naranja oscuro */
            color: var(--brand-white) !important;
        }
        
        .calendar-day-empty {
            background-color: #424242 !important; /* Gris oscuro */
            color: var(--brand-white) !important;
        }
        
        /* ============================================
           BADGES Y INDICADORES
           ============================================ */
        .badge-success {
            background-color: var(--status-success) !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 4px 12px !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        .badge-warning {
            background-color: var(--status-warning) !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 4px 12px !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        .badge-error {
            background-color: var(--status-error) !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 4px 12px !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }
        
        /* ============================================
           INPUTS Y FORMULARIOS
           ============================================ */
        .input-field {
            background-color: var(--surface-color) !important;
            border: 2px solid var(--brand-gold) !important;
            border-radius: 12px !important;
            padding: 12px 16px !important;
            font-size: 16px !important;
            color: var(--on-surface) !important;
            transition: all 0.3s ease !important;
        }
        
        .input-field:focus {
            outline: none !important;
            border-color: var(--brand-gold-dark) !important;
            box-shadow: 0 0 0 3px rgba(197, 155, 52, 0.1) !important;
        }
        
        /* ============================================
           LOGIN SCREEN - Estilos Android App (EXACTO)
           ============================================ */
        .login-container {
            background-color: #F0F0F0 !important; /* EXACTO como Android activity_login.xml línea 6 */
            min-height: 100vh !important;
            position: relative !important;
            width: 100% !important;
            overflow-y: auto !important; /* ScrollView equivalente */
        }
        
        /* Imagen de watermark - EXACTO como Android ImageView líneas 9-15 */
        .login-watermark {
            position: fixed !important; /* Fixed para que se mantenga al hacer scroll */
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-image: url('bg_watermark_image.png') !important;
            background-size: cover !important; /* EXACTO como Android scaleType="fitXY" */
            background-position: center !important;
            background-repeat: no-repeat !important;
            opacity: 0.08 !important; /* EXACTO como Android android:alpha="0.08" */
            z-index: 0 !important;
            pointer-events: none !important; /* No interfiere con clicks */
        }
        
        /* ScrollView equivalente - EXACTO como Android líneas 18-21 */
        .login-scrollview {
            position: relative !important;
            z-index: 1 !important;
            width: 100% !important;
            min-height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* LinearLayout interno - EXACTO como Android líneas 23-28 */
        .login-content-wrapper {
            position: relative !important;
            z-index: 1 !important;
            width: 100% !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important; /* EXACTO como Android gravity="center_horizontal" */
            padding: 24px !important; /* EXACTO como Android padding="24dp" */
            box-sizing: border-box !important;
        }
        
        .login-card {
            background-color: var(--surface-color) !important; /* #FFFFFF */
            border-radius: 16px !important; /* EXACTO como Android cardCornerRadius 16dp */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important; /* EXACTO como Android cardElevation 4dp */
            padding: 16px !important; /* EXACTO como Android contentPadding 16dp (línea 64) */
            border: none !important; /* MaterialCardView no tiene border visible */
            width: 100% !important; /* EXACTO como Android layout_width="match_parent" */
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        
        .login-logo-container {
            position: relative !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin-top: 40px !important; /* EXACTO como Android layout_marginTop="40dp" */
            margin-bottom: 32px !important; /* EXACTO como Android layout_marginBottom="32dp" */
            margin-left: auto !important;
            margin-right: auto !important;
            width: 210px !important; /* EXACTO como Android layout_width="210dp" */
            height: 210px !important; /* EXACTO como Android layout_height="210dp" */
        }
        
        .login-logo-glow {
            position: absolute !important;
            width: 210px !important; /* EXACTO como Android layout_width="210dp" */
            height: 210px !important; /* EXACTO como Android layout_height="210dp" */
            /* EXACTO como Android bg_card_surface con backgroundTint y alpha */
            /* bg_card_surface: solid color=surface_color (#FFFFFF), corners=16dp, stroke=1dp brand_grey_light (#F4F4F4) */
            /* backgroundTint: brand_gold (#C59B34) con alpha=0.3 */
            /* Como es un círculo, usamos border-radius 50% */
            background-color: rgba(197, 155, 52, 0.3) !important; /* brand_gold con alpha 0.3 - EXACTO como Android */
            border-radius: 50% !important; /* Círculo perfecto */
            border: 1px solid rgba(244, 244, 244, 0.3) !important; /* brand_grey_light con alpha reducida */
            z-index: 0 !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            box-shadow: none !important;
        }
        
        .login-logo {
            position: relative !important;
            width: 200px !important; /* EXACTO como Android layout_width="200dp" */
            height: 200px !important; /* EXACTO como Android layout_height="200dp" */
            z-index: 1 !important;
            object-fit: contain !important; /* EXACTO como Android scaleType="centerInside" */
            border: none !important;
            outline: none !important;
        }
        
        /* Texto "Bienvenido" - EXACTO como Android */
        .login-welcome-text {
            font-size: 24px !important; /* EXACTO como Android textSize="24sp" */
            font-weight: bold !important; /* EXACTO como Android textStyle="bold" */
            color: var(--brand-black) !important; /* EXACTO como Android textColorPrimary */
            text-align: center !important; /* EXACTO como Android layout_gravity="center_horizontal" */
            margin-bottom: 24px !important; /* EXACTO como Android layout_marginBottom="24dp" */
        }
        
        /* TextInputLayout Style - EXACTO como Android Widget.Inventario.TextInputLayout */
        .login-text-input-wrapper {
            position: relative !important;
            margin-bottom: 16px !important; /* EXACTO como Android layout_marginBottom="16dp" */
        }
        
        .login-text-input-label {
            position: absolute !important;
            top: -8px !important;
            left: 12px !important;
            background-color: var(--surface-color) !important;
            padding: 0 4px !important;
            font-size: 12px !important;
            color: var(--brand-gold-dark) !important; /* EXACTO como Android hintTextColor */
            font-weight: 500 !important;
            z-index: 1 !important;
        }
        
        .login-text-input {
            width: 100% !important;
            padding: 16px !important; /* EXACTO como Android padding="16dp" */
            border: 2px solid var(--brand-gold) !important; /* EXACTO como Android boxStrokeColor */
            border-radius: 12px !important; /* EXACTO como Android boxCornerRadius */
            font-size: 16px !important;
            color: var(--brand-black) !important;
            background-color: transparent !important;
            transition: all 0.3s ease !important;
        }
        
        .login-text-input:focus {
            outline: none !important;
            border-color: var(--brand-gold-dark) !important;
            box-shadow: 0 0 0 2px rgba(197, 155, 52, 0.1) !important;
        }
        
        .login-text-input:disabled {
            background-color: var(--brand-grey-light) !important;
            cursor: not-allowed !important;
        }
        
        /* Botón Login - EXACTO como Android Widget.Inventario.Button.Primary */
        .login-button {
            width: 100% !important;
            min-height: 56px !important; /* EXACTO como Android minHeight="56dp" */
            padding: 0 24px !important; /* EXACTO como Android paddingStart/End="24dp" */
            background-color: var(--brand-gold) !important;
            color: var(--brand-black) !important;
            border: none !important;
            border-radius: 12px !important;
            font-size: 16px !important; /* EXACTO como Android textSize="16sp" */
            font-weight: bold !important; /* EXACTO como Android textStyle="bold" */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important; /* EXACTO como Android elevation="4dp" */
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            margin-bottom: 16px !important; /* EXACTO como Android layout_marginBottom="16dp" */
        }
        
        .login-button:hover {
            background-color: var(--brand-gold-dark) !important;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        .login-button:active {
            transform: translateY(1px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        .login-button:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }
        
        /* Botón TextButton - EXACTO como Android Widget.MaterialComponents.Button.TextButton (líneas 138-148) */
        .btn-text-button {
            background: transparent !important; /* Sin fondo - EXACTO como Android TextButton */
            border: none !important;
            color: var(--brand-black) !important; /* #1A1A1A - EXACTO como Android textColorPrimary */
            font-size: 14px !important; /* EXACTO como Android textSize="14sp" */
            font-weight: bold !important; /* EXACTO como Android textStyle="bold" */
            height: 48px !important; /* EXACTO como Android layout_height="48dp" */
            padding: 0 24px !important; /* EXACTO como Android paddingStart/End="24dp" */
            cursor: pointer !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
        }
        
        .btn-text-button:hover {
            background-color: rgba(0, 0, 0, 0.05) !important; /* Hover sutil */
        }
        
        .btn-text-button:active {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Botón Acceder del diálogo - EXACTO como Android Button.Primary (48dp height, 14sp text) */
        #accessBtn {
            flex: 1;
            height: 48px;
            padding: 0 24px;
            background-color: #C59B34;
            color: #1A1A1A;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        #accessBtn:hover {
            background-color: #967218;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        #accessBtn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ============================================
           GESTIÓN DE LOCALES - Estilos Android App
           ============================================ */
        
        /* Tabs de Gestión - EXACTO como Android */
        .tab-container {
            background-color: var(--brand-gold) !important; /* #C59B34 */
            border-radius: 8px !important;
            padding: 4px !important;
            margin: 16px !important;
            display: flex !important;
        }
        
        .tab-button {
            flex: 1 !important;
            height: 48px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }
        
        .tab-button-selected {
            background-color: var(--surface-color) !important; /* Blanco */
            color: var(--brand-black) !important;
        }
        
        .tab-button-unselected {
            background-color: transparent !important;
            color: var(--brand-white) !important;
        }
        
        .tab-button {
            background-color: transparent !important;
            border: none !important;
            color: var(--brand-black) !important;
            font-weight: bold !important;
            font-size: 14px !important;
            padding: 12px !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .tab-button-selected {
            background-color: var(--surface-color) !important;
            color: var(--brand-black) !important;
        }
        
        .tab-button-unselected {
            background-color: transparent !important;
            color: var(--brand-black) !important;
        }
        
        /* Cards de Locales */
        .card-local {
            background-color: #E3F2FD !important; /* Azul claro - card_local_background */
            border: 2px solid #BBDEFB !important;
            border-radius: 16px !important;
            padding: 20px !important;
            margin: 8px 16px 16px 16px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }
        
        .card-local:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-2px) !important;
        }
        
        /* Botones de Gestión */
        .btn-gestion-primary {
            background-color: var(--brand-gold) !important; /* #C59B34 - Dorado elegante */
            border: 1px solid var(--brand-gold-dark) !important;
            color: var(--brand-black) !important;
            border-radius: 12px !important;
            padding: 8px 16px !important;
            font-weight: bold !important;
            font-size: 11px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-gestion-success {
            background-color: #4CAF50 !important; /* Verde */
            border: 2px solid #45A049 !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 8px 16px !important;
            font-weight: bold !important;
            font-size: 11px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-gestion-info {
            background-color: #2196F3 !important; /* Azul */
            border: 2px solid #1976D2 !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 8px 16px !important;
            font-weight: bold !important;
            font-size: 11px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-gestion-danger {
            background-color: #F44336 !important; /* Rojo */
            border: 2px solid #D32F2F !important;
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 8px 16px !important;
            font-weight: bold !important;
            font-size: 11px !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        /* Botones especiales de Gestión */
        .btn-ingresar-local {
            background-color: #9C27B0 !important; /* Morado - holo_purple */
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 12px !important;
            font-weight: bold !important;
            font-size: 14px !important;
            border: none !important;
            width: 100% !important;
            margin: 8px 0 !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-ver-stock {
            background-color: #1976D2 !important; /* Azul oscuro - holo_blue_dark */
            color: var(--brand-white) !important;
            border-radius: 12px !important;
            padding: 12px !important;
            font-weight: bold !important;
            font-size: 14px !important;
            border: none !important;
            width: 100% !important;
            margin: 8px 0 !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        /* Hover effects para botones de gestión */
        .btn-gestion-primary:hover,
        .btn-gestion-success:hover,
        .btn-gestion-info:hover,
        .btn-gestion-danger:hover,
        .btn-ingresar-local:hover,
        .btn-ver-stock:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15) !important;
        }
        
        .btn-gestion-primary:active,
        .btn-gestion-success:active,
        .btn-gestion-info:active,
        .btn-gestion-danger:active,
        .btn-ingresar-local:active,
        .btn-ver-stock:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* ============================================
           RESPONSIVE LAYOUT FOR PROMEDIO DE VENTAS
           PC: Tamaños normales, Móvil: Compacto como Android
           ============================================ */
        .ventas-scroll { 
            overflow-x: visible; 
            overflow-y: visible;
            -webkit-overflow-scrolling: touch; 
            width: 100%;
            max-width: 100%;
        }
        .ventas-grid { 
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Tamaños para PC (por defecto) - Como estaba originalmente */
        .ventas-header {
            font-size: 12px !important;
            padding: 8px 4px !important;
        }
        .ventas-name { 
            white-space: nowrap; 
            font-size: 12px !important;
            padding: 8px 4px !important;
        }
        .ventas-cell { 
            white-space: nowrap; 
            font-size: 12px !important;
            padding: 8px 4px !important;
        }
        .ventas-row {
            font-size: 12px !important;
            padding: 8px 4px !important;
        }

        /* Tablet - Reducción moderada */
        @media (max-width: 1024px) {
            .ventas-header {
                font-size: 11px !important;
                padding: 6px 3px !important;
            }
            .ventas-name { 
                font-size: 11px !important;
                padding: 6px 3px !important;
            }
            .ventas-cell { 
                font-size: 11px !important;
                padding: 6px 3px !important;
            }
            .ventas-row {
                font-size: 11px !important;
                padding: 6px 3px !important;
            }
        }

        /* Móvil - Compacto como Android */
        @media (max-width: 768px) {
            .ventas-header {
                font-size: 10px !important;
                padding: 2px 1px !important;
            }
            .ventas-name { 
                font-size: 10px !important;
                padding: 4px !important;
            }
            .ventas-cell { 
                font-size: 10px !important;
                padding: 1px 2px !important;
            }
            .ventas-row {
                font-size: 10px !important;
                padding: 3px 4px !important;
            }
        }

        /* Móvil pequeño - Muy compacto */
        @media (max-width: 480px) {
            .ventas-header {
                font-size: 9px !important;
                padding: 2px 1px !important;
            }
            .ventas-name { 
                font-size: 9px !important;
                padding: 2px !important;
            }
            .ventas-cell { 
                font-size: 9px !important;
                padding: 1px !important;
            }
            .ventas-row {
                font-size: 9px !important;
                padding: 2px !important;
            }
        }

        /* ============================================
           MENU BUTTONS - Responsive como Android
           PC: 12px, Móvil: se adapta automáticamente
           ============================================ */
        .menu-button {
            font-size: 12px !important;
            max-lines: 2;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Tablet - Reducción moderada */
        @media (max-width: 1024px) {
            .menu-button {
                font-size: 11px !important;
            }
        }

        /* Móvil - Compacto como Android */
        @media (max-width: 768px) {
            .menu-button {
                font-size: 10px !important;
            }
        }

        /* Móvil pequeño - Muy compacto */
        @media (max-width: 480px) {
            .menu-button {
                font-size: 9px !important;
            }
        }

        /* Móvil muy pequeño - Extra compacto */
        @media (max-width: 360px) {
            .menu-button {
                font-size: 8px !important;
            }
        }
    </style>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD6dF6jCibROTO-oXBfKUdAjk9q6g6-Mu0",
            authDomain: "inventario-app-multi-local.firebaseapp.com",
            projectId: "inventario-app-multi-local",
            storageBucket: "inventario-app-multi-local.firebasestorage.app",
            messagingSenderId: "623222993471",
            appId: "1:623222993471:web:48bffda68352403f27be8a"
        };

        // Configuración de Regiones (fallback si falla la carga del JSON)
        const REGIONES_CONFIG_FALLBACK = [
            {
                id: "region_1",
                nombre: "Región 1",
                proyectoFirebaseId: "inventario-app-multi-local",
                maestroNombre: "Lucas PIARRISTEGUY",
                activo: true,
                firebaseConfig: {
                    apiKey: "AIzaSyD6dF6jCibROTO-oXBfKUdAjk9q6g6-Mu0",
                    authDomain: "inventario-app-multi-local.firebaseapp.com",
                    projectId: "inventario-app-multi-local",
                    storageBucket: "inventario-app-multi-local.firebasestorage.app",
                    messagingSenderId: "623222993471",
                    appId: "1:623222993471:web:48bffda68352403f27be8a"
                }
            },
            {
                id: "region_2",
                nombre: "Región 2",
                proyectoFirebaseId: "region2-99f04",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION2",
                    authDomain: "region2-99f04.firebaseapp.com",
                    projectId: "region2-99f04",
                    storageBucket: "region2-99f04.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_3",
                nombre: "Región 3",
                proyectoFirebaseId: "region3-e704a",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION3",
                    authDomain: "region3-e704a.firebaseapp.com",
                    projectId: "region3-e704a",
                    storageBucket: "region3-e704a.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_4",
                nombre: "Región 4",
                proyectoFirebaseId: "region4-30c0d",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION4",
                    authDomain: "region4-30c0d.firebaseapp.com",
                    projectId: "region4-30c0d",
                    storageBucket: "region4-30c0d.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_5",
                nombre: "Región 5",
                proyectoFirebaseId: "region5-41627",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION5",
                    authDomain: "region5-41627.firebaseapp.com",
                    projectId: "region5-41627",
                    storageBucket: "region5-41627.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            }
        ];

        // Cache de regiones cargadas
        let REGIONES_CONFIG_CACHE = null;

        // Gestor de Regiones
        const FirebaseRegionManager = {
            currentRegion: null,
            currentApp: null,
            currentDb: null,
            currentAuth: null,

            async cargarRegiones() {
                // Si ya están en cache, retornar cache
                if (REGIONES_CONFIG_CACHE) {
                    return REGIONES_CONFIG_CACHE.filter(function(r) { return r.activo; });
                }

                try {
                    // Intentar cargar desde regiones.json
                    const response = await fetch('regiones.json');
                    if (!response.ok) {
                        throw new Error('No se pudo cargar regiones.json');
                    }
                    const regiones = await response.json();
                    
                    // Validar que sea un array y tenga la estructura correcta
                    if (Array.isArray(regiones) && regiones.length > 0) {
                        REGIONES_CONFIG_CACHE = regiones;
                        console.log('✅ Regiones cargadas desde regiones.json:', regiones.length);
                        return regiones.filter(function(r) { return r.activo; });
                    } else {
                        throw new Error('Formato inválido en regiones.json');
                    }
                } catch (error) {
                    console.warn('⚠️ No se pudo cargar regiones.json, usando configuración por defecto:', error.message);
                    // Usar fallback
                    REGIONES_CONFIG_CACHE = REGIONES_CONFIG_FALLBACK;
                    return REGIONES_CONFIG_FALLBACK.filter(function(r) { return r.activo; });
                }
            },

            async cargarRegionActual() {
                try {
                    // Intentar primero con firebase_region_prefs (formato nuevo)
                    let regionId = null;
                    const regionData = localStorage.getItem('firebase_region_prefs');
                    if (regionData) {
                        try {
                            const parsed = JSON.parse(regionData);
                            regionId = parsed.regionId;
                        } catch (e) {
                            console.warn('Error parseando firebase_region_prefs:', e);
                        }
                    }
                    
                    // Si no está en firebase_region_prefs, buscar en region_id (formato antiguo)
                    if (!regionId) {
                        regionId = localStorage.getItem('region_id');
                    }
                    
                    if (regionId) {
                        // Asegurar que las regiones estén cargadas
                        if (!REGIONES_CONFIG_CACHE) {
                            await this.cargarRegiones();
                        }
                        
                        const region = REGIONES_CONFIG_CACHE.find(function(r) { return r.id === regionId; });
                        if (region) {
                            console.log('✅ Región guardada encontrada:', region.nombre);
                            return region;
                        }
                    }
                } catch (error) {
                    console.error('Error cargando region guardada:', error);
                }
                return null;
            },

            guardarRegionActual(region) {
                try {
                    localStorage.setItem('firebase_region_prefs', JSON.stringify({
                        regionId: region.id,
                        regionJson: region.proyectoFirebaseId
                    }));
                } catch (error) {
                    console.error('Error guardando region:', error);
                }
            },

            initializeFirebase(region) {
                try {
                    console.log('Inicializando Firebase para region:', region.nombre);
                    
                    // Limpiar estado anterior completamente antes de crear nuevo
                    if (this.currentApp) {
                        try {
                            // Verificar si la app todavía existe antes de intentar eliminarla
                            const appName = this.currentApp.name;
                            try {
                                // Intentar acceder a una propiedad para verificar que la app esté activa
                                const testApp = firebase.app(appName);
                                if (testApp) {
                                    // La app existe, intentar eliminarla
                                    testApp.delete();
                                    console.log('Firebase anterior cerrado');
                                }
                            } catch (deleteError) {
                                // Si la app ya fue eliminada o no existe, solo limpiar referencias
                                if (deleteError.message && deleteError.message.includes('already deleted')) {
                                    console.log('Firebase anterior ya estaba eliminado, limpiando referencias');
                                } else {
                                    console.warn('No se pudo verificar/cerrar Firebase anterior:', deleteError.message);
                                }
                            }
                            
                            // Limpiar referencias siempre
                            this.currentDb = null;
                            this.currentAuth = null;
                            this.currentRegion = null;
                        } catch (e) {
                            console.warn('No se pudo cerrar Firebase anterior:', e.message);
                            // Asegurar que las referencias estén limpias incluso si falla el delete
                            this.currentDb = null;
                            this.currentAuth = null;
                        }
                    } else {
                        // Asegurar que todo esté limpio
                        this.currentDb = null;
                        this.currentAuth = null;
                        this.currentRegion = null;
                    }

                    // Pequeño delay para asegurar que el cliente anterior se haya cerrado completamente
                    // Nota: esto es síncrono, pero ayuda a dar tiempo al garbage collector
                    this.currentApp = firebase.initializeApp(region.firebaseConfig, 'firebase_' + region.id);
                    this.currentDb = firebase.firestore(this.currentApp);
                    this.currentAuth = firebase.auth(this.currentApp);
                    this.currentRegion = region;

                    this.guardarRegionActual(region);

                    console.log('Firebase inicializado para region:', region.nombre, 'Proyecto:', region.proyectoFirebaseId);
                    return true;
                } catch (error) {
                    console.error('Error inicializando Firebase:', error);
                    // Limpiar estado en caso de error
                    this.currentApp = null;
                    this.currentDb = null;
                    this.currentAuth = null;
                    this.currentRegion = null;
                    return false;
                }
            },

            getFirestore() {
                if (!this.currentDb || !this.currentApp) {
                    throw new Error('Firebase no esta inicializado. Selecciona una region primero.');
                }
                // Verificar que la app no haya sido eliminada
                try {
                    // Intentar acceder a una propiedad de la app para verificar que esté activa
                    // Si la app fue eliminada, esto lanzará un error
                    const appName = this.currentApp.name;
                    const projectId = this.currentApp.options?.projectId;
                    
                    if (!projectId) {
                        // La app no tiene projectId, probablemente fue eliminada
                        this.currentDb = null;
                        this.currentApp = null;
                        this.currentAuth = null;
                        this.currentRegion = null;
                        throw new Error('Firebase app fue eliminada. Necesita reinicialización.');
                    }
                    
                    // La app parece estar activa, retornar el db
                    return this.currentDb;
                } catch (error) {
                    // Si hay algún problema, limpiar estado y lanzar error
                    if (error.message && (
                        error.message.includes('terminated') || 
                        error.message.includes('already been') ||
                        error.message.includes('already deleted') ||
                        error.message.includes('app-deleted')
                    )) {
                        // Limpiar estado completamente
                        this.currentDb = null;
                        this.currentApp = null;
                        this.currentAuth = null;
                        this.currentRegion = null;
                        throw new Error('The client has already been terminated.');
                    }
                    // Si es otro error relacionado con la app eliminada
                    if (error.message && error.message.includes('eliminada')) {
                        throw error;
                    }
                    // Cualquier otro error, limpiar estado por seguridad
                    this.currentDb = null;
                    this.currentApp = null;
                    this.currentAuth = null;
                    this.currentRegion = null;
                    throw error;
                }
            },

            getAuth() {
                if (!this.currentAuth) {
                    throw new Error('Firebase no esta inicializado. Selecciona una region primero.');
                }
                return this.currentAuth;
            },

            /**
             * Obtiene la instancia de FirebaseAuth para una región específica
             * Útil para intentar operaciones en múltiples regiones (ej: reset de contraseña)
             */
            getAuthForRegion(region) {
                try {
                    let app = null;
                    
                    // Si es la región actual, usar la instancia actual
                    if (this.currentRegion && this.currentRegion.id === region.id) {
                        return this.currentAuth;
                    }
                    
                    // Intentar obtener la app existente para esta región
                    const appName = 'firebase_' + region.id;
                    try {
                        app = firebase.app(appName);
                    } catch (e) {
                        // Si no existe, crear una nueva instancia temporal
                        app = firebase.initializeApp(region.firebaseConfig, appName);
                    }
                    
                    return firebase.auth(app);
                } catch (e) {
                    console.warn('No se pudo obtener FirebaseAuth para región ' + region.nombre + ':', e.message);
                    return null;
                }
            },

            getCurrentRegion() {
                return this.currentRegion;
            }
        };

        // Initialize Firebase (mantener funcionamiento actual)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
</head>
<body>
    <div id="root">
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h1>Cargando Inventario App...</h1>
            <p>Conectando con Firebase...</p>
            <!-- v2.2 - Carga TODOS los locales de Firebase, sin caché -->
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Login Component
        function Login({ onLoginSuccess }) {
            const [regiones, setRegiones] = useState([]);
            const [regionSeleccionada, setRegionSeleccionada] = useState(null);
            const [nombresMaestros, setNombresMaestros] = useState([]);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            // Ya no se usa cargandoLocales - se eliminó la carga de locales en login
            const [cargandoRegiones, setCargandoRegiones] = useState(true);
            const [recordarDatos, setRecordarDatos] = useState(false);
            const [regionCargada, setRegionCargada] = useState(false); // Flag para saber si ya se cargó la región inicial
            const [downloadUrl, setDownloadUrl] = useState('https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk'); // URL por defecto

            // Función para cargar la URL de descarga desde GitHub
            const cargarDownloadUrl = async () => {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/solanosaboresexpress-hash/inventario-app-updates/refs/heads/main/version_info.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.downloadUrl) {
                            setDownloadUrl(data.downloadUrl);
                            console.log('✅ URL de descarga cargada:', data.downloadUrl);
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ No se pudo cargar la URL de descarga desde GitHub, usando URL por defecto:', error);
                    // Mantener la URL por defecto si falla
                }
            };

            useEffect(() => {
                // Resetear estados al montar el componente (pero NO limpiar regionSeleccionada todavía)
                setCargandoRegiones(true);
                setError('');
                // NO limpiar email ni password aquí - se cargarán desde localStorage si existen
                setRegionCargada(false);
                cargarRegiones();
                cargarDownloadUrl(); // Cargar URL de descarga
            }, []);

            // Ya no se cargan locales en el login - se usa email/password con Firebase Auth
            // Cargar datos guardados al montar el componente
            useEffect(() => {
                if (regionCargada) {
                    // Solo cargar credenciales si el email está vacío (permite cambio de cuenta si el usuario ya escribió algo)
                    if (!email || email.trim() === '') {
                        cargarDatosGuardados();
                    }
                }
            }, [regionCargada]);

            const cargarRegiones = async () => {
                try {
                    setCargandoRegiones(true);
                    setError('');
                    
                    const regionesDisponibles = await FirebaseRegionManager.cargarRegiones();
                    
                    if (!regionesDisponibles || regionesDisponibles.length === 0) {
                        setError('No se encontraron regiones disponibles');
                        setCargandoRegiones(false);
                        return;
                    }
                    
                    setRegiones(regionesDisponibles);

                    const nombres = [];
                    for (let i = 0; i < regionesDisponibles.length; i++) {
                        const region = regionesDisponibles[i];
                        try {
                            const tempApp = firebase.initializeApp(region.firebaseConfig, 'temp_' + region.id);
                            const tempDb = firebase.firestore(tempApp);
                            
                            const configDoc = await tempDb.collection('configuracion')
                                .doc('admin')
                                .get();
                            
                            const nombreMaestro = configDoc.exists 
                                ? (configDoc.data().maestro_nombre || region.maestroNombre || 'Maestro')
                                : (region.maestroNombre || 'Maestro');
                            
                            tempApp.delete();
                            nombres.push({
                                regionId: region.id,
                                nombre: nombreMaestro
                            });
                        } catch (e) {
                            console.warn('No se pudo cargar nombre del maestro para ' + region.nombre + ':', e.message);
                            nombres.push({
                                regionId: region.id,
                                nombre: region.maestroNombre || 'Maestro'
                            });
                        }
                    }
                    
                    setNombresMaestros(nombres);

                    // Cargar región guardada - EXACTO como Android LoginActivity.kt líneas 88-94
                    // Prioridad: 1) firebase_region_prefs, 2) region_id, 3) usuario_actual.regionId
                    let regionGuardada = await FirebaseRegionManager.cargarRegionActual();
                    
                    // Si no hay región guardada, intentar obtenerla del usuario_actual (si viene de GestionLocales)
                    if (!regionGuardada) {
                        const usuarioActualData = localStorage.getItem('usuario_actual');
                        if (usuarioActualData) {
                            try {
                                const usuarioActual = JSON.parse(usuarioActualData);
                                if (usuarioActual.regionId) {
                                    console.log('📍 Usando región del usuario_actual:', usuarioActual.regionId);
                                    regionGuardada = regionesDisponibles.find(r => r.id === usuarioActual.regionId);
                                }
                            } catch (e) {
                                console.warn('Error parseando usuario_actual:', e);
                            }
                        }
                    }
                    
                    // Buscar región 1 por ID o usar la primera disponible como fallback
                    const region1 = regionesDisponibles.find(r => r.id === 'region_1' || r.nombre === 'Región 1');
                    const regionInicial = regionGuardada || region1 || regionesDisponibles[0];
                    
                    if (regionInicial) {
                        console.log('Cargando región:', regionInicial.nombre, regionGuardada ? '(guardada)' : '(por defecto)');
                        await seleccionarRegion(regionInicial, true); // true = es carga inicial
                        setRegionCargada(true); // Marcar que ya se cargó la región inicial
                    } else {
                        console.warn('No se encontró región inicial');
                        setCargandoRegiones(false);
                    }
                } catch (error) {
                    console.error('Error cargando regiones:', error);
                    setError('Error cargando regiones: ' + error.message);
                    setCargandoRegiones(false);
                }
            };

            const seleccionarRegion = async (region, esCargaInicial = false) => {
                try {
                    console.log('Cambiando a region:', region.nombre, esCargaInicial ? '(carga inicial)' : '(cambio manual)');
                    
                    // Limpiar estados primero (pero solo si NO es la carga inicial)
                    if (!esCargaInicial) {
                        setEmail('');
                        setPassword('');
                    }
                    
                    const usuarioData = localStorage.getItem('usuario');
                    if (usuarioData) {
                        try {
                            const usuario = JSON.parse(usuarioData);
                            const regionIdUsuario = localStorage.getItem('region_id');
                            if (regionIdUsuario && regionIdUsuario !== region.id) {
                                console.log('Region cambio, limpiando datos del usuario...');
                                localStorage.removeItem('usuario');
                                localStorage.removeItem('loginData');
                            }
                        } catch (e) {
                            console.warn('Error verificando cambio de region:', e);
                        }
                    }
                    
                    // Inicializar Firebase
                    const exito = FirebaseRegionManager.initializeFirebase(region);
                    
                    if (exito) {
                        // Guardar región en ambos lugares para compatibilidad
                        localStorage.setItem('region_id', region.id);
                        FirebaseRegionManager.guardarRegionActual(region);
                        
                        // Esperar más tiempo para que Firebase se inicialice completamente y el cliente anterior se cierre
                        await new Promise(resolve => setTimeout(resolve, 800));
                        
                        // Ahora establecer la región seleccionada, lo que disparará el useEffect que carga locales
                        // El useEffect tiene un delay adicional de 1000ms, así que en total son ~1.8 segundos
                        setRegionSeleccionada(region);
                        console.log('Region seleccionada:', region.nombre);
                        
                        // Asegurar que se termine de cargar regiones cuando se selecciona una región
                        setCargandoRegiones(false);
                    } else {
                        setError('Error inicializando region: ' + region.nombre);
                        setCargandoRegiones(false);
                    }
                } catch (error) {
                    console.error('Error seleccionando region:', error);
                    setError('Error seleccionando region: ' + error.message);
                    setCargandoRegiones(false);
                }
            };

            const cargarDatosGuardados = (localesLista = null) => {
                try {
                    const datosGuardados = localStorage.getItem('loginData');
                    console.log('🔍 cargarDatosGuardados - datosGuardados en localStorage:', datosGuardados ? 'EXISTE' : 'NO EXISTE');
                    if (datosGuardados) {
                        const parsed = JSON.parse(datosGuardados);
                        console.log('🔍 Datos parseados:', { email: parsed.email, recordar: parsed.recordar, tienePassword: !!parsed.password });
                        const { email: savedEmail, password: savedPassword, recordar } = parsed;
                        if (recordar && savedEmail) {
                            // EXACTO como Android: Solo cargar si el campo de email está vacío
                            // Si el usuario ya escribió algo, no sobrescribir (permite cambio de cuenta)
                            console.log('✅ Restaurando credenciales guardadas...');
                            setEmail(savedEmail || '');
                            setPassword(savedPassword || '');
                            setRecordarDatos(true);
                            console.log('✅ Datos restaurados: email =', savedEmail, 'password =', savedPassword ? '***' : '(vacío)');
                        } else {
                            console.log('⚠️ Datos guardados no tienen recordar=true o email:', { recordar, email: savedEmail });
                        }
                    } else {
                        console.log('⚠️ No hay datos guardados en localStorage');
                    }
                } catch (error) {
                    console.error('❌ Error cargando datos guardados:', error);
                }
            };

            // Ya no se cargan locales en el login - se usa email/password con Firebase Auth

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!regionSeleccionada) {
                    setError('Por favor selecciona una región');
                    return;
                }
                
                // Validar email
                const emailCompleto = email.includes('@') ? email : email + '@saboresexpress.com.ar';
                if (!email || email.trim() === '') {
                    setError('Ingrese el email');
                    return;
                }
                
                if (!emailCompleto.endsWith('@saboresexpress.com.ar')) {
                    setError('El email debe ser @saboresexpress.com.ar');
                    return;
                }
                
                if (!password) {
                    setError('Ingrese la contraseña');
                    return;
                }

                try {
                    setLoading(true);
                    setError('');
                    
                    // Asegurar que Firebase esté inicializado para la región seleccionada
                    if (!regionSeleccionada) {
                        setError('Por favor selecciona una región');
                        setLoading(false);
                        return;
                    }
                    
                    // Verificar que Firebase esté inicializado
                    try {
                        FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.log('Firebase no inicializado, inicializando con región seleccionada');
                        const exito = FirebaseRegionManager.initializeFirebase(regionSeleccionada);
                        if (!exito) {
                            setError('Error inicializando Firebase. Intenta nuevamente.');
                            setLoading(false);
                            return;
                        }
                    }
                    
                    const auth = FirebaseRegionManager.getAuth();
                    
                    // Si hay un usuario actual de Firebase Auth y el email es diferente, cerrar sesión primero
                    // Esto es necesario después de hacer logout para poder iniciar sesión con otro usuario
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.email && currentUser.email !== emailCompleto) {
                        console.log('🔄 Usuario diferente detectado, cerrando sesión anterior antes de login');
                        try {
                            await auth.signOut();
                            console.log('✅ Sesión anterior cerrada');
                            // Pequeño delay para asegurar que Firebase procese el signOut
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (signOutError) {
                            console.warn('⚠️ Error cerrando sesión anterior (continuando con login):', signOutError);
                            // Continuar con el login aunque falle el signOut
                        }
                    }
                    
                    // Limpiar usuario guardado si el email es diferente
                    const usuarioGuardado = localStorage.getItem('usuario');
                    if (usuarioGuardado) {
                        try {
                            const usuarioData = JSON.parse(usuarioGuardado);
                            // Verificar si el email del usuario guardado es diferente
                            // (los locales no tienen email en usuarioData, pero supervisores/maestros sí)
                            if (usuarioData.email && usuarioData.email !== emailCompleto) {
                                console.log('🗑️ Limpiando usuario guardado (email diferente)');
                                localStorage.removeItem('usuario');
                                localStorage.removeItem('usuario_actual');
                            }
                        } catch (e) {
                            console.warn('Error verificando usuario guardado:', e);
                        }
                    }
                    
                    // Intentar autenticar con Firebase Auth
                    // Si falla, intentar con todas las regiones (detección automática de región)
                    let userCredential = null;
                    let uid = null;
                    let regionCorrecta = regionSeleccionada;
                    let authCorrecto = null;
                    
                    try {
                        // Intentar primero con la región seleccionada
                        userCredential = await auth.signInWithEmailAndPassword(emailCompleto, password);
                        uid = userCredential.user.uid;
                        authCorrecto = auth;
                        console.log('✅ Firebase Auth exitoso con región seleccionada. UID:', uid);
                    } catch (firstError) {
                        // Si falla con error de API key o auth, intentar con todas las regiones
                        if (firstError.code === 'auth/api-key-not-valid' || 
                            firstError.code === 'auth/invalid-api-key' ||
                            firstError.code === 'auth/network-request-failed' ||
                            firstError.message?.includes('api-key')) {
                            console.log('🔄 Login falló con región seleccionada, intentando con todas las regiones...');
                            
                            // Intentar con cada región hasta encontrar la correcta
                            for (const region of regiones) {
                                if (region.id === regionSeleccionada.id) {
                                    continue; // Ya intentamos con esta
                                }
                                
                                try {
                                    console.log(`🔄 Intentando login con región: ${region.nombre} (${region.id})`);
                                    
                                    // Inicializar Firebase con esta región
                                    const exito = FirebaseRegionManager.initializeFirebase(region);
                                    if (!exito) {
                                        console.warn(`⚠️ No se pudo inicializar Firebase para ${region.nombre}`);
                                        continue;
                                    }
                                    
                                    // Intentar login con esta región
                                    const tempAuth = FirebaseRegionManager.getAuth();
                                    
                                    // Cerrar sesión si hay un usuario actual
                                    if (tempAuth.currentUser) {
                                        await tempAuth.signOut();
                                        await new Promise(resolve => setTimeout(resolve, 100));
                                    }
                                    
                                    userCredential = await tempAuth.signInWithEmailAndPassword(emailCompleto, password);
                                    uid = userCredential.user.uid;
                                    authCorrecto = tempAuth;
                                    regionCorrecta = region;
                                    
                                    // Actualizar región seleccionada
                                    setRegionSeleccionada(region);
                                    localStorage.setItem('region_id', region.id);
                                    FirebaseRegionManager.guardarRegionActual(region);
                                    
                                    console.log(`✅ Firebase Auth exitoso con región: ${region.nombre}. UID: ${uid}`);
                                    break; // Encontramos la región correcta
                                } catch (regionError) {
                                    console.log(`❌ Login falló con región ${region.nombre}:`, regionError.code || regionError.message);
                                    // Continuar con la siguiente región
                                    continue;
                                }
                            }
                            
                            // Si no encontramos ninguna región válida, lanzar el error original
                            if (!uid || !userCredential) {
                                throw firstError;
                            }
                        } else {
                            // Si es otro tipo de error (contraseña incorrecta, usuario no encontrado, etc.), lanzarlo
                            throw firstError;
                        }
                    }
                    
                    // Asegurar que estamos usando el auth correcto
                    if (authCorrecto && authCorrecto !== auth) {
                        // Reinicializar Firebase con la región correcta si cambió
                        FirebaseRegionManager.initializeFirebase(regionCorrecta);
                    }
                    
                    const authFinal = authCorrecto || auth;
                    uid = userCredential.user.uid;
                    
                    console.log('✅ Firebase Auth exitoso. UID:', uid, 'Región:', regionCorrecta.nombre);
                    
                    // Buscar el usuario en Firestore por firebaseAuthUid
                    const db = FirebaseRegionManager.getFirestore();
                    
                    // Buscar en locales
                    let localDoc = null;
                    let local = null;
                    const localesSnapshot = await db.collection('locales')
                        .where('firebaseAuthUid', '==', uid)
                        .limit(1)
                        .get();
                    
                    if (!localesSnapshot.empty) {
                        localDoc = localesSnapshot.docs[0];
                        local = localDoc.data();
                        console.log('✅ Usuario encontrado como LOCAL:', local.nombre);
                    }
                    
                    // Buscar en supervisores
                    let supervisor = null;
                    if (!local) {
                        const supervisoresSnapshot = await db.collection('supervisores')
                            .where('firebaseAuthUid', '==', uid)
                            .limit(1)
                            .get();
                        
                        if (!supervisoresSnapshot.empty) {
                            const supervisorDoc = supervisoresSnapshot.docs[0];
                            supervisor = { id: supervisorDoc.id, ...supervisorDoc.data() };
                            console.log('✅ Usuario encontrado como SUPERVISOR:', supervisor.usuario);
                        }
                    }
                    
                    // Buscar en maestros
                    let maestro = null;
                    if (!local && !supervisor) {
                        const configDoc = await db.collection('configuracion').doc('admin').get();
                        const firebaseAuthUid = configDoc.data()?.firebaseAuthUid;
                        if (firebaseAuthUid === uid) {
                            maestro = {
                                id: 'maestro',
                                usuario: configDoc.data()?.maestro_nombre || 'Maestro',
                                email: configDoc.data()?.email || '',
                                rol: 'maestro'
                            };
                            console.log('✅ Usuario encontrado como MAESTRO:', maestro.usuario);
                        }
                    }
                    
                    if (!local && !supervisor && !maestro) {
                        throw new Error('Usuario no encontrado en la base de datos. Verifica que el email esté correctamente asociado.');
                    }
                    
                    // Determinar tipo de usuario y crear usuarioData
                    // Usar regionCorrecta (puede haber cambiado durante la detección automática)
                    let usuarioData;
                    if (maestro) {
                        usuarioData = {
                            localId: '',
                            localNombre: '',
                            usuarioId: maestro.id,
                            usuario: maestro.usuario,
                            rol: 'maestro',
                            regionId: regionCorrecta.id
                        };
                    } else if (supervisor) {
                        usuarioData = {
                            localId: '',
                            localNombre: '',
                            usuarioId: supervisor.id,
                            usuario: supervisor.usuario,
                            rol: 'supervisor',
                            localesAsignados: supervisor.localesAsignados || [],
                            regionId: regionCorrecta.id
                        };
                    } else {
                        usuarioData = {
                            localId: localDoc.id,
                            localNombre: local.nombre,
                            usuarioId: 'admin_' + localDoc.id.toLowerCase(),
                            usuario: 'admin_' + localDoc.id.toLowerCase(),
                            rol: 'admin_local',
                            regionId: regionCorrecta.id
                        };
                    }

                    localStorage.setItem('usuario', JSON.stringify(usuarioData));
                    localStorage.setItem('region_id', regionSeleccionada.id);
                    
                    // Guardar datos de login si está marcado recordar
                    if (recordarDatos) {
                        const loginData = {
                            email: email,
                            password: password,
                            recordar: true
                        };
                        localStorage.setItem('loginData', JSON.stringify(loginData));
                        console.log('💾 Datos de login guardados:', { email: loginData.email, tienePassword: !!loginData.password, recordar: loginData.recordar });
                    } else {
                        // Limpiar datos guardados si no se quiere recordar
                        localStorage.removeItem('loginData');
                        console.log('🗑️ Datos de login eliminados (recordarDatos = false)');
                    }
                    
                    onLoginSuccess(usuarioData);
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    if (error.code === 'auth/user-not-found') {
                        setError('Email no registrado');
                    } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        setError('Contraseña incorrecta');
                    } else {
                        setError(error.message || 'Error en el login');
                    }
                } finally {
                    setLoading(false);
                }
            };

            const mostrarDialogoResetContraseña = () => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                `;
                
                const emailCompleto = email.includes('@') ? email : email + '@saboresexpress.com.ar';
                
                dialogContent.innerHTML = `
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;">
                        🔐 Recuperar Contraseña
                    </h3>
                    <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                        Se enviará un enlace a tu email para restablecer la contraseña.
                    </p>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-size: 14px; font-weight: 500;">
                            Email
                        </label>
                        <div style="position: relative; display: flex; align-items: center;">
                            <input
                                type="text"
                                id="resetEmailInput"
                                value="${email || ''}"
                                style="
                                    width: 100%;
                                    padding: 12px;
                                    padding-right: 180px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    box-sizing: border-box;
                                "
                                placeholder="Ingresa tu email"
                            />
                            <span style="
                                position: absolute;
                                right: 12px;
                                color: #9E9E9E;
                                font-size: 14px;
                                pointer-events: none;
                            ">
                                @saboresexpress.com.ar
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button
                            id="btnCancelarReset"
                            style="
                                padding: 10px 20px;
                                background: #9E9E9E;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            "
                        >
                            Cancelar
                        </button>
                        <button
                            id="btnEnviarReset"
                            style="
                                padding: 10px 20px;
                                background: var(--brand-gold);
                                color: var(--brand-black);
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            "
                        >
                            Enviar
                        </button>
                    </div>
                `;
                
                modal.appendChild(dialogContent);
                document.body.appendChild(modal);
                
                const inputEmail = dialogContent.querySelector('#resetEmailInput');
                inputEmail.addEventListener('input', (e) => {
                    let valor = e.target.value;
                    if (valor.includes('@') || valor.includes('saboresexpress.com.ar')) {
                        e.target.value = valor.replace(/[@saboresexpress.com.ar]/g, '');
                    }
                });
                
                dialogContent.querySelector('#btnCancelarReset').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                dialogContent.querySelector('#btnEnviarReset').addEventListener('click', async () => {
                    try {
                        const emailInput = inputEmail.value.trim();
                        if (!emailInput) {
                            alert('Ingrese el email');
                            return;
                        }
                        
                        const emailCompleto = emailInput.includes('@') ? emailInput : emailInput + '@saboresexpress.com.ar';
                        
                        if (!emailCompleto.endsWith('@saboresexpress.com.ar')) {
                            alert('El email debe ser @saboresexpress.com.ar');
                            return;
                        }
                        
                        // Cargar todas las regiones disponibles
                        const todasLasRegiones = await FirebaseRegionManager.cargarRegiones();
                        
                        // Ordenar regiones: primero la seleccionada, luego la por defecto, luego las demás
                        const regionActual = FirebaseRegionManager.getCurrentRegion();
                        const regionesOrdenadas = [];
                        
                        // 1. Agregar región seleccionada primero (si existe)
                        if (regionActual) {
                            regionesOrdenadas.push(regionActual);
                        }
                        
                        // 2. Agregar región por defecto (region_1)
                        const regionPorDefecto = todasLasRegiones.find(function(r) { return r.id === 'region_1'; });
                        if (regionPorDefecto && regionPorDefecto !== regionActual) {
                            regionesOrdenadas.push(regionPorDefecto);
                        }
                        
                        // 3. Agregar las demás regiones
                        todasLasRegiones.forEach(function(region) {
                            if (region !== regionActual && region !== regionPorDefecto) {
                                regionesOrdenadas.push(region);
                            }
                        });
                        
                        console.log('🔍 Intentando reset de contraseña en', regionesOrdenadas.length, 'regiones');
                        
                        // Intentar con cada región hasta encontrar una donde el usuario exista
                        var exito = false;
                        var ultimoError = null;
                        
                        for (var i = 0; i < regionesOrdenadas.length; i++) {
                            var region = regionesOrdenadas[i];
                            try {
                                console.log('🔄 Intentando reset en región:', region.nombre);
                                var auth = FirebaseRegionManager.getAuthForRegion(region);
                                
                                if (auth) {
                                    await auth.sendPasswordResetEmail(emailCompleto);
                                    
                                    // Éxito: el usuario existe en esta región
                                    console.log('✅ Email de reset enviado desde región:', region.nombre);
                                    exito = true;
                                    
                                    alert('✅ Email enviado. Revisa tu bandeja de entrada para restablecer tu contraseña.');
                                    document.body.removeChild(modal);
                                    
                                    break;
                                }
                            } catch (error) {
                                // Verificar si es error de usuario no encontrado
                                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                                    // Usuario no existe en esta región, continuar con la siguiente
                                    console.log('⚠️ Usuario no encontrado en región', region.nombre, ', intentando siguiente...');
                                    ultimoError = error;
                                    continue;
                                } else {
                                    // Otro error, guardar pero continuar
                                    console.warn('⚠️ Error en región', region.nombre, ':', error.message);
                                    if (!ultimoError) {
                                        ultimoError = error;
                                    }
                                    continue;
                                }
                            }
                        }
                        
                        // Si no se encontró el usuario en ninguna región
                        if (!exito) {
                            console.error('❌ Usuario no encontrado en ninguna región');
                            if (ultimoError && ultimoError.code === 'auth/user-not-found') {
                                alert('El email ' + emailCompleto + ' no está registrado en ninguna región del sistema.');
                            } else {
                                alert('Error: ' + (ultimoError ? ultimoError.message : 'No se pudo enviar el email'));
                            }
                        }
                        
                    } catch (error) {
                        console.error('Error enviando email reset:', error);
                        alert('Error: ' + (error.message || 'No se pudo enviar el email. Verifique su conexión e intente nuevamente.'));
                    }
                });
            };

            const mostrarDialogoContraseñaGestion = () => {
                // Crear modal EXACTO como LoginActivity.kt líneas 380-432
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                `;
                
                dialogContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center;">
                            🔐 Gestión de Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 8px; font-size: 14px;">
                            Acceso administrativo
                        </p>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Seleccione el usuario y ingrese la contraseña para acceder a la gestión completa de locales:
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 16px; position: relative;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Usuario:
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                id="usuarioInput"
                                placeholder="Seleccione un usuario"
                                readonly
                                style="
                                    width: 100%;
                                    padding: 12px 40px 12px 12px;
                                    border: 2px solid var(--brand-gold);
                                    border-radius: 8px;
                                    font-size: 16px;
                                    box-sizing: border-box;
                                    background: white;
                                    cursor: pointer;
                                "
                            />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--brand-gold); font-size: 18px;">
                                ▼
                            </div>
                        </div>
                        <div id="usuariosDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1002; max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Contraseña de administración:
                        </label>
                        <div style="position: relative;">
                        <input 
                            type="password" 
                            id="passwordInput"
                            placeholder="Ingrese la contraseña"
                            style="
                                width: 100%;
                                    padding: 12px 40px 12px 12px;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                font-size: 16px;
                                box-sizing: border-box;
                            "
                        />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 18px;">
                                👁️
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; font-size: 14px; color: #666;">
                            <input 
                                type="checkbox" 
                                id="rememberPassword"
                                style="margin-right: 8px; accent-color: var(--brand-gold);"
                            />
                            Recordar contraseña en este dispositivo
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px;">
                        <button 
                            id="cancelBtn"
                            class="btn-text-button"
                            style="flex: 1; margin-right: 8px;"
                        >
                            Cancelar
                        </button>
                        <button id="accessBtn">
                            Acceder
                        </button>
                    </div>
                `;
                
                modal.appendChild(dialogContent);
                document.body.appendChild(modal);
                
                // Cargar usuarios disponibles (como en la APK líneas 480-515)
                let closeDropdown; // Declarar fuera del scope
                
                const cargarUsuariosDisponibles = async () => {
                    try {
                        const usuarios = [];
                        
                        // Cargar nombre del maestro desde Firebase de la región actual
                        let db;
                        try {
                            db = FirebaseRegionManager.getFirestore();
                        } catch (firebaseInitError) {
                            console.error('Firebase no está inicializado:', firebaseInitError);
                            usuarios.push('Maestro'); // Fallback
                            db = null;
                        }
                        
                        if (db) {
                            try {
                                const configDoc = await db.collection('configuracion')
                                    .doc('admin')
                                    .get();
                                
                                const nombreMaestro = configDoc.exists 
                                    ? (configDoc.data().maestro_nombre || 'Maestro')
                                    : 'Maestro';
                                
                                usuarios.push(nombreMaestro);
                                
                                // Cargar supervisores desde Firebase
                                const supervisoresSnapshot = await db.collection('supervisores')
                                    .where('activo', '==', true)
                                    .get();
                                
                                supervisoresSnapshot.forEach(doc => {
                                    const supervisor = doc.data();
                                    usuarios.push(supervisor.usuario);
                                });
                            } catch (firebaseError) {
                                console.error('Error cargando desde Firebase:', firebaseError);
                                if (usuarios.length === 0) {
                                    usuarios.push('Maestro'); // Fallback solo si no hay usuarios
                                }
                            }
                        }
                        
                        // Configurar dropdown solo si tenemos elementos
                        const usuarioInput = dialogContent.querySelector('#usuarioInput');
                        const usuariosDropdown = dialogContent.querySelector('#usuariosDropdown');
                        
                        if (usuarioInput && usuariosDropdown) {
                            if (usuarios.length > 0) {
                                usuariosDropdown.innerHTML = usuarios.map(usuario => {
                                    // Escapar comillas simples para evitar problemas
                                    const usuarioEscapado = usuario.replace(/'/g, "\\'");
                                    return `<div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                                         onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                         onmouseout="this.style.backgroundColor='white'"
                                         onclick="seleccionarUsuario('${usuarioEscapado}')">
                                        ${usuario}
                                     </div>`;
                                }).join('');
                            } else {
                                usuariosDropdown.innerHTML = '<div style="padding: 12px;">No hay usuarios disponibles</div>';
                            }
                            
                            // Mostrar dropdown al hacer click
                            usuarioInput.onclick = (e) => {
                                e.stopPropagation();
                                const isVisible = usuariosDropdown.style.display === 'block';
                                usuariosDropdown.style.display = isVisible ? 'none' : 'block';
                            };
                            
                            // Cerrar dropdown al hacer click fuera
                            closeDropdown = (e) => {
                                if (!dialogContent.contains(e.target)) {
                                    usuariosDropdown.style.display = 'none';
                                }
                            };
                            
                            // Agregar listener temporal
                            setTimeout(() => {
                                document.addEventListener('click', closeDropdown);
                            }, 100);
                            
                            // Cargar credenciales guardadas
                            const savedUsuario = localStorage.getItem('usuario_gestion');
                            const savedPassword = localStorage.getItem('contraseña_gestion');
                            const rememberCheckbox = dialogContent.querySelector('#rememberPassword');
                            const passwordInput = dialogContent.querySelector('#passwordInput');
                            
                            if (savedUsuario && savedPassword && rememberCheckbox && passwordInput) {
                                usuarioInput.value = savedUsuario;
                                passwordInput.value = savedPassword;
                                rememberCheckbox.checked = true;
                            }
                        }
                
                    } catch (error) {
                        console.error('Error cargando usuarios:', error);
                    }
                };
                
                // Función para seleccionar usuario
                window.seleccionarUsuario = (usuario) => {
                    dialogContent.querySelector('#usuarioInput').value = usuario;
                    dialogContent.querySelector('#usuariosDropdown').style.display = 'none';
                };
                
                // Cargar usuarios
                cargarUsuariosDisponibles();
                
                // Enfocar el campo de usuario
                dialogContent.querySelector('#usuarioInput').focus();
                
                // Event listeners
                dialogContent.querySelector('#cancelBtn').onclick = () => {
                    document.body.removeChild(modal);
                    delete window.seleccionarUsuario;
                    // Limpiar listener si existe
                    if (closeDropdown) {
                        document.removeEventListener('click', closeDropdown);
                    }
                };
                
                dialogContent.querySelector('#accessBtn').onclick = async () => {
                    const usuario = dialogContent.querySelector('#usuarioInput').value.trim();
                    const password = dialogContent.querySelector('#passwordInput').value.trim();
                    const remember = dialogContent.querySelector('#rememberPassword').checked;
                    
                    if (!usuario) {
                        alert('Seleccione un usuario');
                        return;
                    }
                    
                    if (!password) {
                        alert('Ingrese la contraseña');
                        return;
                    }
                    
                    try {
                        // Verificar credenciales como en la APK líneas 611-700
                        
                        const db = FirebaseRegionManager.getFirestore();
                        // Primero verificar si es usuario maestro
                        const configDoc = await db.collection('configuracion')
                            .doc('admin')
                            .get();
                        
                        const passwordMaestro = configDoc.data()?.password || 'admin123';
                        const nombreMaestro = configDoc.exists 
                            ? (configDoc.data().maestro_nombre || 'Maestro')
                            : 'Maestro';
                        
                        if (usuario === nombreMaestro && password === passwordMaestro) {
                            // Es usuario maestro
                            console.log('🔑 CREDENCIALES DE MAESTRO CORRECTAS');
                            
                            // Guardar credenciales si está marcado el checkbox
                        if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                            localStorage.setItem('contraseña_gestion', password);
                        } else {
                                localStorage.removeItem('usuario_gestion');
                            localStorage.removeItem('contraseña_gestion');
                        }
                            
                            // Guardar datos del usuario maestro en localStorage
                            // EXACTO como Android: incluir regionId para restaurar al volver
                            const regionIdActual = localStorage.getItem('region_id');
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'admin123',
                                rol: 'maestro',
                                usuarioId: 'maestro',
                                usuario: 'maestro',
                                regionId: regionIdActual // Guardar región para restaurar
                            }));
                        
                        document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                        
                            // Ir a gestión de locales
                        window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no es maestro, verificar si es supervisor
                        const supervisoresSnapshot = await db.collection('supervisores')
                            .where('usuario', '==', usuario)
                            .where('contraseña', '==', password)
                            .where('activo', '==', true)
                            .get();
                        
                        if (!supervisoresSnapshot.empty) {
                            const supervisorDoc = supervisoresSnapshot.docs[0];
                            const supervisor = supervisorDoc.data();
                            
                            console.log('🔑 SUPERVISOR AUTENTICADO:', supervisor.usuario);
                            
                            // Guardar credenciales si está marcado el checkbox
                            if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                                localStorage.setItem('contraseña_gestion', password);
                    } else {
                                localStorage.removeItem('usuario_gestion');
                                localStorage.removeItem('contraseña_gestion');
                            }
                            
                            // Guardar datos del supervisor en localStorage
                            // EXACTO como Android: incluir regionId para restaurar al volver
                            const regionIdSupervisor = localStorage.getItem('region_id');
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'supervisor',
                                rol: 'supervisor',
                                usuarioId: supervisorDoc.id,
                                usuario: supervisor.usuario,
                                localesAsignados: supervisor.localesAsignados || [],
                                regionId: regionIdSupervisor // Guardar región para restaurar
                            }));
                            
                            document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                            
                            // Ir a gestión de locales
                            window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no se encontró usuario válido
                        alert('Credenciales incorrectas');
                        
                    } catch (error) {
                        console.error('Error verificando credenciales:', error);
                        alert('Error verificando credenciales: ' + error.message);
                    }
                };
            };

            if (cargandoRegiones) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando regiones...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="login-container">
                    {/* Imagen de watermark - EXACTO como Android ImageView líneas 9-15 */}
                    <div className="login-watermark"></div>
                    
                    {/* Header - Color de marca (SOLO título, sin selector de región) */}
                    <div style={{
                        backgroundColor: 'var(--brand-gold)',
                        padding: '12px 16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                        position: 'relative',
                        zIndex: 2
                    }}>
                        <div 
                            className="text-base font-bold"
                            style={{
                                color: '#000000',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis'
                            }}
                        >
                            Sabores Product Mix v2
                        </div>
                    </div>

                    {/* ScrollView equivalente - EXACTO como Android líneas 18-21 */}
                    <div className="login-scrollview">
                        {/* LinearLayout interno - EXACTO como Android líneas 23-28 */}
                        <div className="login-content-wrapper">
                            {/* Login Card - EXACTO como Android MaterialCardView líneas 55-165 */}
                            <div className="login-card max-w-md w-full">
                        <div className="text-center">
                            {/* Logo Container - EXACTO como Android */}
                            <div className="login-logo-container">
                                <div className="login-logo-glow"></div>
                                <img 
                                    src="logo_sabores_real.png" 
                                    alt="Sabores Express" 
                                    className="login-logo"
                                />
                            </div>
                            
                            {/* Texto "Bienvenido" - EXACTO como Android */}
                            <div className="login-welcome-text">
                                Bienvenido
                            </div>
                        </div>

                        <form onSubmit={handleLogin}>
                            {/* Region Selector - EXACTO como Android líneas 76-94 (DENTRO del card) */}
                            <div className="login-text-input-wrapper">
                                <label className="login-text-input-label">
                                    Región
                                </label>
                                <select
                                    className="login-text-input"
                                    value={regionSeleccionada ? regionSeleccionada.id : ''}
                                    disabled={cargandoRegiones || regiones.length === 0}
                                    onChange={(e) => {
                                        const regionId = e.target.value;
                                        const region = regiones.find(r => r.id === regionId);
                                        if (region) {
                                            seleccionarRegion(region, false); // false = cambio manual del usuario
                                        }
                                    }}
                                >
                                    {cargandoRegiones ? (
                                        <option value="">Cargando regiones...</option>
                                    ) : regiones.length === 0 ? (
                                        <option value="">No hay regiones disponibles</option>
                                    ) : (
                                        <>
                                            <option value="">Selecciona una región</option>
                                            {regiones.map((region) => {
                                                const nombreMaestro = nombresMaestros && nombresMaestros.length > 0 
                                                    ? nombresMaestros.find(n => n.regionId === region.id)
                                                    : null;
                                                return (
                                                    <option key={region.id} value={region.id}>
                                                        {nombreMaestro ? nombreMaestro.nombre : (region.maestroNombre || region.nombre)}
                                                    </option>
                                                );
                                            })}
                                        </>
                                    )}
                                </select>
                            </div>

                            {/* Campo Email - Estilo TextInputLayout con autocompletado */}
                            <div className="login-text-input-wrapper">
                                <label className="login-text-input-label">
                                    Email
                                </label>
                                <div style={{position: 'relative', display: 'flex', alignItems: 'center'}}>
                                    <input
                                        type="text"
                                        value={email}
                                        onChange={(e) => {
                                            let valor = e.target.value;
                                            // Prevenir que el usuario escriba @ o el dominio
                                            if (valor.includes('@') || valor.includes('saboresexpress.com.ar')) {
                                                return;
                                            }
                                            setEmail(valor);
                                            
                                            // Si el email cambia manualmente y es diferente al guardado en loginData, limpiar loginData
                                            // Esto permite que el usuario pueda cambiar de cuenta incluso si tiene "Recordar credenciales" activado
                                            if (valor) {
                                                const loginDataGuardado = localStorage.getItem('loginData');
                                                if (loginDataGuardado) {
                                                    try {
                                                        const loginData = JSON.parse(loginDataGuardado);
                                                        const emailCompleto = valor.includes('@') ? valor : valor + '@saboresexpress.com.ar';
                                                        // Si el email es diferente al guardado, limpiar loginData para permitir cambio de cuenta
                                                        if (loginData.email && loginData.email !== emailCompleto) {
                                                            console.log('🗑️ Email cambiado manualmente, limpiando credenciales guardadas para permitir cambio de cuenta');
                                                            localStorage.removeItem('loginData');
                                                            setRecordarDatos(false);
                                                        }
                                                    } catch (e) {
                                                        // Ignorar errores de parsing
                                                    }
                                                }
                                            }
                                            
                                            // Si el email cambia manualmente y es diferente al usuario guardado, limpiar usuario guardado
                                            const usuarioGuardado = localStorage.getItem('usuario');
                                            if (usuarioGuardado && valor) {
                                                try {
                                                    const usuarioData = JSON.parse(usuarioGuardado);
                                                    const emailCompleto = valor.includes('@') ? valor : valor + '@saboresexpress.com.ar';
                                                    // Si el email es diferente, limpiar usuario guardado
                                                    if (usuarioData.email && usuarioData.email !== emailCompleto) {
                                                        console.log('🗑️ Email cambiado manualmente, limpiando usuario guardado');
                                                        localStorage.removeItem('usuario');
                                                        localStorage.removeItem('usuario_actual');
                                                    }
                                                } catch (e) {
                                                    // Ignorar errores de parsing
                                                }
                                            }
                                        }}
                                        className="login-text-input"
                                        placeholder="Ingresa tu email"
                                        required
                                        style={{paddingRight: '180px'}}
                                    />
                                    <span style={{
                                        position: 'absolute',
                                        right: '12px',
                                        color: 'var(--brand-grey-medium)',
                                        fontSize: '14px',
                                        pointerEvents: 'none'
                                    }}>
                                        @saboresexpress.com.ar
                                    </span>
                                </div>
                            </div>

                            {/* Campo Contraseña - Estilo TextInputLayout */}
                            <div className="login-text-input-wrapper">
                                <label className="login-text-input-label">
                                    Contraseña
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="login-text-input"
                                    placeholder="Ingresa tu contraseña"
                                    required
                                />
                            </div>

                            {/* Checkbox Recordar Datos y Olvidaste Contraseña en la misma línea */}
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="recordarDatos"
                                        checked={recordarDatos}
                                        onChange={(e) => setRecordarDatos(e.target.checked)}
                                        className="mr-2 h-4 w-4"
                                        style={{
                                            accentColor: 'var(--brand-gold)',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <label htmlFor="recordarDatos" className="text-sm" style={{color: 'var(--brand-black)'}}>
                                        Recordar credenciales
                                    </label>
                                </div>
                                <button
                                    type="button"
                                    onClick={() => mostrarDialogoResetContraseña()}
                                    className="text-sm"
                                    style={{
                                        color: 'var(--brand-gold)',
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                        textDecoration: 'underline'
                                    }}
                                >
                                    Olvidaste tu contraseña?
                                </button>
                            </div>

                            {error && (
                                <div className="text-sm text-center mb-4" style={{color: 'var(--status-error)'}}>
                                    {error}
                                </div>
                            )}

                            {/* Botón Login - EXACTO como Android */}
                            <button 
                                type="submit"
                                disabled={loading}
                                className="login-button"
                            >
                                {loading ? 'Verificando...' : 'INICIAR SESIÓN'}
                            </button>
                        </form>

                            {/* Botón Gestión de Locales eliminado - la navegación es automática según el rol */}

                            {/* Enlace de descarga de la app Android */}
                            <div className="mt-6 text-center">
                                <a
                                    href={downloadUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        border: '1px solid #388E3C',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        textDecoration: 'none'
                                    }}
                                >
                                    📱 Descargar App Android
                                </a>
                            </div>

                            {/* Botón de Administración */}
                            <div className="mt-4 text-center">
                                <a
                                    href="https://administracion-se.netlify.app/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                    style={{
                                        backgroundColor: '#2196F3',
                                        border: '1px solid #1976D2',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        textDecoration: 'none'
                                    }}
                                >
                                    🔧 Ir a Administración
                                </a>
                            </div>
                        </div>
                        {/* Cierre LinearLayout - login-content-wrapper */}
                        </div>
                    {/* Cierre ScrollView - login-scrollview */}
                    </div>
                </div>
            );
        }

        // Función global para mostrar popup de problemas (disponible para GestionLocales y Main)
        const mostrarPopupProblemas = (nombreLocal, problemas) => {
            if (!problemas || problemas.length === 0) return;
            
            // Crear diálogo mejorado similar a Android
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:#fff;width:90%;max-width:600px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;max-height:80vh;display:flex;flex-direction:column';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background:#F44336;color:#fff;padding:16px;font-weight:bold;font-size:18px;display:flex;justify-content:space-between;align-items:center';
            header.innerHTML = `⚠️ Alertas - ${nombreLocal}`;
            dialog.appendChild(header);
            
            // Body con scroll
            const body = document.createElement('div');
            body.style.cssText = 'padding:16px;overflow-y:auto;flex:1';
            
            // Mensaje introductorio
            const intro = document.createElement('div');
            intro.style.cssText = 'margin-bottom:16px;padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;font-size:14px;color:#856404';
            intro.innerHTML = '<strong>⚠️ Se encontraron los siguientes problemas:</strong><br><br>Hacé clic en cada problema para ir directamente a completarlo.';
            body.appendChild(intro);
            
            // Lista de problemas (formato original - click directo en el error)
            problemas.forEach((problema, index) => {
                // Parsear fecha del problema si es posible
                let fecha = null;
                let tipo = null;
                
                try {
                    // Buscar fecha en formato "día/mes/año" (ej: "5/11/2025" o "24/11/2025")
                    const regexFecha = /(\d{1,2})\/(\d{1,2})\/(\d{4})/;
                    const matchFecha = problema.match(regexFecha);
                    
                    if (matchFecha) {
                        const dia = matchFecha[1].padStart(2, '0');
                        const mes = matchFecha[2].padStart(2, '0');
                        const año = matchFecha[3];
                        fecha = `${año}-${mes}-${dia}`;
                    }
                    
                    // Detectar tipo
                    if (problema.includes('Stock Final')) {
                        tipo = 'Stock Final';
                    } else if (problema.includes('Ingreso de Mercadería')) {
                        tipo = 'Ingreso de Mercadería';
                    }
                } catch (e) {
                    console.error('Error parseando problema:', problema, e);
                }
                
                const problemaDiv = document.createElement('div');
                problemaDiv.style.cssText = 'margin-bottom:12px;padding:12px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 1px 3px rgba(0,0,0,0.1)';
                problemaDiv.innerHTML = problema.replace(/\n/g, '<br>');
                
                // Hover effect mejorado - más visible
                problemaDiv.onmouseenter = () => {
                    problemaDiv.style.background = '#e3f2fd';
                    problemaDiv.style.borderColor = '#2196F3';
                    problemaDiv.style.boxShadow = '0 4px 8px rgba(33, 150, 243, 0.3)';
                    problemaDiv.style.transform = 'translateY(-2px)';
                };
                problemaDiv.onmouseleave = () => {
                    problemaDiv.style.background = '#f9fafb';
                    problemaDiv.style.borderColor = '#e5e7eb';
                    problemaDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    problemaDiv.style.transform = 'translateY(0)';
                };
                
                // Click para ir a completar el problema
                problemaDiv.onclick = () => {
                    overlay.remove();
                    
                    // Si tenemos fecha y tipo, establecer fecha y navegar con fecha específica
                    if (fecha && tipo) {
                        // Parsear fecha correctamente
                        const fechaParts = fecha.split('-');
                        const fechaDate = new Date(parseInt(fechaParts[0]), parseInt(fechaParts[1]) - 1, parseInt(fechaParts[2]));
                        
                        // Establecer fecha en el estado
                        if (window.setFechaSeleccionada) {
                            window.setFechaSeleccionada(fechaDate);
                        }
                        
                        // Navegar pasando la fecha directamente para evitar problemas de timing
                        setTimeout(() => {
                            if (window.navegarA) {
                                console.log('🚀 Navegando a', tipo, 'con fecha:', fechaDate);
                                window.navegarA(tipo, fechaDate);
                            } else if (tipo === 'Stock Final' && window.abrirCargaStock) {
                                window.abrirCargaStock();
                            } else if (tipo === 'Ingreso de Mercadería' && window.abrirCargaIngreso) {
                                window.abrirCargaIngreso();
                            } else {
                                alert(`Por favor, usa el botón "${tipo}" en el menú principal`);
                            }
                        }, 200);
                    } else {
                        // Fallback: navegar según el contenido del problema
                        if (problema.includes('Stock Final')) {
                            if (window.navegarA) {
                                window.navegarA('Stock Final');
                            } else if (window.abrirCargaStock) {
                                window.abrirCargaStock();
                            } else {
                                alert('Por favor, usa el botón "Stock Final" en el menú principal');
                            }
                        } else if (problema.includes('Ingreso de Mercadería')) {
                            if (window.navegarA) {
                                window.navegarA('Ingreso de Mercadería');
                            } else if (window.abrirCargaIngreso) {
                                window.abrirCargaIngreso();
                            } else {
                                alert('Por favor, usa el botón "Ingreso de Mercadería" en el menú principal');
                            }
                        }
                    }
                };
                
                body.appendChild(problemaDiv);
            });
            
            dialog.appendChild(body);
            
            // Footer con botón cerrar
            const footer = document.createElement('div');
            footer.style.cssText = 'padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end';
            const btnCerrar = document.createElement('button');
            btnCerrar.textContent = 'Cerrar';
            btnCerrar.style.cssText = 'padding:8px 24px;background:#6b7280;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold';
            btnCerrar.onclick = () => overlay.remove();
            footer.appendChild(btnCerrar);
            dialog.appendChild(footer);
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Cerrar al hacer click fuera del diálogo
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
        };
        
        // Exponer globalmente
        window.mostrarPopupProblemas = mostrarPopupProblemas;

        // GestionLocales Component - EXACTO como GestionLocalesActivity.kt
        function GestionLocales({ onVolver, onLoginSuccess }) {
            console.log('🏢 GestionLocales renderizado con props:', { onVolver: !!onVolver, onLoginSuccess: !!onLoginSuccess });
            
            const [locales, setLocales] = useState([]);
            const [localesFiltrados, setLocalesFiltrados] = useState([]);
            const [supervisores, setSupervisores] = useState([]);
            const [supervisoresFiltrados, setSupervisoresFiltrados] = useState([]);
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState('');
            const [mostrarFormulario, setMostrarFormulario] = useState(false);
            const [mostrarFormularioSupervisor, setMostrarFormularioSupervisor] = useState(false);
            const [pestanaActiva, setPestanaActiva] = useState('locales');
            const [usuarioActual, setUsuarioActual] = useState(null);
            const [esUsuarioMaestro, setEsUsuarioMaestro] = useState(false);
            const [nuevoLocal, setNuevoLocal] = useState({
                nombre: '',
                email: '',
                contraseña: ''
            });
            const [nuevoSupervisor, setNuevoSupervisor] = useState({
                nombre: '',
                usuario: '',
                email: '',
                contraseña: '',
                localesAsignados: []
            });
            
            // Estados para alertas
            const [badgesVencimientos, setBadgesVencimientos] = useState({}); // {localId: {hoy: 0, manana: 0}}
            const [problemasLocales, setProblemasLocales] = useState({}); // {localId: [problemas]}

            useEffect(() => {
                cargarUsuarioActual();
            }, []);

            useEffect(() => {
                if (usuarioActual) {
                    if (esUsuarioMaestro) {
                        cargarLocales();
                        cargarSupervisores();
                    } else {
                        cargarLocalesAsignados();
                    }
                }
            }, [usuarioActual, esUsuarioMaestro]);
            
            // Cargar badges y verificar problemas cuando cambian los locales
            useEffect(() => {
                if (locales.length > 0 && (esUsuarioMaestro || usuarioActual?.localesAsignados)) {
                    cargarBadgesYProblemas();
                }
            }, [locales, esUsuarioMaestro, usuarioActual]);

            const cargarUsuarioActual = () => {
                try {
                    const usuarioData = localStorage.getItem('usuario_actual');
                    if (usuarioData) {
                        const usuario = JSON.parse(usuarioData);
                        
                        // Convertir localesAsignados de string a array (igual que Android)
                        if (usuario.localesAsignados && typeof usuario.localesAsignados === 'string') {
                            usuario.localesAsignados = usuario.localesAsignados.split(',').filter(id => id.trim() !== '');
                        } else if (!usuario.localesAsignados) {
                            usuario.localesAsignados = [];
                        }
                        
                        setUsuarioActual(usuario);
                        setEsUsuarioMaestro(usuario.rol === 'maestro');
                        console.log('Usuario cargado:', usuario.usuario, 'Rol:', usuario.rol, 'EsMaestro:', usuario.rol === 'maestro', 'LocalesAsignados:', usuario.localesAsignados);
                    }
                } catch (error) {
                    console.error('Error cargando usuario actual:', error);
                }
            };

            const cargarLocales = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    // Cargar TODOS los locales sin filtro
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    console.log('Locales encontrados:', snapshot.size);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // CRÍTICO: Asegurar que el ID del documento siempre esté presente
                        // Si data tiene un campo 'id', lo sobrescribimos con doc.id (el ID real del documento)
                        const localData = { 
                            ...data,
                            id: doc.id // SIEMPRE usar el ID del documento de Firebase, nunca el de data
                        };
                        console.log('📦 Local cargado:', {
                            id: localData.id,
                            nombre: localData.nombre,
                            tieneId: !!localData.id,
                            docId: doc.id
                        });
                        localesData.push(localData);
                    });
                    
                    console.log('Locales cargados:', localesData);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales:', error);
                    setError('Error cargando locales: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarLocalesAsignados = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    // Usar los localesAsignados que ya están en usuarioActual (cargados desde localStorage)
                    // Esto evita loops infinitos y es más eficiente
                    if (!usuarioActual || !usuarioActual.localesAsignados) {
                        setError('No hay locales asignados');
                        setLocales([]);
                        setLocalesFiltrados([]);
                        setCargando(false);
                        return;
                    }
                    
                    const localesAsignados = usuarioActual.localesAsignados;
                    
                    if (localesAsignados.length === 0) {
                        setError('No tienes locales asignados');
                        setLocales([]);
                        setLocalesFiltrados([]);
                        return;
                    }
                    
                    // Cargar solo los locales asignados
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (localesAsignados.includes(doc.id)) {
                            // CRÍTICO: Asegurar que el ID del documento siempre esté presente
                            const localData = {
                                ...data,
                                id: doc.id // SIEMPRE usar el ID del documento de Firebase
                            };
                            console.log('📦 Local asignado cargado:', {
                                id: localData.id,
                                nombre: localData.nombre,
                                tieneId: !!localData.id
                            });
                            localesData.push(localData);
                        }
                    });
                    
                    console.log('Locales asignados cargados desde Firebase:', localesData.length);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales asignados:', error);
                    setError('Error cargando locales asignados: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarSupervisores = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('supervisores').get();
                    const supervisoresData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activo) {
                            supervisoresData.push({ 
                                id: doc.id, 
                                ...data
                            });
                        }
                    });
                    
                    console.log('Supervisores cargados:', supervisoresData.length);
                    setSupervisores(supervisoresData);
                    setSupervisoresFiltrados(supervisoresData);
                    
                } catch (error) {
                    console.error('Error cargando supervisores:', error);
                    setError('Error cargando supervisores: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const crearLocal = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    // Validar email
                    const emailCompleto = nuevoLocal.email.includes('@') ? nuevoLocal.email : nuevoLocal.email + '@saboresexpress.com.ar';
                    if (!nuevoLocal.email || nuevoLocal.email.trim() === '') {
                        setError('El email es obligatorio');
                        return;
                    }
                    
                    if (!emailCompleto.endsWith('@saboresexpress.com.ar')) {
                        setError('El email debe ser @saboresexpress.com.ar');
                        return;
                    }
                    
                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailCompleto)) {
                        setError('El formato del email no es válido');
                        return;
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const auth = FirebaseRegionManager.getAuth();
                    
                    // Verificar si el local ya existe
                    const snapshot = await db.collection('locales')
                        .where('nombre', '==', nuevoLocal.nombre)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El local ' + nuevoLocal.nombre + ' ya existe');
                        return;
                    }
                    
                    // Verificar si el email ya está en uso en locales
                    const snapshotEmail = await db.collection('locales')
                        .where('email', '==', emailCompleto)
                        .get();
                    
                    if (!snapshotEmail.empty) {
                        setError('El email ' + emailCompleto + ' ya está en uso por otro local');
                        return;
                    }
                    
                    // Usar contraseña personalizada o generar una automáticamente
                    const contraseñaFinal = nuevoLocal.contraseña || generarContraseña();
                    
                    // Crear usuario en Firebase Auth
                    let userCredential;
                    try {
                        userCredential = await auth.createUserWithEmailAndPassword(emailCompleto, contraseñaFinal);
                    } catch (authError) {
                        if (authError.code === 'auth/email-already-in-use') {
                            setError('El email ' + emailCompleto + ' ya está registrado en Firebase Auth');
                            return;
                        }
                        throw authError;
                    }
                    
                    const uid = userCredential.user.uid;
                    console.log('✅ Usuario creado en Firebase Auth con UID:', uid);
                    
                    // Obtener la región actual
                    const regionActual = FirebaseRegionManager.getCurrentRegion();
                    const regionId = regionActual?.id || null;
                    
                    // Crear usuario admin para el nuevo local (mantener para compatibilidad)
                    const usuarioAdmin = {
                        id: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        usuario: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        email: emailCompleto,
                        contraseña: contraseñaFinal, // Se mantiene temporalmente para migración
                        rol: 'admin_local',
                        activo: true,
                        firebaseAuthUid: uid
                    };
                    
                    // Crear el local
                    const localData = {
                        nombre: nuevoLocal.nombre,
                        email: emailCompleto,
                        fechaCreacion: window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0],
                        activo: true,
                        usuarios: {
                            [usuarioAdmin.id]: usuarioAdmin
                        },
                        firebaseAuthUid: uid,
                        regionId: regionId
                    };

                    await db.collection('locales').doc(nuevoLocal.nombre).set(localData);
                    
                    // Limpiar formulario
                    setNuevoLocal({
                        nombre: '',
                        email: '',
                        contraseña: ''
                    });
                    setMostrarFormulario(false);
                    
                    // Recargar locales según el tipo de usuario
                    if (esUsuarioMaestro) {
                    cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    // Mostrar credenciales
                    alert(`🎉 Local creado exitosamente!\n\n📍 Local: ${nuevoLocal.nombre}\n📧 Email: ${emailCompleto}\n🔑 Contraseña: ${contraseñaFinal}\n\n⚠️ Guarda estas credenciales para acceder al local\nUsa el email y contraseña para iniciar sesión`);
                    
                } catch (error) {
                    console.error('Error creando local:', error);
                    setError('Error creando local: ' + error.message);
                }
            };

            const generarContraseña = () => {
                const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                return Array.from({length: 8}, () => caracteres[Math.floor(Math.random() * caracteres.length)]).join('');
            };

            const crearSupervisor = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    // Validar email
                    const emailCompleto = nuevoSupervisor.email.includes('@') ? nuevoSupervisor.email : nuevoSupervisor.email + '@saboresexpress.com.ar';
                    if (!nuevoSupervisor.email || nuevoSupervisor.email.trim() === '') {
                        setError('El email es obligatorio');
                        return;
                    }
                    
                    if (!emailCompleto.endsWith('@saboresexpress.com.ar')) {
                        setError('El email debe ser @saboresexpress.com.ar');
                        return;
                    }
                    
                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailCompleto)) {
                        setError('El formato del email no es válido');
                        return;
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const auth = FirebaseRegionManager.getAuth();
                    
                    // Verificar si el supervisor ya existe
                    const snapshot = await db.collection('supervisores')
                        .where('usuario', '==', nuevoSupervisor.usuario)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El usuario ' + nuevoSupervisor.usuario + ' ya existe');
                        return;
                    }
                    
                    // Verificar si el email ya está en uso en supervisores
                    const snapshotEmail = await db.collection('supervisores')
                        .where('email', '==', emailCompleto)
                        .get();
                    
                    if (!snapshotEmail.empty) {
                        setError('El email ' + emailCompleto + ' ya está en uso por otro supervisor');
                        return;
                    }
                    
                    // Usar contraseña personalizada o generar una automáticamente
                    const contraseñaFinal = nuevoSupervisor.contraseña || generarContraseña();
                    
                    // Crear usuario en Firebase Auth
                    let userCredential;
                    try {
                        userCredential = await auth.createUserWithEmailAndPassword(emailCompleto, contraseñaFinal);
                    } catch (authError) {
                        if (authError.code === 'auth/email-already-in-use') {
                            setError('El email ' + emailCompleto + ' ya está registrado en Firebase Auth');
                            return;
                        }
                        throw authError;
                    }
                    
                    const uid = userCredential.user.uid;
                    console.log('✅ Usuario creado en Firebase Auth con UID:', uid);
                    
                    // Obtener la región actual
                    const regionActual = FirebaseRegionManager.getCurrentRegion();
                    const regionId = regionActual?.id || null;
                    
                    // Crear el supervisor
                    const supervisorData = {
                        nombre: nuevoSupervisor.nombre,
                        usuario: nuevoSupervisor.usuario,
                        email: emailCompleto,
                        contraseña: contraseñaFinal, // Se mantiene temporalmente para migración
                        localesAsignados: nuevoSupervisor.localesAsignados,
                        activo: true,
                        fechaCreacion: new Date().toISOString().split('T')[0],
                        creadoPor: usuarioActual?.usuarioId || '',
                        firebaseAuthUid: uid,
                        regionId: regionId
                    };

                    await db.collection('supervisores').add(supervisorData);
                    
                    // Limpiar formulario
                    setNuevoSupervisor({
                        nombre: '',
                        usuario: '',
                        email: '',
                        contraseña: '',
                        localesAsignados: []
                    });
                    setMostrarFormularioSupervisor(false);
                    
                    // Recargar supervisores
                    cargarSupervisores();
                    
                    // Mostrar credenciales
                    alert(`🎉 Supervisor creado exitosamente!\n\n👤 Usuario: ${nuevoSupervisor.usuario}\n📧 Email: ${emailCompleto}\n🔑 Contraseña: ${contraseñaFinal}\n\n⚠️ Guarda estas credenciales para que el supervisor pueda acceder\nUsa el email y contraseña para iniciar sesión`);
                    
                } catch (error) {
                    console.error('Error creando supervisor:', error);
                    setError('Error creando supervisor: ' + error.message);
                }
            };

            // Función para obtener resumen de vencimientos (similar a VencimientoRepository)
            const obtenerResumenVencimientos = async (localId) => {
                try {
                    // Validar que localId no esté vacío
                    if (!localId || localId.trim() === '') {
                        console.log('⚠️ LocalId vacío, retornando valores por defecto');
                        return { hoy: 0, manana: 0 };
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    console.log('🔍 Obteniendo resumen vencimientos para local:', localId, 'fecha hoy:', fechaHoy);
                    
                    // Obtener todos los lotes del local desde la colección 'vencimientos_activos' (igual que en la pantalla de stock)
                    const lotesSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_activos')
                        .get();
                    
                    console.log('📦 Lotes encontrados (total):', lotesSnapshot.size, 'para local:', localId);
                    
                    let hoy = 0;
                    let manana = 0;
                    
                    lotesSnapshot.forEach(doc => {
                        const lote = doc.data();
                        
                        // Filtrar solo lotes activos (si tienen el campo activo, debe ser true; si no existe, asumimos activo)
                        const esActivo = lote.activo !== false; // Si no existe o es true, está activo
                        
                        if (!esActivo) {
                            console.log('⏭️ Lote inactivo ignorado:', lote.productoCodigo);
                            return;
                        }
                        
                        if (lote.fechaVencimiento) {
                            // Parsear fecha de vencimiento (puede venir como string o timestamp)
                            let fechaVenc;
                            if (lote.fechaVencimiento.toDate) {
                                // Es un Timestamp de Firestore
                                fechaVenc = lote.fechaVencimiento.toDate();
                            } else if (typeof lote.fechaVencimiento === 'string') {
                                // Es un string en formato YYYY-MM-DD
                                fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
                            } else {
                                // Intentar parsear como fecha
                                fechaVenc = new Date(lote.fechaVencimiento);
                            }
                            
                            // Validar que la fecha sea válida
                            if (isNaN(fechaVenc.getTime())) {
                                console.log('⚠️ Fecha inválida para lote:', lote.productoCodigo, 'fechaVencimiento:', lote.fechaVencimiento);
                                return;
                            }
                            
                            const fechaHoyDate = new Date(fechaHoy + 'T00:00:00');
                            fechaVenc.setHours(0, 0, 0, 0);
                            fechaHoyDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = fechaVenc - fechaHoyDate;
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            
                            console.log('📅 Lote:', lote.productoCodigo || doc.id, 'fechaVenc:', fechaVenc.toISOString().split('T')[0], 'diffDays:', diffDays, 'activo:', esActivo);
                            
                            if (diffDays === 0) {
                                hoy++;
                                console.log('🔴 Producto vence HOY:', lote.productoCodigo || doc.id, 'cantidad:', lote.cantidad || 0);
                            } else if (diffDays === 1) {
                                manana++;
                                console.log('🟡 Producto vence MAÑANA:', lote.productoCodigo || doc.id, 'cantidad:', lote.cantidad || 0);
                            }
                        } else {
                            console.log('⚠️ Lote sin fechaVencimiento:', lote.productoCodigo || doc.id);
                        }
                    });
                    
                    console.log('✅ Resumen vencimientos para', localId, ':', { hoy, manana });
                    return { hoy, manana };
                } catch (error) {
                    console.error('❌ Error obteniendo resumen vencimientos para', localId, ':', error);
                    return { hoy: 0, manana: 0 };
                }
            };
            
            // Cargar badges de vencimientos y verificar problemas en paralelo
            const cargarBadgesYProblemas = async () => {
                const localesParaVerificar = esUsuarioMaestro 
                    ? locales 
                    : locales.filter(l => usuarioActual?.localesAsignados?.includes(l.id));
                
                // Filtrar locales que tienen ID válido (no vacío)
                const localesConIdValido = localesParaVerificar.filter(l => l.id && l.id.trim() !== '');
                
                console.log('🔄 Cargando badges y problemas para', localesConIdValido.length, 'locales (de', localesParaVerificar.length, 'totales)');
                
                if (localesConIdValido.length === 0) {
                    console.log('⚠️ No hay locales con ID válido para verificar');
                    return;
                }
                
                // Cargar badges y problemas en paralelo solo para locales con ID válido
                const promesas = localesConIdValido.map(async (local) => {
                    const [badge, problemas] = await Promise.all([
                        obtenerResumenVencimientos(local.id),
                        verificarProblemasLocal(local.id, local.nombre)
                    ]);
                    return { localId: local.id, badge, problemas };
                });
                
                const resultados = await Promise.all(promesas);
                
                const nuevosBadges = {};
                const nuevosProblemas = {};
                
                resultados.forEach(({ localId, badge, problemas }) => {
                    nuevosBadges[localId] = badge;
                    console.log('📊 Badge para', localId, ':', badge);
                    if (problemas.length > 0) {
                        nuevosProblemas[localId] = problemas;
                    }
                });
                
                console.log('✅ Badges cargados:', nuevosBadges);
                console.log('✅ Problemas cargados:', nuevosProblemas);
                
                setBadgesVencimientos(nuevosBadges);
                setProblemasLocales(nuevosProblemas);
            };
            
            // Verificar problemas de datos en cero y días faltantes
            const verificarProblemasLocal = async (localId, nombreLocal) => {
                const problemas = [];
                try {
                    // Validar que localId no esté vacío
                    if (!localId || localId.trim() === '') {
                        console.log('⚠️ LocalId vacío para verificar problemas, retornando array vacío');
                        return [];
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    // Obtener todos los registros históricos
                    const registrosSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('registros')
                        .get();
                    
                    const registrosPorFecha = {};
                    
                    registrosSnapshot.forEach(doc => {
                        const registro = doc.data();
                        if (!registrosPorFecha[registro.fecha]) {
                            registrosPorFecha[registro.fecha] = new Set();
                        }
                        registrosPorFecha[registro.fecha].add(registro.tipo);
                        
                        // Verificar datos en cero
                        const todosEnCero = registro.productos?.every(p => p.cantidad === 0) || false;
                        
                        if (registro.tipo === 'Ingreso de Mercadería' && todosEnCero && !registro.noRecibioMercaderia) {
                            const fecha = new Date(registro.fecha);
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fecha.getDay()];
                            const fechaFormateada = fecha.toLocaleDateString('es-AR');
                            problemas.push(`📦 ${diaSemana} ${fechaFormateada}:\n Ingreso de Mercadería\n   ⚠️ Todos los productos en 0`);
                        } else if (registro.tipo === 'Stock Final' && todosEnCero) {
                            const fecha = new Date(registro.fecha);
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fecha.getDay()];
                            const fechaFormateada = fecha.toLocaleDateString('es-AR');
                            problemas.push(`📊 ${diaSemana} ${fechaFormateada} - Stock Final\n   ⚠️ Todos los productos en 0`);
                        }
                    });
                    
                    // Verificar días faltantes en los últimos 7 días (excluyendo hoy)
                    const fechaHoyDate = new Date(fechaHoy);
                    for (let i = 1; i <= 7; i++) {
                        const fechaCheck = new Date(fechaHoyDate);
                        fechaCheck.setDate(fechaCheck.getDate() - i);
                        const fechaCheckStr = fechaCheck.toISOString().split('T')[0];
                        
                        const tiposExistentes = registrosPorFecha[fechaCheckStr] || new Set();
                        const faltantes = [];
                        
                        if (!tiposExistentes.has('Ingreso de Mercadería')) {
                            faltantes.push('Ingreso de Mercadería');
                        }
                        if (!tiposExistentes.has('Stock Final')) {
                            faltantes.push('Stock Final');
                        }
                        
                        if (faltantes.length > 0) {
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fechaCheck.getDay()];
                            const fechaFormateada = fechaCheck.toLocaleDateString('es-AR');
                            problemas.push(`📅 ${diaSemana} ${fechaFormateada}\n   ⚠️ Faltan: ${faltantes.join(', ')}`);
                        }
                    }
                    
                } catch (error) {
                    console.error('Error verificando problemas:', error);
                }
                
                return problemas;
            };
            
            // Mostrar popup de vencimientos
            const mostrarPopupVencimientos = async (local) => {
                try {
                    // Validar que local.id no esté vacío
                    if (!local.id || local.id.trim() === '') {
                        alert('⚠️ Este local no tiene un ID válido');
                        return;
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    // Usar la colección 'vencimientos_activos' (igual que en la pantalla de stock)
                    const lotesSnapshot = await db.collection('locales')
                        .doc(local.id)
                        .collection('vencimientos_activos')
                        .get();
                    
                    const lotesHoy = [];
                    lotesSnapshot.forEach(doc => {
                        const lote = doc.data();
                        if (lote.fechaVencimiento) {
                            // Parsear fecha de vencimiento (igual que en obtenerResumenVencimientos)
                            let fechaVenc;
                            if (lote.fechaVencimiento.toDate) {
                                fechaVenc = lote.fechaVencimiento.toDate();
                            } else if (typeof lote.fechaVencimiento === 'string') {
                                fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
                            } else {
                                fechaVenc = new Date(lote.fechaVencimiento);
                            }
                            
                            if (isNaN(fechaVenc.getTime())) {
                                return; // Fecha inválida, saltar
                            }
                            
                            const fechaHoyDate = new Date(fechaHoy + 'T00:00:00');
                            fechaVenc.setHours(0, 0, 0, 0);
                            fechaHoyDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = fechaVenc - fechaHoyDate;
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays === 0) {
                                lotesHoy.push(lote);
                            }
                        }
                    });
                    
                    if (lotesHoy.length === 0) {
                        alert('No hay productos que venzan hoy');
                        return;
                    }
                    
                    // Agrupar por producto
                    const lotesPorProducto = {};
                    lotesHoy.forEach(lote => {
                        if (!lotesPorProducto[lote.productoCodigo]) {
                            lotesPorProducto[lote.productoCodigo] = [];
                        }
                        lotesPorProducto[lote.productoCodigo].push(lote);
                    });
                    
                    let mensaje = '🔴 Productos que vencen HOY:\n\n';
                    Object.keys(lotesPorProducto).forEach(codigo => {
                        const total = lotesPorProducto[codigo].reduce((sum, l) => sum + (l.cantidad || 0), 0);
                        mensaje += `${codigo}: ${total} unidades\n`;
                    });
                    
                    alert(mensaje);
                } catch (error) {
                    console.error('Error mostrando popup vencimientos:', error);
                    alert('Error cargando vencimientos: ' + error.message);
                }
            };
            
            // Usar la función global mostrarPopupProblemas
            
            const filtrarLocales = (termino) => {
                if (!termino.trim()) {
                    setLocalesFiltrados(locales);
                    return;
                }
                
                const filtrados = locales.filter(local => 
                    local.nombre.toLowerCase().includes(termino.toLowerCase())
                );
                setLocalesFiltrados(filtrados);
            };

            const filtrarSupervisores = (termino) => {
                if (!termino.trim()) {
                    setSupervisoresFiltrados(supervisores);
                    return;
                }
                
                const filtrados = supervisores.filter(supervisor => 
                    supervisor.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                    supervisor.usuario.toLowerCase().includes(termino.toLowerCase())
                );
                setSupervisoresFiltrados(filtrados);
            };

            const eliminarLocal = async (local) => {
                const contraseña = prompt('Para eliminar el local, ingresa la contraseña del administrador:');
                if (!contraseña) return;
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontró el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contraseña
                    if (usuarioAdmin.contraseña !== contraseña) {
                        alert('❌ Contraseña incorrecta. No se puede eliminar el local.');
                        return;
                    }
                    
                    // Confirmación final
                    if (!confirm(`⚠️ ¿Estás seguro de que quieres eliminar permanentemente el local '${local.nombre}'?\n\nEsta acción NO se puede deshacer.`)) {
                        return;
                    }
                    
                    // Si tiene firebaseAuthUid, intentar eliminar de Firebase Auth primero
                    if (local.firebaseAuthUid) {
                        try {
                            const functions = firebase.functions(FirebaseRegionManager.currentApp);
                            const deleteUser = functions.httpsCallable('deleteUser');
                            await deleteUser({ uid: local.firebaseAuthUid });
                            console.log('✅ Usuario de Firebase Auth del local eliminado:', local.firebaseAuthUid);
                        } catch (authError) {
                            // Si no se puede eliminar de Firebase Auth, NO eliminar de Firestore
                            console.error('❌ No se pudo eliminar usuario de Firebase Auth:', authError);
                            alert('Error: No se pudo eliminar el usuario de Firebase Auth. El local no fue eliminado.');
                            return;
                        }
                    }
                    
                    // Eliminar el local de Firestore
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('locales').doc(local.nombre).delete();
                    
                    // Recargar locales según el tipo de usuario
                    if (esUsuarioMaestro) {
                    cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    alert('✅ Local eliminado exitosamente');
                    
                } catch (error) {
                    console.error('Error eliminando local:', error);
                    alert('Error eliminando local: ' + error.message);
                }
            };

            const cambiarContraseña = async (local) => {
                const contraseñaActual = prompt('Contraseña actual:');
                if (!contraseñaActual) return;
                
                const contraseñaNueva = prompt('Nueva contraseña:');
                if (!contraseñaNueva) return;
                
                const confirmarContraseña = prompt('Confirmar nueva contraseña:');
                if (!confirmarContraseña) return;
                
                if (contraseñaNueva !== confirmarContraseña) {
                    alert('Las contraseñas nuevas no coinciden');
                    return;
                }
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontró el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contraseña actual
                    if (usuarioAdmin.contraseña !== contraseñaActual) {
                        alert('❌ Contraseña actual incorrecta');
                        return;
                    }
                    
                    // Actualizar contraseña
                    const db = FirebaseRegionManager.getFirestore();
                    const usuarioActualizado = { ...usuarioAdmin, contraseña: contraseñaNueva };
                    const usuariosActualizados = { ...local.usuarios };
                    usuariosActualizados[usuarioAdmin.id] = usuarioActualizado;
                    
                    await db.collection('locales').doc(local.nombre).update({
                        usuarios: usuariosActualizados
                    });
                    
                    // Recargar locales
                    cargarLocales();
                    
                    alert('✅ Contraseña actualizada exitosamente');
                    
                } catch (error) {
                    console.error('Error cambiando contraseña:', error);
                    alert('Error cambiando contraseña: ' + error.message);
                }
            };

            const mostrarUsuarios = (local) => {
                const usuarios = Object.values(local.usuarios);
                const mensaje = usuarios.map(usuario => 
                    `👤 Usuario: ${usuario.usuario}\n📧 Email: ${usuario.email || local.email || 'No configurado'}\n🔑 Contraseña: ${usuario.contraseña}\n📋 Rol: ${usuario.rol}`
                ).join('\n\n');
                
                alert(`Usuarios de ${local.nombre}\n\n${mensaje}`);
            };

            // Funciones de gestión de supervisores - EXACTAS como GestionLocalesActivity.kt
            
            const mostrarLocalesAsignados = (supervisor) => {
                // Los locales asignados están guardados por nombre, no por ID
                const nombresLocales = supervisor.localesAsignados || [];
                
                const mensaje = nombresLocales.length === 0 
                    ? "Este supervisor no tiene locales asignados"
                    : "Locales asignados:\n\n" + nombresLocales.map(nombre => `🏪 ${nombre}`).join('\n');
                
                alert(`Locales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarContraseñaSupervisor = (supervisor) => {
                const mensaje = `👤 Usuario: ${supervisor.usuario}\n📧 Email: ${supervisor.email || 'No configurado'}\n\n🔑 Contraseña: ${supervisor.contraseña}\n\n📅 Creado: ${supervisor.fechaCreacion}`;
                alert(`Credenciales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarDialogoAsignarLocales = async (supervisor) => {
                try {
                    console.log('🔍 Supervisor seleccionado:', supervisor);
                    console.log('🔍 Locales asignados del supervisor:', supervisor.localesAsignados);
                    
                    // Recargar locales para asegurar datos actualizados
                    await cargarLocales();
                    
                    console.log('🔍 Locales cargados:', locales.map(l => ({id: l.id, nombre: l.nombre})));
                    
                    if (locales.length === 0) {
                        alert('❌ No hay locales disponibles para asignar\n\nVerifica que existan locales activos en Firebase');
                    return;
                }
                
                    const contenido = `Selecciona los locales que quieres asignar a ${supervisor.usuario}:\n\nℹ️ Los locales pueden estar asignados a múltiples supervisores simultáneamente.`;
                    
                    // Crear modal con checkboxes
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    `;
                    
                    const dialogContent = document.createElement('div');
                    dialogContent.style.cssText = `
                        background: white;
                        padding: 24px;
                        border-radius: 12px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                    `;
                    
                    dialogContent.innerHTML = `
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;">
                            Asignar Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            ${contenido}
                        </p>
                        <div id="checkboxesContainer"></div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                            <button id="cancelBtn" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button id="assignBtn" style="padding: 10px 20px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer;">
                                ASIGNAR
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(dialogContent);
                    document.body.appendChild(modal);
                    
                    const checkboxesContainer = dialogContent.querySelector('#checkboxesContainer');
                    const checkboxes = {};
                    
                    locales.forEach(local => {
                        // Verificar si el local está asignado a otros supervisores
                        // Usar local.nombre para la comparación ya que los locales asignados están guardados por nombre
                        const otrosSupervisores = supervisores.filter(s => 
                            s.id !== supervisor.id && s.localesAsignados?.includes(local.nombre)
                        );
                        
                        const textoLocal = otrosSupervisores.length > 0
                            ? `🏪 ${local.nombre} (📋 Asignado a: ${otrosSupervisores.map(s => s.usuario).join(', ')})`
                            : `🏪 ${local.nombre}`;
                        
                        // Debug: verificar si el local está asignado
                        // Comparar por nombre ya que los locales asignados están guardados por nombre
                        const estaAsignado = supervisor.localesAsignados?.includes(local.nombre) || false;
                        console.log(`🔍 Local: ${local.nombre} (ID: ${local.id}), Asignado: ${estaAsignado}, LocalesAsignados:`, supervisor.localesAsignados);
                        
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.cssText = 'margin-bottom: 8px;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `local-${local.id}`;
                        checkbox.checked = estaAsignado;
                        checkbox.style.cssText = 'margin-right: 8px;';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `local-${local.id}`;
                        label.textContent = textoLocal;
                        label.style.cssText = 'font-size: 14px; cursor: pointer;';
                        
                        if (otrosSupervisores.length > 0) {
                            label.style.color = '#FF9800';
                        }
                        
                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(label);
                        checkboxesContainer.appendChild(checkboxDiv);
                        
                        checkboxes[local.id] = checkbox;
                    });
                    
                    // Event listeners
                    dialogContent.querySelector('#cancelBtn').onclick = () => {
                        document.body.removeChild(modal);
                    };
                    
                    dialogContent.querySelector('#assignBtn').onclick = async () => {
                        const localesSeleccionados = Object.keys(checkboxes).filter(localId => 
                            checkboxes[localId].checked
                        );
                        
                        await asignarLocalesASupervisor(supervisor, localesSeleccionados);
                        document.body.removeChild(modal);
                    };
                    
                } catch (error) {
                    console.error('Error mostrando diálogo de asignación:', error);
                    alert('Error cargando locales: ' + error.message);
                }
            };
            
            const asignarLocalesASupervisor = async (supervisor, localesAsignados) => {
                try {
                    // Convertir IDs de locales a nombres para guardar
                    const nombresLocalesAsignados = localesAsignados.map(localId => {
                        const local = locales.find(l => l.id === localId);
                        return local ? local.nombre : localId;
                    });
                    
                    console.log('🔍 Guardando locales por nombre:', nombresLocalesAsignados);
                    
                    const supervisorActualizado = {
                        ...supervisor,
                        localesAsignados: nombresLocalesAsignados
                    };
                    
                    // Actualizar en Firebase
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('supervisores').doc(supervisor.id).update({
                        localesAsignados: nombresLocalesAsignados
                    });
                    
                    // Actualizar en el estado local
                    setSupervisores(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    setSupervisoresFiltrados(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    
                    alert(`✅ Locales asignados exitosamente a ${supervisor.usuario}`);
                    
                } catch (error) {
                    console.error('Error asignando locales:', error);
                    alert('Error asignando locales: ' + error.message);
                }
            };
            
            const mostrarDialogoEliminarSupervisor = (supervisor) => {
                if (!confirm(`⚠️ ¿Estás seguro de que quieres eliminar permanentemente el supervisor '${supervisor.usuario}'?\n\nEsta acción NO se puede deshacer.`)) {
                    return;
                }
                
                eliminarSupervisor(supervisor);
            };
            
            const eliminarSupervisor = async (supervisor) => {
                try {
                    // Si tiene firebaseAuthUid, intentar eliminar de Firebase Auth primero
                    if (supervisor.firebaseAuthUid) {
                        try {
                            const functions = firebase.functions(FirebaseRegionManager.currentApp);
                            const deleteUser = functions.httpsCallable('deleteUser');
                            await deleteUser({ uid: supervisor.firebaseAuthUid });
                            console.log('✅ Usuario de Firebase Auth del supervisor eliminado:', supervisor.firebaseAuthUid);
                        } catch (authError) {
                            // Si no se puede eliminar de Firebase Auth, NO eliminar de Firestore
                            console.error('❌ No se pudo eliminar usuario de Firebase Auth:', authError);
                            alert('Error: No se pudo eliminar el usuario de Firebase Auth. El supervisor no fue eliminado.');
                            return;
                        }
                    }
                    
                    // Eliminar de Firestore
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('supervisores').doc(supervisor.id).delete();
                    
                    // Actualizar estado local
                    setSupervisores(prev => prev.filter(s => s.id !== supervisor.id));
                    setSupervisoresFiltrados(prev => prev.filter(s => s.id !== supervisor.id));
                    
                    alert(`✅ Supervisor '${supervisor.usuario}' eliminado exitosamente`);
                    
                } catch (error) {
                    console.error('Error eliminando supervisor:', error);
                    alert('Error eliminando supervisor: ' + error.message);
                }
            };

            if (cargando) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando locales...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '8px', maxWidth: '100%', overflowX: 'hidden'}}>
                    {/* Header con botón volver */}
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', width: '100%'}}>
                        <button 
                            onClick={onVolver}
                            style={{
                                padding: '8px 16px',
                                color: '#FFFFFF',
                                fontWeight: 'bold',
                                borderRadius: '8px',
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                fontSize: '16px',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap'
                            }}
                        >
                            ← Volver
                        </button>
                        <div style={{flex: 1}}></div>
                    </div>

                    {/* Título - EXACTO como APK */}
                    <h1 style={{
                        textAlign: 'center',
                        fontSize: 'clamp(18px, 5vw, 24px)',
                        fontWeight: 'bold',
                        color: '#000000',
                        padding: '16px',
                        marginBottom: '8px',
                        width: '100%',
                        boxSizing: 'border-box'
                    }}>
                        GESTIÓN DE LOCALES
                    </h1>

                    {/* Pestañas - EXACTO como APK */}
                    {esUsuarioMaestro && (
                        <div className="tab-container" style={{
                            marginLeft: 'max(8px, calc((100% - 400px) / 2))',
                            marginRight: 'max(8px, calc((100% - 400px) / 2))',
                            maxWidth: 'calc(100% - 16px)',
                            boxSizing: 'border-box'
                        }}>
                            <button
                                onClick={() => setPestanaActiva('locales')}
                                className={pestanaActiva === 'locales' ? 'tab-button tab-button-selected' : 'tab-button tab-button-unselected'}
                                style={{
                                    flex: 1,
                                    height: '48px',
                                    marginRight: '2px'
                                }}
                            >
                                🏪 LOCALES
                            </button>
                            <button
                                onClick={() => setPestanaActiva('supervisores')}
                                className={pestanaActiva === 'supervisores' ? 'tab-button tab-button-selected' : 'tab-button tab-button-unselected'}
                                style={{
                                    flex: 1,
                                    height: '48px',
                                    marginLeft: '2px'
                                }}
                            >
                                👥 SUPERVISORES
                            </button>
                        </div>
                    )}

                    {/* Contenido de Locales - EXACTO como APK */}
                    {pestanaActiva === 'locales' && (
                        <div style={{padding: 'max(8px, 16px)', width: '100%', boxSizing: 'border-box'}}>
                            {/* Botón Agregar Local - EXACTO como APK */}
                            {esUsuarioMaestro && (
                    <button
                        onClick={() => setMostrarFormulario(true)}
                        className="btn-gestion-primary"
                        style={{
                            width: '100%',
                            marginBottom: '16px',
                            fontSize: 'clamp(14px, 4vw, 16px)',
                            padding: '16px'
                        }}
                    >
                        ➕ AGREGAR NUEVO LOCAL
                    </button>
                            )}

                    {/* Buscador - EXACTO como APK */}
                    <input
                        type="text"
                        placeholder="🔍 Buscar locales por nombre, fecha o usuario..."
                        style={{
                            width: '100%',
                            marginBottom: '16px',
                            backgroundColor: 'white',
                            border: '1px solid #E0E0E0',
                            fontSize: 'clamp(12px, 3.5vw, 14px)',
                            padding: '12px',
                            borderRadius: '8px',
                            boxSizing: 'border-box'
                        }}
                        onChange={(e) => filtrarLocales(e.target.value)}
                    />

                    {/* Lista de Locales - EXACTO como APK */}
                    <div style={{minHeight: 'calc(100vh - 200px)'}}>
                        {(localesFiltrados.length > 0 ? localesFiltrados : locales).map((local, index) => {
                            console.log('🔍 Renderizando local', index, ':', {
                                id: local.id,
                                nombre: local.nombre,
                                localCompleto: local
                            });
                            
                            // Validar que el local tenga ID antes de renderizar
                            if (!local.id) {
                                console.error('❌ ERROR: Local sin ID encontrado:', local);
                                return (
                                    <div key={`error-${index}`} style={{
                                        backgroundColor: '#FFEBEE',
                                        border: '2px solid #F44336',
                                        borderRadius: '16px',
                                        padding: '16px',
                                        margin: '16px',
                                        color: '#C62828'
                                    }}>
                                        ⚠️ Error: El local "{local.nombre}" no tiene ID. Por favor, recarga la página.
                                    </div>
                                );
                            }
                            
                            return (
                            <div 
                                key={local.nombre || `local-${index}`} 
                                style={{
                                    backgroundColor: '#E3F2FD',
                                    border: '2px solid #BBDEFB',
                                    borderRadius: '16px',
                                    padding: 'max(12px, 20px)',
                                    marginLeft: 'max(8px, 16px)',
                                    marginRight: 'max(8px, 16px)',
                                    marginTop: '8px',
                                    marginBottom: '16px',
                                    color: '#000000',
                                    width: 'calc(100% - max(16px, 32px))',
                                    boxSizing: 'border-box'
                                }}
                            >
                                {/* Nombre del local con badge de vencimientos - EXACTO como APK */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    marginBottom: '8px',
                                    gap: '8px'
                                }}>
                                    <div 
                                        style={{
                                            fontSize: 'clamp(16px, 5vw, 20px)',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            wordBreak: 'break-word',
                                            textAlign: 'left',
                                            flex: 1,
                                            cursor: problemasLocales[local.id] ? 'pointer' : 'default'
                                        }}
                                        onClick={() => {
                                            if (problemasLocales[local.id]) {
                                                if (window.mostrarPopupProblemas) {
                                                    window.mostrarPopupProblemas(local.nombre, problemasLocales[local.id]);
                                                }
                                            }
                                        }}
                                    >
                                        🏪 {local.nombre} {problemasLocales[local.id] ? '⚠️' : ''}
                                    </div>
                                    
                                    {/* Badge de vencimientos */}
                                    {(() => {
                                        const badge = badgesVencimientos[local.id];
                                        const tieneBadge = badge && (badge.hoy > 0 || badge.manana > 0);
                                        
                                        // Debug en consola
                                        if (badge) {
                                            console.log('🎯 Renderizando badge para', local.nombre, ':', badge, 'tieneBadge:', tieneBadge);
                                        }
                                        
                                        if (!tieneBadge) {
                                            return null;
                                        }
                                        
                                        return (
                                            <div
                                                onClick={() => mostrarPopupVencimientos(local)}
                                                style={{
                                                    fontSize: '12px',
                                                    fontWeight: 'bold',
                                                    color: '#FFFFFF',
                                                    padding: '4px 12px',
                                                    borderRadius: '12px',
                                                    backgroundColor: badge.hoy > 0 ? '#F44336' : '#FF9800',
                                                    cursor: 'pointer',
                                                    whiteSpace: 'nowrap',
                                                    minWidth: '40px',
                                                    textAlign: 'center',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}
                                            >
                                                {badge.hoy > 0 
                                                    ? `🔴 ${badge.hoy}` 
                                                    : `🟡 ${badge.manana}`}
                                            </div>
                                        );
                                    })()}
                                </div>
                                
                                {/* Fecha de creación - EXACTO como APK */}
                                <div style={{
                                    fontSize: 'clamp(11px, 3vw, 12px)',
                                    color: '#000000',
                                    paddingTop: '4px',
                                    paddingBottom: '4px',
                                    textAlign: 'left'
                                }}>
                                    Creado: {local.fechaCreacion}
                                </div>
                                
                                {/* Usuarios - EXACTO como APK */}
                                <div style={{
                                    fontSize: 'clamp(11px, 3vw, 12px)',
                                    color: '#000000',
                                    paddingTop: '4px',
                                    paddingBottom: '8px',
                                    textAlign: 'left'
                                }}>
                                    Usuarios: {Object.keys(local.usuarios || {}).length}
                                </div>
                                
                                {/* Botón de acceso directo - EXACTO como APK */}
                                <button
                                    onClick={async () => {
                                        try {
                                            console.log('🚀 Click en "Ingresar al Local" para:', local.nombre);
                                            console.log('📋 Local completo recibido:', JSON.stringify(local, null, 2));
                                            
                                            // CRÍTICO: Verificar que el local tenga ID
                                            // Si no tiene id, intentar obtenerlo desde Firebase usando el nombre
                                            let localId = local.id;
                                            
                                            if (!localId) {
                                                console.warn('⚠️ Local no tiene id, intentando obtenerlo desde Firebase...');
                                                try {
                                                    const db = FirebaseRegionManager.getFirestore();
                                                    const snapshot = await db.collection('locales')
                                                        .where('nombre', '==', local.nombre)
                                                        .limit(1)
                                                        .get();
                                                    
                                                    if (!snapshot.empty) {
                                                        localId = snapshot.docs[0].id;
                                                        console.log('✅ ID obtenido desde Firebase:', localId);
                                                    } else {
                                                        throw new Error('No se encontró el local en Firebase');
                                                    }
                                                } catch (error) {
                                                    console.error('❌ ERROR: No se pudo obtener el ID del local:', error);
                                                    alert('Error: No se pudo obtener el ID del local "' + local.nombre + '". Por favor, recarga la página e intenta nuevamente.');
                                                    return;
                                                }
                                            }
                                            
                                            console.log('✅ LocalId confirmado:', localId);
                                            
                                            // Crear usuario temporal - EXACTO como Android líneas 1955-2001
                                            const usuarioTemporal = {
                                                id: 'temp_' + localId,
                                                usuario: 'admin_' + local.nombre.toLowerCase(),
                                                localId: localId, // ID del documento de Firebase
                                                localNombre: local.nombre,
                                                rol: 'admin_local',
                                                activo: true
                                            };
                                            
                                            console.log('👤 Usuario temporal creado:', usuarioTemporal);
                                            
                                            // Guardar en localStorage ANTES de llamar onLoginSuccess - EXACTO como Android SharedPreferences
                                            localStorage.setItem('usuario', JSON.stringify(usuarioTemporal));
                                            console.log('💾 Usuario guardado en localStorage');
                                            
                                            // Usar la función onLoginSuccess pasada como prop - EXACTO como Android Intent a MainActivity
                                            if (onLoginSuccess && typeof onLoginSuccess === 'function') {
                                                console.log('✅ Llamando onLoginSuccess con:', usuarioTemporal);
                                                onLoginSuccess(usuarioTemporal);
                                            } else {
                                                console.error('❌ onLoginSuccess no disponible o no es función:', onLoginSuccess);
                                                // Fallback: recargar la página con hash
                                                window.location.href = window.location.origin + window.location.pathname + '#main';
                                            }
                                        } catch (error) {
                                            console.error('❌ ERROR en onClick del botón:', error);
                                            alert('Error ingresando al local: ' + error.message);
                                        }
                                    }}
                                    style={{
                                        width: '100%',
                                        color: '#FFFFFF',
                                        fontWeight: 'bold',
                                        fontSize: 'clamp(12px, 3.5vw, 14px)',
                                        backgroundColor: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: 'max(8px, 10px)',
                                        marginTop: '8px',
                                        marginBottom: '8px',
                                        cursor: 'pointer',
                                        textAlign: 'center',
                                        boxSizing: 'border-box'
                                    }}
                                >
                                    🚀 Ingresar al Local
                                </button>

                                {/* VER STOCK Y VENCIMIENTOS - EXACTO como APK */}
                                <button
                                    onClick={() => {
                                        if (window.openVencimientosHistorial) {
                                            window.openVencimientosHistorial(local.id, local.nombre);
                                        } else if (window.openVencLocal) {
                                            window.openVencLocal();
                                        }
                                    }}
                                    style={{
                                        width: '100%',
                                        color: '#FFFFFF',
                                        fontWeight: 'bold',
                                        fontSize: 'clamp(12px, 3.5vw, 14px)',
                                        backgroundColor: '#1976D2',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: 'max(8px, 10px)',
                                        marginTop: '8px',
                                        marginBottom: '8px',
                                        cursor: 'pointer',
                                        textAlign: 'center',
                                        boxSizing: 'border-box'
                                    }}
                                >
                                    📦 Ver Stock y Vencimientos
                                </button>
                                
                                {/* Botones de administración - EXACTO como APK */}
                                <div style={{
                                    display: 'flex',
                                    gap: 'max(2px, 4px)',
                                    marginTop: '8px',
                                    flexWrap: 'wrap',
                                    width: '100%'
                                }}>
                                    <button
                                        onClick={() => mostrarUsuarios(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#2196F3',
                                            border: '2px solid #1976D2',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        👥 USUARIOS
                                    </button>
                                    
                                    <button
                                        onClick={() => cambiarContraseña(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#4CAF50',
                                            border: '2px solid #45A049',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            marginLeft: 'max(2px, 4px)',
                                            marginRight: 'max(2px, 4px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        🔑 CONTRASEÑA
                                    </button>
                                    
                                    {/* Solo mostrar botón Eliminar para usuarios maestro */}
                                    {esUsuarioMaestro && (
                                    <button
                                        onClick={() => eliminarLocal(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#F44336',
                                            border: '2px solid #D32F2F',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            marginLeft: 'max(2px, 4px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        🗑️ ELIMINAR
                                    </button>
                                    )}
                                </div>
                            </div>
                            );
                        })}
                        
                        {locales.length === 0 && (
                            <div className="text-center p-8">
                                <div className="text-lg text-gray-600 mb-4">📝 No hay locales registrados</div>
                                <button
                                    onClick={() => setMostrarFormulario(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Crear Local
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Texto de estado - EXACTO como líneas 94-97 */}
                    <div 
                        className="text-center mt-4 text-sm"
                        style={{color: '#F44336'}}
                    >
                        {error || `${locales.length} locales encontrados (${localesFiltrados.length} filtrados)`}
                    </div>
                    
                    {/* Debug info */}
                    <div className="text-center mt-2 text-xs text-gray-500">
                        Debug: locales={locales.length}, filtrados={localesFiltrados.length}
                    </div>
                        </div>
                    )}

                    {/* Contenido de Supervisores - EXACTO como APK */}
                    {pestanaActiva === 'supervisores' && esUsuarioMaestro && (
                        <div style={{padding: 'max(8px, 16px)', width: '100%', boxSizing: 'border-box'}}>
                            {/* Botón Agregar Supervisor - EXACTO como APK */}
                            <button
                                onClick={() => setMostrarFormularioSupervisor(true)}
                                className="btn-gestion-primary"
                                style={{
                                    width: '100%',
                                    marginBottom: '16px',
                                    fontSize: 'clamp(14px, 4vw, 16px)',
                                    padding: '16px'
                                }}
                            >
                                ➕ AGREGAR NUEVO SUPERVISOR
                            </button>

                            {/* Buscador de supervisores - EXACTO como APK */}
                            <input
                                type="text"
                                placeholder="🔍 Buscar supervisores por nombre..."
                                style={{
                                    width: '100%',
                                    marginBottom: '16px',
                                    backgroundColor: 'white',
                                    border: '1px solid #E0E0E0',
                                    fontSize: 'clamp(12px, 3.5vw, 14px)',
                                    padding: '12px',
                                    borderRadius: '8px',
                                    boxSizing: 'border-box'
                                }}
                                onChange={(e) => filtrarSupervisores(e.target.value)}
                            />

                            {/* Lista de Supervisores - EXACTO como APK */}
                            <div style={{minHeight: 'calc(100vh - 200px)'}}>
                                {(supervisoresFiltrados.length > 0 ? supervisoresFiltrados : supervisores).map((supervisor, index) => {
                                    // Obtener nombres de locales asignados
                                    const nombresLocales = (supervisor.localesAsignados || []).map(localNombre => {
                                        const local = locales.find(l => l.nombre === localNombre);
                                        return local ? local.nombre : localNombre;
                                    });
                                    
                                    return (
                                    <div 
                                        key={supervisor.id || `supervisor-${index}`} 
                                        style={{
                                            backgroundColor: '#E3F2FD',
                                            border: '2px solid #BBDEFB',
                                            borderRadius: '16px',
                                            padding: 'max(12px, 20px)',
                                            marginLeft: 'max(8px, 16px)',
                                            marginRight: 'max(8px, 16px)',
                                            marginTop: '8px',
                                            marginBottom: '16px',
                                            color: '#000000',
                                            width: 'calc(100% - max(16px, 32px))',
                                            boxSizing: 'border-box'
                                        }}
                                    >
                                        {/* Nombre del supervisor - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(16px, 5vw, 20px)',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '8px',
                                            wordBreak: 'break-word',
                                            textAlign: 'left'
                                        }}>
                                            👨‍💼 {supervisor.usuario}
                                        </div>
                                        
                                        {/* Fecha de creación - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(11px, 3vw, 12px)',
                                            color: '#000000',
                                            paddingTop: '4px',
                                            paddingBottom: '4px',
                                            textAlign: 'left'
                                        }}>
                                            Creado: {supervisor.fechaCreacion || 'N/A'}
                                        </div>
                                        
                                        {/* Locales asignados - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(11px, 3vw, 12px)',
                                            color: '#000000',
                                            paddingTop: '4px',
                                            paddingBottom: '8px',
                                            textAlign: 'left',
                                            wordBreak: 'break-word'
                                        }}>
                                            Locales asignados: {nombresLocales.length} {nombresLocales.length > 0 ? `(${nombresLocales.join(', ')})` : ''}
                                        </div>
                                        
                                        {/* Botones de administración - EXACTO como APK */}
                                        <div style={{
                                            display: 'flex',
                                            gap: 'max(2px, 4px)',
                                            marginTop: '8px',
                                            flexWrap: 'wrap',
                                            width: '100%'
                                        }}>
                                            <button
                                                onClick={() => mostrarLocalesAsignados(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#2196F3',
                                                    border: '2px solid #1976D2',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                🏪 LOCALES
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoAsignarLocales(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#4CAF50',
                                                    border: '2px solid #45A049',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    marginRight: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                ➕ ASIGNAR
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarContraseñaSupervisor(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#2196F3',
                                                    border: '2px solid #1976D2',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    marginRight: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                🔑 CONTRASEÑA
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoEliminarSupervisor(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#F44336',
                                                    border: '2px solid #D32F2F',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                🗑️ ELIMINAR
                                            </button>
                                        </div>
                                    </div>
                                    );
                                })}
                                
                                {supervisores.length === 0 && (
                                    <div className="text-center p-8">
                                        <div className="text-lg text-gray-600 mb-4">👥 No hay supervisores registrados</div>
                                        <button
                                            onClick={() => setMostrarFormularioSupervisor(true)}
                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear Supervisor
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div 
                                className="text-center mt-4 text-sm"
                                style={{color: '#F44336'}}
                            >
                                {error || `${supervisores.length} supervisores encontrados (${supervisoresFiltrados.length} filtrados)`}
                            </div>
                        </div>
                    )}
                                
                    {/* Modal de nuevo local - EXACTO como líneas 251-295 */}
                    {mostrarFormulario && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Local</h3>
                                    <button
                                        onClick={() => setMostrarFormulario(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <form onSubmit={crearLocal} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Nombre del local (ej: WILDE)
                                        </label>
                                        <input
                                            type="text"
                                            value={nuevoLocal.nombre}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Nombre del local (ej: WILDE)"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Email del local (obligatorio)
                                        </label>
                                        <div style={{position: 'relative', display: 'flex', alignItems: 'center'}}>
                                            <input
                                                type="text"
                                                value={nuevoLocal.email}
                                                onChange={(e) => {
                                                    let valor = e.target.value;
                                                    // Prevenir que el usuario escriba @ o el dominio
                                                    if (valor.includes('@') || valor.includes('saboresexpress.com.ar')) {
                                                        return;
                                                    }
                                                    setNuevoLocal({...nuevoLocal, email: valor});
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="Ingresa el email"
                                                style={{paddingRight: '180px'}}
                                                required
                                            />
                                            <span style={{
                                                position: 'absolute',
                                                right: '12px',
                                                color: '#9E9E9E',
                                                fontSize: '14px',
                                                pointerEvents: 'none'
                                            }}>
                                                @saboresexpress.com.ar
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Contraseña inicial del admin
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoLocal.contraseña}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, contraseña: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Contraseña inicial (opcional)"
                                        />
                                    </div>
                                    
                                    <div className="text-sm text-gray-600">
                                        Si no ingresas contraseña, se generará una automáticamente
                                    </div>
                                    
                                    <div className="flex justify-end space-x-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormulario(false)}
                                            className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal de nuevo supervisor */}
                    {mostrarFormularioSupervisor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Supervisor</h3>
                                    <button
                                        onClick={() => setMostrarFormularioSupervisor(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        ✕
                                    </button>
                                </div>
                                
                                <form onSubmit={crearSupervisor}>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre completo
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.nombre}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Nombre del supervisor"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Usuario de acceso
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.usuario}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, usuario: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Usuario para login"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Email del supervisor (obligatorio)
                                        </label>
                                        <div style={{position: 'relative', display: 'flex', alignItems: 'center'}}>
                                            <input
                                                type="text"
                                                value={nuevoSupervisor.email}
                                                onChange={(e) => {
                                                    let valor = e.target.value;
                                                    // Prevenir que el usuario escriba @ o el dominio
                                                    if (valor.includes('@') || valor.includes('saboresexpress.com.ar')) {
                                                        return;
                                                    }
                                                    setNuevoSupervisor({...nuevoSupervisor, email: valor});
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Ingresa el email"
                                                style={{paddingRight: '180px'}}
                                                required
                                            />
                                            <span style={{
                                                position: 'absolute',
                                                right: '12px',
                                                color: '#9E9E9E',
                                                fontSize: '14px',
                                                pointerEvents: 'none'
                                            }}>
                                                @saboresexpress.com.ar
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Contraseña (opcional)
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoSupervisor.contraseña}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, contraseña: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Contraseña (se generará automáticamente si se deja vacío)"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Locales asignados
                                        </label>
                                        <div className="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-2">
                                            {locales.map((local) => (
                                                <div key={local.id} className="flex items-center mb-2">
                                                    <input
                                                        type="checkbox"
                                                        id={`local-${local.id}`}
                                                        checked={nuevoSupervisor.localesAsignados.includes(local.id)}
                                                        onChange={(e) => {
                                                            const localesActualizados = e.target.checked
                                                                ? [...nuevoSupervisor.localesAsignados, local.id]
                                                                : nuevoSupervisor.localesAsignados.filter(id => id !== local.id);
                                                            setNuevoSupervisor({...nuevoSupervisor, localesAsignados: localesActualizados});
                                                        }}
                                                        className="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                    />
                                                    <label htmlFor={`local-${local.id}`} className="text-sm">
                                                        {local.nombre}
                                                    </label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {error && (
                                        <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    
                                    <div className="flex justify-end gap-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormularioSupervisor(false)}
                                            className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // CalendarioPersonalizado Component - EXACTO como MainActivity.kt líneas 279-490
        function CalendarioPersonalizado({ fechaSeleccionada, setFechaSeleccionada, onCerrar, fechasCompletas, fechasParciales, cargando }) {
            const [mesActual, setMesActual] = useState(window.getFechaArgentina ? window.getFechaArgentina() : new Date());

            // Función para formatear fecha como yyyy-MM-dd
            const formatearFechaCorta = (fecha) => {
                // Convertir a zona horaria de Argentina si es necesario
                if (!fecha) fecha = window.getFechaArgentina ? window.getFechaArgentina() : new Date();
                const fechaArg = window.formatearFechaArgentina ? window.formatearFechaArgentina(fecha) : fecha;
                const año = fechaArg.getFullYear();
                const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaArg.getDate()).padStart(2, '0');
                const fechaFormateada = `${año}-${mes}-${dia}`;
                console.log(`📅 formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Función para obtener el primer día del mes
            const obtenerPrimerDia = (fecha) => {
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                return primerDia;
            };

            // Función para obtener el último día del mes
            const obtenerUltimoDia = (fecha) => {
                return new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
            };

            // Función para obtener días de la semana
            const obtenerDiasSemana = () => {
                return ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            };

            // Función para crear el grid del mes - EXACTO como MainActivity.kt líneas 495-730
            const crearGridMes = () => {
                const año = mesActual.getFullYear();
                const mes = mesActual.getMonth();
                const primerDia = obtenerPrimerDia(mesActual);
                const ultimoDia = obtenerUltimoDia(mesActual);
                const diasEnMes = ultimoDia.getDate();
                const primerDiaSemana = primerDia.getDay(); // 0=Domingo, 1=Lunes, etc.

                const dias = [];
                const diasSemana = obtenerDiasSemana();

                // Crear encabezados de días
                const encabezados = diasSemana.map((dia, index) => (
                    <div key={index} className="text-center text-xs font-bold text-gray-600 p-1">
                        {dia}
                    </div>
                ));

                // Agregar espacios vacíos para los días anteriores al primer día del mes
                for (let i = 0; i < primerDiaSemana; i++) {
                    dias.push(
                        <div key={`empty-${i}`} className="h-12 flex items-center justify-center">
                        </div>
                    );
                }

                // Agregar los días del mes
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const fechaString = `${año}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                    const esHoy = fechaString === formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                    const esFechaSeleccionada = fechaString === formatearFechaCorta(fechaSeleccionada);
                    
                    // Determinar color según datos - EXACTO como MainActivity.kt (Android App)
                    let colorFondo, colorTexto, borde;
                    if (fechasCompletas.has(fechaString)) {
                        colorFondo = '#4CAF50'; // Verde oscuro (holo_green_dark) - Completo
                        colorTexto = '#FFFFFF';
                    } else if (fechasParciales.has(fechaString)) {
                        colorFondo = '#FF9800'; // Naranja oscuro (holo_orange_dark) - Parcial
                        colorTexto = '#FFFFFF';
                    } else {
                        colorFondo = '#424242'; // Gris oscuro (darker_gray) - Sin datos (igual que Android)
                        colorTexto = '#FFFFFF';
                    }

                    // Agregar borde rojo para fecha seleccionada o día actual - EXACTO como líneas 591-620
                    if (esFechaSeleccionada || (esHoy && !fechasCompletas.has(fechaString) && !fechasParciales.has(fechaString))) {
                        borde = '3px solid #F44336';
                    }

                    dias.push(
                        <button
                            key={dia}
                            onClick={() => {
                                const nuevaFecha = new Date(año, mes, dia);
                                setFechaSeleccionada(nuevaFecha);
                                onCerrar();
                            }}
                            className="h-12 w-full flex items-center justify-center text-lg font-bold rounded-lg transition-all hover:opacity-80"
                            style={{
                                backgroundColor: colorFondo,
                                color: colorTexto,
                                border: borde,
                                minHeight: '48px'
                            }}
                        >
                            {dia}
                        </button>
                    );
                }

                return { encabezados, dias };
            };

            // Función para cambiar mes - EXACTO como MainActivity.kt líneas 449-463
            const cambiarMes = (offset) => {
                const nuevoMes = new Date(mesActual);
                nuevoMes.setMonth(nuevoMes.getMonth() + offset);
                setMesActual(nuevoMes);
            };

            const { encabezados, dias } = crearGridMes();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                        {/* Header - EXACTO como líneas 310-318 */}
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-black">📅 Seleccionar Fecha</h3>
                            <button
                                onClick={onCerrar}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        {/* Leyenda de colores - EXACTO como líneas 320-344 */}
                        <div className="flex justify-center space-x-4 mb-4 text-xs">
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#4CAF50'}}></div>
                                <span>Completo</span>
                            </div>
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#FF9800'}}></div>
                                <span>Parcial</span>
                            </div>
                        </div>

                        {/* Navegación de mes - EXACTO como MainActivity.kt (Android App) */}
                        <div className="flex items-center justify-between mb-4">
                            <button
                                onClick={() => cambiarMes(-1)}
                                className="w-14 h-12 font-bold rounded-lg transition-colors fade-in"
                                style={{
                                    backgroundColor: '#1976D2', // Azul oscuro (holo_blue_dark) - igual que Android
                                    color: '#FFFFFF',
                                    border: 'none'
                                }}
                            >
                                ◀
                            </button>
                            
                            <div className="text-center">
                                <div className="text-lg font-bold text-black">
                                    {mesActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                                </div>
                            </div>
                            
                            <button
                                onClick={() => cambiarMes(1)}
                                className="w-14 h-12 font-bold rounded-lg transition-colors fade-in"
                                style={{
                                    backgroundColor: '#1976D2', // Azul oscuro (holo_blue_dark) - igual que Android
                                    color: '#FFFFFF',
                                    border: 'none'
                                }}
                            >
                                ▶
                            </button>
                        </div>

                        {/* Grid del calendario - EXACTO como líneas 424-441 */}
                        <div className="grid grid-cols-7 gap-1 mb-4">
                            {encabezados}
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1">
                            {dias}
                        </div>

                        {/* Indicador de carga */}
                        {cargando && (
                            <div className="text-center mt-4">
                                <div className="text-sm text-gray-600">Cargando calendario...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main Component
        function Main({ usuario, onLogout, onVolverGestion }) {
            const [fechaSeleccionada, setFechaSeleccionada] = useState(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
            
            // Exponer setFechaSeleccionada globalmente para que el diálogo de alertas pueda usarla
            window.setFechaSeleccionada = setFechaSeleccionada;
            const [mostrarCalendario, setMostrarCalendario] = useState(false);
            const [cargandoCalendario, setCargandoCalendario] = useState(false);
            const [fechasCompletas, setFechasCompletas] = useState(new Set());
            const [fechasParciales, setFechasParciales] = useState(new Set());
            
            // Estados para controlar colores de botones - EXACTO como MainActivity.kt líneas 66-70
            const [tieneIngreso, setTieneIngreso] = useState(false);
            const [tieneStock, setTieneStock] = useState(false);
            const [tieneVencimientosCoincidentes, setTieneVencimientosCoincidentes] = useState(false);
            const [ultimoEstadoIngreso, setUltimoEstadoIngreso] = useState(null);
            const [ultimoEstadoStock, setUltimoEstadoStock] = useState(null);
            const [downloadUrl, setDownloadUrl] = useState('https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk'); // URL por defecto

            // Función para cargar la URL de descarga desde GitHub
            const cargarDownloadUrl = async () => {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/solanosaboresexpress-hash/inventario-app-updates/refs/heads/main/version_info.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.downloadUrl) {
                            setDownloadUrl(data.downloadUrl);
                            console.log('✅ URL de descarga cargada:', data.downloadUrl);
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ No se pudo cargar la URL de descarga desde GitHub, usando URL por defecto:', error);
                    // Mantener la URL por defecto si falla
                }
            };

            // Cargar URL de descarga al montar el componente
            useEffect(() => {
                cargarDownloadUrl();
            }, []);

            const formatearFecha = (fecha) => {
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            const formatearFechaCorta = (fecha) => {
                // Convertir a zona horaria de Argentina si es necesario
                if (!fecha) fecha = window.getFechaArgentina ? window.getFechaArgentina() : new Date();
                const fechaArg = window.formatearFechaArgentina ? window.formatearFechaArgentina(fecha) : fecha;
                const año = fechaArg.getFullYear();
                const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaArg.getDate()).padStart(2, '0');
                const fechaFormateada = `${año}-${mes}-${dia}`;
                console.log(`📅 formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Función para cargar datos del calendario - EXACTO como MainActivity.kt líneas 232-273
            const cargarDatosCalendario = async () => {
                if (cargandoCalendario) return;
                
                setCargandoCalendario(true);
                
                try {
                    // Obtener todos los registros del local usando la región actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        setCargandoCalendario(false);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Agrupar registros por fecha
                    const registrosPorFecha = {};
                    registros.forEach(registro => {
                        if (!registrosPorFecha[registro.fecha]) {
                            registrosPorFecha[registro.fecha] = [];
                        }
                        registrosPorFecha[registro.fecha].push(registro);
                    });
                    
                    // Analizar fechas - EXACTO como líneas 244-253
                    const fechasCompletasSet = new Set();
                    const fechasParcialesSet = new Set();
                    
                    Object.entries(registrosPorFecha).forEach(([fecha, registrosFecha]) => {
                        const tieneIngreso = registrosFecha.some(registro => registro.tipo === 'Ingreso de Mercadería');
                        const tieneStock = registrosFecha.some(registro => registro.tipo === 'Stock Final');
                        
                        if (tieneIngreso && tieneStock) {
                            fechasCompletasSet.add(fecha);
                        } else if (tieneIngreso || tieneStock) {
                            fechasParcialesSet.add(fecha);
                        }
                    });
                    
                    setFechasCompletas(fechasCompletasSet);
                    setFechasParciales(fechasParcialesSet);
                    
                } catch (error) {
                    console.error('Error cargando datos del calendario:', error);
                } finally {
                    setCargandoCalendario(false);
                }
            };

            // Función para mostrar calendario personalizado - EXACTO como MainActivity.kt líneas 223-274
            const mostrarCalendarioPersonalizado = () => {
                if (cargandoCalendario) return;
                
                setMostrarCalendario(true);
                cargarDatosCalendario();
            };

            // Función para verificar registros existentes - EXACTO como MainActivity.kt líneas 992-1003
            const verificarRegistrosExistentes = async () => {
                try {
                    console.log('🔍 verificarRegistrosExistentes iniciado');
                    console.log('👤 Usuario actual:', usuario);
                    console.log('👤 usuario.localId:', usuario?.localId);
                    console.log('👤 usuario.localNombre:', usuario?.localNombre);
                    console.log('📅 Fecha seleccionada:', fechaSeleccionada);
                    
                    if (!usuario) {
                        console.error('❌ ERROR: No hay usuario');
                        return;
                    }
                    
                    if (!usuario.localId) {
                        console.error('❌ ERROR: usuario.localId está vacío o undefined');
                        console.error('   Usuario completo:', JSON.stringify(usuario, null, 2));
                        return;
                    }
                    
                    console.log('✅ Usuario válido con localId:', usuario.localId);
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    console.log('📅 Fecha string:', fechaString);
                    
                    // Usar la región actual de Firebase
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .get();
                    
                    console.log('📊 Snapshot size:', snapshot.size);
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log('📋 Registros encontrados:', registros);
                    
                    // Verificar si hay registros de Ingreso de Mercadería - EXACTO como líneas 1254-1256
                    const tieneIngresoData = registros.some(registro => registro.tipo === 'Ingreso de Mercadería');
                    setTieneIngreso(tieneIngresoData);
                    
                    // Verificar si hay registros de Stock Final - EXACTO como líneas 1258-1260
                    const tieneStockData = registros.some(registro => registro.tipo === 'Stock Final');
                    setTieneStock(tieneStockData);
                    
                    console.log(`📊 Fecha ${fechaString}: Ingreso=${tieneIngresoData}, Stock=${tieneStockData}`);
                    
                    // Verificar vencimientos coincidentes
                    verificarVencimientosCoinciden();
                    
                } catch (error) {
                    console.error('❌ Error verificando registros existentes:', error);
                }
            };
            
            // Función para calcular stock actual desde Firebase - EXACTO como Android MainActivity.kt líneas 1970-2058
            const calcularStockActualDesdeFirebase = async () => {
                try {
                    if (!usuario || !usuario.localId) return {};
                    
                    const fechaHoy = formatearFechaCorta(fechaSeleccionada);
                    const fechaAyer = new Date(fechaSeleccionada);
                    fechaAyer.setDate(fechaAyer.getDate() - 1);
                    const fechaAyerString = formatearFechaCorta(fechaAyer);
                    
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        return {};
                    }
                    
                    // Obtener registros de ayer y hoy
                    const [snapshotAyer, snapshotHoy] = await Promise.all([
                        db.collection('locales')
                            .doc(usuario.localId)
                            .collection('registros')
                            .where('fecha', '==', fechaAyerString)
                            .get(),
                        db.collection('locales')
                            .doc(usuario.localId)
                            .collection('registros')
                            .where('fecha', '==', fechaHoy)
                            .get()
                    ]);
                    
                    const registrosAyer = [];
                    snapshotAyer.forEach(doc => {
                        registrosAyer.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const registrosHoy = [];
                    snapshotHoy.forEach(doc => {
                        registrosHoy.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // PRIORIDAD 1: Stock Final de HOY (si existe)
                    const stockFinalHoy = registrosHoy
                        .filter(registro => registro.tipo === 'Stock Final')
                        .flatMap(registro => registro.productos || []);
                    
                    if (stockFinalHoy.length > 0) {
                        const stockMap = {};
                        stockFinalHoy.forEach(producto => {
                            const codigo = obtenerCodigoProducto(producto.nombre);
                            stockMap[codigo] = producto.cantidad || 0;
                        });
                        console.log('✅ Usando Stock Final de HOY:', stockMap);
                        return stockMap;
                    }
                    
                    // PRIORIDAD 2: Stock Final Ayer + Ingreso Hoy
                    const stockAyer = registrosAyer
                        .filter(registro => registro.tipo === 'Stock Final')
                        .flatMap(registro => registro.productos || []);
                    
                    const stockMap = {};
                    stockAyer.forEach(producto => {
                        const codigo = obtenerCodigoProducto(producto.nombre);
                        stockMap[codigo] = producto.cantidad || 0;
                    });
                    
                    const ingresoHoy = registrosHoy
                        .filter(registro => registro.tipo === 'Ingreso de Mercadería')
                        .flatMap(registro => registro.productos || []);
                    
                    ingresoHoy.forEach(producto => {
                        const codigo = obtenerCodigoProducto(producto.nombre);
                        const cantidadAnterior = stockMap[codigo] || 0;
                        stockMap[codigo] = cantidadAnterior + (producto.cantidad || 0);
                    });
                    
                    console.log('✅ Stock calculado (Ayer + Ingreso Hoy):', stockMap);
                    return stockMap;
                    
                } catch (error) {
                    console.error('❌ Error calculando stock desde Firebase:', error);
                    return {};
                }
            };
            
            // Función auxiliar para obtener código del producto
            const obtenerCodigoProducto = (nombre) => {
                if (nombre.includes(' - ')) {
                    return nombre.split(' - ')[0].trim();
                }
                // Casos especiales
                if (nombre.startsWith('Pizza ')) {
                    if (nombre.includes('Muzzarella')) return 'MUZZA';
                    if (nombre.includes('Jamón')) return 'JAMON';
                    if (nombre.includes('Pepperoni')) return 'PEPPER';
                    return nombre;
                }
                if (nombre.startsWith('Pastelito ')) {
                    if (nombre.includes('Batata')) return 'BATATA';
                    if (nombre.includes('Membrillo')) return 'MEMBRIL';
                    return nombre;
                }
                return nombre;
            };
            
            // Función auxiliar para normalizar código del producto
            const normalizarCodigoProducto = (codigo) => {
                const codigoUpper = codigo.toUpperCase();
                if (codigoUpper === 'PEPPERO') return 'PEPPER';
                if (codigoUpper === 'MUZZARE') return 'MUZZA';
                return codigoUpper;
            };
            
            // Función para verificar si stock total coincide con lotes activos
            const verificarVencimientosCoinciden = async () => {
                try {
                    if (!usuario || !usuario.localId) return;
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        return;
                    }
                    
                    // Obtener stock final de hoy o ayer
                    const snapshotStock = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .where('tipo', '==', 'Stock Final')
                        .limit(1)
                        .get();
                    
                    let stockActual = {};
                    if (!snapshotStock.empty) {
                        const stockDoc = snapshotStock.docs[0].data();
                        stockActual = stockDoc.datos || {};
                    } else {
                        // Si no hay stock de hoy, usar stock de ayer + ingreso de hoy
                        const fechaAyer = new Date(fechaSeleccionada);
                        fechaAyer.setDate(fechaAyer.getDate() - 1);
                        const fechaAyerString = formatearFechaCorta(fechaAyer);
                        
                        const snapshotStockAyer = await db.collection('locales')
                            .doc(usuario.localId)
                            .collection('registros')
                            .where('fecha', '==', fechaAyerString)
                            .where('tipo', '==', 'Stock Final')
                            .limit(1)
                            .get();
                        
                        const snapshotIngresoHoy = await db.collection('locales')
                            .doc(usuario.localId)
                            .collection('registros')
                            .where('fecha', '==', fechaString)
                            .where('tipo', '==', 'Ingreso de Mercadería')
                            .limit(1)
                            .get();
                        
                        if (!snapshotStockAyer.empty) {
                            const stockAyer = snapshotStockAyer.docs[0].data().datos || {};
                            const ingresoHoy = snapshotIngresoHoy.empty ? {} : snapshotIngresoHoy.docs[0].data().datos || {};
                            
                            Object.keys(stockAyer).forEach(nombre => {
                                stockActual[nombre] = (stockAyer[nombre] || 0) + (ingresoHoy[nombre] || 0);
                            });
                            Object.keys(ingresoHoy).forEach(nombre => {
                                if (!stockActual[nombre]) stockActual[nombre] = ingresoHoy[nombre] || 0;
                            });
                        }
                    }
                    
                    // Obtener lotes activos
                    const snapshotLotes = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('vencimientos')
                        .where('activo', '==', true)
                        .get();
                    
                    const lotesActivos = {};
                    snapshotLotes.forEach(doc => {
                        const lote = doc.data();
                        const codigo = (lote.codigo || '').toLowerCase();
                        if (!lotesActivos[codigo]) lotesActivos[codigo] = 0;
                        lotesActivos[codigo] += (lote.cantidad || 0);
                    });
                    
                    // Verificar coincidencia para productos bajo control de vencimientos
                    const codigosVencimientos = ['jq', 'pb', 'cs', 'po', 'cp', 'hu', 'es', 'cq', 'rj', 'qc', 'cb', 'ch'];
                    let coinciden = true;
                    
                    codigosVencimientos.forEach(codigo => {
                        const stockProducto = stockActual[Object.keys(stockActual).find(n => {
                            const codigoProducto = n.split(' - ')[0].toLowerCase();
                            return codigoProducto === codigo;
                        })] || 0;
                        const lotesProducto = lotesActivos[codigo] || 0;
                        
                        if (stockProducto !== lotesProducto) {
                            coinciden = false;
                        }
                    });
                    
                    setTieneVencimientosCoincidentes(coinciden);
                    
                } catch (error) {
                    console.error('❌ Error verificando vencimientos coincidentes:', error);
                    setTieneVencimientosCoincidentes(false);
                }
            };

            const [pantallaActual, setPantallaActual] = useState('main');
            const [enPantallaCarga, setEnPantallaCarga] = useState(false); // Variable para saber si estamos en Stock Final o Ingreso
            const enPantallaCargaRef = React.useRef(false); // Referencia para leer el valor actual en timeouts
            
            // Sincronizar referencia cuando cambia el estado
            React.useEffect(() => {
                enPantallaCargaRef.current = enPantallaCarga;
            }, [enPantallaCarga]);

            // Verificar registros cuando cambie la fecha - EXACTO como MainActivity.kt líneas 153-159
            useEffect(() => {
                console.log('🔄 useEffect ejecutado - usuario:', usuario);
                console.log('🔄 usuario.localId:', usuario?.localId);
                console.log('🔄 usuario.localNombre:', usuario?.localNombre);
                console.log('🔄 fechaSeleccionada:', fechaSeleccionada);
                console.log('🔄 pantallaActual:', pantallaActual);
                
                if (usuario && usuario.localId) {
                    console.log('✅ Usuario válido, ejecutando verificarRegistrosExistentes para localId:', usuario.localId);
                    verificarRegistrosExistentes();
                } else {
                    console.error('❌ ERROR: No se puede verificar registros - usuario o localId faltante');
                    console.error('   usuario:', usuario);
                    console.error('   usuario.localId:', usuario?.localId);
                }
            }, [fechaSeleccionada, usuario]);
            
            // Verificar alertas SOLO cuando estamos en el menú principal Y NO estamos en pantalla de carga
            useEffect(() => {
                // NO verificar alertas si estamos en una pantalla de carga
                if (enPantallaCarga) {
                    console.log('⏭️ No verificando alertas - estamos en pantalla de carga');
                    return;
                }
                
                // Solo verificar alertas si estamos en el menú principal
                if (pantallaActual === 'main' && usuario && usuario.localId && usuario.localNombre) {
                    console.log('✅ Estamos en menú principal y no en pantalla de carga, verificando alertas...');
                    verificarAlertasLocalAutomatico();
                }
            }, [fechaSeleccionada, usuario, pantallaActual, enPantallaCarga]);
            
            // Verificar alertas automáticamente al entrar al local (como Android MainActivity.kt verificarAlertasLocal)
            const verificarAlertasLocalAutomatico = async () => {
                // Verificar primero que NO estemos en una pantalla de carga (usar referencia para valor actual)
                if (enPantallaCargaRef.current || enPantallaCarga) {
                    console.log('⏭️ verificarAlertasLocalAutomatico: Estamos en pantalla de carga, NO mostrando alertas');
                    return;
                }
                
                // Verificar que estemos en el menú principal
                if (pantallaActual !== 'main') {
                    console.log('⏭️ verificarAlertasLocalAutomatico: No estamos en menú principal (pantallaActual:', pantallaActual, '), saliendo');
                    return;
                }
                
                if (!usuario || !usuario.localId || !usuario.localNombre) {
                    console.log('⚠️ verificarAlertasLocalAutomatico: usuario o datos faltantes, saliendo');
                    return;
                }
                
                console.log('🚀 verificarAlertasLocalAutomatico: Iniciando verificación para local', usuario.localId);
                
                try {
                    const problemas = [];
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    console.log('🔍 Verificando registros para fecha:', fechaHoy);
                    
                    const db = FirebaseRegionManager.getFirestore();
                    
                    // Verificar si es un local nuevo (sin registros históricos)
                    const snapshotTotal = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    console.log('📊 Total de registros encontrados:', snapshotTotal.size);
                    
                    if (snapshotTotal.empty) {
                        console.log('🏪 Local nuevo sin registros, mostrando bienvenida');
                        // Local nuevo - mostrar mensaje de bienvenida
                        setTimeout(() => {
                            alert(`🏪 ¡Bienvenido a ${usuario.localNombre}!\n\nEste es un local nuevo. Podés empezar a cargar datos de inventario.`);
                        }, 500);
                        return;
                    }
                    
                    // Local existente - verificar alertas normales
                    // 1. Verificar datos en 0 de hoy
                    await verificarDatosEnCeroHoyWeb(usuario.localId, fechaHoy, problemas);
                    
                    // 2. Verificar días faltantes en los últimos 7 días
                    await verificarDiasFaltantesWeb(usuario.localId, fechaHoy, problemas);
                    
                    console.log('🔍 Total de problemas encontrados:', problemas.length);
                    problemas.forEach((problema, index) => {
                        console.log(`  ${index + 1}. ${problema}`);
                    });
                    
                    // Mostrar automáticamente el diálogo de alertas SOLO si NO estamos en pantalla de carga
                    if (problemas.length > 0) {
                        setTimeout(() => {
                            // Verificar usando la REFERENCIA para obtener el valor ACTUAL (no el capturado)
                            if (enPantallaCargaRef.current) {
                                console.log('⏭️ No se muestra alerta - enPantallaCargaRef.current es true (estamos en pantalla de carga)');
                                return;
                            }
                            
                            if (pantallaActual !== 'main') {
                                console.log('⏭️ No se muestra alerta - pantallaActual:', pantallaActual, '(no estamos en main)');
                                return;
                            }
                            
                            console.log('📋 Mostrando diálogo automático de alertas (no estamos en pantalla de carga)...');
                            if (window.mostrarPopupProblemas) {
                                window.mostrarPopupProblemas(usuario.localNombre, problemas);
                            } else {
                                console.error('❌ mostrarPopupProblemas no está disponible');
                            }
                        }, 800);
                    } else {
                        console.log('ℹ️ No hay problemas - no se muestra diálogo');
                    }
                } catch (e) {
                    console.error('❌ Error verificando alertas para local', usuario.localId, ':', e);
                }
            };
            
            // Verificar datos en 0 en TODOS los registros históricos (versión web de verificarDatosEnCeroHoy)
            // EXACTO como Android MainActivity.kt líneas 2242-2296
            const verificarDatosEnCeroHoyWeb = async (localId, fechaHoy, problemas) => {
                console.log('🔍 Verificando datos en 0 en TODOS los registros históricos para local:', localId);
                
                try {
                    const db = FirebaseRegionManager.getFirestore();
                    
                    // Obtener TODOS los registros históricos del local (como Android)
                    const snapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('registros')
                        .get();
                    
                    console.log('📊 Total de registros para verificar datos en 0:', snapshot.size);
                    
                    snapshot.forEach(doc => {
                        const registro = doc.data();
                        
                        // Verificar que haya productos antes de verificar si están en 0
                        const todosEnCero = registro.productos && registro.productos.length > 0 && 
                                           registro.productos.every(producto => (producto.cantidad || 0) === 0);
                        
                        console.log('📅 Verificando', registro.tipo, '-', registro.fecha, ': todosEnCero=', todosEnCero, 'productos.size=', registro.productos?.length, 'noRecibioMercaderia=', registro.noRecibioMercaderia);
                        
                        if (registro.tipo === 'Ingreso de Mercadería') {
                            // Si todos están en 0 y NO tiene el flag noRecibioMercaderia, mostrar alerta
                            if (todosEnCero && !registro.noRecibioMercaderia) {
                                // Parsear fecha correctamente usando zona horaria de Argentina
                                const fechaParts = registro.fecha.split('-');
                                const fecha = new Date(parseInt(fechaParts[0]), parseInt(fechaParts[1]) - 1, parseInt(fechaParts[2]));
                                const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fecha.getDay()];
                                const fechaFormateada = fecha.toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
                                const problema = `📦 ${diaSemana} ${fechaFormateada}:\n Ingreso de Mercadería\n   ⚠️ Todos los productos en 0`;
                                problemas.push(problema);
                                console.log('⚠️ Problema encontrado:', registro.tipo, '-', registro.fecha);
                            }
                        } else if (registro.tipo === 'Stock Final') {
                            // Para Stock Final solo alertar si todos están en 0 (no hay flag aquí)
                            if (todosEnCero) {
                                // Parsear fecha correctamente usando zona horaria de Argentina
                                const fechaParts = registro.fecha.split('-');
                                const fecha = new Date(parseInt(fechaParts[0]), parseInt(fechaParts[1]) - 1, parseInt(fechaParts[2]));
                                const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fecha.getDay()];
                                const fechaFormateada = fecha.toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
                                const problema = `📊 ${diaSemana} ${fechaFormateada} - Stock Final\n   ⚠️ Todos los productos en 0`;
                                problemas.push(problema);
                                console.log('⚠️ Problema encontrado:', registro.tipo, '-', registro.fecha);
                            }
                        }
                    });
                    
                    console.log('✅ Verificación de datos en 0 completada. Problemas encontrados:', problemas.length);
                } catch (e) {
                    console.error('❌ Error verificando datos en 0:', e);
                }
            };
            
            // Verificar días faltantes en los últimos 7 días (versión web de verificarDiasFaltantes)
            const verificarDiasFaltantesWeb = async (localId, fechaHoy, problemas) => {
                console.log('🔍 Verificando días faltantes en los últimos 7 días para local:', localId);
                
                try {
                    const db = FirebaseRegionManager.getFirestore();
                    
                    // Primero verificar si el local tiene algún registro histórico
                    const snapshotTotal = await db.collection('locales')
                        .doc(localId)
                        .collection('registros')
                        .get();
                    
                    // Si el local no tiene registros históricos (local nuevo), no generar alertas
                    if (snapshotTotal.empty) {
                        console.log('🏪 Local nuevo sin registros históricos, no generando alertas de días faltantes');
                        return;
                    }
                    
                    console.log('📊 Total de registros históricos encontrados:', snapshotTotal.size);
                    
                    const fechaHoyDate = new Date(fechaHoy);
                    
                    // Verificar los últimos 7 días (excluyendo hoy)
                    for (let i = 1; i <= 7; i++) {
                        const fechaCheck = new Date(fechaHoyDate);
                        fechaCheck.setDate(fechaCheck.getDate() - i);
                        const fechaCheckStr = fechaCheck.toISOString().split('T')[0];
                        
                        console.log('🔍 Verificando fecha:', fechaCheckStr);
                        
                        // Verificar si existe registro de "Ingreso de Mercadería" para esta fecha
                        const snapshotIngreso = await db.collection('locales')
                            .doc(localId)
                            .collection('registros')
                            .doc(`${fechaCheckStr}_Ingreso_de_Mercadería`)
                            .get();
                        
                        // Verificar si existe registro de "Stock Final" para esta fecha
                        const snapshotStock = await db.collection('locales')
                            .doc(localId)
                            .collection('registros')
                            .doc(`${fechaCheckStr}_Stock_Final`)
                            .get();
                        
                        const faltantes = [];
                        if (!snapshotIngreso.exists) {
                            faltantes.push('Ingreso de Mercadería');
                            console.log('⚠️ Falta Ingreso de Mercadería para', fechaCheckStr);
                        }
                        if (!snapshotStock.exists) {
                            faltantes.push('Stock Final');
                            console.log('⚠️ Falta Stock Final para', fechaCheckStr);
                        }
                        
                        if (faltantes.length > 0) {
                            // Parsear fecha correctamente usando zona horaria de Argentina
                            const fechaParts = fechaCheckStr.split('-');
                            const fecha = new Date(parseInt(fechaParts[0]), parseInt(fechaParts[1]) - 1, parseInt(fechaParts[2]));
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][fecha.getDay()];
                            const fechaFormateada = fecha.toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
                            const problemaTexto = `📅 ${diaSemana} ${fechaFormateada}\n   ⚠️ Faltan: ${faltantes.join(', ')}`;
                            problemas.push(problemaTexto);
                            console.log('📅 Agregado problema para', fechaCheckStr, ':', faltantes.join(', '));
                        } else {
                            console.log('✅ Fecha', fechaCheckStr, 'tiene todos los datos necesarios');
                        }
                    }
                    
                    console.log('✅ Verificación completada. Problemas encontrados:', problemas.length);
                } catch (e) {
                    console.error('❌ Error verificando días faltantes:', e);
                }
            };


            // Función para verificar si es el día actual - EXACTO como MainActivity.kt líneas 1219-1227
            const esFechaActual = (fecha) => {
                const fechaString = formatearFechaCorta(fecha);
                const fechaActual = formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                return fechaString === fechaActual;
            };

            // Estados para datos existentes
            const [datosIngreso, setDatosIngreso] = useState({});
            const [datosStock, setDatosStock] = useState({});
            const [cargandoDatos, setCargandoDatos] = useState(false);
            const [noRecibioMercaderia, setNoRecibioMercaderia] = useState(false);


            // Función para cargar datos existentes - EXACTO como CargaActivity.kt
            const cargarDatosExistentes = async (tipo, fechaEspecifica = null) => {
                setCargandoDatos(true);
                try {
                    // Usar fecha específica si se proporciona, sino usar fechaSeleccionada
                    const fechaAUsar = fechaEspecifica || fechaSeleccionada;
                    
                    // Formatear fecha de forma segura sin problemas de zona horaria
                    let fechaString;
                    if (fechaAUsar instanceof Date) {
                        // Si es un objeto Date, usar los componentes directamente para evitar problemas de zona horaria
                        const año = fechaAUsar.getFullYear();
                        const mes = String(fechaAUsar.getMonth() + 1).padStart(2, '0');
                        const dia = String(fechaAUsar.getDate()).padStart(2, '0');
                        fechaString = `${año}-${mes}-${dia}`;
                    } else if (typeof fechaAUsar === 'string' && fechaAUsar.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        // Si ya está en formato yyyy-MM-dd, usarlo directamente
                        fechaString = fechaAUsar;
                    } else {
                        // Fallback a formatearFechaCorta
                        fechaString = formatearFechaCorta(fechaAUsar);
                    }
                    
                    console.log('📅 cargarDatosExistentes - fechaString:', fechaString, 'fechaAUsar:', fechaAUsar, 'fechaEspecifica:', fechaEspecifica, 'fechaSeleccionada:', fechaSeleccionada);
                    // Usar la región actual de Firebase
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        setCargandoDatos(false);
                        return;
                    }
                    console.log('🔍 Consultando Firebase - localId:', usuario.localId, 'fecha:', fechaString, 'tipo:', tipo);
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .where('tipo', '==', tipo)
                        .get();
                    
                    console.log('📊 Resultados de consulta Firebase:', snapshot.size, 'documentos encontrados');
                    if (snapshot.size > 0) {
                        snapshot.docs.forEach((doc, index) => {
                            const data = doc.data();
                            console.log(`  Doc ${index + 1}: fecha=${data.fecha}, tipo=${data.tipo}, id=${doc.id}`);
                        });
                    }
                    
                    if (!snapshot.empty) {
                        console.log(`📊 Total registros encontrados: ${snapshot.docs.length}`);
                        
                        // Ordenar por timestamp descendente para obtener el más reciente
                        const docs = snapshot.docs.sort((a, b) => {
                            const timestampA = a.data().timestamp || '';
                            const timestampB = b.data().timestamp || '';
                            return timestampB.localeCompare(timestampA);
                        });
                        
                        const doc = docs[0]; // El más reciente
                        const data = doc.data();
                        console.log(`📊 Datos ${tipo} encontrados (más reciente):`, data);
                        console.log(`📅 Timestamp del registro seleccionado:`, data.timestamp);
                        
                        // Convertir productos a objeto para fácil acceso
                        const datosProductos = {};
                        if (data.productos && Array.isArray(data.productos)) {
                            data.productos.forEach(producto => {
                                // Extraer nombre del producto (sin código)
                                const nombreCompleto = producto.nombre;
                                const partes = nombreCompleto.split(' - ');
                                const nombre = partes.length > 1 ? partes[1] : nombreCompleto;
                                datosProductos[nombre] = producto.cantidad || 0;
                            });
                        }
                        
                        if (tipo === 'Ingreso de Mercadería') {
                            setDatosIngreso(datosProductos);
                            // Cargar estado del switch "No recibió mercadería"
                            setNoRecibioMercaderia(data.noRecibioMercaderia === true);
                            console.log('Datos de ingreso cargados:', datosProductos, 'noRecibioMercaderia:', data.noRecibioMercaderia);
                        } else if (tipo === 'Stock Final') {
                            setDatosStock(datosProductos);
                            console.log('Datos de stock cargados:', datosProductos);
                        }
                        return true; // Hay datos existentes
                    } else {
                        console.log(`📊 No hay datos ${tipo} para la fecha ${fechaString}`);
                        // EXACTO como Android: Si no hay datos, mostrar campos vacíos (líneas 316-317, 333-334)
                        if (tipo === 'Ingreso de Mercadería') {
                            setDatosIngreso({});
                            setNoRecibioMercaderia(false); // Resetear switch si no hay datos
                        } else if (tipo === 'Stock Final') {
                            // EXACTO como Android: mostrarProductos() con campos vacíos (línea 317)
                            setDatosStock({});
                            console.log('📊 No hay Stock Final guardado, mostrando campos vacíos');
                        }
                        return false; // No hay datos
                    }
                } catch (error) {
                    console.error(`Error cargando datos ${tipo}:`, error);
                    return false;
                } finally {
                    setCargandoDatos(false);
                }
            };


            const navegarA = async (ruta, fechaEspecifica = null) => {
                console.log(`🚀 Navegando a ${ruta}`, fechaEspecifica ? `con fecha específica: ${fechaEspecifica}` : '');
                
                if (ruta === 'Ingreso de Mercadería') {
                    setEnPantallaCarga(true); // Marcar que estamos en pantalla de carga
                    enPantallaCargaRef.current = true; // Actualizar referencia INMEDIATAMENTE
                    setPantallaActual('ingreso');
                    await cargarDatosExistentes('Ingreso de Mercadería', fechaEspecifica);
                } else if (ruta === 'Stock Final') {
                    setEnPantallaCarga(true); // Marcar que estamos en pantalla de carga
                    enPantallaCargaRef.current = true; // Actualizar referencia INMEDIATAMENTE
                    setPantallaActual('stock');
                    await cargarDatosExistentes('Stock Final', fechaEspecifica);
                } else if (ruta === 'Promedio de Ventas') {
                    setPantallaActual('ventas');
                    setEnPantallaCarga(false); // No es pantalla de carga
                    enPantallaCargaRef.current = false;
                } else {
                    alert(`Funcionalidad de ${ruta} próximamente disponible`);
                }
            };
            
            // Exponer navegarA globalmente para que el diálogo de alertas pueda usarla
            window.navegarA = navegarA;

            const volverAlMenu = () => {
                setEnPantallaCarga(false); // Ya no estamos en pantalla de carga
                enPantallaCargaRef.current = false; // Actualizar referencia INMEDIATAMENTE
                setPantallaActual('main');
            };

            // Función para mostrar previsualización - EXACTO como CargaActivity.kt líneas 375-486
            const mostrarPrevisualizacion = () => {
                console.log('🔍 Mostrando previsualización...');
                
                // Lista completa de productos como en CargaActivity.kt
                const todosProductos = [
                    'JQ - Jamón y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jamón', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                    'MUZZARE - Muzzarella', 'JAMON - Jamón', 'PEPPERO - Pepperoni',
                    'BATATA - Batata', 'MEMBRIL - Membrillo',
                    'MEDIALUNA_MANTECA - Medialunas de Manteca', 'MEDIALUNA_GRASA - Medialunas de Grasa', 'CHIPA - Chipa', 'CRIOLLITO - Criollitos'
                ];
                
                // Crear mensaje de previsualización - EXACTO como APK
                let mensaje = `📋 PREVISUALIZACIÓN DE ${pantallaActual === 'stock' ? 'STOCK FINAL' : 'INGRESO DE MERCADERÍA'}\n\n`;
                mensaje += `📅 Fecha: ${formatearFecha(fechaSeleccionada)}\n`;
                mensaje += `🏪 Local: ${usuario.localNombre}\n\n`;
                
                // Mostrar TODOS los productos con sus cantidades (incluso 0)
                mensaje += `📦 PRODUCTOS:\n`;
                let totalUnidades = 0;
                let productosConCantidad = 0;
                
                todosProductos.forEach(producto => {
                    const [codigo, nombre] = producto.split(' - ');
                    
                    // Leer valor actual del input
                    const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                    const cantidad = input ? parseInt(input.value) || 0 : 0;
                    
                    mensaje += `• ${codigo} - ${nombre}: ${cantidad}\n`;
                    
                    if (cantidad > 0) {
                        productosConCantidad++;
                        totalUnidades += cantidad;
                    }
                });
                
                // Resumen completo
                mensaje += `\n📊 RESUMEN:\n`;
                mensaje += `• Total productos: ${todosProductos.length}\n`;
                mensaje += `• Productos con cantidad: ${productosConCantidad}\n`;
                mensaje += `• Productos sin cantidad: ${todosProductos.length - productosConCantidad}\n`;
                mensaje += `• Total unidades: ${totalUnidades}\n`;
                
                // Agregar información del switch solo para Ingreso de Mercadería
                if (pantallaActual === 'ingreso') {
                    mensaje += `• No recibió mercadería: ${noRecibioMercaderia ? 'SÍ' : 'NO'}\n`;
                }
                
                mensaje += `\n¿Deseas guardar estos datos?`;
                
                if (confirm(mensaje)) {
                    guardarDatos();
                }
            };

            // 🔥 Funciones para guardar historial de vencimientos (igual que app Android)
            async function guardarEstadoInicialVencimientos(localId, fecha, db) {
                try {
                    console.log('📝 Guardando estado inicial de vencimientos para:', fecha);
                    
                    // Obtener todos los lotes activos
                    const lotesSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_activos')
                        .get();
                    
                    const lotesActivos = [];
                    lotesSnapshot.forEach(doc => {
                        const data = doc.data();
                        lotesActivos.push({
                            id: doc.id,
                            localId: data.localId || localId,
                            productoCodigo: data.productoCodigo || data.codigo || '',
                            productoNombre: data.productoNombre || data.nombre || '',
                            cantidad: data.cantidad || 0,
                            cantidadInicial: data.cantidadInicial || data.cantidad || 0,
                            fechaVencimiento: data.fechaVencimiento || '',
                            fechaCarga: data.fechaCarga || '',
                            timestamp: data.timestamp || Date.now()
                        });
                    });
                    
                    console.log(`📦 Obtenidos ${lotesActivos.length} lotes activos`);
                    
                    // Obtener registro existente o crear uno nuevo
                    const registroRef = db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_historial_diario')
                        .doc(fecha);
                    
                    const registroDoc = await registroRef.get();
                    const registroExistente = registroDoc.exists ? registroDoc.data() : null;
                    
                    const registro = registroExistente ? {
                        ...registroExistente,
                        lotesIniciales: lotesActivos,
                        timestampInicial: Date.now()
                    } : {
                        localId: localId,
                        fecha: fecha,
                        id: fecha + '_' + Date.now(),
                        lotesIniciales: lotesActivos,
                        lotesFinales: [],
                        timestampInicial: Date.now(),
                        timestampFinal: Date.now()
                    };
                    
                    await registroRef.set(registro);
                    console.log('✅ Estado inicial de vencimientos guardado para', fecha, ':', lotesActivos.length, 'lotes');
                } catch (e) {
                    console.error('❌ Error guardando estado inicial de vencimientos:', e);
                }
            }
            
            async function guardarEstadoFinalVencimientos(localId, fecha, db) {
                try {
                    console.log('📝 Guardando estado final de vencimientos para:', fecha);
                    
                    // Obtener todos los lotes activos
                    const lotesSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_activos')
                        .get();
                    
                    const lotesActivos = [];
                    lotesSnapshot.forEach(doc => {
                        const data = doc.data();
                        lotesActivos.push({
                            id: doc.id,
                            localId: data.localId || localId,
                            productoCodigo: data.productoCodigo || data.codigo || '',
                            productoNombre: data.productoNombre || data.nombre || '',
                            cantidad: data.cantidad || 0,
                            cantidadInicial: data.cantidadInicial || data.cantidad || 0,
                            fechaVencimiento: data.fechaVencimiento || '',
                            fechaCarga: data.fechaCarga || '',
                            timestamp: data.timestamp || Date.now()
                        });
                    });
                    
                    console.log(`📦 Obtenidos ${lotesActivos.length} lotes activos`);
                    
                    // Obtener registro existente o crear uno nuevo
                    const registroRef = db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_historial_diario')
                        .doc(fecha);
                    
                    const registroDoc = await registroRef.get();
                    const registroExistente = registroDoc.exists ? registroDoc.data() : null;
                    
                    const registro = registroExistente ? {
                        ...registroExistente,
                        lotesFinales: lotesActivos,
                        timestampFinal: Date.now()
                    } : {
                        localId: localId,
                        fecha: fecha,
                        id: fecha + '_' + Date.now(),
                        lotesIniciales: [],
                        lotesFinales: lotesActivos,
                        timestampInicial: Date.now(),
                        timestampFinal: Date.now()
                    };
                    
                    await registroRef.set(registro);
                    console.log('✅ Estado final de vencimientos guardado para', fecha, ':', lotesActivos.length, 'lotes');
                } catch (e) {
                    console.error('❌ Error guardando estado final de vencimientos:', e);
                }
            }

            // Función para verificar si debe procesar descuentos - EXACTO como Android CargaActivity.kt líneas 1143-1191
            const verificarSiDebeProcesarDescuentos = async (fecha, nuevosProductos, db) => {
                try {
                    // 🔥 FIX: NO procesar descuentos si la fecha es anterior a hoy
                    const fechaHoy = formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                    if (fecha < fechaHoy) {
                        console.log(`⏭️ Stock Final para ${fecha}: FECHA ANTERIOR (${fecha} < ${fechaHoy}) - NO procesará descuentos`);
                        return { debeProcesar: false, esPrimeraVez: false };
                    }
                    
                    // Buscar Stock Final existente
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fecha)
                        .where('tipo', '==', 'Stock Final')
                        .limit(1)
                        .get();
                    
                    if (snapshot.empty) {
                        // No existe, es primera vez
                        console.log(`🔍 Stock Final para ${fecha}: NO EXISTE (primera vez)`);
                        return { debeProcesar: true, esPrimeraVez: true };
                    } else {
                        // Existe, comparar datos
                        const docExistente = snapshot.docs[0];
                        const productosExistentes = docExistente.data().productos || [];
                        const datosSonDiferentes = compararDatosStockFinal(productosExistentes, nuevosProductos);
                        
                        if (datosSonDiferentes) {
                            console.log(`🔍 Stock Final para ${fecha}: EXISTE pero DATOS CAMBIARON (modificación)`);
                            return { debeProcesar: true, esPrimeraVez: false };
                        } else {
                            console.log(`🔍 Stock Final para ${fecha}: EXISTE con MISMOS DATOS (recarga)`);
                            return { debeProcesar: false, esPrimeraVez: false };
                        }
                    }
                } catch (error) {
                    console.error('❌ Error verificando Stock Final:', error);
                    // Si hay error, verificar si es fecha pasada antes de asumir que debe procesar
                    try {
                        const fechaHoy = formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                        if (fecha < fechaHoy) {
                            console.log(`⏭️ Error pero fecha es anterior - NO procesará descuentos`);
                            return { debeProcesar: false, esPrimeraVez: false };
                        }
                    } catch (e2) {
                        // Si no se puede verificar fecha, asumir que debe procesar (por seguridad)
                    }
                    return { debeProcesar: true, esPrimeraVez: true };
                }
            };
            
            // Función para comparar datos de Stock Final - EXACTO como Android CargaActivity.kt líneas 1197-1239
            const compararDatosStockFinal = (productosExistentes, productosNuevos) => {
                // Si tienen diferente cantidad de productos, son diferentes
                if (productosExistentes.length !== productosNuevos.length) {
                    console.log(`📊 Diferente cantidad de productos: ${productosExistentes.length} vs ${productosNuevos.length}`);
                    return true;
                }
                
                // Crear mapas por nombre para comparar
                const mapaExistente = {};
                productosExistentes.forEach(p => {
                    mapaExistente[p.nombre] = p;
                });
                
                const mapaNuevo = {};
                productosNuevos.forEach(p => {
                    mapaNuevo[p.nombre] = p;
                });
                
                // Verificar si todos los productos coinciden
                for (const nombre in mapaNuevo) {
                    const productoNuevo = mapaNuevo[nombre];
                    const productoExistente = mapaExistente[nombre];
                    
                    if (!productoExistente) {
                        // Producto nuevo que no estaba antes
                        console.log(`📊 Producto nuevo encontrado: ${nombre}`);
                        return true;
                    }
                    
                    if (productoExistente.cantidad !== productoNuevo.cantidad) {
                        // Cantidad diferente
                        console.log(`📊 Cantidad diferente para ${nombre}: ${productoExistente.cantidad} vs ${productoNuevo.cantidad}`);
                        return true;
                    }
                }
                
                // Verificar si hay productos que se eliminaron
                for (const nombre in mapaExistente) {
                    if (!mapaNuevo[nombre]) {
                        console.log(`📊 Producto eliminado: ${nombre}`);
                        return true;
                    }
                }
                
                // Todos los datos son iguales
                console.log(`✅ Todos los datos son iguales`);
                return false;
            };
            
            // Función para calcular ventas por producto - EXACTO como Android CargaActivity.kt líneas 1358-1404
            /**
             * @deprecated Esta función ya no se usa. Ver ajustarLotesAStockFinal()
             * La nueva lógica NO calcula ventas, solo ajusta lotes al stock final directamente
             * Se mantiene solo como referencia histórica
             */
            const calcularVentasPorProducto = async (fecha, stockFinalProductos, db) => {
                try {
                    const fechaAnterior = obtenerFechaAnterior(fecha);
                    
                    // Stock Final de ayer
                    const snapshotStockAyer = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaAnterior)
                        .where('tipo', '==', 'Stock Final')
                        .limit(1)
                        .get();
                    
                    const stockAnterior = snapshotStockAyer.empty ? [] : (snapshotStockAyer.docs[0].data().productos || []);
                    
                    // Ingreso de hoy
                    const snapshotIngresoHoy = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fecha)
                        .where('tipo', '==', 'Ingreso de Mercadería')
                        .limit(1)
                        .get();
                    
                    const ingresoHoy = snapshotIngresoHoy.empty ? [] : (snapshotIngresoHoy.docs[0].data().productos || []);
                    
                    const ventasMap = {};
                    
                    // Calcular venta para cada producto
                    stockFinalProductos.forEach(productoFinal => {
                        const codigo = productoFinal.nombre.split(' - ')[0] || productoFinal.nombre;
                        const codigoNormalizado = normalizarCodigoProducto(codigo);
                        
                        const stockAnt = stockAnterior.find(p => p.nombre === productoFinal.nombre)?.cantidad || 0;
                        const ingreso = ingresoHoy.find(p => p.nombre === productoFinal.nombre)?.cantidad || 0;
                        const stockFin = productoFinal.cantidad;
                        
                        const venta = stockAnt + ingreso - stockFin;
                        
                        if (venta > 0) {
                            ventasMap[codigoNormalizado] = venta;
                            console.log(`   ${codigoNormalizado} (original: ${codigo}): ${stockAnt} + ${ingreso} - ${stockFin} = ${venta} vendido`);
                        }
                    });
                    
                    return ventasMap;
                } catch (error) {
                    console.error('❌ Error calculando ventas:', error);
                    return {};
                }
            };
            
            // Función para obtener fecha anterior
            const obtenerFechaAnterior = (fecha) => {
                try {
                    const fechaObj = new Date(fecha + 'T00:00:00');
                    fechaObj.setDate(fechaObj.getDate() - 1);
                    const año = fechaObj.getFullYear();
                    const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                    const dia = String(fechaObj.getDate()).padStart(2, '0');
                    return `${año}-${mes}-${dia}`;
                } catch (e) {
                    return fecha;
                }
            };
            
            // Función para procesar descuentos FIFO - EXACTO como Android VencimientoManager.kt líneas 22-118
            /**
             * @deprecated Esta función ya no se usa. Ver ajustarLotesAStockFinal()
             * La nueva lógica NO descuenta por ventas, solo ajusta lotes al stock final directamente
             * Se mantiene solo como referencia histórica
             */
            const procesarDescuentosFIFO = async (localId, fecha, ventasPorProducto, db) => {
                try {
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('🔥 INICIANDO DESCUENTO FIFO');
                    console.log('📅 Fecha:', fecha);
                    console.log('🏪 Local:', localId);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    for (const [productoCodigo, cantidadVendida] of Object.entries(ventasPorProducto)) {
                        if (cantidadVendida <= 0) {
                            console.log(`⏭️ Saltando ${productoCodigo} (sin venta)`);
                            continue;
                        }
                        
                        console.log(`\n🔍 Procesando: ${productoCodigo}`);
                        console.log(`   Vendido: ${cantidadVendida} uds`);
                        
                        await descontarVencimientosFIFO(localId, productoCodigo, cantidadVendida, fecha, db);
                    }
                    
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('✅ DESCUENTO FIFO COMPLETADO');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                } catch (error) {
                    console.error('❌ Error procesando descuentos FIFO:', error);
                }
            };
            
            // Función para descontar vencimientos FIFO - EXACTO como Android VencimientoManager.kt líneas 53-118
            const descontarVencimientosFIFO = async (localId, productoCodigo, cantidadVendida, fecha, db) => {
                try {
                    // 1. Obtener lotes ordenados por fecha de vencimiento (más viejo primero)
                    const lotesSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_activos')
                        .where('codigo', '==', productoCodigo.toLowerCase())
                        .where('activo', '==', true)
                        .get();
                    
                    const lotes = [];
                    lotesSnapshot.forEach(doc => {
                        const data = doc.data();
                        lotes.push({
                            id: doc.id,
                            cantidad: data.cantidad || 0,
                            fechaVencimiento: data.fechaVencimiento || '',
                            productoNombre: data.nombre || ''
                        });
                    });
                    
                    // Ordenar por fecha de vencimiento (más viejo primero)
                    lotes.sort((a, b) => {
                        if (!a.fechaVencimiento) return 1;
                        if (!b.fechaVencimiento) return -1;
                        return a.fechaVencimiento.localeCompare(b.fechaVencimiento);
                    });
                    
                    if (lotes.length === 0) {
                        console.warn(`⚠️ No hay lotes activos para ${productoCodigo}`);
                        return;
                    }
                    
                    console.log(`   📦 Lotes disponibles: ${lotes.length}`);
                    lotes.forEach((lote, index) => {
                        console.log(`      ${index + 1}. ${lote.cantidad} uds → Vto ${lote.fechaVencimiento}`);
                    });
                    
                    let pendienteDescontar = cantidadVendida;
                    
                    // 2. Descontar de cada lote (empezando por el más viejo)
                    for (const lote of lotes) {
                        if (pendienteDescontar <= 0) break;
                        
                        const descontar = Math.min(lote.cantidad, pendienteDescontar);
                        const cantidadRestante = lote.cantidad - descontar;
                        
                        console.log(`   🔄 Descontando de lote:`);
                        console.log(`      Vencimiento: ${lote.fechaVencimiento}`);
                        console.log(`      Había: ${lote.cantidad} uds`);
                        console.log(`      Descontar: ${descontar} uds`);
                        console.log(`      Quedan: ${cantidadRestante} uds`);
                        
                        // Actualizar o eliminar el lote
                        if (cantidadRestante <= 0) {
                            // Lote agotado, eliminarlo
                            await db.collection('locales')
                                .doc(localId)
                                .collection('vencimientos_activos')
                                .doc(lote.id)
                                .delete();
                            console.log(`      🗑️ Lote eliminado (agotado)`);
                        } else {
                            // Actualizar cantidad
                            await db.collection('locales')
                                .doc(localId)
                                .collection('vencimientos_activos')
                                .doc(lote.id)
                                .update({
                                    cantidad: cantidadRestante
                                });
                            console.log(`      ✅ Lote actualizado`);
                        }
                        
                        pendienteDescontar -= descontar;
                    }
                    
                    // 3. Verificar si quedó pendiente por descontar
                    if (pendienteDescontar > 0) {
                        console.warn(`⚠️ ADVERTENCIA: Quedan ${pendienteDescontar} uds sin descontar de vencimientos`);
                        console.warn(`   Posible causa: Venta registrada mayor a lotes disponibles`);
                    }
                } catch (error) {
                    console.error(`❌ Error descontando vencimientos FIFO para ${productoCodigo}:`, error);
                }
            };
            
            /**
             * ✅ FUNCIÓN PRINCIPAL: Ajusta los lotes para que sumen exactamente el Stock Final
             * 
             * LÓGICA SIMPLE (igual a Android VencimientoManager.kt líneas 145-264):
             * - Si Stock Final = 50 y Lotes suman 100 → Descuenta 50 de los lotes más viejos (FIFO)
             * - Si Stock Final = 0 → Elimina TODOS los lotes
             * - Si Stock Final = 50 y Lotes suman 30 → Advierte que faltan 20 uds (usuario debe cargar lotes)
             * 
             * NO calcula "venta" - solo ajusta lotes al stock final directamente
             */
            const ajustarLotesAStockFinal = async (localId, fecha, stockFinalPorProducto, db) => {
                try {
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('🔥 AJUSTANDO LOTES AL STOCK FINAL (FIFO)');
                    console.log('📅 Fecha:', fecha);
                    console.log('🏪 Local:', localId);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    for (const [productoCodigo, stockFinal] of Object.entries(stockFinalPorProducto)) {
                        // Obtener lotes activos del producto
                        const lotesSnapshot = await db.collection('locales')
                            .doc(localId)
                            .collection('vencimientos_activos')
                            .where('codigo', '==', productoCodigo.toLowerCase())
                            .get();
                        
                        const lotes = [];
                        lotesSnapshot.forEach(doc => {
                            const data = doc.data();
                            lotes.push({
                                id: doc.id,
                                cantidad: data.cantidad || 0,
                                fechaVencimiento: data.fechaVencimiento || '',
                                productoNombre: data.nombre || ''
                            });
                        });
                        
                        // Ordenar por fecha de vencimiento (más viejo primero) para FIFO
                        lotes.sort((a, b) => {
                            if (!a.fechaVencimiento) return 1;
                            if (!b.fechaVencimiento) return -1;
                            return a.fechaVencimiento.localeCompare(b.fechaVencimiento);
                        });
                        
                        const sumaLotes = lotes.reduce((sum, lote) => sum + lote.cantidad, 0);
                        
                        console.log(`\n🔍 ${productoCodigo}:`);
                        console.log(`   Stock Final deseado: ${stockFinal}`);
                        console.log(`   Lotes actuales: ${sumaLotes}`);
                        
                        if (lotes.length > 0) {
                            console.log(`   📦 Lotes:`);
                            lotes.forEach(lote => {
                                console.log(`      - ${lote.cantidad} uds → Vto ${lote.fechaVencimiento}`);
                            });
                        }
                        
                        // CASO 1: Stock Final = 0 → Eliminar TODOS los lotes
                        if (stockFinal === 0) {
                            if (lotes.length > 0) {
                                console.log(`   🗑️ Eliminando TODOS los lotes (Stock Final = 0)`);
                                for (const lote of lotes) {
                                    await db.collection('locales')
                                        .doc(localId)
                                        .collection('vencimientos_activos')
                                        .doc(lote.id)
                                        .delete();
                                }
                                console.log(`   ✅ Todos los lotes eliminados`);
                            }
                        }
                        // CASO 2: Lotes = Stock Final → Perfecto, no hacer nada
                        else if (sumaLotes === stockFinal) {
                            console.log(`   ✅ Lotes ya coinciden con Stock Final`);
                        }
                        // CASO 3: Lotes > Stock Final → Descontar diferencia (FIFO)
                        else if (sumaLotes > stockFinal) {
                            const cantidadADescontar = sumaLotes - stockFinal;
                            console.log(`   🔄 Descontando ${cantidadADescontar} uds (FIFO)`);
                            
                            let pendiente = cantidadADescontar;
                            for (const lote of lotes) {
                                if (pendiente <= 0) break;
                                
                                const descontar = Math.min(lote.cantidad, pendiente);
                                const restante = lote.cantidad - descontar;
                                
                                console.log(`      Lote Vto ${lote.fechaVencimiento}: ${lote.cantidad} → ${restante} uds`);
                                
                                if (restante <= 0) {
                                    await db.collection('locales')
                                        .doc(localId)
                                        .collection('vencimientos_activos')
                                        .doc(lote.id)
                                        .delete();
                                } else {
                                    await db.collection('locales')
                                        .doc(localId)
                                        .collection('vencimientos_activos')
                                        .doc(lote.id)
                                        .update({ cantidad: restante });
                                }
                                
                                pendiente -= descontar;
                            }
                            
                            console.log(`   ✅ Descuento completado`);
                        }
                        // CASO 4: Lotes < Stock Final → Faltan lotes
                        else {
                            const faltante = stockFinal - sumaLotes;
                            console.warn(`   ⚠️ Faltan ${faltante} uds en lotes`);
                            console.warn(`   💡 Carga los lotes del ingreso en Vencimientos`);
                        }
                    }
                    
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('✅ AJUSTE COMPLETADO');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                } catch (error) {
                    console.error('❌ Error ajustando lotes a stock final:', error);
                }
            };
            
            // Función para guardar datos - EXACTO como CargaActivity.kt líneas 659-822
            const guardarDatos = async () => {
                try {
                    console.log('💾 Guardando datos...');
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    const tipo = pantallaActual === 'stock' ? 'Stock Final' : 'Ingreso de Mercadería';
                    
                    // Leer valores actuales de los inputs
                    const productos = [];
                    const todosProductos = [
                        'JQ - Jamón y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                        'RJ - Roquefort y Jamón', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                        'MUZZARE - Muzzarella', 'JAMON - Jamón', 'PEPPERO - Pepperoni',
                        'BATATA - Batata', 'MEMBRIL - Membrillo',
                        'DULCES - Dulces', 'SALADO - Salado', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                    ];
                    
                    // Leer valores directamente de los inputs del DOM
                    todosProductos.forEach(producto => {
                        const [codigo, nombre] = producto.split(' - ');
                        
                        // Buscar el input correspondiente en el DOM
                        const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                        const cantidad = input ? parseInt(input.value) || 0 : 0;
                        
                        console.log(`📝 ${codigo} - ${nombre}: ${cantidad} (desde input)`);
                        
                        productos.push({
                            codigo,
                            nombre: producto, // Nombre completo con código
                            cantidad: cantidad
                        });
                    });
                    
                    // Guardar en Firebase con ID descriptivo usando la región actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        alert('Error: Firebase no está inicializado. Por favor, selecciona una región primero.');
                        return;
                    }
                    
                    // 🔥 Si es Stock Final, verificar ANTES de guardar si ya existe y si los datos cambiaron
                    // para procesar descuentos SOLO si es PRIMERA VEZ (NO si es modificación)
                    let resultadoVerificacion = null;
                    if (tipo === 'Stock Final') {
                        resultadoVerificacion = await verificarSiDebeProcesarDescuentos(fechaString, productos, db);
                        if (resultadoVerificacion.debeProcesar) {
                            if (resultadoVerificacion.esPrimeraVez) {
                                console.log('📝 Primera vez guardando Stock Final para ' + fechaString + ' - Procesará descuentos FIFO');
                            } else {
                                console.log('📝 Stock Final modificado para ' + fechaString + ' - NO procesará descuentos (ya se aplicaron la primera vez)');
                            }
                        } else {
                            console.log('⏭️ Stock Final ya existía para ' + fechaString + ' con los mismos datos - NO procesará descuentos (recarga)');
                        }
                    }
                    
                    // Crear documento para Firebase - MISMO FORMATO QUE APK
                    const documento = {
                        fecha: fechaString,
                        tipo: tipo,
                        productos: productos,
                        timestamp: window.getTimestampArgentina ? window.getTimestampArgentina() : new Date().toISOString(),
                        usuario: usuario.usuario || 'admin',
                        localId: usuario.localId
                    };
                    
                    // Agregar campo noRecibioMercaderia solo para Ingreso de Mercadería
                    if (tipo === 'Ingreso de Mercadería') {
                        documento.noRecibioMercaderia = noRecibioMercaderia;
                    }
                    
                    console.log('📄 Documento a guardar:', documento);
                    
                    // ID descriptivo como la APK: fecha_tipo
                    const idDocumento = `${fechaString}_${tipo.replace(/\s+/g, '_')}`;
                    console.log('🆔 ID del documento:', idDocumento);
                    
                    // Guardar en Firebase
                    await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .doc(idDocumento)
                        .set(documento);
                    
                    console.log('✅ Datos guardados exitosamente');
                    
                    // 🚀 OPTIMIZACIÓN: Si es Stock Final, actualizar promedio general acumulado
                    // EXACTO como Android CargaActivity.kt líneas 1772-1802
                    // (Nota: La actualización de promedios se puede hacer en background, no bloquea)
                    if (tipo === 'Stock Final') {
                        // Ejecutar en background para no bloquear el guardado
                        actualizarPromedioGeneral(usuario.localId, fechaString, productos, db).catch(error => {
                            console.warn('⚠️ Error actualizando promedios generales (no crítico):', error);
                        });
                    }
                    
                    // 🔥 Si es Stock Final y es la PRIMERA VEZ, ajustar lotes al stock final
                    // ⚠️ NO procesar si es MODIFICACIÓN (ya se procesó la primera vez)
                    // ✅ LÓGICA SIMPLE Y DIRECTA (igual a Android CargaActivity.kt líneas 1700-1745):
                    //    - NO calcular "venta" - solo ajustar lotes al stock final usando FIFO
                    if (tipo === 'Stock Final' && resultadoVerificacion && resultadoVerificacion.debeProcesar && resultadoVerificacion.esPrimeraVez) {
                        console.log('✅ Primera vez guardando Stock Final - Ajustará lotes al Stock Final (FIFO)');
                        
                        // Guardar estado inicial ANTES de ajustar lotes
                        await guardarEstadoInicialVencimientos(usuario.localId, fechaString, db);
                        
                        // ✅ LÓGICA SIMPLE Y DIRECTA:
                        // Ajustar lotes para que sumen exactamente el Stock Final (descuento FIFO)
                        // NO calcular "venta" - solo ajustar lotes al stock final
                        console.log('🔥 Ajustando lotes al Stock Final (FIFO)');
                        const stockFinalPorProducto = {};
                        productos.forEach(producto => {
                            const codigo = producto.nombre.split(' - ')[0] || producto.nombre;
                            const codigoNormalizado = normalizarCodigoProducto(codigo);
                            stockFinalPorProducto[codigoNormalizado] = producto.cantidad;
                        });
                        
                        console.log('📊 Stock Final por producto (normalizado):', stockFinalPorProducto);
                        await ajustarLotesAStockFinal(usuario.localId, fechaString, stockFinalPorProducto, db);
                        
                        // Validar resultado
                        console.log('🔍 Validando resultado...');
                        for (const [productoCodigo, stockFinal] of Object.entries(stockFinalPorProducto)) {
                            const lotesSnapshot = await db.collection('locales')
                                .doc(usuario.localId)
                                .collection('vencimientos_activos')
                                .where('codigo', '==', productoCodigo.toLowerCase())
                                .get();
                            
                            const sumaLotes = lotesSnapshot.docs.reduce((sum, doc) => {
                                return sum + (doc.data().cantidad || 0);
                            }, 0);
                            
                            if (sumaLotes === stockFinal) {
                                console.log(`   ✅ ${productoCodigo}: Lotes = Stock Final (${stockFinal})`);
                            } else {
                                console.error(`   ❌ ${productoCodigo}: Lotes (${sumaLotes}) ≠ Stock Final (${stockFinal})`);
                            }
                        }
                        
                        console.log('✅ Ajuste FIFO completado exitosamente');
                        
                        // Guardar estado final DESPUÉS de ajustar lotes
                        await guardarEstadoFinalVencimientos(usuario.localId, fechaString, db);
                    } else if (tipo === 'Ingreso de Mercadería') {
                        // Guardar estado inicial cuando se carga el ingreso (inicio del día)
                        await guardarEstadoInicialVencimientos(usuario.localId, fechaString, db);
                    } else if (tipo === 'Stock Final') {
                        // Si es modificación o recarga, solo guardar estado final
                        await guardarEstadoFinalVencimientos(usuario.localId, fechaString, db);
                    }
                    
                    alert(`✅ ${tipo} guardado exitosamente para ${fechaString}`);
                    
                    // Actualizar estados de botones
                    if (tipo === 'Ingreso de Mercadería') {
                        setTieneIngreso(true);
                    } else if (tipo === 'Stock Final') {
                        setTieneStock(true);
                    }
                    
                    // Re-verificar alertas después de guardar SOLO si NO estamos en pantalla de carga
                    // (no mostrar cuando estamos arreglando un problema)
                    if (usuario && usuario.localId && usuario.localNombre && !enPantallaCargaRef.current && pantallaActual === 'main') {
                        setTimeout(async () => {
                            // Verificar nuevamente usando la REFERENCIA para obtener el valor ACTUAL
                            if (enPantallaCargaRef.current) {
                                console.log('⏭️ Ya estamos en pantalla de carga, cancelando re-verificación');
                                return;
                            }
                            
                            console.log('🔄 Re-verificando alertas después de guardar registro (no estamos en pantalla de carga)...');
                            try {
                                const problemas = [];
                                const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                                
                                // Verificar datos en 0
                                await verificarDatosEnCeroHoyWeb(usuario.localId, fechaHoy, problemas);
                                
                                // Verificar días faltantes
                                await verificarDiasFaltantesWeb(usuario.localId, fechaHoy, problemas);
                                
                                console.log('🔍 Re-verificación completada. Problemas encontrados:', problemas.length);
                                
                                // Solo mostrar si NO estamos en pantalla de carga (usar referencia)
                                if (problemas.length > 0 && !enPantallaCargaRef.current && pantallaActual === 'main') {
                                    console.log('⚠️ Aún hay problemas después de guardar, mostrando alertas actualizadas...');
                                    setTimeout(() => {
                                        // Verificar nuevamente usando la REFERENCIA antes de mostrar
                                        if (!enPantallaCargaRef.current && pantallaActual === 'main' && window.mostrarPopupProblemas) {
                                            window.mostrarPopupProblemas(usuario.localNombre, problemas);
                                        } else {
                                            console.log('⏭️ No se muestra alerta - enPantallaCargaRef.current:', enPantallaCargaRef.current, 'pantallaActual:', pantallaActual);
                                        }
                                    }, 500);
                                } else {
                                    console.log('✅ Todos los problemas fueron resueltos o estamos en pantalla de carga');
                                }
                            } catch (e) {
                                console.error('❌ Error re-verificando alertas:', e);
                            }
                        }, 1000);
                    } else {
                        console.log('⏭️ No se re-verifican alertas - enPantallaCargaRef.current:', enPantallaCargaRef.current, 'pantallaActual:', pantallaActual);
                    }
                    
                    // Volver al menú principal
                    volverAlMenu();
                    
                } catch (error) {
                    console.error('❌ Error guardando datos:', error);
                    alert(`❌ Error guardando datos: ${error.message}`);
                }
            };
            
            // Función para validar consistencia de lotes después del descuento - EXACTO como Android CargaActivity.kt líneas 1298-1323
            const validarConsistenciaLotes = async (localId, fecha, stockFinalProductos, db) => {
                try {
                    // Preparar mapa de stock final normalizado
                    const stockFinalPorProducto = {};
                    stockFinalProductos.forEach(producto => {
                        const codigo = producto.nombre.split(' - ')[0] || producto.nombre;
                        const codigoNormalizado = normalizarCodigoProducto(codigo);
                        stockFinalPorProducto[codigoNormalizado] = producto.cantidad;
                    });
                    
                    // Validar cada producto
                    for (const [productoCodigo, stockFinal] of Object.entries(stockFinalPorProducto)) {
                        const lotesSnapshot = await db.collection('locales')
                            .doc(localId)
                            .collection('vencimientos_activos')
                            .where('codigo', '==', productoCodigo.toLowerCase())
                            .where('activo', '==', true)
                            .get();
                        
                        const lotes = [];
                        lotesSnapshot.forEach(doc => {
                            const data = doc.data();
                            lotes.push({
                                id: doc.id,
                                cantidad: data.cantidad || 0
                            });
                        });
                        
                        const sumaLotes = lotes.reduce((sum, lote) => sum + lote.cantidad, 0);
                        
                        // Caso especial: stock final = 0 → eliminar todos los lotes
                        if (stockFinal === 0 && lotes.length > 0) {
                            console.log(`🗑️ Stock Final = 0 para ${productoCodigo} → Eliminando TODOS los lotes`);
                            for (const lote of lotes) {
                                await db.collection('locales')
                                    .doc(localId)
                                    .collection('vencimientos_activos')
                                    .doc(lote.id)
                                    .delete();
                            }
                        }
                        // Validar consistencia (solo loguear, no ajustar automáticamente)
                        else if (sumaLotes !== stockFinal) {
                            const diferencia = stockFinal - sumaLotes;
                            console.warn(`⚠️ INCONSISTENCIA en ${productoCodigo} después del descuento:`);
                            console.warn(`   Stock Final: ${stockFinal}`);
                            console.warn(`   Suma Lotes: ${sumaLotes}`);
                            console.warn(`   Diferencia: ${diferencia}`);
                            console.warn(`   (No se ajusta automáticamente - revisar datos manualmente)`);
                        } else {
                            console.log(`✅ ${productoCodigo}: Lotes coinciden con stock final (${stockFinal})`);
                        }
                    }
                } catch (error) {
                    console.error('❌ Error validando consistencia de lotes:', error);
                }
            };
            
            // Función para actualizar promedio general - EXACTO como Android CargaActivity.kt líneas 1772-1989
            const actualizarPromedioGeneral = async (localId, fecha, stockFinalProductos, db) => {
                try {
                    console.log('🔄 Calculando TODOS los promedios históricos (como Venta por Volumen)');
                    
                    // 🚀 Cargar TODOS los registros históricos
                    const registrosSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('registros')
                        .orderBy('fecha', 'desc')
                        .get();
                    
                    const todosLosRegistros = [];
                    registrosSnapshot.forEach(doc => {
                        const data = doc.data();
                        todosLosRegistros.push({
                            fecha: data.fecha,
                            tipo: data.tipo,
                            productos: data.productos || []
                        });
                    });
                    
                    console.log('📊 Total registros históricos:', todosLosRegistros.length);
                    
                    if (todosLosRegistros.length === 0) {
                        console.warn('⚠️ No hay registros históricos para calcular promedios');
                        return;
                    }
                    
                    // 🚀 Calcular TODOS los promedios de TODOS los días (igual que Venta por Volumen)
                    const promediosPorDia = calcularPromediosPorDiaCompleto(todosLosRegistros);
                    console.log('✅ Promedios calculados para', Object.keys(promediosPorDia).length, 'días');
                    
                    // 🚀 Convertir a formato PromedioData (suma, cantidad, promedio) para Firebase
                    const promediosGenerales = convertirPromediosAPromedioData(promediosPorDia, todosLosRegistros);
                    
                    // 🚀 Guardar TODOS los promedios en Firebase
                    await guardarPromediosGeneralesEnFirebase(localId, promediosGenerales, db);
                    
                    console.log('✅ TODOS los promedios guardados en Firebase:', Object.keys(promediosGenerales).length, 'días');
                    
                } catch (error) {
                    console.error('❌ Error calculando promedios generales:', error);
                    // No lanzar excepción para no interrumpir el guardado de Stock Final
                }
            };
            
            // Función para calcular promedios por día completo - EXACTO como Android CargaActivity.kt líneas 1808-1857
            const calcularPromediosPorDiaCompleto = (registros) => {
                const promediosPorDia = {};
                const diasSemana = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
                
                // Inicializar estructura
                diasSemana.forEach(dia => {
                    promediosPorDia[dia] = {};
                });
                
                // Obtener todas las fechas ordenadas
                const fechasOrdenadas = [...new Set(registros.map(r => r.fecha))].sort();
                
                if (fechasOrdenadas.length === 0) {
                    return promediosPorDia;
                }
                
                // Agrupar por día de la semana
                const ventasPorDia = {};
                
                fechasOrdenadas.forEach(fecha => {
                    const diaSemana = obtenerDiaSemana(fecha);
                    const ventasDia = calcularVentasDiaCompleto(fecha, registros);
                    if (Object.keys(ventasDia).length > 0) {
                        if (!ventasPorDia[diaSemana]) {
                            ventasPorDia[diaSemana] = [];
                        }
                        ventasPorDia[diaSemana].push(ventasDia);
                    }
                });
                
                // Calcular promedios
                Object.keys(ventasPorDia).forEach(dia => {
                    const listaVentas = ventasPorDia[dia];
                    if (listaVentas.length > 0) {
                        // Obtener TODOS los productos únicos de TODOS los registros de este día
                        const productos = [...new Set(listaVentas.flatMap(v => Object.keys(v)))];
                        productos.forEach(producto => {
                            // Filtrar solo los días donde este producto tiene ventas > 0
                            const ventasConDatos = listaVentas
                                .map(v => v[producto])
                                .filter(v => v !== undefined && v > 0);
                            
                            if (ventasConDatos.length > 0) {
                                const suma = ventasConDatos.reduce((a, b) => a + b, 0);
                                const promedio = suma / ventasConDatos.length;
                                promediosPorDia[dia][producto] = promedio;
                            } else {
                                // Si no hay días con ventas > 0, el promedio es 0
                                promediosPorDia[dia][producto] = 0;
                            }
                        });
                    }
                });
                
                return promediosPorDia;
            };
            
            // Función para calcular ventas de un día específico - EXACTO como Android CargaActivity.kt líneas 1862-1893
            const calcularVentasDiaCompleto = (fecha, registros) => {
                const registrosFecha = registros.filter(r => r.fecha === fecha);
                const ingreso = registrosFecha.find(r => r.tipo === 'Ingreso de Mercadería')?.productos || [];
                const stockFinal = registrosFecha.find(r => r.tipo === 'Stock Final')?.productos || [];
                
                // Obtener stock final del día anterior
                const fechaAnterior = obtenerFechaAnterior(fecha);
                const stockAnterior = registros
                    .filter(r => r.fecha === fechaAnterior)
                    .find(r => r.tipo === 'Stock Final')?.productos || [];
                
                const ventas = {};
                
                // Si no hay stock final del día actual, no podemos calcular ventas
                if (stockFinal.length === 0) {
                    return ventas;
                }
                
                // Calcular ventas para cada producto del stock final
                stockFinal.forEach(productoStock => {
                    const nombreProducto = productoStock.nombre;
                    const ingresoCantidad = ingreso.find(p => p.nombre === nombreProducto)?.cantidad || 0;
                    const stockFinalCantidad = productoStock.cantidad;
                    const stockAnteriorCantidad = stockAnterior.find(p => p.nombre === nombreProducto)?.cantidad || 0;
                    
                    const venta = stockAnteriorCantidad + ingresoCantidad - stockFinalCantidad;
                    
                    // Agregar TODOS los productos al map, incluso si la venta es 0
                    ventas[nombreProducto] = venta > 0 ? venta : 0;
                });
                
                return ventas;
            };
            
            // Función para convertir promedios a PromedioData - EXACTO como Android CargaActivity.kt líneas 1899-1942
            const convertirPromediosAPromedioData = (promediosPorDia, registros) => {
                const promediosGenerales = {};
                
                // Obtener todas las fechas ordenadas
                const fechasOrdenadas = [...new Set(registros.map(r => r.fecha))].sort();
                
                // Agrupar ventas por día de la semana para calcular suma y cantidad
                const ventasPorDiaSemana = {};
                
                fechasOrdenadas.forEach(fecha => {
                    const diaSemana = obtenerDiaSemana(fecha);
                    const ventasDia = calcularVentasDiaCompleto(fecha, registros);
                    if (Object.keys(ventasDia).length > 0) {
                        if (!ventasPorDiaSemana[diaSemana]) {
                            ventasPorDiaSemana[diaSemana] = [];
                        }
                        ventasPorDiaSemana[diaSemana].push(ventasDia);
                    }
                });
                
                // Convertir promedios a PromedioData
                Object.keys(promediosPorDia).forEach(dia => {
                    promediosGenerales[dia] = {};
                    const productos = promediosPorDia[dia];
                    
                    Object.keys(productos).forEach(producto => {
                        // Obtener todas las ventas de este producto en este día de la semana
                        const ventasDelProducto = (ventasPorDiaSemana[dia] || [])
                            .map(v => v[producto])
                            .filter(v => v !== undefined && v > 0);
                        
                        const suma = ventasDelProducto.reduce((a, b) => a + b, 0);
                        const cantidad = ventasDelProducto.length;
                        const promedioCalculado = cantidad > 0 ? suma / cantidad : 0;
                        
                        promediosGenerales[dia][producto] = {
                            suma: suma,
                            cantidad: cantidad,
                            promedio: promedioCalculado
                        };
                    });
                });
                
                return promediosGenerales;
            };
            
            // Función para guardar promedios generales en Firebase - EXACTO como Android CargaActivity.kt líneas 1947-1989
            const guardarPromediosGeneralesEnFirebase = async (localId, promedios, db) => {
                try {
                    // Convertir estructura a formato Firebase
                    const promediosFirebase = {};
                    Object.keys(promedios).forEach(dia => {
                        promediosFirebase[dia] = {};
                        const productos = promedios[dia];
                        Object.keys(productos).forEach(producto => {
                            const data = productos[producto];
                            promediosFirebase[dia][producto] = {
                                suma: data.suma,
                                cantidad: data.cantidad,
                                promedio: data.promedio
                            };
                        });
                    });
                    
                    const promedioGeneralData = {
                        promedios: promediosFirebase,
                        fechaActualizacion: new Date().toISOString(),
                        localId: localId
                    };
                    
                    // Guardar en: locales/{localId}/promedios_generales/promedios
                    await db.collection('locales')
                        .doc(localId)
                        .collection('promedios_generales')
                        .doc('promedios')
                        .set(promedioGeneralData);
                    
                    console.log('✅ Promedios generales guardados en Firebase');
                } catch (error) {
                    console.warn('⚠️ Error guardando promedios en Firebase:', error);
                }
            };
            
            // Nota: obtenerFechaAnterior y obtenerDiaSemana ya están definidas más arriba en el código

            // Mostrar pantalla de gestión de locales si está seleccionada
            if (pantallaActual === 'gestion-locales') {
                return <GestionLocales onVolver={volverAlMenu} onLoginSuccess={onLoginSuccess} />;
            }

            // Mostrar pantalla de promedios si está seleccionada
            if (pantallaActual === 'ventas') {
                return <PromedioVentas onVolver={volverAlMenu} usuario={usuario} />;
            }

            // Mostrar pantalla de stock si está seleccionada
            if (pantallaActual === 'stock') {
            return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con botón volver */}
                        <div className="flex justify-between items-center mb-4">
                                    <button
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                                    >
                                ← Volver
                                    </button>
                            <h1 className="text-xl font-bold text-black">Stock Final</h1>
                            <div></div>
                                    </div>

                        {/* Información de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Stock Final
                            </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                                    </div>
                                </div>
                                
                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                Productos en Stock
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🥟 EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                    </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jamón y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jamón', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🍕 PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jamón', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🥧 PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    onFocus={(e) => e.target.select()}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🍬 OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        4 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'SALADO - Salado', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    onFocus={(e) => e.target.select()}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Botón guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base btn-primary fade-in"
                        >
                            👁️ Previsualizar y Guardar
                        </button>
                                </div>
                );
            }

            // Mostrar pantalla de ingreso si está seleccionada
            if (pantallaActual === 'ingreso') {
                return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con botón volver */}
                        <div className="flex justify-between items-center mb-4">
                            <button 
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                            >
                                ← Volver
                            </button>
                            <h1 className="text-xl font-bold text-black">Ingreso de Mercadería</h1>
                            <div></div>
                            </div>

                        {/* Información de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Ingreso de Mercadería
                                        </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                        </div>
                    </div>

                        {/* Switch "No recibió mercadería" - Solo para Ingreso de Mercadería */}
                        {pantallaActual === 'ingreso' && (
                            <div className="bg-white rounded-lg mb-4 p-4">
                                <div className="flex items-center justify-between">
                                    <label className="text-base font-semibold text-black">
                                        ⚠️ No recibió mercadería
                                    </label>
                                    <label className="relative inline-flex items-center cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={noRecibioMercaderia}
                                            onChange={(e) => setNoRecibioMercaderia(e.target.checked)}
                                            className="sr-only peer"
                                            style={{display: 'none'}}
                                        />
                                        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"
                                            onClick={() => setNoRecibioMercaderia(!noRecibioMercaderia)}
                                            style={{
                                                backgroundColor: noRecibioMercaderia ? '#FF9800' : '#d1d5db',
                                                transition: 'background-color 0.2s'
                                            }}
                                        >
                                            <div style={{
                                                position: 'absolute',
                                                top: '2px',
                                                left: noRecibioMercaderia ? 'calc(100% - 22px)' : '2px',
                                                width: '20px',
                                                height: '20px',
                                                backgroundColor: 'white',
                                                borderRadius: '50%',
                                                transition: 'left 0.2s',
                                                boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                            }}></div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        )}

                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                {pantallaActual === 'ingreso' ? 'Productos a Ingresar' : 'Productos en Stock'}
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🥟 EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jamón y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jamón', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    onFocus={(e) => e.target.select()}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🍕 PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jamón', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🥧 PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    onFocus={(e) => e.target.select()}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">🍬 OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        4 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'SALADO - Salado', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                            </div>
                        </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    onFocus={(e) => e.target.select()}
                                                    data-nombre={nombre}
                                                />
                    </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Botón guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base btn-primary fade-in"
                        >
                            👁️ Previsualizar y Guardar
                        </button>
                                </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '20px'}}>
                    {/* Header con botón volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={() => {
                                // Detectar si vino de GestionLocales
                                if (usuario.id && usuario.id.startsWith('temp_')) {
                                    // Vino de GestionLocales, volver ahí
                                    if (onVolverGestion) {
                                        onVolverGestion();
                                    } else {
                                        // Fallback: ir a login
                                        onLogout();
                                    }
                                } else {
                                    // Vino del login normal, hacer logout
                                    onLogout();
                                }
                            }}
                            className="px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '8px',
                                fontSize: '16px'
                            }}
                        >
                            ← Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Menú Principal</h1>
                        <div></div>
                            </div>

                    {/* Header del Local */}
                    <div 
                        className="w-full mb-5 text-center text-lg font-bold"
                        style={{
                            backgroundColor: 'var(--brand-gold)',
                            color: 'var(--brand-black)',
                            padding: '16px',
                            borderRadius: '12px',
                            border: '1px solid var(--brand-gold-dark)'
                        }}
                    >
                        🏪 {usuario.localNombre}
                                        </div>

                    {/* Selector de Fecha */}
                    <div 
                        className="w-full mb-8 flex items-center justify-between card-date-selector fade-in"
                    >
                        <button 
                            className="text-2xl font-bold px-3 py-3 rounded-lg transition-colors fade-in"
                            style={{
                                backgroundColor: '#1976D2', // Azul oscuro (holo_blue_dark) - igual que Android
                                color: '#FFFFFF',
                                border: 'none',
                                minWidth: '48px',
                                minHeight: '48px'
                            }}
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() - 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ◀
                        </button>
                        
                        <div 
                            className="flex-1 text-center text-lg font-bold text-black cursor-pointer"
                            onClick={mostrarCalendarioPersonalizado}
                        >
                            {fechaSeleccionada.toLocaleDateString('es-ES', { 
                                weekday: 'long', 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: '2-digit' 
                            })}
                                        </div>
                        
                        <button 
                            className="text-2xl font-bold px-3 py-3 rounded-lg transition-colors fade-in"
                            style={{
                                backgroundColor: '#1976D2', // Azul oscuro (holo_blue_dark) - igual que Android
                                color: '#FFFFFF',
                                border: 'none',
                                minWidth: '48px',
                                minHeight: '48px'
                            }}
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() + 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ▶
                        </button>
                        
                        <svg className="w-6 h-6 text-black ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                    </div>

                    {/* Botones - Grid 2x3 como Android */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '16px',
                        marginBottom: '24px'
                    }}>
                        {/* Ingreso Mercadería */}
                        <div className="card" style={{
                            padding: '16px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            minHeight: '120px',
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div style={{
                                fontSize: '48px',
                                marginBottom: '8px',
                                color: 'var(--brand-gold)'
                            }}>
                                ➕
                            </div>
                            <button
                                onClick={() => navegarA('Ingreso de Mercadería')}
                                className={`w-full font-bold fade-in menu-button ${tieneIngreso ? 'btn-completed' : 'btn-primary'}`}
                                style={{
                                    height: '72px',
                                    textAlign: 'center',
                                    whiteSpace: 'nowrap',
                                    padding: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1.2',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }}
                            >
                                {tieneIngreso ? '✅ Ingreso Mercadería' : 'Ingreso Mercadería'}
                            </button>
                        </div>

                        {/* Stock Final */}
                        <div className="card" style={{
                            padding: '16px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            minHeight: '120px',
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div style={{
                                fontSize: '48px',
                                marginBottom: '8px',
                                color: 'var(--brand-gold)'
                            }}>
                                📊
                            </div>
                            <button
                                onClick={() => navegarA('Stock Final')}
                                className={`w-full font-bold fade-in menu-button ${tieneStock ? 'btn-completed' : 'btn-primary'}`}
                                style={{
                                    height: '72px',
                                    textAlign: 'center',
                                    whiteSpace: 'nowrap',
                                    padding: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1.2',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }}
                            >
                                {tieneStock ? '✅ Stock Final' : 'Stock Final'}
                            </button>
                        </div>

                        {/* Vencimientos */}
                        <div className="card" style={{
                            padding: '16px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            minHeight: '120px',
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div style={{
                                fontSize: '48px',
                                marginBottom: '8px',
                                color: 'var(--brand-gold)'
                            }}>
                                📅
                            </div>
                            <button
                                onClick={() => {
                                    if (window.openVencLocal) {
                                        window.openVencLocal();
                                    } else {
                                        alert('Función de vencimientos no disponible');
                                    }
                                }}
                                className={`w-full font-bold fade-in menu-button ${tieneVencimientosCoincidentes ? 'btn-completed' : 'btn-primary'}`}
                                style={{
                                    height: '72px',
                                    textAlign: 'center',
                                    whiteSpace: 'nowrap',
                                    padding: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1.2',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }}
                            >
                                {tieneVencimientosCoincidentes ? '✅ Vencimientos' : 'Vencimientos'}
                            </button>
                        </div>

                        {/* Promedio Ventas */}
                        <div className="card" style={{
                            padding: '16px',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            minHeight: '120px',
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div style={{
                                fontSize: '48px',
                                marginBottom: '8px',
                                color: 'var(--brand-gold)'
                            }}>
                                📈
                            </div>
                            <button
                                onClick={() => navegarA('Promedio de Ventas')}
                                className="w-full font-bold btn-primary fade-in menu-button"
                                style={{
                                    height: '72px',
                                    textAlign: 'center',
                                    whiteSpace: 'nowrap',
                                    padding: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1.2',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }}
                            >
                                Promedio Ventas
                            </button>
                        </div>
                    </div>

                    {/* Botones adicionales fuera del grid */}
                    <div className="space-y-3">
                        <button
                            onClick={() => {
                                if (window.openPedidoFabrica) {
                                    window.openPedidoFabrica();
                                } else {
                                    alert('Función de pedido a fábrica no disponible');
                                }
                            }}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: '#059669',
                                color: '#FFFFFF',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #047857'
                            }}
                        >
                            🏭 Pedido a Fábrica
                        </button>

                        <button
                            onClick={() => {
                                if (window.openPedidoPanificadora) {
                                    window.openPedidoPanificadora();
                                } else {
                                    alert('Función de pedido a panificadora no disponible');
                                }
                            }}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: '#D97706',
                                color: '#FFFFFF',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B45309'
                            }}
                        >
                            🥖 Pedido a Panificadora
                        </button>
                    </div>

                    {/* Enlace de descarga de la app Android */}
                    <div className="mt-6 text-center">
                        <a
                            href={downloadUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#4CAF50',
                                border: '1px solid #388E3C',
                                borderRadius: '8px',
                                fontSize: '14px',
                                textDecoration: 'none'
                            }}
                        >
                            📱 Descargar App Android
                        </a>
                    </div>

                    {/* Modal del Calendario Personalizado - EXACTO como MainActivity.kt */}
                    {mostrarCalendario && (
                        <CalendarioPersonalizado 
                            fechaSeleccionada={fechaSeleccionada}
                            setFechaSeleccionada={setFechaSeleccionada}
                            onCerrar={() => setMostrarCalendario(false)}
                            fechasCompletas={fechasCompletas}
                            fechasParciales={fechasParciales}
                            cargando={cargandoCalendario}
                        />
                    )}
                                        </div>
            );
        }

        // Componente de Promedio de Ventas - EXACTO como VentaVolumenActivity.kt
        const PromedioVentas = ({ onVolver, usuario }) => {
            const [promedios, setPromedios] = useState({});
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState(null);
            const [vistaMenu, setVistaMenu] = useState(false); // false = tabla, true = menú
            const [registrosCache, setRegistrosCache] = useState([]);
            const [registrosFiltrados, setRegistrosFiltrados] = useState([]);
            const [periodoActual, setPeriodoActual] = useState('General');

            useEffect(() => {
                calcularPromedios();
            }, []);

            const calcularPromedios = async () => {
                try {
                    setCargando(true);
                    console.log('🔍 Calculando promedios de ventas...');
                    
                    // Obtener todos los registros del local usando la región actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        setError('Error: Firebase no está inicializado');
                        setCargando(false);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`📊 Registros encontrados: ${registros.length}`);
                    console.log('📋 Registros:', registros);
                    
                    if (registros.length === 0) {
                        setError('No hay datos para calcular promedios');
                        setCargando(false);
                        return;
                    }
                    
                    // Guardar registros en cache
                    setRegistrosCache(registros);
                    setRegistrosFiltrados(registros);
                    
                    // Calcular promedios por día de la semana con todos los registros (vista general)
                    const promediosCalculados = calcularPromediosPorDia(registros);
                    setPromedios(promediosCalculados);
                    setPeriodoActual('General - Todos los registros');
                    console.log('✅ Promedios calculados:', promediosCalculados);
                    
                } catch (error) {
                    console.error('❌ Error calculando promedios:', error);
                    setError('Error calculando promedios: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const calcularPromediosPorDia = (registros) => {
                console.log('🔄 calcularPromediosPorDia iniciado con registros:', registros.length);
                
                // Orden EXACTO como en la tabla: ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM']
                const diasSemana = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
                const promediosPorDia = {};
                
                // Inicializar estructura
                diasSemana.forEach(dia => {
                    promediosPorDia[dia] = {};
                });

                // Agrupar registros por fecha
                const registrosPorFecha = {};
                
                registros.forEach(registro => {
                    const fecha = registro.fecha;
                    if (!registrosPorFecha[fecha]) {
                        registrosPorFecha[fecha] = { ingreso: null, stock: null };
                    }
                    
                    if (registro.tipo === 'Ingreso de Mercadería') {
                        registrosPorFecha[fecha].ingreso = registro;
                    } else if (registro.tipo === 'Stock Final') {
                        registrosPorFecha[fecha].stock = registro;
                    }
                });

                console.log('📅 Registros agrupados por fecha:', registrosPorFecha);

                // Ordenar fechas para poder calcular stock del día anterior
                const fechasOrdenadas = Object.keys(registrosPorFecha).sort();
                console.log('📅 Fechas ordenadas:', fechasOrdenadas);

                // Calcular ventas por día usando la fórmula correcta:
                // Ventas = (Stock Final día anterior + Ingreso de Mercadería) - Stock Final de hoy
                const ventasPorDia = {};
                
                // Inicializar todos los días de la semana
                diasSemana.forEach(dia => {
                    ventasPorDia[dia] = [];
                });
                
                for (let i = 1; i < fechasOrdenadas.length; i++) { // Empezar desde el segundo día
                    const fechaActual = fechasOrdenadas[i];
                    const fechaAnterior = fechasOrdenadas[i - 1];
                    
                    const registrosActual = registrosPorFecha[fechaActual];
                    const registrosAnterior = registrosPorFecha[fechaAnterior];
                    
                    // Solo calcular si tenemos todos los datos necesarios
                    if (registrosActual.ingreso && registrosActual.stock && registrosAnterior.stock) {
                        const diaSemana = obtenerDiaSemana(fechaActual);
                        
                        // Calcular ventas: (Stock Final día anterior + Ingreso de Mercadería) - Stock Final de hoy
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            registrosAnterior.stock,  // Stock Final día anterior
                            registrosActual.ingreso,  // Ingreso de Mercadería
                            registrosActual.stock     // Stock Final de hoy
                        );
                        
                        console.log(`💰 Ventas del ${diaSemana} (${fechaActual}):`, ventasDia);
                        console.log(`   Stock anterior (${fechaAnterior}):`, registrosAnterior.stock);
                        console.log(`   Ingreso (${fechaActual}):`, registrosActual.ingreso);
                        console.log(`   Stock actual (${fechaActual}):`, registrosActual.stock);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                }
                
                // También calcular ventas para días que no tienen día anterior (primer día)
                // En este caso, asumimos que el stock anterior es 0
                fechasOrdenadas.forEach(fecha => {
                    const registrosDia = registrosPorFecha[fecha];
                    const diaSemana = obtenerDiaSemana(fecha);
                    
                    // Solo si no se calculó ya para este día
                    if (registrosDia.ingreso && registrosDia.stock && ventasPorDia[diaSemana].length === 0) {
                        // Crear un registro de stock anterior con valores 0
                        const stockAnteriorCero = {
                            productos: registrosDia.stock.productos.map(p => ({ ...p, cantidad: 0 }))
                        };
                        
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            stockAnteriorCero,        // Stock anterior = 0
                            registrosDia.ingreso,     // Ingreso de Mercadería
                            registrosDia.stock        // Stock Final de hoy
                        );
                        
                        console.log(`💰 Ventas del ${diaSemana} (${fecha}) - Primer día:`, ventasDia);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                });

                console.log('📊 Ventas por día de la semana:', ventasPorDia);
                console.log('📊 Ventas LUNES:', ventasPorDia['LUNES']);
                console.log('📊 Ventas MARTES:', ventasPorDia['MARTES']);
                console.log('📊 Ventas MIERCOLES:', ventasPorDia['MIERCOLES']);
                console.log('📊 Ventas JUEVES:', ventasPorDia['JUEVES']);
                console.log('📊 Ventas VIERNES:', ventasPorDia['VIERNES']);
                console.log('📊 Ventas SABADO:', ventasPorDia['SABADO']);
                console.log('📊 Ventas DOMINGO:', ventasPorDia['DOMINGO']);

                // Calcular promedios para todos los días de la semana
                diasSemana.forEach(dia => {
                    const ventasDelDia = ventasPorDia[dia];
                    if (ventasDelDia.length > 0) {
                        // Obtener todos los productos únicos de todas las ventas de este día
                        const todosProductos = new Set();
                        ventasDelDia.forEach(venta => {
                            Object.keys(venta).forEach(producto => todosProductos.add(producto));
                        });
                        
                        // Calcular promedio para cada producto
                        todosProductos.forEach(producto => {
                            // Filtrar solo los días donde este producto tiene ventas > 0
                            const ventasConDatos = ventasDelDia.map(venta => venta[producto] || 0).filter(v => v > 0);
                            
                            if (ventasConDatos.length > 0) {
                                const suma = ventasConDatos.reduce((acc, venta) => acc + venta, 0);
                                const promedio = suma / ventasConDatos.length;
                                promediosPorDia[dia][producto] = Math.round(promedio); // Redondear a número entero
                                
                                // Log específico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Día: ${dia}`);
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Total días en lista: ${ventasDelDia.length}`);
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Días con ventas > 0: ${ventasConDatos.length}`);
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Ventas encontradas: ${ventasConDatos}`);
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Suma: ${suma}, Promedio: ${promedio}, Redondeado: ${Math.round(promedio)}`);
                                }
                            } else {
                                // Si no hay días con ventas > 0, el promedio es 0
                                promediosPorDia[dia][producto] = 0.0;
                                
                                // Log específico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`🔍 CRIOLLITO PROMEDIO DEBUG - Día: ${dia} - sin ventas registradas, promedio=0.0`);
                                }
                            }
                        });
                        
                            console.log(`📊 Promedios calculados para ${dia}:`, promediosPorDia[dia]);
                            if (dia === 'LUNES') {
                                console.log('🔍 LUNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MARTES') {
                                console.log('🔍 MARTES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MIERCOLES') {
                                console.log('🔍 MIERCOLES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'JUEVES') {
                                console.log('🔍 JUEVES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'VIERNES') {
                                console.log('🔍 VIERNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'SABADO') {
                                console.log('🔍 SABADO - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'DOMINGO') {
                                console.log('🔍 DOMINGO - Promedios individuales:', promediosPorDia[dia]);
                            }
                    } else {
                        console.log(`⚠️ No hay datos para ${dia}`);
                    }
                });

                console.log('✅ Promedios finales calculados:', promediosPorDia);
                return promediosPorDia;
            };

            const obtenerDiaSemana = (fecha) => {
                const date = new Date(fecha);
                const diaIndex = date.getDay();
                
                // Mapeo CORREGIDO según los datos reales
                // Los datos muestran que:
                // - 2409 es SÁBADO (debería estar en índice 5)
                // - 1092 es DOMINGO (debería estar en índice 6)
                // - 1609 es LUNES (debería estar en índice 0)
                const mapeoDias = {
                    0: 'LUNES',    // JavaScript Sunday (0) -> LUNES (índice 0)
                    1: 'MARTES',   // JavaScript Monday (1) -> MARTES (índice 1)
                    2: 'MIERCOLES', // JavaScript Tuesday (2) -> MIERCOLES (índice 2)
                    3: 'JUEVES',   // JavaScript Wednesday (3) -> JUEVES (índice 3)
                    4: 'VIERNES',  // JavaScript Thursday (4) -> VIERNES (índice 4)
                    5: 'SABADO',   // JavaScript Friday (5) -> SABADO (índice 5)
                    6: 'DOMINGO'   // JavaScript Saturday (6) -> DOMINGO (índice 6)
                };
                
                const diaResultado = mapeoDias[diaIndex];
                console.log(`🗓️ Fecha: ${fecha}, getDay(): ${diaIndex}, Mapeado a: ${diaResultado}`);
                return diaResultado;
            };

            const calcularVentasConFormulaCorrecta = (stockAnterior, ingresoActual, stockActual) => {
                // Fórmula correcta: Ventas = (Stock Final día anterior + Ingreso de Mercadería) - Stock Final de hoy
                const ventas = {};
                
                if (!stockAnterior.productos || !ingresoActual.productos || !stockActual.productos) {
                    return ventas;
                }
                
                // Crear mapas de productos para fácil acceso
                const stockAnteriorMap = {};
                const ingresoMap = {};
                const stockActualMap = {};
                
                stockAnterior.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte después del " - "
                    stockAnteriorMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                ingresoActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte después del " - "
                    ingresoMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                stockActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte después del " - "
                    stockActualMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                // Calcular ventas para cada producto usando la fórmula correcta
                const todosProductos = new Set([
                    ...Object.keys(stockAnteriorMap), 
                    ...Object.keys(ingresoMap), 
                    ...Object.keys(stockActualMap)
                ]);
                
                todosProductos.forEach(producto => {
                    const stockAnt = stockAnteriorMap[producto] || 0;
                    const ingreso = ingresoMap[producto] || 0;
                    const stockAct = stockActualMap[producto] || 0;
                    
                    // Fórmula: (Stock Final día anterior + Ingreso de Mercadería) - Stock Final de hoy
                    const venta = (stockAnt + ingreso) - stockAct;
                    
                    // Log específico para CRIOLLITO
                    if (producto.includes('Criollito') || producto.includes('CRIOLLITO')) {
                        console.log(`🔍 CRIOLLITO DEBUG - Producto: ${producto}`);
                        console.log(`🔍 CRIOLLITO DEBUG - Stock Ant: ${stockAnt}, Ingreso: ${ingreso}, Stock Act: ${stockAct}`);
                        console.log(`🔍 CRIOLLITO DEBUG - Venta calculada: ${venta}`);
                        console.log(`🔍 CRIOLLITO DEBUG - Stock Anterior Map keys:`, Object.keys(stockAnteriorMap));
                        console.log(`🔍 CRIOLLITO DEBUG - Ingreso Map keys:`, Object.keys(ingresoMap));
                        console.log(`🔍 CRIOLLITO DEBUG - Stock Actual Map keys:`, Object.keys(stockActualMap));
                    }
                    
                    // Solo incluir si hay venta positiva
                    if (venta > 0) {
                        ventas[producto] = venta;
                    }
                });
                
                return ventas;
            };

            const procesarProductos = (productos) => {
                const ventas = {};
                if (Array.isArray(productos)) {
                    productos.forEach(producto => {
                        const nombreCompleto = producto.nombre;
                        // Usar el nombre completo como en la APK, no extraer solo la parte después del " - "
                        ventas[nombreCompleto] = producto.cantidad || 0;
                    });
                }
                return ventas;
            };

            const diasSemana = ['LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB', 'DOM'];
            const diasCompletos = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
            
            // Función para obtener abreviación - EXACTO como Android línea 559-584
            const obtenerAbreviacion = (nombreCompleto) => {
                if (nombreCompleto.startsWith('JQ')) return 'JQ';
                if (nombreCompleto.startsWith('PB')) return 'PB';
                if (nombreCompleto.startsWith('CS')) return 'CS';
                if (nombreCompleto.startsWith('PO')) return 'PO';
                if (nombreCompleto.startsWith('CP')) return 'CP';
                if (nombreCompleto.startsWith('HU')) return 'HU';
                if (nombreCompleto.startsWith('ES')) return 'ES';
                if (nombreCompleto.startsWith('CQ')) return 'CQ';
                if (nombreCompleto.startsWith('RJ')) return 'RJ';
                if (nombreCompleto.startsWith('QC')) return 'QC';
                if (nombreCompleto.startsWith('CB')) return 'CB';
                if (nombreCompleto.startsWith('CH -')) return 'CH';
                if (nombreCompleto.startsWith('MUZZARE')) return 'MUZZA';
                if (nombreCompleto.startsWith('JAMON')) return 'JAMON';
                if (nombreCompleto.startsWith('PEPPERO')) return 'PEPPER';
                if (nombreCompleto.startsWith('BATATA')) return 'BATATA';
                if (nombreCompleto.startsWith('MEMBRIL')) return 'MEMBRIL';
                if (nombreCompleto.startsWith('DULCES')) return 'DULCES';
                if (nombreCompleto.startsWith('SALADO')) return 'SALADO';
                if (nombreCompleto.startsWith('CHIPA')) return 'CHIPA';
                if (nombreCompleto.startsWith('CRIOLLITO')) return 'CRIOLLITO';
                return nombreCompleto;
            };
            
            const productosPorCategoria = {
                'EMPANADAS': [
                    'JQ - Jamón y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jamón', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                ],
                'PIZZAS': ['MUZZARE - Muzzarella', 'JAMON - Jamón', 'PEPPERO - Pepperoni'],
                'PASTELITOS': ['BATATA - Batata', 'MEMBRIL - Membrillo'],
                'OTROS': ['DULCES - Dulces', 'SALADO - Salado', 'CHIPA - Chipa', 'CRIOLLITO - Criollito']
            };

            if (cargando) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">📊</div>
                            <div className="text-lg font-bold text-black">Calculando promedios...</div>
                                        </div>
                                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">❌</div>
                            <div className="text-lg font-bold text-red-600 mb-4">{error}</div>
                                    <button
                                onClick={onVolver}
                                className="px-4 py-2 bg-blue-500 text-white rounded"
                                    >
                                Volver
                                    </button>
                                </div>
                            </div>
                );
            }

            // Función helper para obtener fecha Argentina
            const getFechaArgentina = () => {
                return window.getFechaArgentina ? window.getFechaArgentina() : new Date();
            };

            // Función helper para convertir fecha a ISO
            const fechaISO = (fecha) => {
                if (typeof fecha === 'string') return fecha;
                const año = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                return `${año}-${mes}-${dia}`;
            };

            // Función para mostrar menú de promedios
            const mostrarMenuPromedios = () => {
                setVistaMenu(true);
            };

            // Función para mostrar promedio general
            const mostrarPromedioGeneral = async () => {
                setRegistrosFiltrados(registrosCache);
                setPeriodoActual('General - Todos los registros');
                const promediosCalculados = calcularPromediosPorDia(registrosCache);
                setPromedios(promediosCalculados);
                setVistaMenu(false);
            };

            // Función para mostrar última semana
            const mostrarPromedioUltimaSemana = async () => {
                const hoy = getFechaArgentina();
                const diaSemanaActual = hoy.getDay();
                const diasHastaLunes = diaSemanaActual === 0 ? 6 : diaSemanaActual - 1;
                
                // Ir al lunes de la semana actual
                const lunesActual = new Date(hoy);
                lunesActual.setDate(lunesActual.getDate() - diasHastaLunes);
                lunesActual.setHours(0, 0, 0, 0);
                
                // Ir al lunes de la semana anterior (7 días antes)
                const lunesAnterior = new Date(lunesActual);
                lunesAnterior.setDate(lunesAnterior.getDate() - 7);
                
                // Ir al domingo de la semana anterior
                const domingoAnterior = new Date(lunesAnterior);
                domingoAnterior.setDate(domingoAnterior.getDate() + 6);
                domingoAnterior.setHours(23, 59, 59, 999);
                
                const fechaInicio = fechaISO(lunesAnterior);
                const fechaFin = fechaISO(domingoAnterior);
                
                const registrosFiltrados = registrosCache.filter(registro => {
                    const fechaRegistro = registro.fecha;
                    return fechaRegistro >= fechaInicio && fechaRegistro <= fechaFin;
                });
                
                setRegistrosFiltrados(registrosFiltrados);
                setPeriodoActual('Última Semana');
                const promediosCalculados = calcularPromediosPorDia(registrosFiltrados);
                setPromedios(promediosCalculados);
                setVistaMenu(false);
            };

            // Función para mostrar mes actual
            const mostrarPromedioMesActual = async () => {
                const hoy = getFechaArgentina();
                const mesActual = hoy.getMonth();
                const añoActual = hoy.getFullYear();
                
                const registrosFiltrados = registrosCache.filter(registro => {
                    const fechaRegistro = new Date(registro.fecha);
                    return fechaRegistro.getMonth() === mesActual && fechaRegistro.getFullYear() === añoActual;
                });
                
                const nombreMes = hoy.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
                setRegistrosFiltrados(registrosFiltrados);
                setPeriodoActual(nombreMes);
                const promediosCalculados = calcularPromediosPorDia(registrosFiltrados);
                setPromedios(promediosCalculados);
                setVistaMenu(false);
            };

            // Función para mostrar semana específica (selector de rango de fechas)
            const mostrarPromedioSemanaEspecifica = () => {
                // Crear modal para seleccionar rango de fechas
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;overflow-y:auto;padding:20px;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:12px;padding:24px;max-width:500px;width:100%;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin:auto;';
                
                let fechaDesde = null;
                let fechaHasta = null;
                let seleccionandoDesde = true;
                
                // Función para formatear fecha DD/MM/YYYY
                const formatoFecha = (fecha) => {
                    if (!fecha) return 'Seleccionar fecha';
                    const dia = String(fecha.getDate()).padStart(2, '0');
                    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                    return `${dia}/${mes}/${fecha.getFullYear()}`;
                };
                
                // Función para actualizar el texto de las fechas
                const actualizarFechasTexto = () => {
                    const txtDesde = document.getElementById('txt-fecha-desde');
                    const txtHasta = document.getElementById('txt-fecha-hasta');
                    if (txtDesde) txtDesde.textContent = formatoFecha(fechaDesde);
                    if (txtHasta) txtHasta.textContent = formatoFecha(fechaHasta);
                };
                
                const hoy = getFechaArgentina();
                const fechaDefault = fechaISO(hoy);
                
                modal.innerHTML = `
                    <h2 style="font-size:20px;font-weight:bold;margin-bottom:16px;color:#7C3AED;text-align:center">🗓️ Seleccionar Rango de Fechas</h2>
                    
                    <!-- Botones rápidos -->
                    <div style="display:flex;gap:8px;margin-bottom:20px">
                        <button 
                            id="btn-ultimos-7-dias"
                            style="flex:1;padding:10px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px"
                        >
                            Últimos 7 días
                        </button>
                        <button 
                            id="btn-ultimos-30-dias"
                            style="flex:1;padding:10px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px"
                        >
                            Últimos 30 días
                        </button>
                    </div>
                    
                    <!-- Fechas seleccionadas -->
                    <div style="display:flex;gap:12px;margin-bottom:20px">
                        <div style="flex:1">
                            <label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:#6b7280">Desde:</label>
                            <div 
                                id="txt-fecha-desde"
                                style="padding:10px;border:2px solid ${seleccionandoDesde ? '#7C3AED' : '#d1d5db'};border-radius:8px;font-size:14px;text-align:center;background:${seleccionandoDesde ? '#f3f4f6' : 'white'};cursor:pointer;min-height:20px"
                            >
                                Seleccionar fecha
                            </div>
                        </div>
                        <div style="flex:1">
                            <label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:#6b7280">Hasta:</label>
                            <div 
                                id="txt-fecha-hasta"
                                style="padding:10px;border:2px solid ${!seleccionandoDesde ? '#7C3AED' : '#d1d5db'};border-radius:8px;font-size:14px;text-align:center;background:${!seleccionandoDesde ? '#f3f4f6' : 'white'};cursor:pointer;min-height:20px"
                            >
                                Seleccionar fecha
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selectores de fecha -->
                    <div style="display:flex;gap:12px;margin-bottom:20px">
                        <div style="flex:1">
                            <label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:#6b7280">Fecha Desde:</label>
                            <input 
                                type="date" 
                                id="input-fecha-desde" 
                                style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box"
                            />
                        </div>
                        <div style="flex:1">
                            <label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:#6b7280">Fecha Hasta:</label>
                            <input 
                                type="date" 
                                id="input-fecha-hasta" 
                                style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box"
                            />
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div style="display:flex;gap:8px">
                        <button 
                            id="btn-cancelar-rango"
                            style="flex:1;padding:12px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px"
                        >
                            Cancelar
                        </button>
                        <button 
                            id="btn-aplicar-rango"
                            style="flex:1;padding:12px;background:#7C3AED;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px"
                        >
                            Aplicar
                        </button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                const txtFechaDesde = document.getElementById('txt-fecha-desde');
                const txtFechaHasta = document.getElementById('txt-fecha-hasta');
                const inputFechaDesde = document.getElementById('input-fecha-desde');
                const inputFechaHasta = document.getElementById('input-fecha-hasta');
                
                // Cuando cambia el input de fecha desde
                inputFechaDesde.onchange = (e) => {
                    if (e.target.value) {
                        const [y, m, d] = e.target.value.split('-').map(Number);
                        fechaDesde = new Date(y, m - 1, d);
                        fechaDesde.setHours(0, 0, 0, 0);
                        seleccionandoDesde = false;
                        actualizarFechasTexto();
                        // Actualizar estilo
                        txtFechaDesde.style.borderColor = '#d1d5db';
                        txtFechaDesde.style.background = 'white';
                        txtFechaHasta.style.borderColor = '#7C3AED';
                        txtFechaHasta.style.background = '#f3f4f6';
                    }
                };
                
                // Cuando cambia el input de fecha hasta
                inputFechaHasta.onchange = (e) => {
                    if (e.target.value) {
                        const [y, m, d] = e.target.value.split('-').map(Number);
                        fechaHasta = new Date(y, m - 1, d);
                        fechaHasta.setHours(23, 59, 59, 999);
                        
                        // Asegurar que fechaDesde <= fechaHasta
                        if (fechaDesde && fechaDesde.getTime() > fechaHasta.getTime()) {
                            const temp = fechaDesde;
                            fechaDesde = fechaHasta;
                            fechaHasta = temp;
                            inputFechaDesde.value = fechaISO(fechaDesde);
                            inputFechaHasta.value = fechaISO(fechaHasta);
                        }
                        
                        seleccionandoDesde = true;
                        actualizarFechasTexto();
                        // Actualizar estilo
                        txtFechaHasta.style.borderColor = '#d1d5db';
                        txtFechaHasta.style.background = 'white';
                        txtFechaDesde.style.borderColor = '#7C3AED';
                        txtFechaDesde.style.background = '#f3f4f6';
                    }
                };
                
                // Click en texto de fecha desde
                txtFechaDesde.onclick = () => {
                    inputFechaDesde.showPicker();
                };
                
                // Click en texto de fecha hasta
                txtFechaHasta.onclick = () => {
                    inputFechaHasta.showPicker();
                };
                
                // Botón últimos 7 días
                document.getElementById('btn-ultimos-7-dias').onclick = () => {
                    fechaHasta = new Date(hoy);
                    fechaHasta.setHours(23, 59, 59, 999);
                    
                    fechaDesde = new Date(hoy);
                    fechaDesde.setDate(fechaDesde.getDate() - 6);
                    fechaDesde.setHours(0, 0, 0, 0);
                    
                    inputFechaDesde.value = fechaISO(fechaDesde);
                    inputFechaHasta.value = fechaISO(fechaHasta);
                    seleccionandoDesde = true;
                    actualizarFechasTexto();
                };
                
                // Botón últimos 30 días
                document.getElementById('btn-ultimos-30-dias').onclick = () => {
                    fechaHasta = new Date(hoy);
                    fechaHasta.setHours(23, 59, 59, 999);
                    
                    fechaDesde = new Date(hoy);
                    fechaDesde.setDate(fechaDesde.getDate() - 29);
                    fechaDesde.setHours(0, 0, 0, 0);
                    
                    inputFechaDesde.value = fechaISO(fechaDesde);
                    inputFechaHasta.value = fechaISO(fechaHasta);
                    seleccionandoDesde = true;
                    actualizarFechasTexto();
                };
                
                // Botón cancelar
                document.getElementById('btn-cancelar-rango').onclick = () => {
                    document.body.removeChild(overlay);
                };
                
                // Botón aplicar
                document.getElementById('btn-aplicar-rango').onclick = () => {
                    if (!fechaDesde || !fechaHasta) {
                        alert('Por favor selecciona ambas fechas (desde y hasta)');
                        return;
                    }
                    
                    const fechaDesdeStr = fechaISO(fechaDesde);
                    const fechaHastaStr = fechaISO(fechaHasta);
                    
                    // Filtrar registros del rango
                    const registrosFiltrados = registrosCache.filter(registro => {
                        const fechaRegistro = registro.fecha;
                        return fechaRegistro >= fechaDesdeStr && fechaRegistro <= fechaHastaStr;
                    });
                    
                    // Formatear período
                    const periodoTexto = `${formatoFecha(fechaDesde)} a ${formatoFecha(fechaHasta)}`;
                    
                    setRegistrosFiltrados(registrosFiltrados);
                    setPeriodoActual(periodoTexto);
                    const promediosCalculados = calcularPromediosPorDia(registrosFiltrados);
                    setPromedios(promediosCalculados);
                    setVistaMenu(false);
                    
                    // Cerrar modal
                    document.body.removeChild(overlay);
                };
                
                // Cerrar al hacer clic fuera del modal
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                };
            };

            // Si está en vista de menú, mostrar menú
            if (vistaMenu) {
                return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con botón volver */}
                        <div className="flex justify-between items-center mb-4">
                            <button 
                                onClick={onVolver}
                                className="text-2xl font-bold text-black"
                            >
                                ← Volver
                            </button>
                            <h1 className="text-xl font-bold text-black">Venta por Volumen</h1>
                            <div></div>
                        </div>

                        {/* Switch para cambiar vista */}
                        <div className="bg-white rounded-lg p-4 mb-4">
                            <div className="flex items-center justify-between">
                                <span className="text-base font-semibold text-black">Vista de Tabla</span>
                                <div 
                                    onClick={() => setVistaMenu(!vistaMenu)}
                                    style={{
                                        width: '44px',
                                        height: '24px',
                                        backgroundColor: !vistaMenu ? '#3B82F6' : '#d1d5db',
                                        borderRadius: '12px',
                                        position: 'relative',
                                        cursor: 'pointer',
                                        transition: 'background-color 0.2s'
                                    }}
                                >
                                    <div style={{
                                        position: 'absolute',
                                        top: '2px',
                                        left: !vistaMenu ? 'calc(100% - 22px)' : '2px',
                                        width: '20px',
                                        height: '20px',
                                        backgroundColor: 'white',
                                        borderRadius: '50%',
                                        transition: 'left 0.2s',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                    }}></div>
                                </div>
                            </div>
                        </div>

                        {/* Menú de promedios */}
                        <div className="bg-white rounded-lg p-6">
                            <div className="text-center mb-6">
                                <h2 className="text-2xl font-bold" style={{color: '#7C3AED'}}>📊 MENÚ DE PROMEDIOS</h2>
                                <p className="text-sm text-gray-600 mt-2">Selecciona una opción para ver los promedios de ventas</p>
                            </div>

                            <div className="space-y-3">
                                <button
                                    onClick={mostrarPromedioGeneral}
                                    className="w-full p-4 text-white font-bold rounded-lg"
                                    style={{backgroundColor: '#7C3AED'}}
                                >
                                    📈 PROMEDIO GENERAL
                                </button>

                                <button
                                    onClick={mostrarPromedioUltimaSemana}
                                    className="w-full p-4 text-white font-bold rounded-lg"
                                    style={{backgroundColor: '#2E7D32'}}
                                >
                                    📅 ÚLTIMA SEMANA
                                </button>

                                <button
                                    onClick={mostrarPromedioSemanaEspecifica}
                                    className="w-full p-4 text-white font-bold rounded-lg"
                                    style={{backgroundColor: '#0288D1'}}
                                >
                                    🗓️ SEMANA ESPECÍFICA
                                </button>

                                <button
                                    onClick={mostrarPromedioMesActual}
                                    className="w-full p-4 text-white font-bold rounded-lg"
                                    style={{backgroundColor: '#C62828'}}
                                >
                                    📆 MES ACTUAL
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '4px', width: '100%'}}>
                    {/* Header con botón volver */}
                    <div className="flex justify-between items-center mb-2" style={{padding: '4px'}}>
                        <button 
                            onClick={onVolver}
                            className="text-xl font-bold text-black"
                            style={{padding: '4px'}}
                        >
                            ← Volver
                        </button>
                        <h1 className="text-lg font-bold text-black">Venta por Volumen</h1>
                        <div></div>
                        </div>

                    {/* Switch para cambiar vista */}
                    <div className="bg-white rounded-lg mb-2" style={{padding: '8px'}}>
                        <div className="flex items-center justify-between">
                            <span className="text-sm font-semibold text-black">Vista de Tabla</span>
                            <div 
                                onClick={() => setVistaMenu(!vistaMenu)}
                                style={{
                                    width: '44px',
                                    height: '24px',
                                    backgroundColor: !vistaMenu ? '#3B82F6' : '#d1d5db',
                                    borderRadius: '12px',
                                    position: 'relative',
                                    cursor: 'pointer',
                                    transition: 'background-color 0.2s'
                                }}
                            >
                                <div style={{
                                    position: 'absolute',
                                    top: '2px',
                                    left: !vistaMenu ? 'calc(100% - 22px)' : '2px',
                                    width: '20px',
                                    height: '20px',
                                    backgroundColor: 'white',
                                    borderRadius: '50%',
                                    transition: 'left 0.2s',
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                }}></div>
                            </div>
                        </div>
                    </div>

                    {/* Tabla de promedios - EXACTO como PromedioVentasActivity.kt */}
                    <div className="bg-white rounded-lg" style={{minHeight: 'calc(100vh - 150px)', width: '100%', padding: '8px'}}>
                        {/* Indicador de período */}
                        <div 
                            className="text-center mb-2"
                            style={{color: '#7C3AED', fontSize: '16px', fontWeight: 'bold', padding: '8px'}}
                        >
                            PROMEDIO: {periodoActual}
                        </div>

                        {/* Indicador de local - EXACTO como Android línea 146-154 */}
                        <div 
                            className="text-center mb-2"
                            style={{color: '#2196F3', fontSize: '14px', fontWeight: 'bold', padding: '4px'}}
                        >
                            LOCAL: {usuario.localNombre}
                                </div>
                        
                        {/* Título principal - EXACTO como Android línea 156-163 */}
                        <div 
                            className="text-center mb-2"
                            style={{color: '#4CAF50', fontSize: '18px', fontWeight: 'bold', padding: '8px'}}
                        >
                            PROMEDIO DE VENTA POR DÍA
                                </div>
                            
                        <div className="ventas-scroll" style={{width: '100%'}}><div className="ventas-grid">
                        {/* Header de la tabla - Responsive: PC normal, móvil compacto */}
                        <div 
                            className="flex text-white font-bold mb-2 ventas-header"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '4px 4px 0 0'
                            }}
                        >
                            <div className="border-r border-blue-300 ventas-name" style={{flex: '1.2'}}>TIPO</div>
                            {diasSemana.map((dia, index) => (
                                <div 
                                    key={dia} 
                                    className={`text-center ventas-cell ${index < diasSemana.length - 1 ? 'border-r border-blue-300' : ''}`} 
                                    style={{flex: '0.8'}}
                                >
                                    {dia}
                            </div>
                            ))}
                        </div>

                        {/* Productos por categoría con iconos y separaciones */}
                        {Object.entries(productosPorCategoria).map(([categoria, productos]) => (
                            <div key={categoria}>
                                {/* Header de categoría con icono - EXACTO como Android línea 447-490 */}
                                <div 
                                    className="flex items-center justify-between text-white font-bold mb-2 mt-2"
                                    style={{
                                        backgroundColor: categoria === 'EMPANADAS' ? '#FF6B6B' : 
                                                       categoria === 'PIZZAS' ? '#4CAF50' : 
                                                       categoria === 'PASTELITOS' ? '#FF9800' : '#9C27B0',
                                        borderRadius: '8px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                        padding: '12px'
                                    }}
                                >
                                    <span style={{fontSize: '16px'}}>
                                        {categoria === 'EMPANADAS' ? '🥟' : 
                                         categoria === 'PIZZAS' ? '🍕' : 
                                         categoria === 'PASTELITOS' ? '🥧' : '🍬'} {categoria}
                                    </span>
                                    <span style={{fontSize: '10px', padding: '2px 4px', borderRadius: '4px', backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        {productos.length} productos
                                    </span>
                    </div>

                                {/* Productos de la categoría - EXACTO como Android línea 495-497 */}
                                <div className="mb-2" style={{backgroundColor: '#F8F9FA', borderRadius: '8px', padding: '8px'}}>
                                    {productos.map((producto, index) => {
                                        // Usar abreviación como en Android línea 515
                                        const nombreAbreviado = obtenerAbreviacion(producto);
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex mb-1 ventas-row"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '4px',
                                                    margin: '2px'
                                                }}
                                            >
                                                <div 
                                                    className="text-left text-black border-r border-gray-300 ventas-name" 
                                                    style={{flex: '1.2'}}
                                                >
                                                    {nombreAbreviado}
                </div>
                                                {diasCompletos.map((diaCompleto, diaIndex) => {
                                                    const valor = promedios[diaCompleto]?.[producto] || 0;
                                                    
                                                    // Log para debug
                                                    if (producto.includes('CRIOLLITO')) {
                                                        console.log(`🔍 CRIOLLITO - ${diaCompleto} (índice ${diaIndex}): ${valor}`);
                                                        console.log(`🔍 Promedios disponibles para ${diaCompleto}:`, promedios[diaCompleto]);
                                                    }
                                                    
                                                    return (
                                                        <div 
                                                            key={diaCompleto} 
                                                            className={`text-center text-black ventas-cell ${diaIndex < diasCompletos.length - 1 ? 'border-r border-gray-300' : ''}`} 
                                                            style={{flex: '0.8'}}
                                                        >
                                                            {valor > 0 ? Math.round(valor) : '-'}
                </div>
            );
                                                })}
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Total de empanadas - Responsive: PC normal, móvil compacto */}
                                    {categoria === 'EMPANADAS' && (
                                        <div 
                                            className="flex text-white font-bold mt-2 ventas-row"
                                            style={{
                                                backgroundColor: '#4CAF50',
                                                border: '1px solid #388E3C',
                                                borderRadius: '4px'
                                            }}
                                        >
                                            <div className="border-r border-green-300 ventas-name" style={{flex: '1.2'}}>TOTAL</div>
                                            {diasCompletos.map((diaCompleto, index) => {
                                                const totalDia = productos.reduce((acc, producto) => {
                                                    return acc + (promedios[diaCompleto]?.[producto] || 0);
                                                }, 0);
                                                
                                                // Log para debug del total
                                                console.log(`🔍 TOTAL ${diaCompleto} (índice ${index}): ${totalDia}`);
                                                
                                                return (
                                                    <div 
                                                        key={diaCompleto} 
                                                        className={`text-center ventas-cell ${index < diasCompletos.length - 1 ? 'border-r border-green-300' : ''}`} 
                                                        style={{flex: '0.8'}}
                                                    >
                                                        {totalDia > 0 ? Math.round(totalDia) : '-'}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        </div></div>
                    </div>
                </div>
            );
        };

        // App Component
        function App() {
            const [usuario, setUsuario] = useState(null);
            const [loading, setLoading] = useState(true);
            const [vistaActual, setVistaActual] = useState('login');

            useEffect(() => {
                // EXACTO como Android LoginActivity.onCreate(): 
                // NO verificar sesión activa, NO hacer login automático
                // Siempre mostrar pantalla de login, solo cargar credenciales guardadas en los campos
                setLoading(false);
            }, []);

            // Manejar navegación por hash
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash;
                    console.log('🔗 Hash cambiado:', hash, 'Usuario:', usuario, 'VistaActual:', vistaActual);
                    
                    // Solo manejar cambios de hash que vienen del navegador (no de cambios programáticos)
                    // Los cambios programáticos (como en handleLoginSuccess) ya establecen vistaActual directamente
                    if (hash === '#gestion-locales' && vistaActual !== 'gestion-locales') {
                        setVistaActual('gestion-locales');
                    } else if (hash === '#main' && vistaActual !== 'main') {
                        setVistaActual('main');
                    } else if (!hash && !usuario && vistaActual !== 'login') {
                        setVistaActual('login');
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                // Solo ejecutar al cargar si no hay vistaActual establecida
                if (!vistaActual || vistaActual === 'login') {
                    handleHashChange();
                }

                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []); // Sin dependencias - solo escuchar cambios de hash del navegador

            const handleLoginSuccess = (usuarioData) => {
                console.log('🚀 handleLoginSuccess llamado con:', usuarioData);
                
                if (!usuarioData) {
                    console.error('❌ ERROR: usuarioData es null o undefined');
                    alert('Error: No se pudo obtener los datos del usuario. Por favor, intenta nuevamente.');
                    return;
                }
                
                const rol = usuarioData.rol || '';
                console.log('🔍 Rol del usuario:', rol);
                
                // Guardar en localStorage (igual que Android SharedPreferences)
                localStorage.setItem('usuario', JSON.stringify(usuarioData));
                
                // Guardar en usuario_actual con el mismo formato que Android SharedPreferences
                const usuarioActualData = {
                    localId: usuarioData.localId || '',
                    localNombre: usuarioData.localNombre || '',
                    usuarioId: usuarioData.usuarioId || '',
                    usuario: usuarioData.usuario || '',
                    rol: rol,
                    localesAsignados: usuarioData.localesAsignados ? usuarioData.localesAsignados.join(',') : '',
                    regionId: usuarioData.regionId || ''
                };
                localStorage.setItem('usuario_actual', JSON.stringify(usuarioActualData));
                console.log('💾 Usuario guardado en usuario_actual:', usuarioActualData);
                
                // Navegación según rol (EXACTO como Android)
                // IMPORTANTE: Establecer vistaActual ANTES de setUsuario para evitar conflictos
                if (rol === 'maestro') {
                    console.log('🔑 Login como MAESTRO:', usuarioData.usuario);
                    setVistaActual('gestion-locales');
                    window.location.hash = '#gestion-locales';
                    setUsuario(usuarioData);
                    console.log('✅ Redirigiendo a Gestión de Locales (maestro)');
                } else if (rol === 'supervisor') {
                    console.log('👤 Login como SUPERVISOR:', usuarioData.usuario);
                    setVistaActual('gestion-locales');
                    window.location.hash = '#gestion-locales';
                    setUsuario(usuarioData);
                    console.log('✅ Redirigiendo a Gestión de Locales (supervisor)');
                } else if (rol === 'admin_local') {
                    console.log('🏪 Login como LOCAL:', usuarioData.localNombre);
                    if (!usuarioData.localId) {
                        console.error('❌ ERROR: usuarioData no tiene localId:', usuarioData);
                        alert('Error: No se pudo obtener el ID del local. Por favor, intenta nuevamente.');
                        return;
                    }
                    setVistaActual('main');
                    window.location.hash = '#main';
                    setUsuario(usuarioData);
                    console.log('✅ Redirigiendo a Main (admin_local)');
                } else {
                    console.error('❌ ERROR: Rol desconocido:', rol);
                    alert('Error: Rol de usuario no reconocido. Por favor, contacta al administrador.');
                }
            };

            const handleLogout = async () => {
                // Cerrar sesión de Firebase Auth
                try {
                    const auth = FirebaseRegionManager.getAuth();
                    if (auth.currentUser) {
                        console.log('🚪 Cerrando sesión de Firebase Auth');
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('Error cerrando sesión de Firebase Auth:', error);
                }
                
                // EXACTO como Android: Solo limpiar usuario, NO limpiar región ni loginData
                // La región y los datos de login (si se marcó "Recordar") se mantienen guardados
                localStorage.removeItem('usuario');
                localStorage.removeItem('usuario_actual');
                // NO limpiar 'loginData' - se mantiene si el usuario marcó "Recordar local y contraseña"
                // NO limpiar 'region_id' ni 'firebase_region_prefs' - se mantiene como en Android
                setUsuario(null);
                setVistaActual('login');
                window.location.hash = '';
                console.log('🚪 Logout realizado - loginData y región se mantienen guardados');
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            console.log('🎯 App render - usuario:', usuario, 'vistaActual:', vistaActual);

            // EXACTO como Android: GestionLocales se puede mostrar sin usuario (lo lee de localStorage)
            if (vistaActual === 'gestion-locales') {
                console.log('✅ Renderizando GestionLocales');
                return <GestionLocales 
                    onVolver={() => {
                        // EXACTO como Android: Volver al login SIN limpiar región ni usuario_actual
                        // El usuario_actual se mantiene para poder volver a Gestión de Locales
                        console.log('🔄 Volviendo al Login (manteniendo región y usuario_actual)');
                        setUsuario(null);
                        setVistaActual('login');
                        window.location.hash = '';
                    }} 
                    onLoginSuccess={handleLoginSuccess}
                />;
            }

            if (usuario && vistaActual === 'main') {
                console.log('✅ Renderizando Main');
                return <Main 
                    usuario={usuario} 
                    onLogout={handleLogout} 
                    onVolverGestion={() => {
                        console.log('🔄 Volviendo a Gestión de Locales');
                        setVistaActual('gestion-locales');
                        window.location.hash = '#gestion-locales';
                    }}
                />;
            }

            return <Login onLoginSuccess={handleLoginSuccess} />;
        }

        // Usar createRoot en lugar de ReactDOM.render (React 18)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<script>
// Inline Vencimientos (sin archivo externo)
(function () {
  // Utils
  const normalizar = (c) => {
    if (!c) return c;
    const up = String(c).toUpperCase();
    if (up === 'PEPPERO') return 'PEPPER';
    if (up === 'MUZZARE') return 'MUZZA';
    return up;
  };
  // Usar las funciones globales definidas arriba
  const getFechaArgentina = window.getFechaArgentina || (() => new Date());
  const getFechaActualArgentina = window.getFechaActualArgentina || (() => new Date().toISOString().split('T')[0]);
  const formatearFechaArgentina = window.formatearFechaArgentina || ((f) => f || new Date());
  const getTimestampArgentina = window.getTimestampArgentina || (() => new Date().toISOString());

  const fechaISO = (d) => {
    if (!d) d = getFechaArgentina();
    // Asegurar que trabajamos con fecha en zona horaria de Argentina
    const fechaArg = formatearFechaArgentina(d);
    const año = fechaArg.getFullYear();
    const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
    const dia = String(fechaArg.getDate()).padStart(2, '0');
    return `${año}-${mes}-${dia}`;
  };

  // Orden de productos igual a la APK (lista desplegable de productos del local)
  const orderCache = {};
  async function getProductosOrder(localId) {
    if (orderCache[localId]) return orderCache[localId];
    try {
      const snap = await db
        .collection('locales')
        .doc(localId)
        .collection('productos')
        .get();
      const arr = [];
      snap.forEach((d) => arr.push(d.data()?.nombre || d.id));
      const map = {};
      arr.forEach((nombre, i) => (map[normalizar(nombre)] = i));
      orderCache[localId] = map;
      return map;
    } catch (e) {
      orderCache[localId] = {};
      return {};
    }
  }

  async function getHistorial(localId, fecha) {
    try {
      if (!localId || !fecha) {
        console.warn('⚠️ getHistorial: localId o fecha vacíos', { localId, fecha });
        return { lotesIniciales: [], lotesFinales: [] };
      }
      console.log('🔍 Buscando historial en: locales/' + localId + '/vencimientos_historial_diario/' + fecha);
      const db = FirebaseRegionManager.getFirestore();
      const doc = await db
        .collection('locales')
        .doc(localId)
        .collection('vencimientos_historial_diario')
        .doc(fecha)
        .get();
      
      if (!doc.exists) {
        console.log('📭 No existe registro para fecha:', fecha);
        return null; // Retornar null cuando no existe registro
      }
      
      const data = { id: doc.id, ...doc.data() };
      console.log('✅ Registro encontrado:', data);
      
      // Normalizar lotes iniciales y finales
      data.lotesIniciales = Array.isArray(data.lotesIniciales)
        ? data.lotesIniciales.map((l) => {
            const codigoRaw = l.productoCodigo || l.codigo || '';
            return { ...l, codigo: normalizar(codigoRaw) };
          })
        : [];
      data.lotesFinales = Array.isArray(data.lotesFinales)
        ? data.lotesFinales.map((l) => {
            const codigoRaw = l.productoCodigo || l.codigo || '';
            return { ...l, codigo: normalizar(codigoRaw) };
          })
        : [];
      
      console.log('📦 Lotes iniciales:', data.lotesIniciales.length, 'Lotes finales:', data.lotesFinales.length);
      return data;
    } catch (e) {
      console.error('❌ Error obteniendo historial:', e);
      return null; // Retornar null en caso de error
    }
  }

  function groupAndSort(lotes, fecha, soloHoy, orderMap) {
    const byProd = {};
    lotes.forEach((l) => {
      if (soloHoy) {
        if (!l.fechaVencimiento) return;
        // Comparar directamente las cadenas de fecha sin conversión a Date
        // para evitar problemas de zona horaria
        // l.fechaVencimiento ya viene en formato "YYYY-MM-DD" desde Firebase
        const fechaVencStr = l.fechaVencimiento.split('T')[0]; // Extraer solo la parte de fecha si viene con hora
        if (fechaVencStr !== fecha) return;
      }
      const key = l.codigo || 'DESCONOCIDO';
      (byProd[key] = byProd[key] || []).push(l);
    });
    return Object.keys(byProd)
      .sort((a, b) => {
        const ia = (orderMap && (a in orderMap)) ? orderMap[a] : Number.MAX_SAFE_INTEGER;
        const ib = (orderMap && (b in orderMap)) ? orderMap[b] : Number.MAX_SAFE_INTEGER;
        if (ia !== ib) return ia - ib;
        return a.localeCompare(b);
      })
      .map((codigo) => ({
        codigo,
        lotes: byProd[codigo].sort((a, b) => {
          const ta = a.fechaVencimiento ? new Date(a.fechaVencimiento).getTime() : 0;
          const tb = b.fechaVencimiento ? new Date(b.fechaVencimiento).getTime() : 0;
          return ta - tb;
        }),
      }));
  }

  function renderSection(container, title, groups) {
    const wrap = document.createElement('div');
    wrap.style.cssText = 'border:2px solid #e5e7eb;border-radius:12px;margin:16px 0;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.08);overflow:hidden;transition:all 0.3s';
    const header = document.createElement('button');
    header.type = 'button';
    const isInicio = title.includes('INICIO');
    const icono = isInicio ? '🌅' : '🌇';
    const colorBg = isInicio ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    header.innerHTML = '<span style="font-size:20px;margin-right:8px">' + icono + '</span><span style="font-size:18px;font-weight:700">' + title + '</span><span style="margin-left:auto;font-size:14px;opacity:0.8">(' + groups.length + ' productos)</span>';
    header.style.cssText = 'width:100%;text-align:left;background:' + colorBg + ';color:#fff;font-weight:600;padding:16px 20px;border:none;cursor:pointer;display:flex;align-items:center;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.1)';
    header.onmouseover = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; };
    header.onmouseout = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; };
    wrap.appendChild(header);
    const content = document.createElement('div');
    content.style.cssText = 'padding:16px;display:none;background:#fff';
    if (groups.length === 0) {
      const empty = document.createElement('div');
      empty.innerHTML = '<div style="text-align:center;padding:30px;color:#9ca3af;font-size:15px">📭 Sin datos en esta sección</div>';
      content.appendChild(empty);
    } else {
      groups.forEach(({ codigo, lotes }, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;margin:12px 0;overflow:hidden;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.05);transition:all 0.2s';
        card.onmouseover = function() { this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; this.style.transform = 'translateY(-2px)'; };
        card.onmouseout = function() { this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)'; this.style.transform = 'translateY(0)'; };
        const head = document.createElement('div');
        head.innerHTML = '<span style="font-weight:700;font-size:16px;color:#1f2937">' + codigo + '</span><span style="float:right;font-size:14px;color:#6b7280;font-weight:500">' + lotes.length + ' lote' + (lotes.length !== 1 ? 's' : '') + '</span>';
        head.style.cssText = 'padding:12px 16px;background:linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);border-bottom:2px solid #e5e7eb;font-weight:600;display:flex;justify-content:space-between;align-items:center';
        card.appendChild(head);
        const lotesContainer = document.createElement('div');
        lotes.forEach((l, idx) => {
          const fechaVenc = l.fechaVencimiento || '-';
          const fechaDisplay = fechaVenc !== '-' ? fechaVenc.split('-').reverse().slice(0, 2).join('/') : '-';
          // Calcular días hasta vencimiento para mostrar icono
          let icono = '🟢';
          let colorFondo = '#f0fdf4';
          let colorTexto = '#166534';
          if (fechaVenc !== '-') {
            try {
              const fechaVencDate = new Date(fechaVenc + 'T00:00:00');
              const hoy = new Date();
              hoy.setHours(0, 0, 0, 0);
              const diasHasta = Math.ceil((fechaVencDate - hoy) / 86400000);
              if (diasHasta <= 0) {
                icono = '🔴';
                colorFondo = '#fef2f2';
                colorTexto = '#991b1b';
              } else if (diasHasta === 1) {
                icono = '🟡';
                colorFondo = '#fefce8';
                colorTexto = '#854d0e';
              } else if (diasHasta <= 3) {
                icono = '🟠';
                colorFondo = '#fff7ed';
                colorTexto = '#9a3412';
              }
            } catch (e) {}
          }
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:' + (idx < lotes.length - 1 ? '1px solid #f3f4f6' : 'none') + ';font-size:14px;background:' + (idx % 2 === 0 ? '#fff' : '#fafafa') + ';transition:background 0.2s';
          row.onmouseover = function() { this.style.background = '#f9fafb'; };
          row.onmouseout = function() { this.style.background = (idx % 2 === 0 ? '#fff' : '#fafafa'); };
          row.innerHTML = '<div style="display:flex;align-items:center;gap:10px">' +
            '<span style="font-size:18px">' + icono + '</span>' +
            '<div>' +
            '<div style="font-weight:600;color:#374151">Vence: <span style="color:' + colorTexto + '">' + fechaDisplay + '</span></div>' +
            '<div style="font-size:12px;color:#6b7280;margin-top:2px">' + fechaVenc + '</div>' +
            '</div>' +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:8px">' +
            '<span style="font-size:20px;font-weight:700;color:#1f2937;background:' + colorFondo + ';padding:6px 12px;border-radius:8px;min-width:60px;text-align:center">' + (l.cantidad || 0) + '</span>' +
            '<span style="font-size:12px;color:#6b7280">uds</span>' +
            '</div>';
          lotesContainer.appendChild(row);
        });
        card.appendChild(lotesContainer);
        content.appendChild(card);
      });
    }
    wrap.appendChild(content);
    header.onclick = () => {
      const visible = content.style.display !== 'none';
      content.style.display = visible ? 'none' : 'block';
      header.innerHTML = '<span style="font-size:20px;margin-right:8px">' + icono + '</span><span style="font-size:18px;font-weight:700">' + title + '</span><span style="margin-left:auto;font-size:14px;opacity:0.8">(' + groups.length + ' productos)</span><span style="margin-left:12px;font-size:16px">' + (visible ? '▶' : '▼') + '</span>';
    };
    container.appendChild(wrap);
  }

  // Vista de STOCK Y VENCIMIENTOS ACTUALES (como StockVencimientosActivity en la APK)
  async function openStockVencimientosModal(localId, localNombre) {
    const overlay = document.createElement('div');
    overlay.style.cssText =
      'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText =
      'background:#fff;width:95%;max-width:1000px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)';
    overlay.appendChild(modal);

    const header = document.createElement('div');
    header.style.cssText =
      'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb';
    header.innerHTML =
      '<div style="font-weight:700;font-size:18px">📦 Stock y Vencimientos - ' + (localNombre || 'Local') + '</div>' +
      '<div style="display:flex;gap:8px">' +
      '<select id="venc-filtro" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff">' +
      '<option value="ORDEN_DEFECTO">Orden por defecto</option>' +
      '<option value="POR_VENCIMIENTO">Por vencimiento</option>' +
      '<option value="POR_CANTIDAD">Por cantidad</option>' +
      '</select>' +
      '<button id="venc-historial" style="padding:6px 12px;background:#0ea5e9;color:#fff;border:none;border-radius:6px;font-weight:600">📅 Historial</button>' +
      '<button id="venc-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px">Cerrar</button>' +
      '</div>';
    modal.appendChild(header);

    const body = document.createElement('div');
    body.style.cssText = 'padding:16px;overflow:auto;max-height:calc(92vh - 70px)';
    modal.appendChild(body);

    let filtroSeleccionado = 'ORDEN_DEFECTO';
    const categorias = {
      EMPANADAS: ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
      PIZZAS: ['MUZZA', 'JAMON', 'PEPPER'],
      PASTELITOS: ['BATATA', 'MEMBRIL']
    };

    async function calcularStockActual() {
      const hoy = getFechaActualArgentina();
      const fechaAyer = getFechaArgentina();
      fechaAyer.setDate(fechaAyer.getDate() - 1);
      const ayer = fechaISO(fechaAyer);
      const stockMap = {};
      try {
        const db = FirebaseRegionManager.getFirestore();
        
        // PRIMERO: Verificar si existe Stock Final de HOY (si existe, usarlo directamente)
        const stockHoy = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', hoy).where('tipo', '==', 'Stock Final').get();
        
        if (!stockHoy.empty) {
          // Si existe Stock Final de hoy, usarlo directamente (igual que en gestión de locales)
          console.log('📊 Usando Stock Final de HOY (existe)');
          stockHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        } else {
          // Si NO existe Stock Final de hoy, calcular: Stock Final de ayer + Ingreso de hoy
          console.log('📊 Calculando stock: Stock Final ayer + Ingreso hoy');
          const stockAyer = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', ayer).where('tipo', '==', 'Stock Final').get();
          stockAyer.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
          const ingresoHoy = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', hoy).where('tipo', '==', 'Ingreso de Mercadería').get();
          ingresoHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        }
      } catch (e) {
        console.warn('Error calculando stock:', e);
      }
      return stockMap;
    }

    async function render() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      try {
        console.log('🔍 Buscando lotes para localId:', localId);
        const db = FirebaseRegionManager.getFirestore();
        const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
        console.log('📦 Lotes encontrados:', lotesSnap.size);
        const stockMap = await calcularStockActual();
        console.log('📊 Stock calculado:', stockMap);
        const lotes = [];
        lotesSnap.forEach(d => {
          const data = d.data();
          console.log('📋 Lote raw:', data);
          const codigoRaw = data.productoCodigo || data.codigo || '';
          lotes.push({
            id: d.id,
            codigo: normalizar(codigoRaw),
            fechaVencimiento: data.fechaVencimiento || '',
            cantidad: Number(data.cantidad) || 0,
            productoNombre: data.productoNombre || codigoRaw || ''
          });
        });
        console.log('✅ Lotes normalizados:', lotes);
        
        // Detectar productos con problemas (como Android StockVencimientosActivity)
        const codigosConControlVencimientos = new Set();
        Object.values(categorias).forEach(codigos => {
          codigos.forEach(codigo => codigosConControlVencimientos.add(normalizar(codigo)));
        });
        
        const codigosConVencimientos = new Set(lotes.map(l => l.codigo));
        const productosSinVencimientos = [];
        const productosConDiferencias = [];
        
        // Detectar productos sin vencimientos
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          if (codigosConControlVencimientos.has(codigoNorm) && stockMap[codigo] > 0) {
            if (!codigosConVencimientos.has(codigoNorm)) {
              productosSinVencimientos.push({ codigo: codigoNorm, stock: stockMap[codigo] });
            }
          }
        });
        
        // Detectar productos con diferencias
        const lotesPorProducto = {};
        lotes.forEach(l => {
          if (!lotesPorProducto[l.codigo]) lotesPorProducto[l.codigo] = [];
          lotesPorProducto[l.codigo].push(l);
        });
        
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          if (codigosConControlVencimientos.has(codigoNorm) && stockMap[codigo] > 0) {
            const lotesProducto = lotesPorProducto[codigoNorm] || [];
            if (lotesProducto.length > 0) {
              const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
              if (sumaLotes !== stockMap[codigo]) {
                productosConDiferencias.push({ codigo: codigoNorm, stock: stockMap[codigo], sumaLotes });
              }
            }
          }
        });
        
        const datosStockCargados = Object.keys(stockMap).length > 0;
        const hayProblemas = !datosStockCargados || productosSinVencimientos.length > 0 || productosConDiferencias.length > 0;
        
        if (lotes.length === 0 && !datosStockCargados) {
          body.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;font-size:16px">📭 No hay vencimientos cargados para este local<br><small style="color:#9ca3af">LocalId: ' + localId + '</small></div>';
          return;
        }
        body.innerHTML = '';
        
        // Mostrar banner de alerta (verde si todo está bien, rojo si hay problemas)
        if (!hayProblemas && datosStockCargados) {
          const bannerVerde = document.createElement('div');
          bannerVerde.style.cssText = 'background:#4caf50;color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-weight:700;text-align:center;font-size:15px';
          bannerVerde.textContent = '✓ TODO EN ORDEN - Todos los productos con stock tienen lotes cargados';
          body.appendChild(bannerVerde);
        } else if (hayProblemas) {
          const bannerError = document.createElement('div');
          bannerError.style.cssText = 'background:#c62828;color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-weight:700;text-align:center;font-size:15px';
          let mensajeError = '';
          if (productosSinVencimientos.length > 0) {
            mensajeError += '🔴 ' + productosSinVencimientos.length + ' producto(s) con stock SIN lotes cargados';
          }
          if (productosConDiferencias.length > 0) {
            if (mensajeError) mensajeError += ' | ';
            mensajeError += '🔴 ' + productosConDiferencias.length + ' producto(s) con diferencia entre stock y lotes';
          }
          bannerError.textContent = mensajeError;
          body.appendChild(bannerError);
        }
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const lotesCategoria = lotes.filter(l => codigosCategoria.includes(l.codigo));
          if (lotesCategoria.length === 0) return;
          const lotesPorProducto = {};
          lotesCategoria.forEach(l => {
            if (!lotesPorProducto[l.codigo]) lotesPorProducto[l.codigo] = [];
            lotesPorProducto[l.codigo].push(l);
          });
          let productosOrdenados = [];
          if (filtroSeleccionado === 'ORDEN_DEFECTO') {
            productosOrdenados = codigosCategoria.map(codigo => lotesPorProducto[codigo] ? [codigo, lotesPorProducto[codigo]] : null).filter(Boolean);
          } else if (filtroSeleccionado === 'POR_VENCIMIENTO') {
            productosOrdenados = Object.keys(lotesPorProducto).map(codigo => {
              const minVenc = Math.min(...lotesPorProducto[codigo].map(l => {
                try { return new Date(l.fechaVencimiento).getTime(); } catch { return Infinity; }
              }));
              return [codigo, lotesPorProducto[codigo], minVenc];
            }).sort((a, b) => a[2] - b[2]).map(([codigo, lotes]) => [codigo, lotes]);
          } else if (filtroSeleccionado === 'POR_CANTIDAD') {
            productosOrdenados = Object.keys(lotesPorProducto).map(codigo => {
              const total = lotesPorProducto[codigo].reduce((sum, l) => sum + l.cantidad, 0);
              return [codigo, lotesPorProducto[codigo], total];
            }).sort((a, b) => b[2] - a[2]).map(([codigo, lotes]) => [codigo, lotes]);
          }
          let totalCategoria = 0;
          productosOrdenados.forEach(([codigo, lotesProducto]) => {
            const stockRegistrado = stockMap[codigo];
            const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
            const stockReal = stockRegistrado != null ? stockRegistrado : sumaLotes;
            totalCategoria += stockReal;
          });
          const catDiv = document.createElement('div');
          catDiv.style.cssText = 'margin:24px 0';
          catDiv.innerHTML = '<div style="font-size:20px;font-weight:700;color:#0ea5e9;margin-bottom:8px">📊 ' + categoria + '</div>' +
            '<div style="font-size:16px;font-weight:700;color:#059669;margin-bottom:12px">📦 TOTAL: ' + totalCategoria + ' unidades</div>' +
            '<div style="height:2px;background:#81d4fa;margin-bottom:16px"></div>';
          body.appendChild(catDiv);
          productosOrdenados.forEach(([codigo, lotesProducto]) => {
            const stockRegistrado = stockMap[codigo];
            const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
            const stockReal = stockRegistrado != null ? stockRegistrado : sumaLotes;
            const productoNombre = lotesProducto[0]?.productoNombre || codigo;
            const prodDiv = document.createElement('div');
            prodDiv.style.cssText = 'margin:16px 0;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden';
            prodDiv.innerHTML = '<div style="background:#0ea5e9;color:#fff;font-weight:700;padding:12px 16px;font-size:15px">' + productoNombre + '</div>' +
              '<div style="padding:8px 16px;font-size:14px">   Stock actual: ' + stockReal + ' uds</div>' +
              '<div style="padding:4px 16px;font-size:14px;color:#6b7280">   Lotes con vencimiento:</div>';
            const lotesOrdenados = lotesProducto.sort((a, b) => (a.fechaVencimiento || '').localeCompare(b.fechaVencimiento || ''));
            lotesOrdenados.forEach(l => {
              const fechaVenc = new Date(l.fechaVencimiento);
              const hoy = getFechaArgentina();
              const diasHasta = Math.ceil((fechaVenc - hoy) / 86400000);
              const icono = diasHasta <= 0 ? '🔴' : diasHasta === 1 ? '🟡' : diasHasta <= 3 ? '🟠' : '🟢';
              const urgencia = diasHasta <= 0 ? ' (¡HOY!)' : diasHasta === 1 ? ' (Mañana)' : diasHasta <= 3 ? ' (' + diasHasta + ' días)' : '';
              const fechaDisplay = l.fechaVencimiento ? l.fechaVencimiento.split('-').reverse().slice(0, 2).join('/') : '-';
              const color = diasHasta <= 0 ? '#c62828' : diasHasta === 1 ? '#f57c00' : '#000';
              const loteDiv = document.createElement('div');
              loteDiv.style.cssText = 'padding:4px 32px;font-size:14px;color:' + color;
              loteDiv.textContent = '   ' + icono + ' ' + l.cantidad + ' uds → Vence ' + fechaDisplay + urgencia;
              prodDiv.appendChild(loteDiv);
            });
            const coincide = sumaLotes === stockReal;
            const diferencia = stockReal - sumaLotes;
            
            // Validación mejorada (como Android)
            prodDiv.innerHTML += '<div style="height:1px;background:#d1d5db;margin:8px 32px"></div>';
            
            if (coincide) {
              prodDiv.innerHTML += '<div style="padding:4px 32px;font-size:14px;font-weight:700;color:#059669">   ✅ Stock: ' + stockReal + ' uds | Lotes: ' + sumaLotes + ' uds (Coincide)</div>';
            } else {
              prodDiv.innerHTML += '<div style="padding:4px 32px;font-size:14px;font-weight:700;color:#374151">   Stock: ' + stockReal + ' uds | Lotes: ' + sumaLotes + ' uds</div>';
              
              // Mensaje de error en ROJO si NO coincide (como Android)
              const mensajeError = diferencia > 0 
                ? '🔴 FALTAN: +' + diferencia + ' unidades | Los lotes NO coinciden con el stock'
                : '🔴 SOBRAN: ' + Math.abs(diferencia) + ' unidades | Los lotes NO coinciden con el stock';
              
              const errorDiv = document.createElement('div');
              errorDiv.style.cssText = 'padding:12px 32px;margin:8px 0;background:#c62828;color:#fff;font-weight:700;font-size:15px;border-radius:4px';
              errorDiv.textContent = '   ' + mensajeError;
              prodDiv.appendChild(errorDiv);
              
              const mensajeDiv = document.createElement('div');
              mensajeDiv.style.cssText = 'padding:0 32px 16px;font-size:12px;color:#c62828';
              mensajeDiv.textContent = '   ⚠️ Debes ajustar los lotes para que coincidan con el stock actual';
              prodDiv.appendChild(mensajeDiv);
            }
            
            body.appendChild(prodDiv);
          });
          
          // Mostrar productos con stock pero sin lotes de vencimiento (como Android)
          productosSinVencimientos.forEach(({ codigo, stock }) => {
            // Verificar si el producto pertenece a esta categoría
            if (!codigosCategoria.includes(codigo)) return;
            
            const productos = {
              'JQ': 'JQ - Jamón y Queso',
              'PB': 'PB - Pollo BBQ',
              'CS': 'CS - Carne Suave',
              'PO': 'PO - Pollo',
              'CP': 'CP - Carne Picante',
              'HU': 'HU - Humita',
              'ES': 'ES - Espinaca',
              'CQ': 'CQ - Calabaza y Queso',
              'RJ': 'RJ - Roquefort y Jamón',
              'QC': 'QC - Queso y Cebolla',
              'CB': 'CB - Cerdo y Barbacoa',
              'CH': 'CH - Cheeseburger',
              'MUZZA': 'Pizza Muzzarella',
              'JAMON': 'Pizza Jamón',
              'PEPPER': 'Pizza Pepperoni',
              'BATATA': 'Pastelito Batata',
              'MEMBRIL': 'Pastelito Membrillo'
            };
            
            const productoNombre = productos[codigo] || codigo;
            
            const prodDiv = document.createElement('div');
            prodDiv.style.cssText = 'margin:16px 0;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden';
            prodDiv.innerHTML = '<div style="background:#f57c00;color:#fff;font-weight:700;padding:12px 16px;font-size:15px">' + productoNombre + '</div>' +
              '<div style="padding:8px 16px;font-size:14px">   Stock actual: ' + stock + ' uds</div>' +
              '<div style="padding:4px 16px;font-size:14px;font-weight:700;color:#c62828">   ⚠️ NO HAY VENCIMIENTOS CARGADOS para este producto</div>' +
              '<div style="padding:0 16px 16px;font-size:12px;color:#6b7280">   💡 Debes cargar los vencimientos desde la sección "Vencimientos"</div>';
            body.appendChild(prodDiv);
          });
        });
      } catch (e) {
        console.error('Error renderizando:', e);
        body.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626">Error cargando datos: ' + e.message + '</div>';
      }
    }

    document.body.appendChild(overlay);
    document.addEventListener('keydown', function esc(e) {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
    });
    modal.querySelector('#venc-close').onclick = () => overlay.remove();
    modal.querySelector('#venc-filtro').onchange = (e) => {
      filtroSeleccionado = e.target.value;
      render();
    };
    modal.querySelector('#venc-historial').onclick = () => {
      overlay.remove();
      openHistorialModal(localId, localNombre);
    };
    await render();
  }

  // Historial (modal separado, llamado desde el botón dentro de Stock y Vencimientos)
  async function openHistorialModal(localId, localNombre) {
    let fecha = getFechaActualArgentina();
    let soloHoy = false;
    const overlay = document.createElement('div');
    overlay.style.cssText =
      'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText =
      'background:#fff;width:90%;max-width:900px;max-height:90vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)';
    overlay.appendChild(modal);
    const header = document.createElement('div');
    header.style.cssText =
      'display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:2px solid #e5e7eb;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    header.innerHTML =
      '<div style="display:flex;flex-direction:column;gap:8px;flex:1">' +
      '<div style="font-size:20px;font-weight:700;color:#fff">📅 Historial de Vencimientos' + (localNombre ? ' - ' + localNombre : '') + '</div>' +
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">' +
      '<button id="venc-prev" style="padding:8px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:8px;color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'rgba(255,255,255,0.3)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.2)\'">◀</button>' +
      '<div id="venc-fecha" style="padding:8px 16px;background:rgba(255,255,255,0.95);border-radius:8px;font-weight:700;font-size:16px;color:#1f2937;min-width:120px;text-align:center">' + fecha + '</div>' +
      '<button id="venc-next" style="padding:8px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:8px;color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'rgba(255,255,255,0.3)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.2)\'">▶</button>' +
      '<label style="margin-left:8px;font-size:14px;display:flex;align-items:center;gap:6px;color:#fff;cursor:pointer;padding:6px 12px;background:rgba(255,255,255,0.15);border-radius:6px">' +
      '<input type="checkbox" id="venc-solohoy" style="cursor:pointer"/> <span>🔍 Solo vencimientos del día</span>' +
      '</label></div></div>' +
      '<button id="venc-close" style="padding:10px 20px;background:#fff;color:#667eea;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-left:12px" onmouseover="this.style.background=\'#f3f4f6\';this.style.transform=\'scale(1.05)\'" onmouseout="this.style.background=\'#fff\';this.style.transform=\'scale(1)\'">✕ Cerrar</button>';
    modal.appendChild(header);
    const body = document.createElement('div');
    body.style.cssText = 'padding:20px;overflow:auto;max-height:calc(90vh - 120px);background:#f9fafb';
    modal.appendChild(body);
    let orderMap = {};
    function render(registro) {
      body.innerHTML = '';
      const inicio = groupAndSort(registro.lotesIniciales || [], fecha, soloHoy, orderMap);
      const fin = groupAndSort(registro.lotesFinales || [], fecha, soloHoy, orderMap);
      renderSection(body, 'INICIO DEL DÍA', inicio);
      renderSection(body, 'FIN DEL DÍA', fin);
    }
    async function loadAndRender() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      if (!orderMap || Object.keys(orderMap).length === 0) {
        orderMap = await getProductosOrder(localId);
      }
      const reg = await getHistorial(localId, fecha);
      
      if (!reg) {
        // No existe registro para esta fecha
        const fechaDisplay = fecha.split('-').reverse().join('/');
        body.innerHTML = '<div style="text-align:center;padding:60px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)">' +
          '<div style="font-size:64px;margin-bottom:16px">📭</div>' +
          '<div style="font-size:20px;font-weight:700;color:#374151;margin-bottom:8px">No hay datos históricos</div>' +
          '<div style="font-size:16px;color:#6b7280">Fecha: <span style="font-weight:600;color:#667eea">' + fechaDisplay + '</span></div>' +
          '</div>';
      } else if ((!reg.lotesIniciales || reg.lotesIniciales.length === 0) && 
                 (!reg.lotesFinales || reg.lotesFinales.length === 0)) {
        // Existe registro pero está vacío (sin lotes)
        const fechaDisplay = fecha.split('-').reverse().join('/');
        body.innerHTML = '<div style="text-align:center;padding:60px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)">' +
          '<div style="font-size:64px;margin-bottom:16px">📅</div>' +
          '<div style="font-size:20px;font-weight:700;color:#374151;margin-bottom:8px">' + fechaDisplay + '</div>' +
          '<div style="font-size:16px;color:#6b7280;margin-bottom:20px">No había lotes registrados en esta fecha</div>' +
          '<div style="display:flex;gap:20px;justify-content:center;margin-top:24px">' +
          '<div style="padding:12px 24px;background:#f3f4f6;border-radius:8px"><div style="font-size:12px;color:#6b7280;margin-bottom:4px">Lotes Iniciales</div><div style="font-size:24px;font-weight:700;color:#374151">0</div></div>' +
          '<div style="padding:12px 24px;background:#f3f4f6;border-radius:8px"><div style="font-size:12px;color:#6b7280;margin-bottom:4px">Lotes Finales</div><div style="font-size:24px;font-weight:700;color:#374151">0</div></div>' +
          '</div></div>';
      } else {
        // Existe registro con datos
        render(reg);
      }
      modal.querySelector('#venc-fecha').textContent = fecha;
    }
    document.body.appendChild(overlay);
    document.addEventListener('keydown', function esc(e) {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
    });
    modal.querySelector('#venc-close').onclick = () => overlay.remove();
    modal.querySelector('#venc-prev').onclick = () => {
      const [y, m, d] = fecha.split('-').map(Number);
      // Usar UTC para evitar problemas de zona horaria
      const dObj = new Date(Date.UTC(y, m - 1, d));
      dObj.setUTCDate(dObj.getUTCDate() - 1);
      fecha = dObj.getUTCFullYear() + '-' + 
              String(dObj.getUTCMonth() + 1).padStart(2, '0') + '-' + 
              String(dObj.getUTCDate()).padStart(2, '0');
      loadAndRender();
    };
    modal.querySelector('#venc-next').onclick = () => {
      const [y, m, d] = fecha.split('-').map(Number);
      // Usar UTC para evitar problemas de zona horaria
      const dObj = new Date(Date.UTC(y, m - 1, d));
      dObj.setUTCDate(dObj.getUTCDate() + 1);
      fecha = dObj.getUTCFullYear() + '-' + 
              String(dObj.getUTCMonth() + 1).padStart(2, '0') + '-' + 
              String(dObj.getUTCDate()).padStart(2, '0');
      loadAndRender();
    };
    modal.querySelector('#venc-solohoy').onchange = (e) => {
      soloHoy = e.target.checked;
      loadAndRender();
    };
    await loadAndRender();
  }

  // Vista de Vencimientos para LOCAL (carga/edición de lotes) - igual que VencimientosActivity.kt
  async function openVencLocalModal() {
    const u = localStorage.getItem('usuario');
    if (!u) {
      alert('Inicie sesión primero.');
      return;
    }
    const usuario = JSON.parse(u);
    const localId = usuario.localId || '';
    const localNombre = usuario.localNombre || 'Local';
    
    if (!localId) {
      alert('Error: No se encontró el local');
      return;
    }
    
    // Verificar e inicializar Firebase con la región del usuario si no está inicializado
    try {
      FirebaseRegionManager.getFirestore();
    } catch (e) {
      // Firebase no está inicializado, intentar inicializarlo con la región del usuario
      const regionIdUsuario = usuario.regionId || localStorage.getItem('region_id');
      if (regionIdUsuario) {
        try {
          // Cargar regiones si no están en cache
          if (!REGIONES_CONFIG_CACHE || REGIONES_CONFIG_CACHE.length === 0) {
            const response = await fetch('regiones.json');
            const regionesData = await response.json();
            REGIONES_CONFIG_CACHE = regionesData.filter(r => r.activo);
          }
          
          const regionUsuario = REGIONES_CONFIG_CACHE.find(r => r.id === regionIdUsuario);
          if (regionUsuario) {
            console.log('Inicializando Firebase para región del usuario:', regionUsuario.nombre);
            FirebaseRegionManager.initializeFirebase(regionUsuario);
          } else {
            throw new Error('No se encontró la región del usuario');
          }
        } catch (initError) {
          console.error('Error inicializando Firebase:', initError);
          alert('Error: No se pudo inicializar Firebase. Por favor, vuelve al login y selecciona una región.');
          return;
        }
      } else {
        alert('Error: No se encontró la región. Por favor, vuelve al login y selecciona una región.');
        return;
      }
    }

    const productos = {
      'JQ': 'JQ - Jamón y Queso',
      'PB': 'PB - Pollo BBQ',
      'CS': 'CS - Carne Suave',
      'PO': 'PO - Pollo',
      'CP': 'CP - Carne Picante',
      'HU': 'HU - Humita',
      'ES': 'ES - Espinaca',
      'CQ': 'CQ - Calabaza y Queso',
      'RJ': 'RJ - Roquefort y Jamón',
      'QC': 'QC - Queso y Cebolla',
      'CB': 'CB - Cerdo y Barbacoa',
      'CH': 'CH - Cheeseburger',
      'MUZZA': 'Pizza Muzzarella',
      'JAMON': 'Pizza Jamón',
      'PEPPER': 'Pizza Pepperoni',
      'BATATA': 'Pastelito Batata',
      'MEMBRIL': 'Pastelito Membrillo'
    };

    const categorias = {
      'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
      'PIZZAS': ['MUZZA', 'JAMON', 'PEPPER'],
      'PASTELITOS': ['BATATA', 'MEMBRIL']
    };

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;width:95%;max-width:1000px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column';
    overlay.appendChild(modal);

    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb';
    header.innerHTML = '<div style="font-weight:700;font-size:18px">📅 Vencimientos - ' + localNombre + '</div><button id="vloc-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px">Cerrar</button>';
    modal.appendChild(header);

    const body = document.createElement('div');
    body.style.cssText = 'display:flex;flex-direction:column;gap:12px;padding:12px;overflow-y:auto;max-height:calc(92vh - 60px)';
    modal.appendChild(body);

    const colLeft = document.createElement('div');
    colLeft.style.cssText = 'width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:12px;overflow-y:visible';
    const colRight = document.createElement('div');
    colRight.style.cssText = 'width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:12px;overflow-y:visible';
    body.appendChild(colLeft);
    body.appendChild(colRight);

    let fechaVencimientoSeleccionada = '';
    const hoy = getFechaArgentina();
    hoy.setDate(hoy.getDate() + 1);
    fechaVencimientoSeleccionada = fechaISO(hoy);

    colLeft.innerHTML = '<div style="font-weight:600;margin-bottom:12px;font-size:16px">Agregar Lote</div>' +
      '<div style="display:grid;gap:10px">' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Producto</label>' +
      '<div style="display:flex;gap:4px;align-items:center">' +
      '<button id="vl-prod-prev" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:16px;line-height:1">▲</button>' +
      '<select id="vl-prod" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px"></select>' +
      '<button id="vl-prod-next" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:16px;line-height:1">▼</button>' +
      '</div></div>' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Fecha de Vencimiento</label>' +
      '<div style="display:flex;gap:4px;align-items:center"><button id="vl-fecha-prev" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;min-width:40px">◀</button>' +
      '<input type="date" id="vl-fecha" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;cursor:pointer;min-height:38px;box-sizing:border-box"/>' +
      '<button id="vl-fecha-next" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;min-width:40px">▶</button></div>' +
      '<div id="vl-fecha-display" style="margin-top:4px;text-align:center;font-size:12px;color:#6b7280"></div></div>' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Cantidad</label>' +
      '<input type="number" min="1" id="vl-cant" placeholder="0" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px"/></div>' +
      '<button id="vl-add" style="padding:10px;background:#10b981;color:#fff;border:none;border-radius:6px;font-weight:600;font-size:14px">Agregar Lote</button>' +
      '<div id="vl-msg" style="font-size:12px;min-height:20px"></div></div>';

    colRight.innerHTML = '<div style="font-weight:600;margin-bottom:12px;font-size:16px">Lotes Cargados</div><div id="vl-list"></div><div id="vl-whatsapp-container" style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb"></div>';

    function actualizarTextoFecha() {
      try {
        const [y, m, d] = fechaVencimientoSeleccionada.split('-').map(Number);
        const fechaObj = new Date(y, m - 1, d);
        const fechaDisplay = fechaObj.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const fechaDisplayEl = colLeft.querySelector('#vl-fecha-display');
        if (fechaDisplayEl) {
          fechaDisplayEl.textContent = '📅 Vence: ' + fechaDisplay;
        }
        const fechaInput = colLeft.querySelector('#vl-fecha');
        if (fechaInput) {
          fechaInput.value = fechaVencimientoSeleccionada;
        }
      } catch (e) {
        const fechaDisplayEl = colLeft.querySelector('#vl-fecha-display');
        if (fechaDisplayEl) {
          fechaDisplayEl.textContent = '📅 Seleccionar Fecha';
        }
      }
    }

    function cambiarFecha(dias) {
      try {
        // Leer el valor actual del input date (siempre la fuente de verdad)
        const fechaInput = colLeft.querySelector('#vl-fecha');
        let fechaActual = fechaVencimientoSeleccionada;
        
        if (fechaInput && fechaInput.value) {
          fechaActual = fechaInput.value;
        } else if (!fechaActual) {
          // Si no hay fecha, inicializar con mañana
          console.warn('No hay fecha seleccionada, inicializando...');
          const hoy = getFechaArgentina();
          hoy.setDate(hoy.getDate() + 1);
          fechaActual = fechaISO(hoy);
        }
        
        console.log('Fecha actual antes de cambiar:', fechaActual, 'dias a sumar:', dias);
        
        // Calcular nueva fecha - usar método directo sin conversiones de zona horaria
        const [y, m, d] = fechaActual.split('-').map(Number);
        console.log('Componentes de fecha:', { año: y, mes: m, dia: d });
        
        // Crear fecha en UTC para evitar problemas de zona horaria
        const fechaObj = new Date(Date.UTC(y, m - 1, d));
        console.log('Fecha objeto creada:', fechaObj.toISOString(), 'día local:', fechaObj.getUTCDate());
        
        // Sumar/restar días directamente en UTC
        fechaObj.setUTCDate(fechaObj.getUTCDate() + dias);
        console.log('Después de setUTCDate:', fechaObj.toISOString(), 'día local:', fechaObj.getUTCDate());
        
        // Formatear manualmente para evitar problemas con fechaISO
        const nuevoAño = fechaObj.getUTCFullYear();
        const nuevoMes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
        const nuevoDia = String(fechaObj.getUTCDate()).padStart(2, '0');
        fechaVencimientoSeleccionada = `${nuevoAño}-${nuevoMes}-${nuevoDia}`;
        
        console.log('Nueva fecha calculada:', fechaVencimientoSeleccionada);
        
        // Actualizar el input date visible
        if (fechaInput) {
          fechaInput.value = fechaVencimientoSeleccionada;
          console.log('Input date actualizado a:', fechaInput.value);
        }
        
        actualizarTextoFecha();
        console.log('Fecha cambiada a:', fechaVencimientoSeleccionada, '(dias:', dias, ')');
      } catch (e) {
        console.error('Error cambiando fecha:', e);
      }
    }

    function obtenerCodigoProducto(nombre) {
      // Extraer código del nombre (formato: "JQ - Jamón y Queso" -> "JQ")
      let codigo = '';
      if (nombre && nombre.includes(' - ')) {
        codigo = nombre.split(' - ')[0].trim();
      } else if (nombre && nombre.startsWith('Pizza ')) {
        if (nombre.includes('Muzzarella')) codigo = 'MUZZA';
        else if (nombre.includes('Jamón')) codigo = 'JAMON';
        else if (nombre.includes('Pepperoni')) codigo = 'PEPPER';
        else codigo = nombre;
      } else if (nombre && nombre.startsWith('Pastelito ')) {
        if (nombre.includes('Batata')) codigo = 'BATATA';
        else if (nombre.includes('Membrillo')) codigo = 'MEMBRIL';
        else codigo = nombre;
      } else {
        codigo = nombre || '';
      }
      return normalizar(codigo);
    }

    async function calcularStockActual() {
      const hoy = getFechaActualArgentina();
      const fechaAyer = getFechaArgentina();
      fechaAyer.setDate(fechaAyer.getDate() - 1);
      const ayer = fechaISO(fechaAyer);
      const stockMap = {};
      try {
        const db = FirebaseRegionManager.getFirestore();
        
        // PRIMERO: Verificar si existe Stock Final de HOY (si existe, usarlo directamente)
        const stockHoy = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', hoy).where('tipo', '==', 'Stock Final').get();
        
        if (!stockHoy.empty) {
          // Si existe Stock Final de hoy, usarlo directamente (igual que en gestión de locales)
          console.log('📊 [VencLocalModal] Usando Stock Final de HOY (existe)');
          stockHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        } else {
          // Si NO existe Stock Final de hoy, calcular: Stock Final de ayer + Ingreso de hoy
          console.log('📊 [VencLocalModal] Calculando stock: Stock Final ayer + Ingreso hoy');
          const stockAyer = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', ayer).where('tipo', '==', 'Stock Final').get();
          stockAyer.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
          const ingresoHoy = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', hoy).where('tipo', '==', 'Ingreso de Mercadería').get();
          ingresoHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        }
      } catch (e) {
        console.warn('Error calculando stock:', e);
      }
      return stockMap;
    }

    async function renderProductos() {
      const sel = colLeft.querySelector('#vl-prod');
      sel.innerHTML = '';
      Object.entries(productos).forEach(([codigo, nombre]) => {
        const opt = document.createElement('option');
        opt.value = codigo;
        opt.textContent = nombre;
        sel.appendChild(opt);
      });
    }

    function cambiarProducto(direccion) {
      const sel = colLeft.querySelector('#vl-prod');
      const opciones = Array.from(sel.options);
      const indiceActual = sel.selectedIndex;
      let nuevoIndice = indiceActual + direccion;
      
      if (nuevoIndice < 0) {
        nuevoIndice = opciones.length - 1; // Ir al último
      } else if (nuevoIndice >= opciones.length) {
        nuevoIndice = 0; // Ir al primero
      }
      
      sel.selectedIndex = nuevoIndice;
      actualizarCantidadFaltante();
    }

    async function actualizarCantidadFaltante() {
      const sel = colLeft.querySelector('#vl-prod');
      const codigo = sel.value;
      if (!codigo) return;

      try {
        const stockMap = await calcularStockActual();
        const codigoNorm = normalizar(codigo);
        const stockActual = stockMap[codigoNorm] || 0;

        // Calcular cuánto ya está lotado
        const db = FirebaseRegionManager.getFirestore();
        const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
        let cantidadLoteada = 0;
        lotesSnap.forEach(d => {
          const data = d.data();
          const codigoLote = normalizar(data.productoCodigo || data.codigo || '');
          if (codigoLote === codigoNorm) {
            cantidadLoteada += Number(data.cantidad) || 0;
          }
        });

        // Calcular lo que falta lotear
        const faltante = Math.max(0, stockActual - cantidadLoteada);
        
        // Actualizar el campo cantidad solo si hay stock y falta lotear
        const campoCantidad = colLeft.querySelector('#vl-cant');
        if (faltante > 0) {
          campoCantidad.value = faltante;
        } else {
          campoCantidad.value = '';
        }
        
        return { faltante, stockActual, cantidadLoteada };
      } catch (e) {
        console.warn('Error calculando cantidad faltante:', e);
        return { faltante: 0, stockActual: 0, cantidadLoteada: 0 };
      }
    }

    async function buscarSiguienteProductoSinLotes() {
      const sel = colLeft.querySelector('#vl-prod');
      const opciones = Array.from(sel.options);
      const indiceActual = sel.selectedIndex;
      
      // Empezar a buscar desde el siguiente producto
      for (let i = indiceActual + 1; i < opciones.length; i++) {
        const codigo = opciones[i].value;
        if (!codigo) continue;
        
        try {
          const stockMap = await calcularStockActual();
          const codigoNorm = normalizar(codigo);
          const stockActual = stockMap[codigoNorm] || 0;
          
          // Si no hay stock, saltar este producto
          if (stockActual <= 0) continue;
          
          // Calcular cuánto ya está lotado
          const db = FirebaseRegionManager.getFirestore();
          const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
          let cantidadLoteada = 0;
          lotesSnap.forEach(d => {
            const data = d.data();
            const codigoLote = normalizar(data.productoCodigo || data.codigo || '');
            if (codigoLote === codigoNorm) {
              cantidadLoteada += Number(data.cantidad) || 0;
            }
          });
          
          // Si falta lotear algo, este es el siguiente producto
          const faltante = Math.max(0, stockActual - cantidadLoteada);
          if (faltante > 0) {
            sel.selectedIndex = i;
            await actualizarCantidadFaltante();
            return true;
          }
        } catch (e) {
          console.warn('Error verificando producto:', e);
        }
      }
      
      // Si no encontró ninguno después del actual, buscar desde el inicio
      for (let i = 0; i < indiceActual; i++) {
        const codigo = opciones[i].value;
        if (!codigo) continue;
        
        try {
          const stockMap = await calcularStockActual();
          const codigoNorm = normalizar(codigo);
          const stockActual = stockMap[codigoNorm] || 0;
          
          if (stockActual <= 0) continue;
          
          const db = FirebaseRegionManager.getFirestore();
          const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
          let cantidadLoteada = 0;
          lotesSnap.forEach(d => {
            const data = d.data();
            const codigoLote = normalizar(data.productoCodigo || data.codigo || '');
            if (codigoLote === codigoNorm) {
              cantidadLoteada += Number(data.cantidad) || 0;
            }
          });
          
          const faltante = Math.max(0, stockActual - cantidadLoteada);
          if (faltante > 0) {
            sel.selectedIndex = i;
            await actualizarCantidadFaltante();
            return true;
          }
        } catch (e) {
          console.warn('Error verificando producto:', e);
        }
      }
      
      return false; // No se encontró ningún producto sin lotes completos
    }

    async function renderLotes() {
      const list = colRight.querySelector('#vl-list');
      list.innerHTML = '';
      try {
        const db = FirebaseRegionManager.getFirestore();
        const [lotesSnap, stockMap] = await Promise.all([
          db.collection('locales').doc(localId).collection('vencimientos_activos').get(),
          calcularStockActual()
        ]);
        const lotes = [];
        lotesSnap.forEach(d => {
          const data = d.data();
          lotes.push({
            id: d.id,
            codigo: normalizar(data.productoCodigo || data.codigo || ''),
            fechaVencimiento: data.fechaVencimiento || '',
            cantidad: Number(data.cantidad) || 0,
            productoNombre: data.productoNombre || productos[data.productoCodigo] || data.codigo || ''
          });
        });

        const lotesPorProducto = {};
        lotes.forEach(l => {
          if (!lotesPorProducto[l.codigo]) lotesPorProducto[l.codigo] = [];
          lotesPorProducto[l.codigo].push(l);
        });

        // Lista de productos que forman parte del control de vencimientos
        const productosVencimientos = [
          'JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH', // Empanadas
          'MUZZA', 'JAMON', 'PEPPER', // Pizzas
          'BATATA', 'MEMBRIL' // Pastelitos
        ];
        const productosVencimientosNormalizados = productosVencimientos.map(c => normalizar(c));

        // Filtrar solo productos que forman parte del control de vencimientos
        const productosConStockSinLotes = {};
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          // Solo considerar productos que están en la lista de vencimientos
          if (productosVencimientosNormalizados.includes(codigoNorm)) {
            if (stockMap[codigo] > 0 && (!lotesPorProducto[codigoNorm] || lotesPorProducto[codigoNorm].length === 0)) {
              productosConStockSinLotes[codigoNorm] = stockMap[codigo];
            }
          }
        });

        // Verificar si hay productos con lotes
        let hayProductosConLotes = false;
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const codigosCategoriaNormalizados = codigosCategoria.map(c => normalizar(c));
          const lotesCategoria = lotes.filter(l => codigosCategoriaNormalizados.includes(l.codigo));
          if (lotesCategoria.length > 0) {
            hayProductosConLotes = true;
          }
        });

        // Verificar si todos los productos con stock tienen lotes y coinciden (solo productos de vencimientos)
        let todosEnOrden = true;
        let hayProductosVencimientosConStock = false;
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          // Solo considerar productos que están en la lista de vencimientos
          if (productosVencimientosNormalizados.includes(codigoNorm) && stockMap[codigo] > 0) {
            hayProductosVencimientosConStock = true;
            const lotesProducto = lotesPorProducto[codigoNorm] || [];
            if (lotesProducto.length === 0) {
              todosEnOrden = false;
            } else {
              const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
              if (sumaLotes !== stockMap[codigo]) {
                todosEnOrden = false;
              }
            }
          }
        });

        // PRIMERO: Mostrar mensaje "TODO EN ORDEN" si no hay productos con stock sin lotes y todo coincide
        if (Object.keys(productosConStockSinLotes).length === 0 && hayProductosConLotes && hayProductosVencimientosConStock && todosEnOrden) {
          const okDiv = document.createElement('div');
          okDiv.style.cssText = 'background:#059669;color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:16px;font-weight:700;font-size:14px;text-align:center';
          okDiv.textContent = '✅ TODO EN ORDEN - Todos los productos con stock tienen lotes cargados';
          list.appendChild(okDiv);
          const sep = document.createElement('div');
          sep.style.cssText = 'height:8px';
          list.appendChild(sep);
        }

        // SEGUNDO: Mostrar advertencia solo si hay productos con stock sin lotes
        if (Object.keys(productosConStockSinLotes).length > 0) {
          const advDiv = document.createElement('div');
          advDiv.style.cssText = 'background:#dc2626;color:#fff;padding:12px;border-radius:6px;margin-bottom:16px;font-weight:700;font-size:14px';
          advDiv.textContent = '⚠️ PRODUCTOS CON STOCK SIN LOTES CARGADOS';
          list.appendChild(advDiv);

          Object.keys(categorias).forEach(categoria => {
            const codigosCategoria = categorias[categoria];
            let hayProductos = false;
            codigosCategoria.forEach(codigo => {
              const codigoNorm = normalizar(codigo);
              if (productosConStockSinLotes[codigoNorm]) hayProductos = true;
            });
            if (hayProductos) {
              const catDiv = document.createElement('div');
              catDiv.style.cssText = 'margin:8px 0';
              catDiv.innerHTML = '<div style="font-size:15px;font-weight:700;color:#f57c00;margin:8px 0">📊 ' + categoria + '</div>';
              codigosCategoria.forEach(codigo => {
                const codigoNorm = normalizar(codigo);
                const stock = productosConStockSinLotes[codigoNorm];
                if (stock) {
                  const prodDiv = document.createElement('div');
                  prodDiv.style.cssText = 'margin:8px 0;border:1px solid #dc2626;border-radius:6px;overflow:hidden';
                  prodDiv.innerHTML = '<div style="background:#dc2626;color:#fff;font-weight:700;padding:8px 12px;font-size:14px">' + (productos[codigo] || codigo) + '</div>' +
                    '<div style="padding:8px 12px;font-size:12px;font-weight:700;color:#dc2626;background:#fee2e2">⚠️ Stock: ' + stock + ' uds | Lotes: 0 uds | FALTAN CARGAR LOTES</div>';
                  catDiv.appendChild(prodDiv);
                }
              });
              list.appendChild(catDiv);
            }
          });
          const sep = document.createElement('div');
          sep.style.cssText = 'height:16px';
          list.appendChild(sep);
        }

        // TERCERO: Mostrar productos con lotes
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const codigosCategoriaNormalizados = codigosCategoria.map(c => normalizar(c));
          const lotesCategoria = lotes.filter(l => codigosCategoriaNormalizados.includes(l.codigo));
          if (lotesCategoria.length > 0) {
            const catDiv = document.createElement('div');
            catDiv.style.cssText = 'margin:16px 0';
            catDiv.innerHTML = '<div style="font-size:18px;font-weight:700;color:#0ea5e9;margin:8px 0">📊 ' + categoria + '</div>';
            codigosCategoria.forEach(codigo => {
              const codigoNorm = normalizar(codigo);
              const lotesProducto = lotesPorProducto[codigoNorm] || [];
              if (lotesProducto.length > 0) {
                const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
                // Buscar stock usando el código normalizado (igual que en la APK)
                const stockActual = stockMap[codigoNorm] || null;
                const coincide = stockActual != null && sumaLotes === stockActual;
                const diferencia = stockActual != null ? stockActual - sumaLotes : null;
                const prodDiv = document.createElement('div');
                prodDiv.style.cssText = 'margin:8px 0;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden';
                let validacionText = '';
                let validacionColor = '#6b7280';
                if (stockActual == null) {
                  validacionText = 'ℹ️ Lotes: ' + sumaLotes + ' uds (sin comparar - no hay stock registrado aún)';
                } else if (coincide) {
                  validacionText = '✅ Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds (Coincide)';
                  validacionColor = '#059669';
                } else if (diferencia > 0) {
                  validacionText = '⚠️ Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds | Faltan: +' + diferencia + ' uds';
                  validacionColor = '#f57c00';
                } else {
                  validacionText = '⚠️ Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds | Sobran: ' + (-diferencia) + ' uds';
                  validacionColor = '#dc2626';
                }
                prodDiv.innerHTML = '<div style="background:#0ea5e9;color:#fff;font-weight:700;padding:8px 12px;font-size:14px">' + lotesProducto[0].productoNombre + '</div>' +
                  '<div style="padding:4px 12px;font-size:12px;font-weight:700;color:' + validacionColor + '">   ' + validacionText + '</div>';
                const lotesOrdenados = lotesProducto.sort((a, b) => (a.fechaVencimiento || '').localeCompare(b.fechaVencimiento || ''));
                lotesOrdenados.forEach(l => {
                  const fechaVenc = new Date(l.fechaVencimiento);
              const hoy = getFechaArgentina();
              const diasHasta = Math.ceil((fechaVenc - hoy) / 86400000);
                  const icono = diasHasta <= 0 ? '🔴' : diasHasta === 1 ? '🟡' : '🟢';
                  const urgencia = diasHasta <= 0 ? ' (¡HOY!)' : diasHasta === 1 ? ' (Mañana)' : '';
                  const fechaDisplay = l.fechaVencimiento ? l.fechaVencimiento.split('-').reverse().slice(0, 2).join('/') : '-';
                  const fila = document.createElement('div');
                  fila.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:4px 24px;font-size:14px';
                  fila.innerHTML = '<span>' + icono + ' ' + l.cantidad + ' uds → ' + fechaDisplay + urgencia + '</span>' +
                    '<button data-lote-id="' + l.id + '" style="padding:4px 8px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px">❌</button>';
                  prodDiv.appendChild(fila);
                });
                catDiv.appendChild(prodDiv);
              }
            });
            list.appendChild(catDiv);
          }
        });

        if (!hayProductosConLotes && Object.keys(productosConStockSinLotes).length === 0) {
          const empty = document.createElement('div');
          empty.style.cssText = 'text-align:center;padding:40px;color:#6b7280;font-size:14px';
          empty.textContent = 'No hay lotes cargados';
          list.appendChild(empty);
        }

        // Actualizar botón de WhatsApp después de renderizar lotes
        actualizarBotonWhatsApp(lotes);

        list.querySelectorAll('[data-lote-id]').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('¿Eliminar este lote?')) return;
            try {
              const db = FirebaseRegionManager.getFirestore();
              await db.collection('locales').doc(localId).collection('vencimientos_activos').doc(btn.getAttribute('data-lote-id')).delete();
              await renderLotes();
              // Actualizar cantidad faltante después de eliminar el lote
              await actualizarCantidadFaltante();
            } catch (e) {
              alert('Error al eliminar lote: ' + e.message);
            }
          };
        });
      } catch (e) {
        console.error('Error renderizando lotes:', e);
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626">Error cargando lotes: ' + e.message + '</div>';
      }
    }

    function actualizarBotonWhatsApp(lotes) {
      const container = colRight.querySelector('#vl-whatsapp-container');
      container.innerHTML = '';
      
      if (!lotes || lotes.length === 0) {
        return;
      }

      const btn = document.createElement('button');
      btn.style.cssText = 'width:100%;padding:12px;background:#25D366;color:#fff;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px';
      btn.innerHTML = '📱 Enviar Informe por WhatsApp';
      btn.onclick = () => generarInformeWhatsApp(lotes);
      container.appendChild(btn);
    }

    function generarInformeWhatsApp(lotes) {
      const hoy = getFechaActualArgentina();
      const fechaHoy = new Date(hoy + 'T00:00:00');
      const fechaManana = new Date(fechaHoy);
      fechaManana.setDate(fechaManana.getDate() + 1);
      
      const hoyStr = fechaISO(fechaHoy);
      const mananaStr = fechaISO(fechaManana);
      
      const vencimientosHoy = [];
      const vencimientosManana = [];
      const vencimientosProximos = [];
      
      // Función para obtener abreviación - EXACTO como Android
      const obtenerAbreviacionVencimiento = (codigo) => {
        if (!codigo) return codigo;
        const codigoUpper = codigo.toUpperCase();
        if (codigoUpper.startsWith('JQ')) return 'JQ';
        if (codigoUpper.startsWith('PB')) return 'PB';
        if (codigoUpper.startsWith('CS')) return 'CS';
        if (codigoUpper.startsWith('PO')) return 'PO';
        if (codigoUpper.startsWith('CP')) return 'CP';
        if (codigoUpper.startsWith('HU')) return 'HU';
        if (codigoUpper.startsWith('ES')) return 'ES';
        if (codigoUpper.startsWith('CQ')) return 'CQ';
        if (codigoUpper.startsWith('RJ')) return 'RJ';
        if (codigoUpper.startsWith('QC')) return 'QC';
        if (codigoUpper.startsWith('CB')) return 'CB';
        if (codigoUpper.startsWith('CH')) return 'CH';
        if (codigoUpper.startsWith('MUZZARE') || codigoUpper.startsWith('MUZZA')) return 'MUZZA';
        if (codigoUpper.startsWith('JAMON')) return 'JAMON';
        if (codigoUpper.startsWith('PEPPERO') || codigoUpper.startsWith('PEPPER')) return 'PEPPER';
        if (codigoUpper.startsWith('BATATA')) return 'BATATA';
        if (codigoUpper.startsWith('MEMBRIL')) return 'MEMBRIL';
        if (codigoUpper.startsWith('DULCES')) return 'DULCES';
        if (codigoUpper.startsWith('SALADO')) return 'SALADO';
        if (codigoUpper.startsWith('CHIPA')) return 'CHIPA';
        if (codigoUpper.startsWith('CRIOLLITO')) return 'CRIOLLITO';
        return codigo;
      };
      
      lotes.forEach(lote => {
        if (!lote.fechaVencimiento) return;
        
        const fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
        const fechaVencStr = fechaISO(fechaVenc);
        const diasHasta = Math.floor((fechaVenc - fechaHoy) / (1000 * 60 * 60 * 24));
        
        // Usar código abreviado como en Android línea 2041, 2049, 2057
        const codigo = lote.productoCodigo || lote.codigo || '';
        const codigoAbreviado = obtenerAbreviacionVencimiento(codigo);
        
        // Formatear fecha como dd/MM/yyyy
        const fechaParts = lote.fechaVencimiento.split('-');
        const fechaDisplay = fechaParts.length === 3 ? `${fechaParts[2]}/${fechaParts[1]}/${fechaParts[0]}` : lote.fechaVencimiento;
        
        const item = {
          codigo: codigoAbreviado,
          cantidad: lote.cantidad,
          fecha: fechaDisplay,
          dias: diasHasta
        };
        
        if (fechaVencStr === hoyStr) {
          vencimientosHoy.push(item);
        } else if (fechaVencStr === mananaStr) {
          vencimientosManana.push(item);
        } else if (diasHasta > 1 && diasHasta <= 7) {
          vencimientosProximos.push(item);
        }
      });
      
      // Ordenar próximos por fecha
      vencimientosProximos.sort((a, b) => a.dias - b.dias);
      
      // Calcular totales
      const totalHoy = vencimientosHoy.reduce((sum, v) => sum + v.cantidad, 0);
      const totalManana = vencimientosManana.reduce((sum, v) => sum + v.cantidad, 0);
      
      // Construir mensaje - EXACTO como Android línea 2033-2068
      const fechaHoyDisplay = fechaHoy.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
      
      let mensaje = '⌛*VENCIMIENTOS*⌛\n';
      mensaje += 'Local: ' + (localNombre || 'Local') + '\n';
      mensaje += 'Fecha: ' + fechaHoyDisplay + '\n\n';
      
      if (vencimientosHoy.length > 0) {
        mensaje += '> *VENCEN HOY* 🚨:\n';
        vencimientosHoy.forEach(v => {
          mensaje += '  • ' + v.codigo + ': ' + v.cantidad + ' uds\n';
        });
        mensaje += '\n';
      }
      
      if (vencimientosManana.length > 0) {
        mensaje += '> *VENCEN MAÑANA* ⚠️:\n';
        vencimientosManana.forEach(v => {
          mensaje += '  • ' + v.codigo + ': ' + v.cantidad + ' uds\n';
        });
        mensaje += '\n';
      }
            
      if (vencimientosHoy.length === 0 && vencimientosManana.length === 0) {
        mensaje += '✅ OK - No hay vencimientos proximos en los proximos 2 dias.\n\n';
      }
      
      mensaje += '===========================\n';
      
      // Función para escapar HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Mostrar modal de vista previa
      const previewOverlay = document.createElement('div');
      previewOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10000';
      const previewModal = document.createElement('div');
      previewModal.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:20px;max-height:80vh;overflow:auto';
      
      const previewTitle = document.createElement('div');
      previewTitle.style.cssText = 'font-weight:700;font-size:18px;margin-bottom:16px';
      previewTitle.textContent = 'Vista Previa del Mensaje';
      
      const previewContent = document.createElement('div');
      previewContent.style.cssText = 'background:#f9fafb;padding:16px;border-radius:6px;font-family:monospace;white-space:pre-wrap;font-size:14px;line-height:1.6;border:1px solid #e5e7eb;word-wrap:break-word';
      previewContent.textContent = mensaje;
      
      const previewButtons = document.createElement('div');
      previewButtons.style.cssText = 'display:flex;gap:8px;margin-top:16px';
      
      const btnCopy = document.createElement('button');
      btnCopy.id = 'preview-copy';
      btnCopy.style.cssText = 'flex:1;padding:10px;background:#10b981;color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer';
      btnCopy.textContent = 'Copiar y Abrir WhatsApp';
      
      const btnCancel = document.createElement('button');
      btnCancel.id = 'preview-cancel';
      btnCancel.style.cssText = 'padding:10px;background:#6b7280;color:#fff;border:none;border-radius:6px;cursor:pointer';
      btnCancel.textContent = 'Cancelar';
      
      previewButtons.appendChild(btnCopy);
      previewButtons.appendChild(btnCancel);
      
      previewModal.appendChild(previewTitle);
      previewModal.appendChild(previewContent);
      previewModal.appendChild(previewButtons);
      previewOverlay.appendChild(previewModal);
      document.body.appendChild(previewOverlay);
      
      previewOverlay.querySelector('#preview-cancel').onclick = () => previewOverlay.remove();
      previewOverlay.querySelector('#preview-copy').onclick = () => {
        // Copiar mensaje al portapapeles
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(mensaje).then(() => {
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          }).catch(() => {
            alert('Error copiando al portapapeles. Abriendo WhatsApp...');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          });
        } else {
          // Fallback
          const textarea = document.createElement('textarea');
          textarea.value = mensaje;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          } catch (e) {
            alert('Error copiando. Abriendo WhatsApp...');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          }
          document.body.removeChild(textarea);
        }
      };
    }

    header.querySelector('#vloc-close').onclick = () => overlay.remove();
    colLeft.querySelector('#vl-prod-prev').onclick = () => cambiarProducto(-1);
    colLeft.querySelector('#vl-prod-next').onclick = () => cambiarProducto(1);
    colLeft.querySelector('#vl-prod').onchange = () => actualizarCantidadFaltante();
    
    // Asignar eventos de navegación de fecha con validación
    const btnFechaPrev = colLeft.querySelector('#vl-fecha-prev');
    const btnFechaNext = colLeft.querySelector('#vl-fecha-next');
    const fechaInput = colLeft.querySelector('#vl-fecha');
    
    if (btnFechaPrev) {
      btnFechaPrev.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        cambiarFecha(-1);
      };
    }
    
    if (btnFechaNext) {
      btnFechaNext.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Botón siguiente clickeado, cambiando fecha +1');
        cambiarFecha(1);
        return false;
      };
    }
    
    // Configurar input date
    if (fechaInput) {
      // Inicializar el valor del input date
      fechaInput.value = fechaVencimientoSeleccionada;
      
      // Actualizar cuando el usuario cambie la fecha manualmente en el input
      fechaInput.onchange = (e) => {
        fechaVencimientoSeleccionada = e.target.value;
        actualizarTextoFecha();
      };
    }
    
    // Configurar input de cantidad para seleccionar todo el texto al hacer focus
    const cantInput = colLeft.querySelector('#vl-cant');
    if (cantInput) {
      cantInput.onfocus = function() { this.select(); };
    }
    colLeft.querySelector('#vl-add').onclick = async () => {
      const codigo = colLeft.querySelector('#vl-prod').value;
      const fecha = fechaVencimientoSeleccionada;
      const cant = parseInt(colLeft.querySelector('#vl-cant').value);
      const msg = colLeft.querySelector('#vl-msg');
      if (!codigo || !fecha || !cant || cant <= 0) {
        msg.style.color = '#dc2626';
        msg.textContent = 'Complete producto, fecha y cantidad válida';
        return;
      }
      
      // Validar que el stock final de ayer esté cargado antes de permitir cargar lotes (como Android)
      try {
        const fechaHoy = getFechaActualArgentina();
        const fechaAyerObj = new Date(fechaHoy);
        fechaAyerObj.setDate(fechaAyerObj.getDate() - 1);
        const fechaAyer = fechaISO(fechaAyerObj);
        
        const db = FirebaseRegionManager.getFirestore();
        const docStockFinalAyer = await db.collection('locales')
          .doc(localId)
          .collection('registros')
          .doc(`${fechaAyer}_Stock_Final`)
          .get();
        
        if (!docStockFinalAyer.exists) {
          const fechaAyerFormateada = fechaAyerObj.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
          
          // Crear diálogo de alerta similar a Android
          const alertOverlay = document.createElement('div');
          alertOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10001';
          
          const alertDialog = document.createElement('div');
          alertDialog.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden';
          
          const alertHeader = document.createElement('div');
          alertHeader.style.cssText = 'background:#ff9800;color:#fff;padding:16px;font-weight:bold;font-size:18px';
          alertHeader.textContent = '⚠️ Stock Final Pendiente';
          alertDialog.appendChild(alertHeader);
          
          const alertBody = document.createElement('div');
          alertBody.style.cssText = 'padding:20px;font-size:15px;line-height:1.6;color:#374151';
          alertBody.innerHTML = `No podés cargar lotes porque falta cargar el Stock Final de ayer (${fechaAyerFormateada}).<br><br>Por favor, cargá el Stock Final de ayer primero.`;
          alertDialog.appendChild(alertBody);
          
          const alertFooter = document.createElement('div');
          alertFooter.style.cssText = 'padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end';
          
          const btnEntendido = document.createElement('button');
          btnEntendido.textContent = 'Entendido';
          btnEntendido.style.cssText = 'padding:8px 24px;background:#6b7280;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold';
          btnEntendido.onclick = () => alertOverlay.remove();
          
          const btnIrStock = document.createElement('button');
          btnIrStock.textContent = '📊 Ir a Stock Final';
          btnIrStock.style.cssText = 'padding:8px 24px;background:#10b981;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold';
          btnIrStock.onclick = () => {
            alertOverlay.remove();
            overlay.remove(); // Cerrar también el modal de vencimientos
            // Abrir Stock Final de ayer
            if (window.abrirCargaStock) {
              // Cambiar fecha seleccionada a ayer antes de abrir
              const fechaAyerDate = new Date(fechaAyer);
              if (window.setFechaSeleccionada) {
                window.setFechaSeleccionada(fechaAyerDate);
              }
              setTimeout(() => {
                window.abrirCargaStock();
              }, 300);
            } else {
              alert('Por favor, usa el botón "Stock Final" en el menú principal y selecciona la fecha de ayer');
            }
          };
          
          alertFooter.appendChild(btnEntendido);
          alertFooter.appendChild(btnIrStock);
          alertDialog.appendChild(alertFooter);
          
          alertOverlay.appendChild(alertDialog);
          document.body.appendChild(alertOverlay);
          
          // Cerrar al hacer click fuera del diálogo
          alertOverlay.onclick = (e) => {
            if (e.target === alertOverlay) alertOverlay.remove();
          };
          
          return; // No continuar con la carga del lote
        }
      } catch (e) {
        console.error('Error verificando Stock Final de ayer:', e);
        msg.style.color = '#dc2626';
        msg.textContent = 'Error verificando Stock Final de ayer: ' + e.message;
        return;
      }
      
      try {
        const fechaActual = getFechaActualArgentina();
        const nuevoLote = {
          id: Date.now().toString(36) + Math.random().toString(36).substr(2),
          localId: localId,
          productoCodigo: codigo,
          productoNombre: productos[codigo] || codigo,
          cantidad: cant,
          cantidadInicial: cant,
          fechaVencimiento: fecha,
          fechaCarga: fechaActual,
          timestamp: Date.now()
        };
        const db = FirebaseRegionManager.getFirestore();
        await db.collection('locales').doc(localId).collection('vencimientos_activos').doc(nuevoLote.id).set(nuevoLote);
        msg.style.color = '#059669';
        msg.textContent = 'Lote agregado exitosamente';
        await renderLotes();
        
        // Actualizar cantidad faltante después de agregar el lote
        const infoFaltante = await actualizarCantidadFaltante();
        
        // Si el producto actual ya está completamente lotado (faltante === 0), pasar al siguiente
        if (infoFaltante && infoFaltante.faltante === 0 && infoFaltante.stockActual > 0) {
          // Esperar un momento para que el usuario vea el mensaje de éxito
          setTimeout(async () => {
            const encontrado = await buscarSiguienteProductoSinLotes();
            if (encontrado) {
              msg.style.color = '#0ea5e9';
              msg.textContent = 'Producto completo. Cambiando al siguiente producto sin lotes...';
              // Limpiar el mensaje después de 2 segundos
              setTimeout(() => {
                msg.textContent = '';
              }, 2000);
            } else {
              msg.style.color = '#059669';
              msg.textContent = '¡Todos los productos con stock ya tienen lotes cargados!';
            }
          }, 500);
        }
      } catch (e) {
        msg.style.color = '#dc2626';
        msg.textContent = 'Error: ' + e.message;
      }
    };

    document.body.appendChild(overlay);
    actualizarTextoFecha();
    await renderProductos();
    await renderLotes();
    // Actualizar cantidad faltante para el producto seleccionado por defecto
    await actualizarCantidadFaltante();
  }

  // ============================================
  // SISTEMA DE PEDIDO A FÁBRICA
  // ============================================

  // Modelos de datos
  const productosFabrica = {
    'JQ': { codigo: 'JQ', nombre: 'JQ - Jamón y Queso', categoria: 'EMPANADAS' },
    'PB': { codigo: 'PB', nombre: 'PB - Pollo BBQ', categoria: 'EMPANADAS' },
    'CS': { codigo: 'CS', nombre: 'CS - Carne Suave', categoria: 'EMPANADAS' },
    'PO': { codigo: 'PO', nombre: 'PO - Pollo', categoria: 'EMPANADAS' },
    'CP': { codigo: 'CP', nombre: 'CP - Carne Picante', categoria: 'EMPANADAS' },
    'HU': { codigo: 'HU', nombre: 'HU - Humita', categoria: 'EMPANADAS' },
    'ES': { codigo: 'ES', nombre: 'ES - Espinaca', categoria: 'EMPANADAS' },
    'CQ': { codigo: 'CQ', nombre: 'CQ - Calabaza y Queso', categoria: 'EMPANADAS' },
    'RJ': { codigo: 'RJ', nombre: 'RJ - Roquefort y Jamón', categoria: 'EMPANADAS' },
    'QC': { codigo: 'QC', nombre: 'QC - Queso y Cebolla', categoria: 'EMPANADAS' },
    'CB': { codigo: 'CB', nombre: 'CB - Cerdo y Barbacoa', categoria: 'EMPANADAS' },
    'CH': { codigo: 'CH', nombre: 'CH - Cheeseburger', categoria: 'EMPANADAS' },
    'MUZZARE': { codigo: 'MUZZARE', nombre: 'Pizza Muzzarella', categoria: 'PIZZAS' },
    'JAMON': { codigo: 'JAMON', nombre: 'Pizza Jamón', categoria: 'PIZZAS' },
    'PEPPERO': { codigo: 'PEPPERO', nombre: 'Pizza Pepperoni', categoria: 'PIZZAS' },
    'BATATA': { codigo: 'BATATA', nombre: 'Pastelito Batata', categoria: 'PASTELITOS' },
    'MEMBRIL': { codigo: 'MEMBRIL', nombre: 'Pastelito Membrillo', categoria: 'PASTELITOS' }
  };

  const ordenProductos = [
    'JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH',
    'MUZZARE', 'JAMON', 'PEPPERO',
    'BATATA', 'MEMBRIL'
  ];

  const categorias = {
    'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
    'PIZZAS': ['MUZZARE', 'JAMON', 'PEPPERO'],
    'PASTELITOS': ['BATATA', 'MEMBRIL']
  };

  // Productos de Panificadora (movidos desde Pedido a Fábrica)
  const productosPanificadora = {
    'MEDIALUNA_MANTECA': { codigo: 'MEDIALUNA_MANTECA', nombre: 'Medialunas de Manteca', categoria: 'PANIFICADORA' },
    'MEDIALUNA_GRASA': { codigo: 'MEDIALUNA_GRASA', nombre: 'Medialunas de Grasa', categoria: 'PANIFICADORA' },
    'CHIPA': { codigo: 'CHIPA', nombre: 'Chipa', categoria: 'PANIFICADORA' },
    'CRIOLLITO': { codigo: 'CRIOLLITO', nombre: 'Criollitos', categoria: 'PANIFICADORA' }
  };

  const ordenProductosPanificadora = [
    'MEDIALUNA_MANTECA', 'MEDIALUNA_GRASA', 'CHIPA', 'CRIOLLITO'
  ];

  const categoriasPanificadora = {
    'PANIFICADORA': ['MEDIALUNA_MANTECA', 'MEDIALUNA_GRASA', 'CHIPA', 'CRIOLLITO']
  };

  // Función principal para abrir el modal de Pedido a Fábrica
  /**
   * 📈 Obtiene historial de ventas para el gráfico de tendencias
   * Retorna array de {fecha, ventaReal, promedioHistorico}
   */
  async function obtenerHistorialVentasTendencia(codigo, localId, nombreProducto, promediosVentaProducto) {
    try {
      const db = FirebaseRegionManager.getFirestore();
      const historial = [];
      const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
      
      // Cargar últimos 14 días
      for (let i = 1; i <= 14; i++) {
        try {
          const fecha = new Date(fechaHoy);
          fecha.setDate(fecha.getDate() - i);
          const fechaStr = fecha.toISOString().split('T')[0];
          
          const fechaAnterior = new Date(fechaStr);
          fechaAnterior.setDate(fechaAnterior.getDate() - 1);
          const fechaAnteriorStr = fechaAnterior.toISOString().split('T')[0];
          
          // Cargar los 3 documentos necesarios
          const stockAnteriorDoc = await db.collection('locales').doc(localId).collection('registros').doc(fechaAnteriorStr + '_Stock_Final').get();
          const ingresoDoc = await db.collection('locales').doc(localId).collection('registros').doc(fechaStr + '_Ingreso_de_Mercadería').get();
          const stockFinalDoc = await db.collection('locales').doc(localId).collection('registros').doc(fechaStr + '_Stock_Final').get();
          
          // Buscar el producto (múltiples formatos posibles)
          const nombreCompleto = codigo + ' - ' + nombreProducto;
          
          const stockAnterior = stockAnteriorDoc.exists ? (stockAnteriorDoc.data().productos || []).find(p => 
            p.nombre === nombreCompleto || p.nombre.startsWith(codigo + ' ') || p.nombre === codigo
          )?.cantidad || 0 : 0;
          
          const ingreso = ingresoDoc.exists ? (ingresoDoc.data().productos || []).find(p => 
            p.nombre === nombreCompleto || p.nombre.startsWith(codigo + ' ') || p.nombre === codigo
          )?.cantidad || 0 : 0;
          
          const stockFinal = stockFinalDoc.exists ? (stockFinalDoc.data().productos || []).find(p => 
            p.nombre === nombreCompleto || p.nombre.startsWith(codigo + ' ') || p.nombre === codigo
          )?.cantidad || 0 : 0;
          
          // Calcular venta
          const ventaReal = stockAnterior + ingreso - stockFinal;
          
          if (ventaReal > 0 || stockAnterior > 0 || ingreso > 0 || stockFinal > 0) {
            // Obtener día de la semana
            const diaSemana = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'][fecha.getDay()];
            const promedioHistorico = promediosVentaProducto[diaSemana] || 0;
            
            historial.push({
              fecha: fechaStr,
              ventaReal: ventaReal,
              promedioHistorico: promedioHistorico
            });
          }
        } catch (e) {
          console.warn('Error obteniendo día:', e);
        }
      }
      
      return historial.reverse(); // Del más antiguo al más reciente
    } catch (e) {
      console.error('Error obteniendo historial:', e);
      return [];
    }
  }

  /**
   * 📊 Dibuja gráfico de tendencias usando Canvas
   */
  function dibujarGraficoTendencias(canvas, historial, codigo, nombreProducto, tendencia) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Limpiar canvas
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, width, height);
    
    if (historial.length === 0) {
      ctx.fillStyle = '#666666';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('No hay datos suficientes', width / 2, height / 2);
      return;
    }
    
    // Márgenes
    const margin = { top: 80, right: 30, bottom: 60, left: 60 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    
    // Título
    ctx.fillStyle = '#7b2cbf';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(codigo + ' - ' + nombreProducto, width / 2, 30);
    
    // Subtítulo con tendencia
    const iconoTendencia = tendencia >= 10 ? '📈' : tendencia >= 5 ? '⬆️' : tendencia <= -10 ? '📉' : '⬇️';
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = tendencia >= 0 ? '#22c55e' : '#f59e0b';
    ctx.fillText(iconoTendencia + ' Tendencia: ' + tendencia.toFixed(1) + '%', width / 2, 55);
    
    // Encontrar valores máximos
    const maxVenta = Math.max(...historial.map(h => h.ventaReal), ...historial.map(h => h.promedioHistorico));
    const minVenta = 0;
    const rangoY = maxVenta - minVenta;
    
    // Función para escalar valores
    const escalaX = (index) => margin.left + (index / (historial.length - 1)) * chartWidth;
    const escalaY = (valor) => margin.top + chartHeight - ((valor - minVenta) / rangoY) * chartHeight;
    
    // Dibujar ejes
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 1;
    
    // Eje Y
    ctx.beginPath();
    ctx.moveTo(margin.left, margin.top);
    ctx.lineTo(margin.left, height - margin.bottom);
    ctx.stroke();
    
    // Eje X
    ctx.beginPath();
    ctx.moveTo(margin.left, height - margin.bottom);
    ctx.lineTo(width - margin.right, height - margin.bottom);
    ctx.stroke();
    
    // Etiqueta del eje Y (arriba)
    ctx.fillStyle = '#7b2cbf';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.save();
    ctx.translate(20, margin.top + chartHeight / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Unidades', 0, 0);
    ctx.restore();
    
    // Etiquetas eje Y
    ctx.fillStyle = '#666666';
    ctx.font = '12px Arial';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
      const valor = minVenta + (rangoY / 5) * i;
      const y = escalaY(valor);
      ctx.fillText(Math.round(valor), margin.left - 10, y + 4);
      
      // Líneas guía horizontales (más visibles)
      ctx.strokeStyle = '#d1d5db'; // Gris más oscuro
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(margin.left, y);
      ctx.lineTo(width - margin.right, y);
      ctx.stroke();
    }
    
    // Etiquetas eje X (fechas) - Mostrar más fechas
    ctx.fillStyle = '#666666';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    
    // Calcular cuántas fechas mostrar (máximo 7-8 para que no se amontonen)
    const maxFechas = Math.min(8, historial.length);
    const intervalo = Math.max(1, Math.floor(historial.length / maxFechas));
    
    historial.forEach((h, i) => {
      // Mostrar primera, última y algunas intermedias
      if (i === 0 || i === historial.length - 1 || i % intervalo === 0) {
        const x = escalaX(i);
        const fecha = h.fecha.split('-');
        ctx.fillText(fecha[2] + '/' + fecha[1], x, height - margin.bottom + 20);
      }
    });
    
    // Dibujar línea de promedio (línea punteada naranja)
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    historial.forEach((h, i) => {
      const x = escalaX(i);
      const y = escalaY(h.promedioHistorico);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Dibujar línea de venta real (línea sólida morada)
    ctx.strokeStyle = '#7b2cbf';
    ctx.lineWidth = 3;
    ctx.beginPath();
    historial.forEach((h, i) => {
      const x = escalaX(i);
      const y = escalaY(h.ventaReal);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.stroke();
    
    // Dibujar puntos sobre la línea de venta real
    historial.forEach((h, i) => {
      const x = escalaX(i);
      const y = escalaY(h.ventaReal);
      
      ctx.fillStyle = '#7b2cbf';
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fill();
      
      ctx.strokeStyle = '#FFFFFF';
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    // Leyenda
    const leyendaY = height - 25;
    
    // Venta Real
    ctx.strokeStyle = '#7b2cbf';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(width / 2 - 100, leyendaY);
    ctx.lineTo(width / 2 - 70, leyendaY);
    ctx.stroke();
    ctx.fillStyle = '#666666';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Venta Real', width / 2 - 65, leyendaY + 4);
    
    // Promedio
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(width / 2 + 20, leyendaY);
    ctx.lineTo(width / 2 + 50, leyendaY);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillText('Promedio', width / 2 + 55, leyendaY + 4);
  }

  /**
   * 📈 Muestra el gráfico de tendencias en un modal
   */
  window.mostrarGraficoTendenciaGlobal = async function(codigo, tendencia, nombreProducto, promediosVentaProducto, localId) {
    try {
      // Mostrar loading
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999';
      loadingOverlay.innerHTML = '<div style="background:#fff;padding:30px;border-radius:8px;text-align:center"><div style="font-size:24px;margin-bottom:10px">📊</div><div style="font-size:16px;font-weight:700;color:#7b2cbf">Cargando gráfico...</div></div>';
      document.body.appendChild(loadingOverlay);
      
      const historial = await obtenerHistorialVentasTendencia(codigo, localId, nombreProducto, promediosVentaProducto);
      
      // Remover loading
      document.body.removeChild(loadingOverlay);
      
      // Crear modal
      const modalOverlay = document.createElement('div');
      modalOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background:#fff;border-radius:8px;padding:20px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto';
      
      // Canvas para el gráfico
      const canvas = document.createElement('canvas');
      canvas.width = 850;
      canvas.height = 500;
      canvas.style.cssText = 'width:100%;height:auto;display:block';
      
      // Dibujar gráfico
      dibujarGraficoTendencias(canvas, historial, codigo, nombreProducto, tendencia);
      
      modalContent.appendChild(canvas);
      
      // Mensaje
      const mensaje = document.createElement('div');
      mensaje.style.cssText = 'text-align:center;margin-top:15px;font-size:14px;font-weight:700;color:' + (tendencia >= 0 ? '#22c55e' : '#f59e0b');
      mensaje.textContent = tendencia >= 5 ? '💡 Sugerencias ajustadas automáticamente' : '💡 Considera reducir el pedido';
      modalContent.appendChild(mensaje);
      
      // Botón cerrar
      const btnCerrar = document.createElement('button');
      btnCerrar.textContent = 'Entendido';
      btnCerrar.style.cssText = 'display:block;margin:20px auto 0;padding:12px 30px;background:#7b2cbf;color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer';
      btnCerrar.onclick = () => document.body.removeChild(modalOverlay);
      modalContent.appendChild(btnCerrar);
      
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
      
      // Cerrar al hacer click fuera
      modalOverlay.onclick = (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
        }
      };
      
    } catch (e) {
      console.error('Error mostrando gráfico:', e);
      alert('Error mostrando gráfico: ' + e.message);
    }
  }

  async function openPedidoFabricaModal() {
    const u = localStorage.getItem('usuario');
    if (!u) {
      alert('Inicie sesión primero.');
      return;
    }
    const usuario = JSON.parse(u);
    const localId = usuario.localId || '';
    const localNombre = usuario.localNombre || 'Local';
    
    if (!localId) {
      alert('Error: No se encontró el local');
      return;
    }
    
    // Verificar que Firebase esté inicializado, si no, inicializarlo con la región guardada
    try {
      FirebaseRegionManager.getFirestore();
    } catch (e) {
      // Firebase no está inicializado, intentar inicializarlo con la región guardada
      const regionIdGuardada = localStorage.getItem('region_id');
      if (regionIdGuardada && usuario.regionId) {
        try {
          // Cargar regiones disponibles
          const regiones = await FirebaseRegionManager.cargarRegiones();
          const regionGuardada = regiones.find(r => r.id === regionIdGuardada || r.id === usuario.regionId);
          if (regionGuardada) {
            FirebaseRegionManager.initializeFirebase(regionGuardada);
            console.log('Firebase inicializado para Pedido a Fábrica con región:', regionGuardada.nombre);
          } else {
            throw new Error('No se encontró la región guardada');
          }
        } catch (error) {
          console.error('Error inicializando Firebase:', error);
          alert('Error: No se pudo inicializar Firebase. Por favor, selecciona una región primero.');
          return;
        }
      } else {
        alert('Error: No se encontró la región. Por favor, selecciona una región primero.');
        return;
      }
    }

    // Obtener fecha actual (Argentina UTC-3)
    const hoy = new Date();
    const offsetArgentina = -3 * 60; // UTC-3 en minutos
    const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
    let fechaSeleccionada = fechaISO(fechaArgentina);
    let modoSoloLectura = false;
    let modoAdmin = false; // TODO: Detectar si es admin desde usuario

    // Crear overlay y modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;width:95%;max-width:1200px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column';
    overlay.appendChild(modal);

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;position:relative';
    header.innerHTML = '<div style="display:flex;align-items:center;gap:12px;flex:1">' +
      '<button id="pf-volver" style="padding:8px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:700">←</button>' +
      '<button id="pf-config" style="padding:8px 12px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:16px">⚙️</button>' +
      '</div>' +
      '<div style="position:absolute;left:50%;transform:translateX(-50%);font-weight:700;font-size:18px;text-align:center">🏭 Pedido Fábrica</div>' +
      '<button id="pf-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;margin-left:auto">Cerrar</button>';
    modal.appendChild(header);

    // Navegación de fechas
    const navFecha = document.createElement('div');
    navFecha.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:8px;padding:8px;background:#f3f4f6;border-bottom:1px solid #e5e7eb';
    navFecha.innerHTML = '<button id="pf-fecha-prev" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">←</button>' +
      '<div id="pf-fecha-actual" style="padding:8px 16px;font-weight:700;font-size:14px">' + fechaSeleccionada + '</div>' +
      '<button id="pf-fecha-next" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">→</button>';
    modal.appendChild(navFecha);

    // Información del día (replica exacta del layout de la APK)
    const infoDia = document.createElement('div');
    infoDia.style.cssText = 'background:#f3f4f6;padding:6px;border-bottom:1px solid #e5e7eb';
    
    // Primera fila: Día y % Extra
    const fila1 = document.createElement('div');
    fila1.style.cssText = 'display:flex;justify-content:space-between;align-items:center;font-size:12px';
    fila1.innerHTML = '<div id="pf-dia-actual" style="font-weight:700;flex:1">Día: LUNES</div>' +
      '<div id="pf-porcentaje" style="font-weight:700;flex:1;text-align:right">% Extra: 30%</div>';
    infoDia.appendChild(fila1);
    
    // Segunda fila: Días extra (inicialmente oculto)
    const fila2 = document.createElement('div');
    fila2.id = 'pf-dias-extra';
    fila2.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:2px;display:none';
    fila2.textContent = '📅 Pedido para: Mañana';
    infoDia.appendChild(fila2);
    
    // Tercera fila: Hora de alerta
    const fila3 = document.createElement('div');
    fila3.id = 'pf-hora-alerta';
    fila3.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:4px';
    fila3.textContent = '🔔 Alerta: 15:30';
    infoDia.appendChild(fila3);
    
    modal.appendChild(infoDia);

    // Leyenda de tendencias (igual que Android)
    const leyendaTendencias = document.createElement('div');
    leyendaTendencias.style.cssText = 'background:#f3f4f6;padding:4px;text-align:center;font-size:10px;color:#6b7280;border-bottom:1px solid #e5e7eb';
    leyendaTendencias.textContent = '📈≥10% | ⬆️5-10% | 📉≤-10% | ⬇️-10 a -5%';
    modal.appendChild(leyendaTendencias);

    // Contenido principal
    const body = document.createElement('div');
    body.style.cssText = 'flex:1;overflow-y:auto;padding:16px';
    body.id = 'pf-body';
    modal.appendChild(body);

    // Variables de estado
    let configuracion = { porcentajeExtra: 30, horaAlerta: '15:30', activarAlerta: true };
    let diasEntrega = { lunes: 'Mañana', martes: 'Mañana', miercoles: 'Mañana', jueves: 'Mañana', viernes: 'Sábado + Domingo', sabado: 'Domingo', domingo: 'Mañana' };
    let productos = [];
    let promediosVenta = {}; // {codigo: {LUNES: 100, MARTES: 120, ...}}
    
    // 📈 Cache de tendencias de ventas (igual que Android)
    let cacheTendencias = null; // {codigo: porcentaje de tendencia}

    // Función helper para obtener Firestore de la región actual
    function obtenerFirestore() {
      try {
        return FirebaseRegionManager.getFirestore();
      } catch (e) {
        console.error('Error obteniendo Firestore:', e);
        throw new Error('Firebase no está inicializado. Por favor, selecciona una región primero.');
      }
    }

    // Función para obtener día de la semana
    function obtenerDiaSemana(fecha) {
      const [y, m, d] = fecha.split('-').map(Number);
      const date = new Date(y, m - 1, d);
      const dias = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'];
      return dias[date.getDay()];
    }

    /**
     * 📥 Carga el cache completo de tendencias desde Firebase (igual que Android)
     * Usa documento único "tendencias" que se sobrescribe (sin fecha)
     */
    async function cargarCacheTendenciasDesdeFirebase() {
      try {
        // Si ya tenemos cache en memoria, no cargar de nuevo
        if (cacheTendencias !== null) {
          console.log('✅ Cache ya disponible en memoria (' + Object.keys(cacheTendencias).length + ' productos)');
          return;
        }

        console.log('📥 Cargando cache de tendencias desde Firebase (documento único)...');
        const db = obtenerFirestore();
        
        const docTendencias = await db.collection('locales')
          .doc(localId)
          .collection('cache_tendencias')
          .doc('tendencias')  // Documento único
          .get();

        if (docTendencias.exists) {
          const data = docTendencias.data();
          if (data) {
            const tendenciasGuardadas = {};
            Object.keys(data).forEach(key => {
              if (key !== 'timestamp' && key !== 'fecha') {
                tendenciasGuardadas[key] = data[key] || 0;
              }
            });

            if (Object.keys(tendenciasGuardadas).length > 0) {
              cacheTendencias = tendenciasGuardadas;
              console.log('✅ Cache cargado desde Firebase: ' + Object.keys(tendenciasGuardadas).length + ' productos');
              console.log('   Productos con tendencia: ' + Object.keys(tendenciasGuardadas).filter(k => tendenciasGuardadas[k] !== 0).length);
            } else {
              console.log('⚠️ Documento existe pero no tiene tendencias válidas');
            }
          } else {
            console.log('⚠️ Documento existe pero está vacío');
          }
        } else {
          console.log('ℹ️ No hay cache en Firebase (aún no se cargó Stock Final)');
        }
      } catch (e) {
        console.error('❌ Error cargando cache desde Firebase:', e);
      }
    }

    /**
     * 📈 Detecta tendencia de ventas de un producto
     * SOLO lee del cache (igual que Android)
     */
    function detectarTendenciaVentas(codigo) {
      try {
        if (cacheTendencias !== null) {
          const tendenciaCache = cacheTendencias[codigo] || 0;
          if (tendenciaCache !== 0) {
            console.log('⚡ ' + codigo + ': ' + tendenciaCache.toFixed(1) + '% (desde cache)');
          }
          return tendenciaCache;
        }
        return 0;
      } catch (e) {
        return 0;
      }
    }

    // Función para cargar configuración desde Firebase
    async function cargarConfiguracion() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarConfiguracion, usando valores por defecto');
          actualizarUI();
          return;
        }
        
        // 📈 Cargar cache de tendencias desde Firebase al inicio (una sola vez)
        await cargarCacheTendenciasDesdeFirebase();
        
        const configDoc = await db.collection('locales').doc(localId).collection('configuracion_pedido_fabrica').doc('config').get();
        if (configDoc.exists) {
          const data = configDoc.data();
          configuracion = {
            porcentajeExtra: data.porcentajeExtra || 30,
            horaAlerta: data.horaAlerta || '15:30',
            activarAlerta: data.activarAlerta !== false
          };
        }
        const diasDoc = await db.collection('locales').doc(localId).collection('configuracion_dias_entrega').doc('config').get();
        if (diasDoc.exists) {
          const data = diasDoc.data();
          diasEntrega = {
            lunes: data.lunes !== false,
            martes: data.martes !== false,
            miercoles: data.miercoles !== false,
            jueves: data.jueves !== false,
            viernes: data.viernes !== false,
            sabado: data.sabado !== false,
            domingo: data.domingo !== false
          };
        } else {
          // Valores por defecto: todos los días habilitados
          diasEntrega = {
            lunes: true,
            martes: true,
            miercoles: true,
            jueves: true,
            viernes: true,
            sabado: true,
            domingo: true
          };
        }
        actualizarUI();
      } catch (e) {
        console.warn('Error cargando configuración:', e);
      }
    }

    // Función para actualizar UI con configuración
    function actualizarUI() {
      const porcentajeEl = document.getElementById('pf-porcentaje');
      const horaAlertaEl = document.getElementById('pf-hora-alerta');
      const diaActualEl = document.getElementById('pf-dia-actual');
      
      if (porcentajeEl) porcentajeEl.textContent = '% Extra: ' + configuracion.porcentajeExtra + '%';
      if (horaAlertaEl) horaAlertaEl.textContent = '🔔 Alerta: ' + configuracion.horaAlerta;
      
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      if (diaActualEl) diaActualEl.textContent = 'Día: ' + diaActual;
      
      // Actualizar información de días extra
      actualizarInformacionDiasExtra();
    }

    // Función para cargar promedios de ventas
    async function cargarPromediosVenta() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPromediosVenta');
          return;
        }
        const registrosSnap = await db.collection('locales').doc(localId).collection('registros').orderBy('fecha', 'desc').limit(100).get();
        const registros = [];
        registrosSnap.forEach(d => {
          const data = d.data();
          registros.push({ 
            fecha: data.fecha, 
            tipo: data.tipo, 
            productos: data.productos || [] 
          });
        });

        // Agrupar por día de la semana
        const ventasPorDia = { LUNES: {}, MARTES: {}, MIERCOLES: {}, JUEVES: {}, VIERNES: {}, SABADO: {}, DOMINGO: {} };
        
        // Procesar cada fecha
        const fechasProcesadas = new Set();
        registros.forEach(registro => {
          if (fechasProcesadas.has(registro.fecha)) return;
          fechasProcesadas.add(registro.fecha);
          
          const dia = obtenerDiaSemana(registro.fecha);
          if (!(dia in ventasPorDia)) return;
          
          const ingreso = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Ingreso de Mercadería');
          const stockFinal = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Stock Final');
          
          if (!stockFinal || !stockFinal.productos) return;
          
          // Calcular fecha anterior
          const [y, m, d] = registro.fecha.split('-').map(Number);
          const fechaAnterior = new Date(y, m - 1, d);
          fechaAnterior.setDate(fechaAnterior.getDate() - 1);
          const fechaAnteriorStr = fechaISO(fechaAnterior);
          const stockAnterior = registros.find(r => r.fecha === fechaAnteriorStr && r.tipo === 'Stock Final');
          
          // Calcular ventas por producto
          stockFinal.productos.forEach(p => {
            const ingresoCant = (ingreso?.productos || []).find(ip => ip.nombre === p.nombre)?.cantidad || 0;
            const stockAntCant = (stockAnterior?.productos || []).find(sp => sp.nombre === p.nombre)?.cantidad || 0;
            const venta = stockAntCant + ingresoCant - p.cantidad;
            
            if (venta > 0) {
              if (!ventasPorDia[dia][p.nombre]) {
                ventasPorDia[dia][p.nombre] = [];
              }
              ventasPorDia[dia][p.nombre].push(venta);
            }
          });
        });

        // Calcular promedios por código de producto (replica de calcularPromediosPorDia de la APK)
        ordenProductos.forEach(codigo => {
          promediosVenta[codigo] = {};
          const nombreCompleto = obtenerNombreProducto(codigo);
          const claveCompleta = codigo + ' - ' + nombreCompleto;
          
          ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'].forEach(dia => {
            const ventas = [];
            
            // Buscar ventas que coincidan con este producto (igual que la APK)
            Object.keys(ventasPorDia[dia] || {}).forEach(nombreProducto => {
              // Buscar por clave completa "CÓDIGO - Nombre"
              if (nombreProducto === claveCompleta) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // Si no se encuentra, intentar con nombre del producto
              else if (nombreProducto === nombreCompleto) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // Si no se encuentra, intentar con el código directamente
              else if (nombreProducto === codigo) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // También buscar por formato "CÓDIGO -"
              else if (nombreProducto.startsWith(codigo + ' -')) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
            });
            
            // Filtrar solo los días donde este producto tiene ventas > 0
            const ventasConDatos = ventas.filter(v => v > 0);
            
            if (ventasConDatos.length > 0) {
              const suma = ventasConDatos.reduce((sum, v) => sum + v, 0);
              promediosVenta[codigo][dia] = suma / ventasConDatos.length;
            } else {
              promediosVenta[codigo][dia] = 0;
            }
          });
        });
        
        console.log('✅ Promedios cargados:', promediosVenta);
      } catch (e) {
        console.error('Error cargando promedios:', e);
      }
    }

    // Función para obtener nombre del producto (replica de obtenerNombreProducto de la APK)
    function obtenerNombreProducto(codigo) {
      return productosFabrica[codigo]?.nombre || codigo;
    }

    // Función para cargar pedido existente (replica de cargarPedidoExistente de la APK)
    async function cargarPedidoExistente(fecha) {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPedidoExistente');
          return false;
        }
        const pedidoDoc = await db.collection('locales').doc(localId).collection('pedidos_fabrica').doc(fecha).get();
        if (pedidoDoc.exists) {
          const data = pedidoDoc.data();
          
          // Si hay productos guardados, usarlos
          if (data.productos && data.productos.length > 0) {
            productos = ordenProductos.map(codigo => {
              const prodData = (data.productos || []).find(p => p.codigo === codigo);
              return {
                codigo: codigo,
                nombre: obtenerNombreProducto(codigo),
                categoria: productosFabrica[codigo]?.categoria || 'OTROS',
                promediosVenta: promediosVenta[codigo] || {},
                stockActual: prodData?.stock || 0,
                pedidoSugerido: prodData?.sugerencia || 0,
                pedidoFinal: prodData?.pedido || 0
              };
            });
          } else {
            // Si no hay productos guardados, cargar stock actual desde registros
            const stockActualMap = await cargarStockActualDesdeRegistros();
            productos = ordenProductos.map(codigo => ({
              codigo: codigo,
              nombre: obtenerNombreProducto(codigo),
              categoria: productosFabrica[codigo]?.categoria || 'OTROS',
              promediosVenta: promediosVenta[codigo] || {},
              stockActual: stockActualMap[codigo] || 0,
              pedidoSugerido: 0,
              pedidoFinal: 0
            }));
          }
          
          if (data.configuracion) {
            configuracion.porcentajeExtra = data.configuracion.porcentajeExtra || 30;
            configuracion.horaAlerta = data.configuracion.horaAlerta || '15:30';
            configuracion.activarAlerta = data.configuracion.activarAlerta !== false;
            if (data.configuracion.diasEntrega) {
              diasEntrega = data.configuracion.diasEntrega;
            }
          }
          return true;
        }
        return false;
      } catch (e) {
        console.error('Error cargando pedido existente:', e);
        return false;
      }
    }

    // Función para inicializar productos si no hay pedido existente
    async function inicializarProductos() {
      // Cargar stock actual desde registros de inventario
      const stockActualMap = await cargarStockActualDesdeRegistros();
      
      productos = ordenProductos.map(codigo => ({
        codigo: codigo,
        nombre: productosFabrica[codigo]?.nombre || codigo,
        categoria: productosFabrica[codigo]?.categoria || 'OTROS',
        promediosVenta: promediosVenta[codigo] || {},
        stockActual: stockActualMap[codigo] || 0,
        pedidoSugerido: 0,
        pedidoFinal: 0
      }));
    }

    // Función para cargar stock actual desde registros (replica de la APK)
    async function cargarStockActualDesdeRegistros() {
      const stockMap = {};
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarStockActualDesdeRegistros');
          return stockMap;
        }
        // Obtener fecha de HOY (no fechaSeleccionada, sino la fecha actual)
        const hoy = new Date();
        const offsetArgentina = -3 * 60;
        const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
        const fechaHoy = fechaISO(fechaArgentina);
        
        // Obtener fecha anterior
        const [y, m, d] = fechaHoy.split('-').map(Number);
        const fechaAnterior = new Date(y, m - 1, d);
        fechaAnterior.setDate(fechaAnterior.getDate() - 1);
        const fechaAnteriorStr = fechaISO(fechaAnterior);
        
        // Obtener ingreso de HOY (no de fechaSeleccionada)
        const ingresoHoySnap = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', fechaHoy)
          .where('tipo', '==', 'Ingreso de Mercadería')
          .get();
        
        // Obtener stock final del día anterior
        const stockFinalAnteriorSnap = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', fechaAnteriorStr)
          .where('tipo', '==', 'Stock Final')
          .get();
        
        const ingresoHoy = ingresoHoySnap.docs[0]?.data()?.productos || [];
        const stockFinalAnterior = stockFinalAnteriorSnap.docs[0]?.data()?.productos || [];
        
        // Calcular stock actual para cada producto
        ordenProductos.forEach(codigo => {
          const nombreProducto = productosFabrica[codigo]?.nombre || codigo;
          const ingresoCant = ingresoHoy.find(p => 
            p.nombre === nombreProducto || 
            p.nombre.startsWith(codigo + ' -') ||
            p.nombre === codigo
          )?.cantidad || 0;
          const stockAnteriorCant = stockFinalAnterior.find(p => 
            p.nombre === nombreProducto || 
            p.nombre.startsWith(codigo + ' -') ||
            p.nombre === codigo
          )?.cantidad || 0;
          
          stockMap[codigo] = stockAnteriorCant + ingresoCant;
        });
      } catch (e) {
        console.error('Error cargando stock actual:', e);
      }
      return stockMap;
    }

    // Función para obtener datos de venta parcial (replica de obtenerDatosVentaParcial de la APK)
    async function obtenerDatosVentaParcial(codigo) {
      try {
        const db = obtenerFirestore();
        const nombreProducto = productosFabrica[codigo]?.nombre || codigo;
        // Usar fecha de HOY, no fechaSeleccionada
        const hoy = new Date();
        const offsetArgentina = -3 * 60;
        const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
        const fechaHoy = fechaISO(fechaArgentina);
        
        // Calcular fecha anterior
        const [y, m, d] = fechaHoy.split('-').map(Number);
        const fechaAnterior = new Date(y, m - 1, d);
        fechaAnterior.setDate(fechaAnterior.getDate() - 1);
        const fechaAnteriorStr = fechaISO(fechaAnterior);
        
        // Obtener registros
        const registrosSnap = await db.collection('locales').doc(localId).collection('registros').get();
        const registros = [];
        registrosSnap.forEach(d => {
          const data = d.data();
          registros.push({
            fecha: data.fecha,
            tipo: data.tipo,
            productos: data.productos || []
          });
        });
        
        // Obtener stock anterior (stock final del día anterior)
        const stockAnteriorReg = registros.find(r => r.fecha === fechaAnteriorStr && r.tipo === 'Stock Final');
        const stockAnterior = stockAnteriorReg?.productos?.find(p => 
          p.nombre === nombreProducto || 
          p.nombre.startsWith(codigo + ' -') ||
          p.nombre === codigo
        )?.cantidad || 0;
        
        // Obtener ingreso del día actual
        const ingresoHoyReg = registros.find(r => r.fecha === fechaHoy && r.tipo === 'Ingreso de Mercadería');
        const ingresoHoy = ingresoHoyReg?.productos?.find(p => 
          p.nombre === nombreProducto || 
          p.nombre.startsWith(codigo + ' -') ||
          p.nombre === codigo
        )?.cantidad || 0;
        
        return [stockAnterior, ingresoHoy];
      } catch (e) {
        console.error('Error obteniendo datos venta parcial:', e);
        return [0, 0];
      }
    }

    // Función para obtener promedios hasta próxima entrega (replica de obtenerPromediosHastaProximaEntrega de la APK)
    function obtenerPromediosHastaProximaEntrega(codigo) {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diaSiguiente = obtenerDiaSiguiente(diaActual);
      
      // Siempre incluir el día siguiente
      let suma = promediosVenta[codigo]?.[diaSiguiente] || 0;
      
      // Obtener días extra según configuración
      const diasExtra = obtenerDiasExtraSegunTexto();
      diasExtra.forEach(dia => {
        suma += promediosVenta[codigo]?.[dia] || 0;
      });
      
      return suma;
    }

    // Función para obtener días extra según texto (replica de obtenerDiasExtraSegunTexto de la APK)
    function obtenerDiasExtraSegunTexto() {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diasExtra = [];
      
      // Obtener la lista de próximos días con sus configuraciones (usando booleanos)
      const proximosDias = {
        'LUNES': [['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes]],
        'MARTES': [['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado]],
        'MIERCOLES': [['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo]],
        'JUEVES': [['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes]],
        'VIERNES': [['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes]],
        'SABADO': [['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles]],
        'DOMINGO': [['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves]]
      };
      
      const lista = proximosDias[diaActual] || [];
      if (lista.length === 0) return diasExtra;
      
      // Verificar que el primer día (mañana) tenga entrega
      const [primerDia, tieneEntregaPrimerDia] = lista[0];
      if (!tieneEntregaPrimerDia) {
        return diasExtra; // No se puede hacer pedido
      }
      
      // Revisar días después de mañana
      for (let i = 1; i < lista.length; i++) {
        const [nombreDia, tieneEntrega] = lista[i];
        if (!tieneEntrega) {
          diasExtra.push(nombreDia);
        } else {
          break; // Parar al encontrar día con entrega
        }
      }
      
      return diasExtra;
    }

    // Función para obtener día siguiente
    function obtenerDiaSiguiente(dia) {
      const dias = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
      const index = dias.indexOf(dia);
      return dias[(index + 1) % 7];
    }

    // Función para redondear sugerencia según tipo de producto (replica exacta de redondearSugerencia de la APK)
    function redondearSugerencia(sugerencia, codigo) {
      if (sugerencia <= 0) return 0;
      
      const porcentajeMultiplo = 1.0; // Por defecto 100% del múltiplo
      
      // Empanadas: redondear a múltiplo de 50
      if (categorias.EMPANADAS.includes(codigo)) {
        const multiplo = 50;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Pizzas: redondear a múltiplo de 5
      if (categorias.PIZZAS.includes(codigo)) {
        const multiplo = 5;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        const cociente = Math.floor(sugerencia / multiplo);
        const resto = sugerencia % multiplo;
        return resto > 0 ? (cociente + 1) * multiplo : Math.round(sugerencia);
      }
      
      // Pastelitos: redondear a múltiplo de 35
      if (categorias.PASTELITOS.includes(codigo)) {
        const multiplo = 35;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Por defecto: redondear normalmente
      return Math.round(sugerencia);
    }

    // Función para verificar si un día tiene entrega
    function diaTieneEntrega(dia, tieneEntrega) {
      // Si tieneEntrega es un booleano, retornarlo directamente
      if (typeof tieneEntrega === 'boolean') {
        return tieneEntrega;
      }
      
      // Compatibilidad con código antiguo que usaba strings
      if (typeof tieneEntrega === 'string') {
        // Si el texto es "Mañana", significa que ese día tiene entrega
        if (tieneEntrega === 'Mañana') return true;
        
        // Si el texto incluye el nombre del día, significa que ese día tiene entrega
        const diaLower = dia.toLowerCase();
        const textoLower = tieneEntrega.toLowerCase();
        if (textoLower.includes(diaLower)) return true;
      }
      
      // Mapeo de días en español
      const diasMap = {
        'LUNES': ['lunes', 'lun'],
        'MARTES': ['martes', 'mar'],
        'MIERCOLES': ['miercoles', 'miércoles', 'mier', 'mié'],
        'JUEVES': ['jueves', 'jue'],
        'VIERNES': ['viernes', 'vie'],
        'SABADO': ['sabado', 'sábado', 'sab', 'sáb'],
        'DOMINGO': ['domingo', 'dom']
      };
      
      const variantes = diasMap[dia] || [];
      return variantes.some(v => textoLower.includes(v));
    }

    // Función para calcular sugerencia de pedido (replica exacta de calcularSugerenciaPedido de la APK)
    async function calcularSugerencia(codigo, stockActual) {
      try {
        const diaActual = obtenerDiaSemana(fechaSeleccionada);
        const promedioHoy = promediosVenta[codigo]?.[diaActual] || 0;
        
        if (promedioHoy <= 0) return 0;

        // Obtener datos de venta parcial
        const [stockAnterior, ingresoHoy] = await obtenerDatosVentaParcial(codigo);
        
        // Calcular venta parcial y venta restante
        let ventaRestanteHoy, ventaParcial;
        
        if (stockAnterior > 0 || ingresoHoy > 0) {
          // HAY datos históricos - usar lógica completa
          ventaParcial = stockAnterior + ingresoHoy - stockActual;
          const porcentajeAvance = promedioHoy > 0 ? Math.min(1, Math.max(0, ventaParcial / promedioHoy)) : 0;
          ventaRestanteHoy = promedioHoy * (1 - porcentajeAvance);
        } else {
          // NO hay datos históricos - NO sugerir pedidos
          return 0;
        }

        // Porcentaje extra configurado
        const porcentajeExtra = configuracion.porcentajeExtra / 100.0;

        // Sumar todos los promedios hasta la próxima entrega
        let sumaPromedios = obtenerPromediosHastaProximaEntrega(codigo);

        // 🔥 NUEVO: Detectar tendencia de ventas (aumento/disminución)
        const tendenciaVentas = detectarTendenciaVentas(codigo);

        // 🔥 NUEVO: Aplicar ajuste de tendencia a los promedios
        if (tendenciaVentas !== 0) {
          const factorTendencia = 1.0 + (tendenciaVentas / 100.0);
          sumaPromedios = sumaPromedios * factorTendencia;
          console.log('📈 ' + codigo + ': Ajustando promedios por tendencia ' + tendenciaVentas.toFixed(1) + '% (factor: ' + factorTendencia.toFixed(2) + ')');
        }

        // Calcular stock al final de hoy
        const stockFinalHoy = stockActual - ventaRestanteHoy;

        // Fórmula correcta: necesito cubrir los próximos días MENOS lo que me va a quedar hoy
        const porcentajeExtraValor = sumaPromedios * porcentajeExtra;
        const sugerenciaBase = sumaPromedios - stockFinalHoy;
        const sugerenciaFinal = sugerenciaBase + porcentajeExtraValor;

        // Evitar negativos
        const sugerenciaPositiva = Math.max(0, sugerenciaFinal);

        // Redondear según tipo de producto (replica exacta de redondearSugerencia de la APK)
        return redondearSugerencia(sugerenciaPositiva, codigo);
      } catch (e) {
        console.error('Error calculando sugerencia:', e);
        return 0;
      }
    }

    // Función para mostrar contenido del pedido (replica exacta de la APK)
    async function mostrarContenidoPedido() {
      body.innerHTML = '';
      
      // Agregar indicador de local (como en la APK)
      const indicadorLocal = document.createElement('div');
      indicadorLocal.style.cssText = 'text-align:center;font-size:16px;font-weight:700;color:#1976d2;padding:5px 0 15px 0';
      indicadorLocal.textContent = 'LOCAL: ' + localNombre;
      body.appendChild(indicadorLocal);

      // Banner de modo admin si está activo
      if (modoAdmin) {
        const bannerAdmin = document.createElement('div');
        bannerAdmin.style.cssText = 'background:#ff9800;color:#fff;text-align:center;padding:12px;font-weight:700;font-size:14px;margin-bottom:16px';
        bannerAdmin.textContent = '🔧 MODO ADMINISTRADOR - EDICIÓN HABILITADA';
        body.appendChild(bannerAdmin);
      }

      // Verificar si es hora de alerta (solo a las 15:30 o después) Y solo para la fecha actual
      const ahora = getFechaArgentina();
      const hoy = fechaISO(ahora);
      const esFechaActual = fechaSeleccionada === hoy;
      
      // Obtener hora y minuto en zona horaria de Argentina
      const formatterHora = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Argentina/Buenos_Aires',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      const partesHora = formatterHora.formatToParts(new Date());
      const hora = parseInt(partesHora.find(p => p.type === 'hour').value);
      const minuto = parseInt(partesHora.find(p => p.type === 'minute').value);
      const [horaAlerta, minutoAlerta] = configuracion.horaAlerta.split(':').map(Number);
      const esHoraAlerta = hora === horaAlerta && minuto >= minutoAlerta;

      // NO mostrar alertas aquí - se muestran dentro de mostrarSeccionCargarStockIntegrada() solo cuando corresponde

      // Si no hay productos, mostrar mensaje
      if (productos.length === 0) {
        if (modoSoloLectura) {
          const mensaje = document.createElement('div');
          mensaje.style.cssText = 'text-align:center;padding:32px;color:#6b7280';
          mensaje.innerHTML = '<div style="font-size:48px;margin-bottom:16px">📋</div>' +
            '<div style="font-size:18px;font-weight:700;color:#1976d2;margin-bottom:8px">No hay datos para esta fecha</div>' +
            '<div style="font-size:14px;color:#6b7280">No se encontró ningún pedido guardado para el ' + fechaSeleccionada + '.</div>';
          body.appendChild(mensaje);
        } else {
          const mensaje = document.createElement('div');
          mensaje.style.cssText = 'text-align:center;padding:32px;color:#6b7280';
          mensaje.innerHTML = '<div style="font-size:48px;margin-bottom:16px">📊</div>' +
            '<div style="font-size:18px;font-weight:700;color:#1976d2;margin-bottom:8px">Sin datos históricos de ventas</div>' +
            '<div style="font-size:14px;color:#6b7280;margin-bottom:16px">Para generar sugerencias de pedido necesitas tener registros de inventario históricos.</div>';
          body.appendChild(mensaje);
        }
        return;
      }

      // Mostrar sección "CARGAR STOCK 15:30" integrada (como en la APK)
      mostrarSeccionCargarStockIntegrada();
    }

    // Función para mostrar sección de carga de stock integrada (replica exacta de mostrarSeccionCargarStockIntegrada de la APK)
    function mostrarSeccionCargarStockIntegrada() {
      // 📈 Banner de tendencia general (reemplaza al título viejo)
      // Calcular tendencia promedio de productos principales
      const productosParaTendencia = ['JQ', 'PB', 'CS']; // Productos principales
      const tendencias = productosParaTendencia
        .map(codigo => detectarTendenciaVentas(codigo))
        .filter(t => t !== 0); // Solo contar tendencias significativas
      
      if (tendencias.length > 0) {
        const tendenciaGeneral = tendencias.reduce((a, b) => a + b, 0) / tendencias.length;
        
        // Solo mostrar si es significativa (≥5%)
        if (Math.abs(tendenciaGeneral) >= 5.0) {
          const bannerTendencia = document.createElement('div');
          const icono = tendenciaGeneral > 0 ? '📈' : '📉';
          const texto = tendenciaGeneral > 0 ? 'AUMENTO' : 'DISMINUCIÓN';
          const colorBg = tendenciaGeneral > 0 ? '#22c55e' : '#f59e0b';
          
          bannerTendencia.style.cssText = 'font-size:16px;font-weight:700;color:#fff;padding:12px;text-align:center;background:' + colorBg + ';margin-bottom:16px;border-radius:6px';
          bannerTendencia.textContent = icono + ' ' + texto + ' DE VENTAS: ' + Math.abs(tendenciaGeneral).toFixed(0) + '%';
          body.appendChild(bannerTendencia);
          
          console.log('✅ Banner de tendencia general mostrado:', tendenciaGeneral.toFixed(1) + '%');
        }
      }

      // Orden de categorías (igual que la APK)
      const ordenCategorias = ['EMPANADAS', 'PIZZAS', 'PASTELITOS', 'OTROS'];
      
      ordenCategorias.forEach(categoria => {
        const codigosCategoria = categorias[categoria] || [];
        const productosCategoria = productos.filter(p => codigosCategoria.includes(p.codigo));
        
        if (productosCategoria.length > 0) {
          mostrarCategoriaIntegrada(categoria, productosCategoria);
        }
      });

      // Botón de WhatsApp
      const btnWhatsApp = document.createElement('button');
      btnWhatsApp.style.cssText = 'width:100%;padding:16px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:16px;margin-top:24px;cursor:pointer';
      if (modoAdmin) {
        btnWhatsApp.textContent = '📱 Enviar por WhatsApp (Admin)';
      } else if (modoSoloLectura) {
        btnWhatsApp.textContent = '📱 Ver Pedido (Solo Lectura)';
        btnWhatsApp.style.background = '#6b7280';
      } else {
        btnWhatsApp.textContent = '📱 Enviar por WhatsApp';
      }
      btnWhatsApp.onclick = () => {
        if (!modoSoloLectura || modoAdmin) {
          guardarPedido();
        }
        generarYEnviarWhatsApp();
      };
      body.appendChild(btnWhatsApp);
    }

    // Función para mostrar categoría integrada (replica exacta de mostrarCategoriaIntegrada de la APK)
    function mostrarCategoriaIntegrada(categoria, productosCategoria) {
      // Contenedor de categoría
      const categoriaDiv = document.createElement('div');
      categoriaDiv.style.cssText = 'margin-bottom:16px';

      // Header de categoría con color
      const headerDiv = document.createElement('div');
      const coloresHeader = {
        'EMPANADAS': '#8b4513',
        'PIZZAS': '#ff6b6b',
        'PASTELITOS': '#ffd93d'
      };
      headerDiv.style.cssText = 'background:' + (coloresHeader[categoria] || '#6c757d') + ';color:#fff;padding:12px;display:flex;align-items:center;gap:12px;font-weight:700';
      
      const iconoCategoria = categoria === 'EMPANADAS' ? '🥟' : categoria === 'PIZZAS' ? '🍕' : categoria === 'PASTELITOS' ? '🥧' : '📦';
      headerDiv.innerHTML = '<span style="font-size:24px">' + iconoCategoria + '</span>' +
        '<span style="flex:1;font-size:18px">' + categoria + '</span>' +
        '<span style="background:rgba(255,255,255,.3);padding:4px 8px;border-radius:4px;font-size:12px">' + productosCategoria.length + ' productos</span>';
      categoriaDiv.appendChild(headerDiv);

      // Contenedor de productos
      const productosDiv = document.createElement('div');
      productosDiv.style.cssText = 'background:#fff;padding:8px';

      // Ordenar productos según orden específico
      const ordenEspecifico = {
        'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
        'PIZZAS': ['MUZZARE', 'JAMON', 'PEPPERO'],
        'PASTELITOS': ['BATATA', 'MEMBRIL']
      };
      const orden = ordenEspecifico[categoria] || [];
      const productosOrdenados = orden.map(codigo => productosCategoria.find(p => p.codigo === codigo)).filter(p => p);

      for (const prod of productosOrdenados) {

        // Crear fila de producto (diseño de 3 columnas como el layout XML)
        const filaDiv = document.createElement('div');
        filaDiv.style.cssText = 'display:flex;align-items:center;padding:12px;background:#f9fafb;margin:2px 0;gap:4px';
        filaDiv.id = 'pf-row-' + prod.codigo;

        // Columna 1: Código del producto
        const codigoDiv = document.createElement('div');
        codigoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column';
        const codigoSpan = document.createElement('span');
        codigoSpan.id = 'pf-codigo-' + prod.codigo;
        codigoSpan.style.cssText = 'font-size:13px;font-weight:700;color:#7b2cbf';
        codigoSpan.textContent = prod.codigo;
        
        // 📈 Agregar tendencia del cache si está disponible (instantáneo)
        if (cacheTendencias !== null) {
          const tendencia = cacheTendencias[prod.codigo] || 0;
          if (Math.abs(tendencia) >= 5.0) {
            const icono = tendencia >= 10.0 ? '📈' : 
                         tendencia >= 5.0 ? '⬆️' : 
                         tendencia <= -10.0 ? '📉' : '⬇️';
            const porcentaje = Math.abs(tendencia).toFixed(0);
            const tendenciaSpan = document.createElement('span');
            tendenciaSpan.style.cssText = 'display:inline-block;margin-left:6px;font-size:12px;cursor:pointer';
            tendenciaSpan.textContent = icono + porcentaje + '%';
            tendenciaSpan.title = 'Click para ver gráfico de tendencia';
            tendenciaSpan.onclick = function() {
              const nombreProd = obtenerNombreProducto(prod.codigo);
              const promediosProd = promediosVenta[prod.codigo] || {};
              window.mostrarGraficoTendenciaGlobal(prod.codigo, tendencia, nombreProd, promediosProd, localId);
            };
            codigoSpan.appendChild(tendenciaSpan);
            console.log('⚡ Tendencia desde cache: ' + prod.codigo + ' → ' + icono + porcentaje + '%');
          }
        }
        
        codigoDiv.appendChild(codigoSpan);
        filaDiv.appendChild(codigoDiv);

        // Columna 2: Stock 15:30
        const stockDiv = document.createElement('div');
        stockDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px';
        const stockLabel = document.createElement('span');
        stockLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        stockLabel.textContent = 'Stock';
        stockDiv.appendChild(stockLabel);
        const inputStock = document.createElement('input');
        inputStock.type = 'number';
        inputStock.id = 'pf-stock-' + prod.codigo;
        inputStock.setAttribute('data-codigo', prod.codigo);
        inputStock.setAttribute('data-tipo', 'stock');
        inputStock.value = prod.stockActual;
        inputStock.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#7b2cbf';
        if (modoSoloLectura && !modoAdmin) {
          inputStock.disabled = true;
          inputStock.style.background = '#d1d5db';
        } else {
          inputStock.onfocus = function() { this.select(); };
        }
        stockDiv.appendChild(inputStock);
        filaDiv.appendChild(stockDiv);

        // Columna 3: Sugerencia
        const sugerenciaDiv = document.createElement('div');
        sugerenciaDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px';
        const sugerenciaLabel = document.createElement('span');
        sugerenciaLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        sugerenciaLabel.textContent = 'Sugerencia';
        sugerenciaDiv.appendChild(sugerenciaLabel);
        const spanSugerencia = document.createElement('span');
        spanSugerencia.id = 'pf-sugerencia-' + prod.codigo;
        spanSugerencia.setAttribute('data-codigo', prod.codigo);
        spanSugerencia.setAttribute('data-tipo', 'sugerencia');
        spanSugerencia.textContent = '...';
        spanSugerencia.style.cssText = 'width:60px;height:35px;padding:4px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#7b2cbf;display:flex;align-items:center;justify-content:center';
        sugerenciaDiv.appendChild(spanSugerencia);
        
        // Calcular sugerencia de forma asíncrona y actualizar
        calcularSugerencia(prod.codigo, prod.stockActual).then(sug => {
          spanSugerencia.textContent = sug;
          prod.pedidoSugerido = sug;
        });
        filaDiv.appendChild(sugerenciaDiv);

        // Columna 4: Pedido Final
        const pedidoDiv = document.createElement('div');
        pedidoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center';
        const pedidoLabel = document.createElement('span');
        pedidoLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        pedidoLabel.textContent = 'Pedido Final';
        pedidoDiv.appendChild(pedidoLabel);
        const inputPedido = document.createElement('input');
        inputPedido.type = 'number';
        inputPedido.id = 'pf-pedido-' + prod.codigo;
        inputPedido.setAttribute('data-codigo', prod.codigo);
        inputPedido.setAttribute('data-tipo', 'pedido');
        inputPedido.value = prod.pedidoFinal;
        inputPedido.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#ff6b00';
        if (modoSoloLectura && !modoAdmin) {
          inputPedido.disabled = true;
          inputPedido.style.background = '#d1d5db';
        } else {
          inputPedido.onfocus = function() { this.select(); };
        }
        pedidoDiv.appendChild(inputPedido);
        filaDiv.appendChild(pedidoDiv);

        productosDiv.appendChild(filaDiv);

        // Configurar listeners
        inputStock.addEventListener('input', async () => {
          const stock = parseInt(inputStock.value) || 0;
          const sugerencia = await calcularSugerencia(prod.codigo, stock);
          spanSugerencia.textContent = sugerencia;
          prod.stockActual = stock;
          prod.pedidoSugerido = sugerencia;
        });

        // Cargar historial de stock bajo de forma asíncrona
        obtenerHistorialStockBajo(prod.codigo).then(historial => {
          if (historial.length > 0) {
            codigoSpan.innerHTML = prod.codigo + ' <span style="color:#dc2626;cursor:pointer" data-codigo="' + prod.codigo + '">⚠️</span>';
            const iconoAlerta = codigoSpan.querySelector('[data-codigo="' + prod.codigo + '"]');
            if (iconoAlerta) {
              iconoAlerta.addEventListener('click', () => {
                mostrarReporteStockBajo(prod.codigo, prod.nombre, historial);
              });
            }
          }
        });
      }

      categoriaDiv.appendChild(productosDiv);
      body.appendChild(categoriaDiv);
    }

    // Función para obtener historial de stock bajo
    async function obtenerHistorialStockBajo(codigo) {
      try {
        const historial = [];
        const hoy = new Date();
        for (let i = 1; i <= 7; i++) {
          const fecha = new Date(hoy);
          fecha.setDate(fecha.getDate() - i);
          const fechaStr = fechaISO(fecha);
          
          const registrosSnap = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', fechaStr).where('tipo', '==', 'Stock Final').get();
          
          registrosSnap.forEach(d => {
            const productos = d.data().productos || [];
            const producto = productos.find(p => p.nombre && (p.nombre.startsWith(codigo + ' -') || p.nombre === productosFabrica[codigo]?.nombre));
            if (producto) {
              const umbral = (codigo.startsWith('MUZZA') || codigo.startsWith('JAMON') || codigo.startsWith('PEPPER')) ? 0 : 15;
              if (producto.cantidad <= umbral) {
                historial.push({ fecha: fechaStr, stock: producto.cantidad });
              }
            }
          });
        }
        return historial;
      } catch (e) {
        console.error('Error obteniendo historial:', e);
        return [];
      }
    }

    // Función para mostrar reporte de stock bajo
    function mostrarReporteStockBajo(codigo, nombre, historial) {
      const overlayReporte = document.createElement('div');
      overlayReporte.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalReporte = document.createElement('div');
      modalReporte.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:80vh;overflow-y:auto';
      
      const fechaFormateada = (fecha) => {
        const [y, m, d] = fecha.split('-').map(Number);
        return d + '/' + m + '/' + y;
      };

      modalReporte.innerHTML = '<div style="font-weight:700;font-size:18px;color:#dc2626;text-align:center;margin-bottom:16px">⚠️ Stock Bajo Detectado</div>' +
        '<div style="font-weight:700;font-size:16px;text-align:center;margin-bottom:16px">' + codigo + ' - ' + nombre + '</div>' +
        '<div style="font-size:14px;margin-bottom:16px;text-align:center">En los últimos 7 días, este producto quedó con stock bajo (≤ 15 unidades):</div>' +
        '<div style="max-height:300px;overflow-y:auto;margin-bottom:16px">' +
        (historial.length > 0 ? historial.map(h => '<div style="padding:12px;background:#f5f5f5;border-radius:4px;margin-bottom:8px">📅 ' + fechaFormateada(h.fecha) + ' → ' + h.stock + ' unidades restantes</div>').join('') : '<div style="text-align:center;color:#6b7280;padding:16px">No se encontraron registros de stock bajo</div>') +
        '</div>' +
        '<div style="font-weight:700;font-size:14px;color:#f57c00;text-align:center;margin-bottom:16px">💡 Considera reforzar el pedido para evitar quedarte sin stock.</div>' +
        '<button style="width:100%;padding:10px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:700">Entendido</button>';
      
      overlayReporte.appendChild(modalReporte);
      document.body.appendChild(overlayReporte);
      
      modalReporte.querySelector('button').onclick = () => overlayReporte.remove();
    }

    // Función para guardar pedido (replica de guardarPedidoEnFirestore de la APK)
    async function guardarPedido() {
      if (modoSoloLectura && !modoAdmin) {
        alert('No se puede guardar en fechas anteriores');
        return;
      }

      try {
        const productosParaGuardar = [];
        
        ordenProductos.forEach(codigo => {
          const stockInput = document.getElementById('pf-stock-' + codigo);
          const pedidoInput = document.getElementById('pf-pedido-' + codigo);
          const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
          
          if (!stockInput || !pedidoInput) return;
          
          const stock = parseInt(stockInput.value) || 0;
          const pedido = parseInt(pedidoInput.value) || 0;
          const sugerencia = parseInt(sugerenciaSpan?.textContent) || 0;
          
          if (stock > 0 || pedido > 0) {
            productosParaGuardar.push({
              codigo: codigo,
              nombre: productosFabrica[codigo]?.nombre || codigo,
              stock: stock,
              sugerencia: sugerencia,
              pedido: pedido
            });
          }
        });

        const diaActual = obtenerDiaSemana(fechaSeleccionada);
        const textoDiasExtra = actualizarInformacionDiasExtra();

        const pedidoData = {
          productos: productosParaGuardar,
          configuracion: {
            porcentajeExtra: configuracion.porcentajeExtra,
            horaAlerta: configuracion.horaAlerta,
            activarAlerta: configuracion.activarAlerta,
            diasEntrega: diasEntrega,
            paraFecha: textoDiasExtra
          },
          fecha: fechaSeleccionada,
          localId: localId,
          timestamp: new Date().toISOString()
        };

        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('pedidos_fabrica').doc(fechaSeleccionada).set(pedidoData);
        console.log('✅ Pedido guardado exitosamente');
      } catch (e) {
        console.error('Error guardando pedido:', e);
        alert('Error guardando pedido: ' + e.message);
      }
    }

    // Función para actualizar información de días extra (replica de actualizarInformacionDiasExtra de la APK)
    function actualizarInformacionDiasExtra() {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diaSiguiente = obtenerDiaSiguiente(diaActual);
      
      const proximosDias = {
        'LUNES': [['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes]],
        'MARTES': [['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado]],
        'MIERCOLES': [['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo]],
        'JUEVES': [['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes]],
        'VIERNES': [['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes]],
        'SABADO': [['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles]],
        'DOMINGO': [['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves]]
      };
      
      const lista = proximosDias[diaActual] || [];
      if (lista.length === 0) {
        const diasExtraEl = document.getElementById('pf-dias-extra');
        if (diasExtraEl) diasExtraEl.textContent = '📅 Pedido para: ' + diaSiguiente;
        return diaSiguiente;
      }
      
      // Verificar que el primer día (mañana) tenga entrega
      const [primerDia, tieneEntregaPrimerDia] = lista[0];
      if (!tieneEntregaPrimerDia) {
        const diasExtraEl = document.getElementById('pf-dias-extra');
        if (diasExtraEl) diasExtraEl.textContent = '⚠️ No se puede hacer pedido - ' + primerDia + ' sin entrega';
        return diaSiguiente;
      }
      
      // Revisar días después de mañana
      const diasExtra = [];
      for (let i = 1; i < lista.length; i++) {
        const [nombreDia, tieneEntrega] = lista[i];
        if (!tieneEntrega) {
          diasExtra.push(nombreDia);
        } else {
          break;
        }
      }
      
      // Construir el texto
      const textoPedido = diasExtra.length === 0 
        ? '📅 Pedido para: ' + diaSiguiente
        : '📅 Pedido para: ' + diaSiguiente + ' + ' + diasExtra.join(' + ');
      
      const diasExtraEl = document.getElementById('pf-dias-extra');
      if (diasExtraEl) {
        diasExtraEl.textContent = textoPedido;
        diasExtraEl.style.display = 'block';
      }
      
      return textoPedido;
    }

    // Función para generar y enviar por WhatsApp
    function generarYEnviarWhatsApp() {
      const texto = generarTextoPedido();
      const url = 'https://wa.me/?text=' + encodeURIComponent(texto);
      window.open(url, '_blank');
    }

    // Función para generar texto del pedido (replica exacta de generarTextoPedido de la APK)
    function generarTextoPedido() {
      const pedido = [];
      
      // Contadores para agregar espacios entre secciones
      let contadorEmpanadas = 0;
      let contadorPizzas = 0;
      let contadorPastelitos = 0;
      
      pedido.push('📋 PEDIDO FÁBRICA - ' + fechaSeleccionada + '\n\n');
      
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const pedidoInput = document.getElementById('pf-pedido-' + codigo);
        if (!stockInput || !pedidoInput) return;
        
        const stock = parseInt(stockInput.value) || 0;
        const pedidoFinal = parseInt(pedidoInput.value) || 0;
        
        // Agregar espacio antes de cada sección
        if (categorias.EMPANADAS.includes(codigo)) {
          if (contadorEmpanadas === 0) {
            pedido.push('\n');
          }
          contadorEmpanadas++;
        } else if (categorias.PIZZAS.includes(codigo)) {
          if (contadorPizzas === 0) {
            pedido.push('\n');
          }
          contadorPizzas++;
        } else if (categorias.PASTELITOS.includes(codigo)) {
          if (contadorPastelitos === 0) {
            pedido.push('\n');
          }
          contadorPastelitos++;
        }
        
        // Formatear según tipo de producto (igual que la APK)
        const pedidoFormateado = (() => {
          // Pizzas: mostrar literal
          if (categorias.PIZZAS.includes(codigo)) {
            return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-nopido`;
          }
          // Pastelitos: mostrar literal
          if (categorias.PASTELITOS.includes(codigo)) {
            return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-0`;
          }
          // Empanadas: usar pedido final directamente
          return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-no pido`;
        })();
        
        pedido.push(pedidoFormateado + '\n');
      });

      return pedido.join('');
    }

    // Función para navegar fechas
    function navegarFecha(dias) {
      const [y, m, d] = fechaSeleccionada.split('-').map(Number);
      const fecha = new Date(y, m - 1, d);
      fecha.setDate(fecha.getDate() + dias);
      fechaSeleccionada = fechaISO(fecha);
      document.getElementById('pf-fecha-actual').textContent = fechaSeleccionada;
      
      const hoy = fechaISO(new Date());
      modoSoloLectura = (fechaSeleccionada !== hoy) && !modoAdmin;
      
      actualizarUI();
      cargarDatos();
    }

    // Función para cargar datos
    async function cargarDatos() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      
      await cargarPromediosVenta();
      const existePedido = await cargarPedidoExistente(fechaSeleccionada);
      if (!existePedido) {
        await inicializarProductos();
      }
      
      await mostrarContenidoPedido();
    }

    // Agregar overlay al DOM primero
    document.body.appendChild(overlay);

    // Event listeners (después de agregar al DOM)
    const btnClose = document.getElementById('pf-close');
    const btnVolver = document.getElementById('pf-volver');
    const btnFechaPrev = document.getElementById('pf-fecha-prev');
    const btnFechaNext = document.getElementById('pf-fecha-next');
    const btnConfig = document.getElementById('pf-config');

    if (btnClose) btnClose.onclick = () => overlay.remove();
    if (btnVolver) btnVolver.onclick = () => overlay.remove();
    if (btnFechaPrev) btnFechaPrev.onclick = () => navegarFecha(-1);
    if (btnFechaNext) btnFechaNext.onclick = () => navegarFecha(1);
    if (btnConfig) btnConfig.onclick = () => {
      mostrarConfiguracion();
    };

    // Función para mostrar configuración (replica exacta de mostrarConfiguracion de la APK)
    function mostrarConfiguracion() {
      const overlayConfig = document.createElement('div');
      overlayConfig.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalConfig = document.createElement('div');
      modalConfig.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      // Título
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:24px;text-align:center';
      titulo.textContent = '⚙️ Configuración';
      modalConfig.appendChild(titulo);
      
      // Porcentaje Extra
      const porcentajeDiv = document.createElement('div');
      porcentajeDiv.style.cssText = 'margin-bottom:24px';
      
      const txtPorcentaje = document.createElement('div');
      txtPorcentaje.id = 'config-porcentaje-text';
      txtPorcentaje.style.cssText = 'font-size:16px;font-weight:600;color:#1976d2;padding:8px 16px;margin-bottom:8px';
      const porcentajeActual = parseInt(document.getElementById('pf-porcentaje')?.textContent.replace('% Extra: ', '').replace('%', '') || '30');
      txtPorcentaje.textContent = 'Porcentaje Extra: ' + porcentajeActual + '%';
      porcentajeDiv.appendChild(txtPorcentaje);
      
      const seekBar = document.createElement('input');
      seekBar.type = 'range';
      seekBar.min = '0';
      seekBar.max = '100';
      seekBar.value = porcentajeActual;
      seekBar.style.cssText = 'width:100%;height:8px;margin:16px 0';
      seekBar.oninput = function() {
        txtPorcentaje.textContent = 'Porcentaje Extra: ' + this.value + '%';
        // Actualizar sugerencias en tiempo real
        actualizarSugerenciasEnTiempoReal(parseInt(this.value));
      };
      porcentajeDiv.appendChild(seekBar);
      modalConfig.appendChild(porcentajeDiv);
      
      // Hora de Alerta
      const horaDiv = document.createElement('div');
      horaDiv.style.cssText = 'margin-bottom:24px';
      
      const txtHora = document.createElement('div');
      txtHora.style.cssText = 'font-size:16px;padding:8px 16px;margin-bottom:8px';
      txtHora.textContent = 'Hora de Alerta:';
      horaDiv.appendChild(txtHora);
      
      const editHora = document.createElement('input');
      editHora.type = 'text';
      editHora.id = 'config-hora-input';
      const horaActual = document.getElementById('pf-hora-alerta')?.textContent.replace('🔔 Alerta: ', '') || '15:30';
      editHora.value = horaActual;
      editHora.style.cssText = 'width:100%;padding:16px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;cursor:pointer';
      editHora.readOnly = true;
      editHora.onclick = function() {
        mostrarSelectorHora(editHora);
      };
      horaDiv.appendChild(editHora);
      modalConfig.appendChild(horaDiv);
      
      // Botón para configurar días de entrega
      const btnDiasEntrega = document.createElement('button');
      btnDiasEntrega.style.cssText = 'width:100%;padding:16px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:16px;margin-bottom:24px;cursor:pointer';
      btnDiasEntrega.textContent = '📅 Configurar Días de Entrega';
      btnDiasEntrega.onclick = () => {
        overlayConfig.remove();
        mostrarConfiguracionDiasEntrega();
      };
      modalConfig.appendChild(btnDiasEntrega);
      
      // Botones
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        const nuevoPorcentaje = parseInt(seekBar.value);
        const nuevaHora = editHora.value;
        
        configuracion.porcentajeExtra = nuevoPorcentaje;
        configuracion.horaAlerta = nuevaHora;
        
        // Guardar en Firebase
        await guardarConfiguracionEnFirebase();
        
        // Actualizar UI
        actualizarUI();
        
        // Actualizar sugerencias
        actualizarSugerenciasEnTiempoReal(nuevoPorcentaje);
        
        overlayConfig.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayConfig.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalConfig.appendChild(botonesDiv);
      
      overlayConfig.appendChild(modalConfig);
      document.body.appendChild(overlayConfig);
    }

    // Función para mostrar selector de hora (replica de mostrarSelectorHoraTemporal de la APK)
    function mostrarSelectorHora(editHora) {
      const horaActual = editHora.value || '15:30';
      const [h, m] = horaActual.split(':').map(Number);
      
      // Crear overlay para selector de hora
      const overlayHora = document.createElement('div');
      overlayHora.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10001';
      const modalHora = document.createElement('div');
      modalHora.style.cssText = 'background:#fff;padding:24px;border-radius:8px;min-width:300px';
      
      modalHora.innerHTML = '<div style="font-size:18px;font-weight:700;margin-bottom:16px;text-align:center">Seleccionar Hora</div>' +
        '<div style="display:flex;gap:16px;justify-content:center;align-items:center;margin-bottom:24px">' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Hora</label>' +
        '<input type="number" id="hora-picker-h" min="0" max="23" value="' + h + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '<div style="font-size:24px;font-weight:700">:</div>' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Minuto</label>' +
        '<input type="number" id="hora-picker-m" min="0" max="59" value="' + m + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '</div>' +
        '<div style="display:flex;gap:12px">' +
        '<button id="hora-ok" style="flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Aceptar</button>' +
        '<button id="hora-cancel" style="flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Cancelar</button>' +
        '</div>';
      
      overlayHora.appendChild(modalHora);
      document.body.appendChild(overlayHora);
      
      // Configurar selección automática de texto al hacer focus en inputs de hora
      const inputHora = document.getElementById('hora-picker-h');
      const inputMinuto = document.getElementById('hora-picker-m');
      if (inputHora) {
        inputHora.onfocus = function() { this.select(); };
      }
      if (inputMinuto) {
        inputMinuto.onfocus = function() { this.select(); };
      }
      
      document.getElementById('hora-ok').onclick = () => {
        const hora = String(inputHora.value).padStart(2, '0');
        const minuto = String(inputMinuto.value).padStart(2, '0');
        editHora.value = hora + ':' + minuto;
        overlayHora.remove();
      };
      
      document.getElementById('hora-cancel').onclick = () => overlayHora.remove();
    }

    // Función para mostrar configuración de días de entrega (replica de mostrarConfiguracionDiasEntrega de la APK)
    function mostrarConfiguracionDiasEntrega() {
      const overlayDias = document.createElement('div');
      overlayDias.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalDias = document.createElement('div');
      modalDias.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      // Título
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:16px;text-align:center';
      titulo.textContent = '⚙️ Días de Entrega';
      modalDias.appendChild(titulo);
      
      // Subtítulo
      const subtitulo = document.createElement('div');
      subtitulo.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      subtitulo.textContent = '📅 Configurar Días de Entrega';
      modalDias.appendChild(subtitulo);
      
      // Descripción
      const descripcion = document.createElement('div');
      descripcion.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      descripcion.textContent = 'Marca los días en que la fábrica entrega mercadería a tu local. Esto afectará el cálculo de sugerencias de pedido.';
      modalDias.appendChild(descripcion);
      
      // Checkboxes
      const checkboxes = {};
      const dias = [
        ['lunes', 'Lunes'],
        ['martes', 'Martes'],
        ['miercoles', 'Miércoles'],
        ['jueves', 'Jueves'],
        ['viernes', 'Viernes'],
        ['sabado', 'Sábado'],
        ['domingo', 'Domingo']
      ];
      
      dias.forEach(([clave, nombre]) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = 'display:flex;align-items:center;padding:8px 16px;margin-bottom:8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'dias-' + clave;
        checkbox.checked = diasEntrega[clave] || false;
        checkbox.style.cssText = 'width:20px;height:20px;margin-right:12px;cursor:pointer';
        
        const label = document.createElement('label');
        label.htmlFor = 'dias-' + clave;
        label.style.cssText = 'font-size:16px;color:#000;cursor:pointer;flex:1';
        label.textContent = nombre;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        modalDias.appendChild(checkboxDiv);
        
        checkboxes[clave] = checkbox;
      });
      
      // Botones
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px;margin-top:24px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        // Actualizar configuración
        diasEntrega = {
          lunes: checkboxes.lunes.checked,
          martes: checkboxes.martes.checked,
          miercoles: checkboxes.miercoles.checked,
          jueves: checkboxes.jueves.checked,
          viernes: checkboxes.viernes.checked,
          sabado: checkboxes.sabado.checked,
          domingo: checkboxes.domingo.checked
        };
        
        // Guardar en Firebase
        await guardarDiasEntregaEnFirebase();
        
        // Actualizar información de días extra
        actualizarInformacionDiasExtra();
        
        // Recalcular todas las sugerencias
        recalcularTodasLasSugerencias();
        
        overlayDias.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayDias.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalDias.appendChild(botonesDiv);
      
      overlayDias.appendChild(modalDias);
      document.body.appendChild(overlayDias);
    }

    // Función para guardar configuración en Firebase
    async function guardarConfiguracionEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_pedido_fabrica').doc('config').set({
          porcentajeExtra: configuracion.porcentajeExtra,
          horaAlerta: configuracion.horaAlerta,
          activarAlerta: configuracion.activarAlerta,
          timestamp: new Date().toISOString()
        });
        console.log('✅ Configuración guardada en Firebase');
      } catch (e) {
        console.error('Error guardando configuración:', e);
        alert('Error guardando configuración: ' + e.message);
      }
    }

    // Función para guardar días de entrega en Firebase
    async function guardarDiasEntregaEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_dias_entrega').doc('config').set({
          lunes: diasEntrega.lunes,
          martes: diasEntrega.martes,
          miercoles: diasEntrega.miercoles,
          jueves: diasEntrega.jueves,
          viernes: diasEntrega.viernes,
          sabado: diasEntrega.sabado,
          domingo: diasEntrega.domingo,
          timestamp: new Date().toISOString()
        });
        console.log('✅ Días de entrega guardados en Firebase');
      } catch (e) {
        console.error('Error guardando días de entrega:', e);
        alert('Error guardando días de entrega: ' + e.message);
      }
    }

    // Función para actualizar sugerencias en tiempo real (replica de actualizarSugerenciasEnTiempoReal de la APK)
    function actualizarSugerenciasEnTiempoReal(nuevoPorcentaje) {
      // Actualizar porcentaje en configuración temporalmente
      const porcentajeAnterior = configuracion.porcentajeExtra;
      configuracion.porcentajeExtra = nuevoPorcentaje;
      
      // Recalcular todas las sugerencias visibles
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
        
        if (stockInput && sugerenciaSpan) {
          const stock = parseInt(stockInput.value) || 0;
          calcularSugerencia(codigo, stock).then(sug => {
            sugerenciaSpan.textContent = sug;
          });
        }
      });
      
      // Restaurar porcentaje anterior (se guardará cuando se guarde la configuración)
      configuracion.porcentajeExtra = porcentajeAnterior;
    }

    // Función para recalcular todas las sugerencias (replica de recalcularTodasLasSugerencias de la APK)
    async function recalcularTodasLasSugerencias() {
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
        
        if (stockInput && sugerenciaSpan) {
          const stock = parseInt(stockInput.value) || 0;
          calcularSugerencia(codigo, stock).then(sug => {
            sugerenciaSpan.textContent = sug;
            const prod = productos.find(p => p.codigo === codigo);
            if (prod) prod.pedidoSugerido = sug;
          });
        }
      });
    }

    await cargarConfiguracion();
    await cargarDatos();
  }

  // ============================================
  // SISTEMA DE PEDIDO A PANIFICADORA
  // ============================================

  // Función principal para abrir el modal de Pedido a Panificadora
  async function openPedidoPanificadoraModal() {
    const u = localStorage.getItem('usuario');
    if (!u) {
      alert('Inicie sesión primero.');
      return;
    }
    const usuario = JSON.parse(u);
    const localId = usuario.localId || '';
    const localNombre = usuario.localNombre || 'Local';
    
    if (!localId) {
      alert('Error: No se encontró el local');
      return;
    }
    
    // Verificar que Firebase esté inicializado
    try {
      FirebaseRegionManager.getFirestore();
    } catch (e) {
      const regionIdGuardada = localStorage.getItem('region_id');
      if (regionIdGuardada && usuario.regionId) {
        try {
          const regiones = await FirebaseRegionManager.cargarRegiones();
          const regionGuardada = regiones.find(r => r.id === regionIdGuardada || r.id === usuario.regionId);
          if (regionGuardada) {
            FirebaseRegionManager.initializeFirebase(regionGuardada);
            console.log('Firebase inicializado para Pedido a Panificadora con región:', regionGuardada.nombre);
          } else {
            throw new Error('No se encontró la región guardada');
          }
        } catch (error) {
          console.error('Error inicializando Firebase:', error);
          alert('Error: No se pudo inicializar Firebase. Por favor, selecciona una región primero.');
          return;
        }
      } else {
        alert('Error: No se encontró la región. Por favor, selecciona una región primero.');
        return;
      }
    }

    // Obtener fecha actual (Argentina UTC-3)
    const hoy = new Date();
    const offsetArgentina = -3 * 60;
    const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
    let fechaSeleccionada = fechaISO(fechaArgentina);
    let modoSoloLectura = false;
    let modoAdmin = false;

    // Crear overlay y modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;width:95%;max-width:1200px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column';
    overlay.appendChild(modal);

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;position:relative';
    header.innerHTML = '<div style="display:flex;align-items:center;gap:12px;flex:1">' +
      '<button id="pp-volver" style="padding:8px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:700">←</button>' +
      '<button id="pp-config" style="padding:8px 12px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:16px">⚙️</button>' +
      '</div>' +
      '<div style="position:absolute;left:50%;transform:translateX(-50%);font-weight:700;font-size:18px;text-align:center">🥖 Pedido Panificadora</div>' +
      '<button id="pp-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;margin-left:auto">Cerrar</button>';
    modal.appendChild(header);

    // Navegación de fechas
    const navFecha = document.createElement('div');
    navFecha.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:8px;padding:8px;background:#f3f4f6;border-bottom:1px solid #e5e7eb';
    navFecha.innerHTML = '<button id="pp-fecha-prev" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">←</button>' +
      '<div id="pp-fecha-actual" style="padding:8px 16px;font-weight:700;font-size:14px">' + fechaSeleccionada + '</div>' +
      '<button id="pp-fecha-next" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">→</button>';
    modal.appendChild(navFecha);

    // Información del día
    const infoDia = document.createElement('div');
    infoDia.style.cssText = 'background:#f3f4f6;padding:6px;border-bottom:1px solid #e5e7eb';
    
    const fila1 = document.createElement('div');
    fila1.style.cssText = 'display:flex;justify-content:space-between;align-items:center;font-size:12px';
    fila1.innerHTML = '<div id="pp-dia-actual" style="font-weight:700;flex:1">Día: LUNES</div>' +
      '<div id="pp-porcentaje" style="font-weight:700;flex:1;text-align:right">% Extra: 30%</div>';
    infoDia.appendChild(fila1);
    
    const fila2 = document.createElement('div');
    fila2.id = 'pp-dias-extra';
    fila2.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:2px;display:none';
    fila2.textContent = '📅 Pedido para: Mañana';
    infoDia.appendChild(fila2);
    
    const fila3 = document.createElement('div');
    fila3.id = 'pp-hora-alerta';
    fila3.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:4px';
    fila3.textContent = '🔔 Alerta: 15:30';
    infoDia.appendChild(fila3);
    
    modal.appendChild(infoDia);

    // Contenido principal
    const body = document.createElement('div');
    body.style.cssText = 'flex:1;overflow-y:auto;padding:16px';
    body.id = 'pp-body';
    modal.appendChild(body);

    // Variables de estado
    let configuracion = { porcentajeExtra: 30, horaAlerta: '15:30', activarAlerta: true };
    let diasEntrega = { lunes: 'Mañana', martes: 'Mañana', miercoles: 'Mañana', jueves: 'Mañana', viernes: 'Sábado + Domingo', sabado: 'Domingo', domingo: 'Mañana' };
    let productos = [];
    let promediosVenta = {};

    // Función helper para obtener Firestore
    function obtenerFirestore() {
      try {
        return FirebaseRegionManager.getFirestore();
      } catch (e) {
        console.error('Error obteniendo Firestore:', e);
        throw new Error('Firebase no está inicializado. Por favor, selecciona una región primero.');
      }
    }

    // Función para obtener día de la semana
    function obtenerDiaSemana(fecha) {
      const [y, m, d] = fecha.split('-').map(Number);
      const date = new Date(y, m - 1, d);
      const dias = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'];
      return dias[date.getDay()];
    }

    // Función para cargar configuración desde Firebase
    async function cargarConfiguracion() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarConfiguracion, usando valores por defecto');
          actualizarUI();
          return;
        }
        const configDoc = await db.collection('locales').doc(localId).collection('configuracion_pedido_panificadora').doc('config').get();
        if (configDoc.exists) {
          const data = configDoc.data();
          configuracion = {
            porcentajeExtra: data.porcentajeExtra || 30,
            horaAlerta: data.horaAlerta || '15:30',
            activarAlerta: data.activarAlerta !== false
          };
        }
        // EXACTO como Android: cargar desde configuracion_dias_entrega_panificadora (línea 4860 PedidoPanificadoraActivity.kt)
        const diasDoc = await db.collection('locales').doc(localId).collection('configuracion_dias_entrega_panificadora').doc('config').get();
        if (diasDoc.exists) {
          const data = diasDoc.data();
          diasEntrega = {
            lunes: data.lunes !== false,
            martes: data.martes !== false,
            miercoles: data.miercoles !== false,
            jueves: data.jueves !== false,
            viernes: data.viernes !== false,
            sabado: data.sabado !== false,
            domingo: data.domingo !== false
          };
        } else {
          diasEntrega = {
            lunes: true,
            martes: true,
            miercoles: true,
            jueves: true,
            viernes: true,
            sabado: true,
            domingo: true
          };
        }
        actualizarUI();
      } catch (e) {
        console.warn('Error cargando configuración:', e);
      }
    }

    // Función para actualizar UI con configuración
    function actualizarUI() {
      const porcentajeEl = document.getElementById('pp-porcentaje');
      const horaAlertaEl = document.getElementById('pp-hora-alerta');
      const diaActualEl = document.getElementById('pp-dia-actual');
      
      if (porcentajeEl) porcentajeEl.textContent = '% Extra: ' + configuracion.porcentajeExtra + '%';
      if (horaAlertaEl) horaAlertaEl.textContent = '🔔 Alerta: ' + configuracion.horaAlerta;
      
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      if (diaActualEl) diaActualEl.textContent = 'Día: ' + diaActual;
      
      actualizarInformacionDiasExtra();
    }

    // Función para actualizar información de días extra
    function actualizarInformacionDiasExtra() {
      const diasExtra = obtenerDiasExtraSegunTexto();
      const diasExtraEl = document.getElementById('pp-dias-extra');
      if (diasExtraEl && diasExtra.length > 0) {
        const textoDias = diasExtra.join(', ');
        diasExtraEl.textContent = '📅 Pedido para: ' + textoDias;
        diasExtraEl.style.display = 'block';
      } else if (diasExtraEl) {
        diasExtraEl.style.display = 'none';
      }
    }

    // Función para obtener días extra según texto
    function obtenerDiasExtraSegunTexto() {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diasExtra = [];
      
      const proximosDias = {
        'LUNES': [['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes]],
        'MARTES': [['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado]],
        'MIERCOLES': [['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo]],
        'JUEVES': [['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes]],
        'VIERNES': [['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes]],
        'SABADO': [['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles]],
        'DOMINGO': [['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves]]
      };
      
      const lista = proximosDias[diaActual] || [];
      if (lista.length === 0) return diasExtra;
      
      const [primerDia, tieneEntregaPrimerDia] = lista[0];
      if (!tieneEntregaPrimerDia) {
        return diasExtra;
      }
      
      for (let i = 1; i < lista.length; i++) {
        const [nombreDia, tieneEntrega] = lista[i];
        if (!tieneEntrega) {
          diasExtra.push(nombreDia);
        } else {
          break;
        }
      }
      
      return diasExtra;
    }

    // Función para redondear sugerencia según tipo de producto (PANIFICADORA)
    function redondearSugerencia(sugerencia, codigo) {
      if (sugerencia <= 0) return 0;
      
      const porcentajeMultiplo = 1.0;
      
      // Medialunas de Manteca/Grasa: redondear a múltiplo de 180
      if (codigo === 'MEDIALUNA_MANTECA' || codigo === 'MEDIALUNA_GRASA') {
        const multiplo = 180;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Chipa: redondear a múltiplo de 120
      if (codigo === 'CHIPA') {
        const multiplo = 120;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Criollito: redondear a múltiplo de 120
      if (codigo === 'CRIOLLITO') {
        const multiplo = 120;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      return Math.round(sugerencia);
    }

    // Función para cargar promedios de ventas (similar a Pedido a Fábrica)
    async function cargarPromediosVenta() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPromediosVenta');
          return;
        }
        const registrosSnap = await db.collection('locales').doc(localId).collection('registros').orderBy('fecha', 'desc').limit(100).get();
        const registros = [];
        registrosSnap.forEach(d => {
          const data = d.data();
          registros.push({ 
            fecha: data.fecha, 
            tipo: data.tipo, 
            productos: data.productos || [] 
          });
        });

        const ventasPorDia = { LUNES: {}, MARTES: {}, MIERCOLES: {}, JUEVES: {}, VIERNES: {}, SABADO: {}, DOMINGO: {} };
        
        console.log('📊 [Panificadora] Iniciando cálculo de promedios. Productos a procesar:', ordenProductosPanificadora);
        
        const fechasProcesadas = new Set();
        registros.forEach(registro => {
          if (fechasProcesadas.has(registro.fecha)) return;
          fechasProcesadas.add(registro.fecha);
          
          const dia = obtenerDiaSemana(registro.fecha);
          if (!(dia in ventasPorDia)) return;
          
          const ingreso = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Ingreso de Mercadería');
          const stockFinal = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Stock Final');
          
          if (!stockFinal || !stockFinal.productos) return;
          
          const [y, m, d] = registro.fecha.split('-').map(Number);
          const fechaAnterior = new Date(y, m - 1, d);
          fechaAnterior.setDate(fechaAnterior.getDate() - 1);
          const fechaAnteriorStr = fechaISO(fechaAnterior);
          const stockAnterior = registros.find(r => r.fecha === fechaAnteriorStr && r.tipo === 'Stock Final');
          
          // Filtrar SOLO productos de panificadora antes de procesar
          const productosPanificadora = stockFinal.productos.filter(p => {
            const nombreProducto = p.nombre || p.codigo || '';
            const codigo = obtenerCodigoProducto(nombreProducto);
            const esPanificadora = ordenProductosPanificadora.includes(codigo);
            if (!esPanificadora && nombreProducto) {
              // Log solo para productos que NO son de panificadora (para debug)
              // console.log('⏭️ [Panificadora] Saltando producto:', nombreProducto, '→ código:', codigo);
            }
            return esPanificadora;
          });
          
          if (productosPanificadora.length > 0) {
            console.log(`📅 [Panificadora] Fecha ${registro.fecha} (${dia}): ${productosPanificadora.length} productos de panificadora de ${stockFinal.productos.length} totales`);
          }
          
          // Solo procesar productos de panificadora
          productosPanificadora.forEach(p => {
            const nombreProducto = p.nombre || p.codigo || '';
            const codigo = obtenerCodigoProducto(nombreProducto);
            
            // Debug: log para ver qué productos se están procesando
            console.log('🔍 [Panificadora] Procesando producto:', nombreProducto, '→ código:', codigo);
            
            // Buscar en ingreso y stock anterior usando el mapeo de códigos
            // Necesitamos buscar por el nombre original del producto en la BD
            const ingresoCant = (ingreso?.productos || []).find(ip => {
              const nombreIngreso = ip.nombre || ip.codigo || '';
              const codigoIngreso = obtenerCodigoProducto(nombreIngreso);
              return codigoIngreso === codigo;
            })?.cantidad || 0;
            
            const stockAntCant = (stockAnterior?.productos || []).find(sp => {
              const nombreStock = sp.nombre || sp.codigo || '';
              const codigoStock = obtenerCodigoProducto(nombreStock);
              return codigoStock === codigo;
            })?.cantidad || 0;
            
            const venta = stockAntCant + ingresoCant - p.cantidad;
            
            if (venta > 0) {
              if (!ventasPorDia[dia][codigo]) {
                ventasPorDia[dia][codigo] = [];
              }
              ventasPorDia[dia][codigo].push(venta);
              
              // Debug: log para ver ventas calculadas
              if (codigo === 'MEDIALUNA_MANTECA') {
                console.log('📊 [Panificadora] Venta calculada para', codigo, 'en', dia, ':', venta, '(stockAnt:', stockAntCant, '+ ingreso:', ingresoCant, '- stockFinal:', p.cantidad, ')');
              }
            }
          });
        });

        // Calcular promedios SOLO para productos de panificadora
        console.log('📊 [Panificadora] Calculando promedios para productos:', ordenProductosPanificadora);
        ordenProductosPanificadora.forEach(codigo => {
          if (!promediosVenta[codigo]) {
            promediosVenta[codigo] = {};
          }
          ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'].forEach(dia => {
            const ventasDelDia = ventasPorDia[dia][codigo] || [];
            if (ventasDelDia.length > 0) {
              const suma = ventasDelDia.reduce((a, b) => a + b, 0);
              const promedio = suma / ventasDelDia.length;
              promediosVenta[codigo][dia] = Math.round(promedio);
              
              console.log(`✅ [Panificadora] Promedio calculado para ${codigo} en ${dia}: ${Math.round(promedio)} (de ${ventasDelDia.length} ventas)`);
            } else {
              promediosVenta[codigo][dia] = 0;
            }
          });
        });
        
        // Debug: mostrar resumen de promedios para todos los productos de panificadora
        ordenProductosPanificadora.forEach(codigo => {
          if (promediosVenta[codigo]) {
            console.log(`📈 [Panificadora] Resumen promedios ${codigo}:`, promediosVenta[codigo]);
          }
        });
      } catch (e) {
        console.warn('Error cargando promedios:', e);
      }
    }

    // Función helper para obtener código de producto desde nombre
    function obtenerCodigoProducto(nombre) {
      if (!nombre) return nombre;
      
      // Normalizar nombre (trim)
      const nombreNormalizado = nombre.trim();
      const nombreUpper = nombreNormalizado.toUpperCase();
      
      // Casos especiales primero (formato "CODIGO - Nombre" o solo "CODIGO")
      // Buscar por coincidencia al inicio (case-insensitive)
      if (nombreUpper.startsWith('DULCES')) {
        console.log('🔍 [obtenerCodigoProducto] Mapeando:', nombreNormalizado, '→ MEDIALUNA_MANTECA');
        return 'MEDIALUNA_MANTECA';
      }
      if (nombreUpper.startsWith('CHIPA')) {
        return 'CHIPA';
      }
      if (nombreUpper.startsWith('CRIOLLITO')) {
        return 'CRIOLLITO';
      }
      
      // Mapeo completo de nombres de la base de datos a códigos de panificadora
      const mapeoNombres = {
        // Formatos de Medialunas de Manteca
        'MEDIALUNA_MANTECA': 'MEDIALUNA_MANTECA',
        'Medialunas de Manteca': 'MEDIALUNA_MANTECA',
        'Medialuna de Manteca': 'MEDIALUNA_MANTECA',
        'DULCES - Dulces': 'MEDIALUNA_MANTECA',
        'DULCES': 'MEDIALUNA_MANTECA',
        'Dulces': 'MEDIALUNA_MANTECA',
        'dulces': 'MEDIALUNA_MANTECA',
        
        // Formatos de Medialunas de Grasa
        'MEDIALUNA_GRASA': 'MEDIALUNA_GRASA',
        'Medialunas de Grasa': 'MEDIALUNA_GRASA',
        'Medialuna de Grasa': 'MEDIALUNA_GRASA',
        
        // Formatos de Chipa
        'CHIPA': 'CHIPA',
        'CHIPA - Chipa': 'CHIPA',
        'Chipa': 'CHIPA',
        'chipa': 'CHIPA',
        
        // Formatos de Criollito
        'CRIOLLITO': 'CRIOLLITO',
        'CRIOLLITO - Criollito': 'CRIOLLITO',
        'CRIOLLITO - Criollitos': 'CRIOLLITO',
        'Criollito': 'CRIOLLITO',
        'Criollitos': 'CRIOLLITO',
        'criollito': 'CRIOLLITO',
        'criollitos': 'CRIOLLITO'
      };
      
      // Buscar coincidencia exacta primero (case-insensitive)
      for (const [key, value] of Object.entries(mapeoNombres)) {
        if (nombreUpper === key.toUpperCase()) {
          if (value === 'MEDIALUNA_MANTECA') {
            console.log('🔍 [obtenerCodigoProducto] Coincidencia exacta:', nombreNormalizado, '→', value);
          }
          return value;
        }
      }
      
      // Buscar por coincidencia parcial (case-insensitive)
      for (const [key, value] of Object.entries(mapeoNombres)) {
        const keyUpper = key.toUpperCase();
        if (nombreUpper.includes(keyUpper) || keyUpper.includes(nombreUpper)) {
          if (value === 'MEDIALUNA_MANTECA') {
            console.log('🔍 [obtenerCodigoProducto] Coincidencia parcial:', nombreNormalizado, '→', value, '(key:', key, ')');
          }
          return value;
        }
      }
      
      // Si no encuentra, retornar el nombre original
      console.warn('⚠️ [obtenerCodigoProducto] No se encontró mapeo para:', nombreNormalizado);
      return nombreNormalizado;
    }

    // Función para cargar stock actual desde registros
    async function cargarStockActualDesdeRegistros() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarStockActualDesdeRegistros');
          return {};
        }
        
        const hoy = getFechaActualArgentina();
        const stockMap = {};
        
        // PRIMERO: Verificar si existe Stock Final de HOY (si existe, usarlo directamente)
        const stockHoy = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', hoy).where('tipo', '==', 'Stock Final').get();
        
        if (!stockHoy.empty) {
          // Si existe Stock Final de hoy, usarlo directamente
          stockHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const nombreProducto = p.nombre || p.codigo || '';
              const codigo = obtenerCodigoProducto(nombreProducto);
              if (ordenProductosPanificadora.includes(codigo)) {
                stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
              }
            });
          });
        } else {
          // Si NO existe Stock Final de hoy, calcular: Stock Final de ayer + Ingreso de hoy
          const fechaAyer = getFechaArgentina();
          fechaAyer.setDate(fechaAyer.getDate() - 1);
          const ayer = fechaISO(fechaAyer);
          
          const stockAyer = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', ayer).where('tipo', '==', 'Stock Final').get();
          stockAyer.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const nombreProducto = p.nombre || p.codigo || '';
              const codigo = obtenerCodigoProducto(nombreProducto);
              if (ordenProductosPanificadora.includes(codigo)) {
                stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
              }
            });
          });
          
          const ingresoHoy = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', hoy).where('tipo', '==', 'Ingreso de Mercadería').get();
          ingresoHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const nombreProducto = p.nombre || p.codigo || '';
              const codigo = obtenerCodigoProducto(nombreProducto);
              if (ordenProductosPanificadora.includes(codigo)) {
                stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
              }
            });
          });
        }
        
        return stockMap;
      } catch (e) {
        console.warn('Error cargando stock actual:', e);
        return {};
      }
    }

    // Función para calcular sugerencia de pedido
    function calcularSugerencia(codigo, stockActual) {
      // MEDIALUNA_GRASA es nuevo, no tiene sugerencia
      if (codigo === 'MEDIALUNA_GRASA') return 0;
      
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const promedioDiaActual = promediosVenta[codigo]?.[diaActual] || 0;
      
      // Si no hay promedio, no hay sugerencia
      if (!promedioDiaActual) return 0;
      
      // stockActual puede ser 0, pero igual debemos calcular la sugerencia
      const stock = stockActual || 0;
      
      const porcentajeExtra = configuracion.porcentajeExtra / 100.0;
      
      if (diaActual === 'VIERNES') {
        const promedioSabado = promediosVenta[codigo]?.['SABADO'] || 0;
        const promedioDomingo = promediosVenta[codigo]?.['DOMINGO'] || 0;
        
        const ventaRestanteHoy = promedioDiaActual / 2.0;
        const ventaSabado = promedioSabado;
        const ventaDomingo = promedioDomingo * (1 + porcentajeExtra);
        
        const totalNecesario = ventaRestanteHoy + ventaSabado + ventaDomingo;
        const stockDisponible = stock - ventaRestanteHoy;
        
        const pedido = Math.max(0, totalNecesario - stockDisponible);
        return redondearSugerencia(pedido, codigo);
      } else {
        const ventaEsperada = promedioDiaActual * (1 + porcentajeExtra);
        const pedido = Math.max(0, ventaEsperada - stock);
        return redondearSugerencia(pedido, codigo);
      }
    }

    // Función para inicializar productos
    async function inicializarProductos() {
      productos = [];
      const stockMap = await cargarStockActualDesdeRegistros();
      
      ordenProductosPanificadora.forEach(codigo => {
        const productoInfo = productosPanificadora[codigo];
        if (!productoInfo) return;
        
        productos.push({
          codigo: codigo,
          nombre: productoInfo.nombre,
          categoria: productoInfo.categoria,
          stockActual: stockMap[codigo] || 0,
          pedidoFinal: 0,
          sugerencia: calcularSugerencia(codigo, stockMap[codigo] || 0)
        });
      });
    }

    // Función para mostrar categoría integrada (PANIFICADORA)
    function mostrarCategoriaIntegrada(categoria, productosCategoria) {
      const categoriaDiv = document.createElement('div');
      categoriaDiv.style.cssText = 'margin-bottom:16px';

      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'background:#D97706;color:#fff;padding:12px;display:flex;align-items:center;gap:12px;font-weight:700';
      
      headerDiv.innerHTML = '<span style="font-size:24px">🥖</span>' +
        '<span style="flex:1;font-size:18px">PANIFICADORA</span>';
      categoriaDiv.appendChild(headerDiv);

      const productosDiv = document.createElement('div');
      productosDiv.style.cssText = 'background:#fff;padding:8px';

      const orden = ordenProductosPanificadora;
      const productosOrdenados = orden.map(codigo => productosCategoria.find(p => p.codigo === codigo)).filter(p => p);

      for (const prod of productosOrdenados) {
        const filaDiv = document.createElement('div');
        filaDiv.style.cssText = 'display:flex;align-items:center;padding:12px;background:#f9fafb;margin:2px 0;gap:4px';
        filaDiv.id = 'pp-row-' + prod.codigo;

        // Columna 1: Código y Nombre (similar a Pedido a Fábrica)
        const codigoDiv = document.createElement('div');
        codigoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;min-width:0';
        const codigoSpan = document.createElement('span');
        codigoSpan.id = 'pp-codigo-' + prod.codigo;
        codigoSpan.style.cssText = 'font-size:13px;font-weight:700;color:#D97706;margin-bottom:2px';
        codigoSpan.textContent = prod.codigo;
        codigoDiv.appendChild(codigoSpan);
        const nombreSpan = document.createElement('span');
        nombreSpan.style.cssText = 'font-size:11px;color:#6b7280;word-wrap:break-word;overflow-wrap:break-word';
        nombreSpan.textContent = prod.nombre;
        codigoDiv.appendChild(nombreSpan);
        filaDiv.appendChild(codigoDiv);

        // Columna 2: Stock
        const stockDiv = document.createElement('div');
        stockDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px;min-width:70px';
        const stockLabel = document.createElement('span');
        stockLabel.style.cssText = 'font-size:9px;font-weight:700;color:#D97706;margin-bottom:2px';
        stockLabel.textContent = 'Stock';
        stockDiv.appendChild(stockLabel);
        const stockInput = document.createElement('input');
        stockInput.type = 'number';
        stockInput.id = 'pp-stock-' + prod.codigo;
        stockInput.value = prod.stockActual || 0;
        stockInput.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#D97706';
        if (modoSoloLectura && !modoAdmin) {
          stockInput.disabled = true;
          stockInput.style.background = '#d1d5db';
        } else {
          stockInput.onfocus = function() { this.select(); };
          // Listener para actualizar sugerencia cuando cambia el stock
          stockInput.addEventListener('input', async () => {
            const stock = parseInt(stockInput.value) || 0;
            const sugerencia = calcularSugerencia(prod.codigo, stock);
            spanSugerencia.textContent = sugerencia;
            // Actualizar el objeto producto
            const producto = productos.find(p => p.codigo === prod.codigo);
            if (producto) {
              producto.stockActual = stock;
              producto.sugerencia = sugerencia;
            }
          });
        }
        stockDiv.appendChild(stockInput);
        filaDiv.appendChild(stockDiv);

        // Columna 3: Sugerencia
        const sugerenciaDiv = document.createElement('div');
        sugerenciaDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px;min-width:70px';
        const sugerenciaLabel = document.createElement('span');
        sugerenciaLabel.style.cssText = 'font-size:9px;font-weight:700;color:#059669;margin-bottom:2px';
        sugerenciaLabel.textContent = 'Sugerencia';
        sugerenciaDiv.appendChild(sugerenciaLabel);
        const spanSugerencia = document.createElement('span');
        spanSugerencia.id = 'pp-sugerencia-' + prod.codigo;
        spanSugerencia.style.cssText = 'width:60px;height:35px;display:flex;align-items:center;justify-content:center;background:#ecfdf5;border:1px solid #10b981;border-radius:4px;font-size:14px;font-weight:700;color:#059669';
        spanSugerencia.textContent = prod.sugerencia || 0;
        sugerenciaDiv.appendChild(spanSugerencia);
        filaDiv.appendChild(sugerenciaDiv);

        // Columna 4: Pedido Final
        const pedidoDiv = document.createElement('div');
        pedidoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;min-width:70px';
        const pedidoLabel = document.createElement('span');
        pedidoLabel.style.cssText = 'font-size:9px;font-weight:700;color:#D97706;margin-bottom:2px';
        pedidoLabel.textContent = 'Pedido Final';
        pedidoDiv.appendChild(pedidoLabel);
        const pedidoInput = document.createElement('input');
        pedidoInput.type = 'number';
        pedidoInput.id = 'pp-pedido-' + prod.codigo;
        pedidoInput.value = prod.pedidoFinal || 0;
        pedidoInput.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#D97706';
        if (modoSoloLectura && !modoAdmin) {
          pedidoInput.disabled = true;
          pedidoInput.style.background = '#d1d5db';
        } else {
          pedidoInput.onfocus = function() { this.select(); };
        }
        pedidoDiv.appendChild(pedidoInput);
        filaDiv.appendChild(pedidoDiv);

        productosDiv.appendChild(filaDiv);
      }

      categoriaDiv.appendChild(productosDiv);
      body.appendChild(categoriaDiv);
    }

    // Función para cargar pedido existente
    async function cargarPedidoExistente() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPedidoExistente');
          return;
        }
        
        const pedidoDoc = await db.collection('locales').doc(localId).collection('pedidos_panificadora').doc(fechaSeleccionada).get();
        if (pedidoDoc.exists) {
          const data = pedidoDoc.data();
          const productosGuardados = data.productos || [];
          
          productosGuardados.forEach(prod => {
            const codigo = obtenerCodigoProducto(prod.nombre || prod.codigo || '');
            const pedidoInput = document.getElementById('pp-pedido-' + codigo);
            if (pedidoInput) {
              pedidoInput.value = prod.pedidoFinal || 0;
            }
            const stockInput = document.getElementById('pp-stock-' + codigo);
            if (stockInput) {
              stockInput.value = prod.stockActual || 0;
            }
          });
        }
      } catch (e) {
        console.warn('Error cargando pedido existente:', e);
      }
    }

    // Función para guardar pedido
    async function guardarPedido() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          alert('Error: Firebase no está inicializado');
          return;
        }
        
        const productosParaGuardar = [];
        ordenProductosPanificadora.forEach(codigo => {
          const stockInput = document.getElementById('pp-stock-' + codigo);
          const pedidoInput = document.getElementById('pp-pedido-' + codigo);
          if (stockInput && pedidoInput) {
            productosParaGuardar.push({
              codigo: codigo,
              nombre: productosPanificadora[codigo]?.nombre || codigo,
              stockActual: parseInt(stockInput.value) || 0,
              pedidoFinal: parseInt(pedidoInput.value) || 0
            });
          }
        });
        
        const configuracionParaGuardar = {
          porcentajeExtra: configuracion.porcentajeExtra,
          horaAlerta: configuracion.horaAlerta,
          activarAlerta: configuracion.activarAlerta,
          diasEntrega: diasEntrega,
          fechaCreacion: new Date(),
          paraFecha: obtenerDiasExtraSegunTexto().join(', '),
          fecha: fechaSeleccionada,
          localId: localId
        };
        
        const pedidoData = {
          productos: productosParaGuardar,
          configuracion: configuracionParaGuardar,
          fecha: fechaSeleccionada,
          localId: localId,
          reconstruido: true
        };
        
        await db.collection('locales').doc(localId).collection('pedidos_panificadora').doc(fechaSeleccionada).set(pedidoData);
        alert('Pedido guardado exitosamente');
      } catch (e) {
        alert('Error guardando pedido: ' + e.message);
      }
    }

    // Función para generar texto del pedido
    function generarTextoPedido() {
      const pedido = [];
      
      pedido.push('📋 PEDIDO PANIFICADORA - ' + fechaSeleccionada + '\n\n');
      
      ordenProductosPanificadora.forEach(codigo => {
        const stockInput = document.getElementById('pp-stock-' + codigo);
        const pedidoInput = document.getElementById('pp-pedido-' + codigo);
        if (!stockInput || !pedidoInput) return;
        
        const stock = parseInt(stockInput.value) || 0;
        const pedidoFinal = parseInt(pedidoInput.value) || 0;
        
        // Formatear según tipo de producto (igual que la APK)
        let pedidoFormateado = '';
        if (codigo === 'MEDIALUNA_MANTECA') {
          pedidoFormateado = pedidoFinal > 0 ? `mdl manteca ${stock}-${pedidoFinal}` : `mdl manteca ${stock}-no pido`;
        } else if (codigo === 'MEDIALUNA_GRASA') {
          pedidoFormateado = pedidoFinal > 0 ? `mdl grasa ${stock}-${pedidoFinal}` : `mdl grasa ${stock}-no pido`;
        } else if (codigo === 'CHIPA') {
          pedidoFormateado = pedidoFinal > 0 ? `chipa ${stock}-${pedidoFinal}` : `chipa ${stock}-0`;
        } else if (codigo === 'CRIOLLITO') {
          pedidoFormateado = pedidoFinal > 0 ? `criollito ${stock}-${pedidoFinal}` : `criollito ${stock}-0`;
        }
        
        if (pedidoFormateado) {
          pedido.push(pedidoFormateado + '\n');
        }
      });
      
      return pedido.join('');
    }

    // Función para navegar fechas
    function navegarFecha(dias) {
      const [y, m, d] = fechaSeleccionada.split('-').map(Number);
      const fecha = new Date(y, m - 1, d);
      fecha.setDate(fecha.getDate() + dias);
      fechaSeleccionada = fechaISO(fecha);
      document.getElementById('pp-fecha-actual').textContent = fechaSeleccionada;
      
      const fechaHoy = getFechaActualArgentina();
      modoSoloLectura = (fechaSeleccionada !== fechaHoy) && !modoAdmin;
      
      actualizarUI();
      cargarDatos();
    }

    // Función para cargar todos los datos
    async function cargarDatos() {
      body.innerHTML = '<div style="text-align:center;padding:40px">Cargando...</div>';
      
      await cargarPromediosVenta();
      await inicializarProductos();
      
      body.innerHTML = '';
      
      // Mostrar solo categoría PANIFICADORA
      const productosPanificadoraList = productos.filter(p => p.categoria === 'PANIFICADORA');
      if (productosPanificadoraList.length > 0) {
        mostrarCategoriaIntegrada('PANIFICADORA', productosPanificadoraList);
      }
      
      // Botones de acción
      const btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display:flex;gap:8px;margin-top:16px;padding:16px;border-top:1px solid #e5e7eb';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#10b981;color:#fff;border:none;border-radius:6px;font-weight:600';
      btnGuardar.textContent = '💾 Guardar Pedido';
      btnGuardar.onclick = guardarPedido;
      btnContainer.appendChild(btnGuardar);
      
      const btnCopiar = document.createElement('button');
      btnCopiar.style.cssText = 'flex:1;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:600';
      btnCopiar.textContent = '📋 Copiar Pedido';
      btnCopiar.onclick = () => {
        const texto = generarTextoPedido();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(texto).then(() => {
            alert('Pedido copiado al portapapeles');
          });
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = texto;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            alert('Pedido copiado al portapapeles');
          } catch (e) {
            alert('Error copiando: ' + e.message);
          }
          document.body.removeChild(textarea);
        }
      };
      btnContainer.appendChild(btnCopiar);
      
      body.appendChild(btnContainer);
      
      await cargarPedidoExistente();
    }

    // Event listeners
    header.querySelector('#pp-close').onclick = () => overlay.remove();
    header.querySelector('#pp-volver').onclick = () => overlay.remove();
    navFecha.querySelector('#pp-fecha-prev').onclick = () => navegarFecha(-1);
    navFecha.querySelector('#pp-fecha-next').onclick = () => navegarFecha(1);
    
    // EXACTO como Android: Usar función completa de configuración (línea 1662 PedidoPanificadoraActivity.kt)
    header.querySelector('#pp-config').onclick = () => {
      mostrarConfiguracionPedidoPanificadora();
    };
    
    // Función para mostrar configuración completa (igual que Android)
    function mostrarConfiguracionPedidoPanificadora() {
      const overlayConfig = document.createElement('div');
      overlayConfig.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalConfig = document.createElement('div');
      modalConfig.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      // Título
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:24px;text-align:center';
      titulo.textContent = '⚙️ Configuración';
      modalConfig.appendChild(titulo);
      
      // Porcentaje Extra con SeekBar
      // EXACTO como Android: Obtener el porcentaje actual de la UI (línea 1669 PedidoPanificadoraActivity.kt)
      const porcentajeEl = document.getElementById('pp-porcentaje');
      const porcentajeActual = porcentajeEl 
        ? parseInt(porcentajeEl.textContent.replace('% Extra: ', '').replace('%', '') || '30')
        : (configuracion.porcentajeExtra || 30);
      
      const porcentajeDiv = document.createElement('div');
      porcentajeDiv.style.cssText = 'margin-bottom:24px';
      
      const txtPorcentaje = document.createElement('div');
      txtPorcentaje.id = 'pp-config-porcentaje-text';
      txtPorcentaje.style.cssText = 'font-size:16px;font-weight:600;color:#1976d2;padding:8px 16px;margin-bottom:8px';
      txtPorcentaje.textContent = 'Porcentaje Extra: ' + porcentajeActual + '%';
      porcentajeDiv.appendChild(txtPorcentaje);
      
      const seekBar = document.createElement('input');
      seekBar.type = 'range';
      seekBar.min = '0';
      seekBar.max = '100';
      seekBar.value = porcentajeActual;
      seekBar.style.cssText = 'width:100%;height:8px;margin:16px 0';
      seekBar.oninput = function() {
        txtPorcentaje.textContent = 'Porcentaje Extra: ' + this.value + '%';
        // Actualizar sugerencias en tiempo real
        if (typeof actualizarSugerenciasEnTiempoReal === 'function') {
          actualizarSugerenciasEnTiempoReal(parseInt(this.value));
        }
      };
      porcentajeDiv.appendChild(seekBar);
      modalConfig.appendChild(porcentajeDiv);
      
      // Hora de Alerta
      const horaDiv = document.createElement('div');
      horaDiv.style.cssText = 'margin-bottom:24px';
      
      const txtHora = document.createElement('div');
      txtHora.style.cssText = 'font-size:16px;padding:8px 16px;margin-bottom:8px';
      txtHora.textContent = 'Hora de Alerta:';
      horaDiv.appendChild(txtHora);
      
      const editHora = document.createElement('input');
      editHora.type = 'text';
      editHora.id = 'pp-config-hora-input';
      // EXACTO como Android: Usar la hora actual mostrada en la UI (línea 1712 PedidoPanificadoraActivity.kt)
      const horaAlertaEl = document.getElementById('pp-hora-alerta');
      const horaActual = horaAlertaEl 
        ? horaAlertaEl.textContent.replace('🔔 Alerta: ', '') || '15:30'
        : (configuracion.horaAlerta || '15:30');
      editHora.value = horaActual;
      editHora.style.cssText = 'width:100%;padding:16px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;cursor:pointer';
      editHora.readOnly = true;
      editHora.onclick = function() {
        mostrarSelectorHoraPedidoPanificadora(editHora);
      };
      horaDiv.appendChild(editHora);
      modalConfig.appendChild(horaDiv);
      
      // Botón para configurar días de entrega
      const btnDiasEntrega = document.createElement('button');
      btnDiasEntrega.style.cssText = 'width:100%;padding:16px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:16px;margin-bottom:24px;cursor:pointer';
      btnDiasEntrega.textContent = '📅 Configurar Días de Entrega';
      btnDiasEntrega.onclick = () => {
        overlayConfig.remove();
        mostrarConfiguracionDiasEntregaPedidoPanificadora();
      };
      modalConfig.appendChild(btnDiasEntrega);
      
      // Botones
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        const nuevoPorcentaje = parseInt(seekBar.value);
        const nuevaHora = editHora.value;
        
        configuracion.porcentajeExtra = nuevoPorcentaje;
        configuracion.horaAlerta = nuevaHora;
        
        // Guardar en Firebase
        await guardarConfiguracionEnFirebase();
        
        // Actualizar UI
        if (typeof actualizarUI === 'function') {
          actualizarUI();
        }
        
        // Actualizar sugerencias
        if (typeof actualizarSugerenciasEnTiempoReal === 'function') {
          actualizarSugerenciasEnTiempoReal(nuevoPorcentaje);
        }
        
        overlayConfig.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayConfig.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalConfig.appendChild(botonesDiv);
      
      overlayConfig.appendChild(modalConfig);
      document.body.appendChild(overlayConfig);
    }
    
    // Función para mostrar selector de hora
    function mostrarSelectorHoraPedidoPanificadora(editHora) {
      const horaActual = editHora.value || '15:30';
      const [h, m] = horaActual.split(':').map(Number);
      
      const overlayHora = document.createElement('div');
      overlayHora.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10001';
      const modalHora = document.createElement('div');
      modalHora.style.cssText = 'background:#fff;padding:24px;border-radius:8px;min-width:300px';
      
      modalHora.innerHTML = '<div style="font-size:18px;font-weight:700;margin-bottom:16px;text-align:center">Seleccionar Hora</div>' +
        '<div style="display:flex;gap:16px;justify-content:center;align-items:center;margin-bottom:24px">' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Hora</label>' +
        '<input type="number" id="pp-hora-picker-h" min="0" max="23" value="' + h + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '<div style="font-size:24px;font-weight:700">:</div>' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Minuto</label>' +
        '<input type="number" id="pp-hora-picker-m" min="0" max="59" value="' + m + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '</div>' +
        '<div style="display:flex;gap:12px">' +
        '<button id="pp-hora-ok" style="flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Aceptar</button>' +
        '<button id="pp-hora-cancel" style="flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Cancelar</button>' +
        '</div>';
      
      overlayHora.appendChild(modalHora);
      document.body.appendChild(overlayHora);
      
      const inputHora = document.getElementById('pp-hora-picker-h');
      const inputMinuto = document.getElementById('pp-hora-picker-m');
      if (inputHora) {
        inputHora.onfocus = function() { this.select(); };
      }
      if (inputMinuto) {
        inputMinuto.onfocus = function() { this.select(); };
      }
      
      document.getElementById('pp-hora-ok').onclick = () => {
        const hora = String(inputHora.value).padStart(2, '0');
        const minuto = String(inputMinuto.value).padStart(2, '0');
        editHora.value = hora + ':' + minuto;
        overlayHora.remove();
      };
      
      document.getElementById('pp-hora-cancel').onclick = () => overlayHora.remove();
    }
    
    // Función para mostrar configuración de días de entrega
    function mostrarConfiguracionDiasEntregaPedidoPanificadora() {
      const overlayDias = document.createElement('div');
      overlayDias.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalDias = document.createElement('div');
      modalDias.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:16px;text-align:center';
      titulo.textContent = '⚙️ Días de Entrega';
      modalDias.appendChild(titulo);
      
      const subtitulo = document.createElement('div');
      subtitulo.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      subtitulo.textContent = '📅 Configurar Días de Entrega';
      modalDias.appendChild(subtitulo);
      
      const descripcion = document.createElement('div');
      descripcion.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      descripcion.textContent = 'Marca los días en que la fábrica entrega mercadería a tu local. Esto afectará el cálculo de sugerencias de pedido.';
      modalDias.appendChild(descripcion);
      
      const checkboxes = {};
      const dias = [
        ['lunes', 'Lunes'],
        ['martes', 'Martes'],
        ['miercoles', 'Miércoles'],
        ['jueves', 'Jueves'],
        ['viernes', 'Viernes'],
        ['sabado', 'Sábado'],
        ['domingo', 'Domingo']
      ];
      
      dias.forEach(([clave, nombre]) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = 'display:flex;align-items:center;padding:8px 16px;margin-bottom:8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'pp-dia-' + clave;
        checkbox.style.cssText = 'width:20px;height:20px;margin-right:12px;cursor:pointer';
        // Cargar estado actual desde diasEntrega si existe
        if (typeof diasEntrega !== 'undefined' && diasEntrega[clave] !== undefined) {
          checkbox.checked = diasEntrega[clave];
        } else {
          checkbox.checked = true; // Por defecto todos marcados
        }
        checkboxes[clave] = checkbox;
        
        const label = document.createElement('label');
        label.htmlFor = 'pp-dia-' + clave;
        label.style.cssText = 'font-size:16px;cursor:pointer;flex:1';
        label.textContent = nombre;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        modalDias.appendChild(checkboxDiv);
      });
      
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px;margin-top:24px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        // Actualizar configuración
        if (typeof diasEntrega === 'undefined') {
          diasEntrega = {};
        }
        diasEntrega.lunes = checkboxes.lunes.checked;
        diasEntrega.martes = checkboxes.martes.checked;
        diasEntrega.miercoles = checkboxes.miercoles.checked;
        diasEntrega.jueves = checkboxes.jueves.checked;
        diasEntrega.viernes = checkboxes.viernes.checked;
        diasEntrega.sabado = checkboxes.sabado.checked;
        diasEntrega.domingo = checkboxes.domingo.checked;
        
        // Guardar en Firebase
        await guardarDiasEntregaEnFirebase();
        
        // Actualizar UI
        if (typeof actualizarInformacionDiasExtra === 'function') {
          actualizarInformacionDiasExtra();
        }
        
        // Recalcular sugerencias
        if (typeof recalcularTodasLasSugerencias === 'function') {
          recalcularTodasLasSugerencias();
        }
        if (typeof actualizarSugerenciasEnTiempoReal === 'function') {
          actualizarSugerenciasEnTiempoReal(configuracion.porcentajeExtra);
        }
        
        overlayDias.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayDias.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalDias.appendChild(botonesDiv);
      
      overlayDias.appendChild(modalDias);
      document.body.appendChild(overlayDias);
    }
    
    // Función para guardar configuración en Firebase (específica para Panificadora)
    async function guardarConfiguracionEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_pedido_panificadora').doc('config').set({
          porcentajeExtra: configuracion.porcentajeExtra,
          horaAlerta: configuracion.horaAlerta,
          activarAlerta: configuracion.activarAlerta,
          timestamp: new Date().toISOString()
        });
        console.log('✅ Configuración de Panificadora guardada en Firebase');
      } catch (e) {
        console.error('Error guardando configuración:', e);
        alert('Error guardando configuración: ' + e.message);
      }
    }

    // Función para guardar días de entrega en Firebase (específica para Panificadora)
    // EXACTO como Android: usa configuracion_dias_entrega_panificadora (línea 4548 PedidoPanificadoraActivity.kt)
    async function guardarDiasEntregaEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_dias_entrega_panificadora').doc('config').set({
          lunes: diasEntrega.lunes,
          martes: diasEntrega.martes,
          miercoles: diasEntrega.miercoles,
          jueves: diasEntrega.jueves,
          viernes: diasEntrega.viernes,
          sabado: diasEntrega.sabado,
          domingo: diasEntrega.domingo,
          timestamp: new Date().toISOString()
        });
        console.log('✅ Días de entrega de Panificadora guardados en Firebase');
      } catch (e) {
        console.error('Error guardando días de entrega:', e);
        alert('Error guardando días de entrega: ' + e.message);
      }
    }

    document.body.appendChild(overlay);
    await cargarConfiguracion();
    await cargarDatos();
  }

  // API global para botones del HTML
  window.openVencimientosHistorial = function (localId, localNombre) {
    return openStockVencimientosModal(localId, localNombre);
  };
  window.openVencLocal = function () {
    return openVencLocalModal();
  };
  window.openPedidoFabrica = function () {
    return openPedidoFabricaModal();
  };
  window.openPedidoPanificadora = function () {
    return openPedidoPanificadoraModal();
  };
})();
</script>
</script>