<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sabores Express - Product Mix V2 Web v4.8</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js?v=4.8"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js?v=4.8"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js?v=4.8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD6dF6jCibROTO-oXBfKUdAjk9q6g6-Mu0",
            authDomain: "inventario-app-multi-local.firebaseapp.com",
            projectId: "inventario-app-multi-local",
            storageBucket: "inventario-app-multi-local.firebasestorage.app",
            messagingSenderId: "623222993471",
            appId: "1:623222993471:web:48bffda68352403f27be8a"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
</head>
<body>
    <div id="root">
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h1>Cargando Inventario App...</h1>
            <p>Conectando con Firebase...</p>
            <!-- v2.2 - Carga TODOS los locales de Firebase, sin cach√© -->
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Login Component
        function Login({ onLoginSuccess }) {
            const [locales, setLocales] = useState([]);
            const [localSeleccionado, setLocalSeleccionado] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [cargandoLocales, setCargandoLocales] = useState(true);
            const [recordarDatos, setRecordarDatos] = useState(false);

            useEffect(() => {
                cargarLocales();
                cargarDatosGuardados();
            }, []);

            const cargarDatosGuardados = () => {
                try {
                    const datosGuardados = localStorage.getItem('loginData');
                    if (datosGuardados) {
                        const { localId, password: savedPassword, recordar } = JSON.parse(datosGuardados);
                        if (recordar) {
                            setLocalSeleccionado(localId);
                            setPassword(savedPassword);
                            setRecordarDatos(true);
                        }
                    }
                } catch (error) {
                    console.error('Error cargando datos guardados:', error);
                }
            };

            const cargarLocales = async () => {
                try {
                    setCargandoLocales(true);
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        localesData.push({ 
                            id: doc.id, 
                            nombre: data.nombre,
                            activo: data.activo 
                        });
                    });
                    setLocales(localesData);
                } catch (error) {
                    console.error('Error cargando locales:', error);
                    setError('Error cargando locales: ' + error.message);
                } finally {
                    setCargandoLocales(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!localSeleccionado || !password) {
                    setError('Por favor completa todos los campos');
                    return;
                }

                try {
                    setLoading(true);
                    setError('');
                    
                    const localDoc = await db.collection('locales').doc(localSeleccionado).get();
                    const local = localDoc.data();
                    
                    if (!local || !local.usuarios) {
                        throw new Error('Local no encontrado');
                    }

                    const usuario = Object.values(local.usuarios).find(
                        user => user.contrase√±a === password && user.activo
                    );

                    if (!usuario) {
                        throw new Error('Credenciales incorrectas');
                    }

                    const usuarioData = {
                        localId: localSeleccionado,
                        localNombre: local.nombre,
                        usuarioId: usuario.id,
                        usuario: usuario.usuario,
                        rol: usuario.rol
                    };

                    localStorage.setItem('usuario', JSON.stringify(usuarioData));
                    
                    // Guardar datos de login si est√° marcado recordar
                    if (recordarDatos) {
                        localStorage.setItem('loginData', JSON.stringify({
                            localId: localSeleccionado,
                            password: password,
                            recordar: true
                        }));
                    } else {
                        // Limpiar datos guardados si no se quiere recordar
                        localStorage.removeItem('loginData');
                    }
                    
                    onLoginSuccess(usuarioData);
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const mostrarDialogoContrase√±aGestion = () => {
                // Crear modal EXACTO como LoginActivity.kt l√≠neas 380-432
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                `;
                
                dialogContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center;">
                            üîê Gesti√≥n de Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 8px; font-size: 14px;">
                            Acceso administrativo
                        </p>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Seleccione el usuario y ingrese la contrase√±a para acceder a la gesti√≥n completa de locales:
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 16px; position: relative;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Usuario:
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                id="usuarioInput"
                                placeholder="Seleccione un usuario"
                                readonly
                                style="
                                    width: 100%;
                                    padding: 12px 40px 12px 12px;
                                    border: 2px solid #FFD700;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    box-sizing: border-box;
                                    background: white;
                                    cursor: pointer;
                                "
                            />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #FFD700; font-size: 18px;">
                                ‚ñº
                            </div>
                        </div>
                        <div id="usuariosDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1002; max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Contrase√±a de administraci√≥n:
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="password" 
                                id="passwordInput"
                                placeholder="Ingrese la contrase√±a"
                                style="
                                    width: 100%;
                                    padding: 12px 40px 12px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    box-sizing: border-box;
                                "
                            />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 18px;">
                                üëÅÔ∏è
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; font-size: 14px; color: #666;">
                            <input 
                                type="checkbox" 
                                id="rememberPassword"
                                style="margin-right: 8px; accent-color: #FFD700;"
                            />
                            Recordar contrase√±a en este dispositivo
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button 
                            id="cancelBtn"
                            style="
                                padding: 12px 24px;
                                border: none;
                                background: #FFD700;
                                color: white;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            "
                        >
                            CANCELAR
                        </button>
                        <button 
                            id="accessBtn"
                            style="
                                padding: 12px 24px;
                                border: none;
                                background: #FFD700;
                                color: white;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            "
                        >
                            ACCEDER
                        </button>
                    </div>
                `;
                
                modal.appendChild(dialogContent);
                document.body.appendChild(modal);
                
                // Cargar usuarios disponibles (como en la APK l√≠neas 480-515)
                let closeDropdown; // Declarar fuera del scope
                
                const cargarUsuariosDisponibles = async () => {
                    try {
                        const usuarios = ['Lucas PIARRISTEGUY']; // Usuario maestro por defecto
                        
                        // Cargar supervisores desde Firebase
                        const supervisoresSnapshot = await db.collection('supervisores')
                            .where('activo', '==', true)
                            .get();
                        
                        supervisoresSnapshot.forEach(doc => {
                            const supervisor = doc.data();
                            usuarios.push(supervisor.usuario);
                        });
                        
                        // Configurar dropdown
                        const usuarioInput = dialogContent.querySelector('#usuarioInput');
                        const usuariosDropdown = dialogContent.querySelector('#usuariosDropdown');
                        
                        usuariosDropdown.innerHTML = usuarios.map(usuario => 
                            `<div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                                 onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                 onmouseout="this.style.backgroundColor='white'"
                                 onclick="seleccionarUsuario('${usuario}')">
                                ${usuario}
                             </div>`
                        ).join('');
                        
                        // Mostrar dropdown al hacer click
                        usuarioInput.onclick = (e) => {
                            e.stopPropagation();
                            const isVisible = usuariosDropdown.style.display === 'block';
                            usuariosDropdown.style.display = isVisible ? 'none' : 'block';
                        };
                        
                        // Cerrar dropdown al hacer click fuera
                        closeDropdown = (e) => {
                            if (!dialogContent.contains(e.target)) {
                                usuariosDropdown.style.display = 'none';
                            }
                        };
                        
                        // Agregar listener temporal
                        setTimeout(() => {
                            document.addEventListener('click', closeDropdown);
                        }, 100);
                        
                        // Cargar credenciales guardadas
                        const savedUsuario = localStorage.getItem('usuario_gestion');
                        const savedPassword = localStorage.getItem('contrase√±a_gestion');
                        const rememberCheckbox = dialogContent.querySelector('#rememberPassword');
                        const passwordInput = dialogContent.querySelector('#passwordInput');
                        
                        if (savedUsuario && savedPassword) {
                            usuarioInput.value = savedUsuario;
                            passwordInput.value = savedPassword;
                            rememberCheckbox.checked = true;
                        }
                        
                    } catch (error) {
                        console.error('Error cargando usuarios:', error);
                    }
                };
                
                // Funci√≥n para seleccionar usuario
                window.seleccionarUsuario = (usuario) => {
                    dialogContent.querySelector('#usuarioInput').value = usuario;
                    dialogContent.querySelector('#usuariosDropdown').style.display = 'none';
                };
                
                // Cargar usuarios
                cargarUsuariosDisponibles();
                
                // Enfocar el campo de usuario
                dialogContent.querySelector('#usuarioInput').focus();
                
                // Event listeners
                dialogContent.querySelector('#cancelBtn').onclick = () => {
                    document.body.removeChild(modal);
                    delete window.seleccionarUsuario;
                    // Limpiar listener si existe
                    if (closeDropdown) {
                        document.removeEventListener('click', closeDropdown);
                    }
                };
                
                dialogContent.querySelector('#accessBtn').onclick = async () => {
                    const usuario = dialogContent.querySelector('#usuarioInput').value.trim();
                    const password = dialogContent.querySelector('#passwordInput').value.trim();
                    const remember = dialogContent.querySelector('#rememberPassword').checked;
                    
                    if (!usuario) {
                        alert('Seleccione un usuario');
                        return;
                    }
                    
                    if (!password) {
                        alert('Ingrese la contrase√±a');
                        return;
                    }
                    
                    try {
                        // Verificar credenciales como en la APK l√≠neas 611-700
                        
                        // Primero verificar si es usuario maestro
                        const configDoc = await db.collection('configuracion')
                            .doc('admin')
                            .get();
                        
                        const passwordMaestro = configDoc.data()?.password || 'admin123';
                        
                        if (usuario === 'Lucas PIARRISTEGUY' && password === passwordMaestro) {
                            // Es usuario maestro
                            console.log('üîë CREDENCIALES DE MAESTRO CORRECTAS');
                            
                            // Guardar credenciales si est√° marcado el checkbox
                            if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                                localStorage.setItem('contrase√±a_gestion', password);
                            } else {
                                localStorage.removeItem('usuario_gestion');
                                localStorage.removeItem('contrase√±a_gestion');
                            }
                            
                            // Guardar datos del usuario maestro en localStorage
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'admin123',
                                rol: 'maestro',
                                usuarioId: 'maestro',
                                usuario: 'maestro'
                            }));
                            
                            document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                            
                            // Ir a gesti√≥n de locales
                            window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no es maestro, verificar si es supervisor
                        const supervisoresSnapshot = await db.collection('supervisores')
                            .where('usuario', '==', usuario)
                            .where('contrase√±a', '==', password)
                            .where('activo', '==', true)
                            .get();
                        
                        if (!supervisoresSnapshot.empty) {
                            const supervisorDoc = supervisoresSnapshot.docs[0];
                            const supervisor = supervisorDoc.data();
                            
                            console.log('üîë SUPERVISOR AUTENTICADO:', supervisor.usuario);
                            
                            // Guardar credenciales si est√° marcado el checkbox
                            if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                                localStorage.setItem('contrase√±a_gestion', password);
                            } else {
                                localStorage.removeItem('usuario_gestion');
                                localStorage.removeItem('contrase√±a_gestion');
                            }
                            
                            // Guardar datos del supervisor en localStorage
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'supervisor',
                                rol: 'supervisor',
                                usuarioId: supervisorDoc.id,
                                usuario: supervisor.usuario,
                                localesAsignados: supervisor.localesAsignados || []
                            }));
                            
                            document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                            
                            // Ir a gesti√≥n de locales
                            window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no se encontr√≥ usuario v√°lido
                        alert('Credenciales incorrectas');
                        
                    } catch (error) {
                        console.error('Error verificando credenciales:', error);
                        alert('Error verificando credenciales: ' + error.message);
                    }
                };
            };

            if (cargandoLocales) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando locales...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor: '#E0E0E0'}}>
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="text-center mb-6">
                                <img 
                                    src="logo_sabores_real.png" 
                                    alt="Sabores Express" 
                                    className="mx-auto"
                                    style={{
                                        maxWidth: '200px',
                                        maxHeight: '120px',
                                        objectFit: 'contain'
                                    }}
                                />
                                <div 
                                    className="text-lg font-bold mt-3"
                                    style={{
                                        color: '#FFD700',
                                        textShadow: '1px 1px 2px rgba(0,0,0,0.3)'
                                    }}
                                >
                                    Sabores Express - Product Mix V2 Web
                            </div>
                            </div>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Seleccionar Local
                                </label>
                                <select 
                                    value={localSeleccionado}
                                    onChange={(e) => setLocalSeleccionado(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    required
                                >
                                    <option value="">Selecciona un local</option>
                                    {locales.map(local => (
                                        <option key={local.id} value={local.id}>
                                            {local.nombre}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Contrase√±a
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    placeholder="Ingresa tu contrase√±a"
                                    required
                                />
                            </div>

                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="recordarDatos"
                                    checked={recordarDatos}
                                    onChange={(e) => setRecordarDatos(e.target.checked)}
                                    className="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded"
                                />
                                <label htmlFor="recordarDatos" className="text-sm text-gray-700">
                                    Recordar local y contrase√±a
                                </label>
                            </div>

                            {error && (
                                <div className="text-red-600 text-sm text-center">
                                    {error}
                                </div>
                            )}

                            <button 
                                type="submit"
                                disabled={loading}
                                className="w-full text-black font-bold text-base py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                style={{
                                    backgroundColor: '#FFD700',
                                    height: '56px',
                                    borderRadius: '12px',
                                    border: '1px solid #B8860B'
                                }}
                            >
                                {loading ? 'Verificando...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>

                        {locales.length > 0 && (
                            <button
                                type="button"
                                onClick={() => mostrarDialogoContrase√±aGestion()}
                                className="w-full text-black font-bold text-sm py-3 rounded-lg transition-colors mt-3"
                                style={{
                                    backgroundColor: '#FFD700',
                                    height: '48px',
                                    borderRadius: '12px',
                                    border: '1px solid #B8860B',
                                    fontSize: '14px',
                                    fontWeight: 'bold'
                                }}
                            >
                                GESTIONAR LOCALES
                            </button>
                        )}

                        {/* Enlace de descarga de la app Android */}
                        <div className="mt-6 text-center">
                            <a
                                href="https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                style={{
                                    backgroundColor: '#4CAF50',
                                    border: '1px solid #388E3C',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    textDecoration: 'none'
                                }}
                            >
                                üì± Descargar App Android
                            </a>
                        </div>

                        {/* Bot√≥n de Administraci√≥n */}
                        <div className="mt-4 text-center">
                            <a
                                href="/administracion-se/"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                style={{
                                    backgroundColor: '#2196F3',
                                    border: '1px solid #1976D2',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    textDecoration: 'none'
                                }}
                            >
                                üîß Administraci√≥n
                            </a>
                        </div>
                        </div>
                </div>
            );
        }

        // GestionLocales Component - EXACTO como GestionLocalesActivity.kt
        function GestionLocales({ onVolver, onLoginSuccess }) {
            console.log('üè¢ GestionLocales renderizado con props:', { onVolver: !!onVolver, onLoginSuccess: !!onLoginSuccess });
            
            const [locales, setLocales] = useState([]);
            const [localesFiltrados, setLocalesFiltrados] = useState([]);
            const [supervisores, setSupervisores] = useState([]);
            const [supervisoresFiltrados, setSupervisoresFiltrados] = useState([]);
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState('');
            const [mostrarFormulario, setMostrarFormulario] = useState(false);
            const [mostrarFormularioSupervisor, setMostrarFormularioSupervisor] = useState(false);
            const [pestanaActiva, setPestanaActiva] = useState('locales');
            const [usuarioActual, setUsuarioActual] = useState(null);
            const [esUsuarioMaestro, setEsUsuarioMaestro] = useState(false);
            const [nuevoLocal, setNuevoLocal] = useState({
                nombre: '',
                contrase√±a: ''
            });
            const [nuevoSupervisor, setNuevoSupervisor] = useState({
                nombre: '',
                usuario: '',
                contrase√±a: '',
                localesAsignados: []
            });

            useEffect(() => {
                cargarUsuarioActual();
            }, []);

            useEffect(() => {
                if (usuarioActual) {
                    if (esUsuarioMaestro) {
                        cargarLocales();
                        cargarSupervisores();
                    } else {
                        cargarLocalesAsignados();
                    }
                }
            }, [usuarioActual, esUsuarioMaestro]);

            const cargarUsuarioActual = () => {
                try {
                    const usuarioData = localStorage.getItem('usuario_actual');
                    if (usuarioData) {
                        const usuario = JSON.parse(usuarioData);
                        setUsuarioActual(usuario);
                        setEsUsuarioMaestro(usuario.rol === 'maestro');
                        console.log('Usuario cargado:', usuario.usuario, 'Rol:', usuario.rol, 'EsMaestro:', usuario.rol === 'maestro');
                    }
                } catch (error) {
                    console.error('Error cargando usuario actual:', error);
                }
            };

            const cargarLocales = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    // Cargar TODOS los locales sin filtro
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    console.log('Locales encontrados:', snapshot.size);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        console.log('Local:', doc.id, data);
                        localesData.push({ 
                            id: doc.id, 
                            ...data
                        });
                    });
                    
                    console.log('Locales cargados:', localesData);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales:', error);
                    setError('Error cargando locales: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarLocalesAsignados = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    const localesAsignados = usuarioActual?.localesAsignados || [];
                    
                    if (localesAsignados.length === 0) {
                        setError('No tienes locales asignados');
                        setLocales([]);
                        setLocalesFiltrados([]);
                        return;
                    }
                    
                    // Cargar solo los locales asignados
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (localesAsignados.includes(doc.id)) {
                            localesData.push({ 
                                id: doc.id, 
                                ...data
                            });
                        }
                    });
                    
                    console.log('Locales asignados cargados:', localesData.length);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales asignados:', error);
                    setError('Error cargando locales asignados: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarSupervisores = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    const snapshot = await db.collection('supervisores').get();
                    const supervisoresData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activo) {
                            supervisoresData.push({ 
                                id: doc.id, 
                                ...data
                            });
                        }
                    });
                    
                    console.log('Supervisores cargados:', supervisoresData.length);
                    setSupervisores(supervisoresData);
                    setSupervisoresFiltrados(supervisoresData);
                    
                } catch (error) {
                    console.error('Error cargando supervisores:', error);
                    setError('Error cargando supervisores: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const crearLocal = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    // Verificar si el local ya existe
                    const snapshot = await db.collection('locales')
                        .where('nombre', '==', nuevoLocal.nombre)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El local ' + nuevoLocal.nombre + ' ya existe');
                        return;
                    }
                    
                    // Usar contrase√±a personalizada o generar una autom√°ticamente
                    const contrase√±aFinal = nuevoLocal.contrase√±a || generarContrase√±a();
                    
                    // Crear usuario admin para el nuevo local
                    const usuarioAdmin = {
                        id: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        usuario: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        contrase√±a: contrase√±aFinal,
                        rol: 'admin_local',
                        activo: true
                    };
                    
                    // Crear el local
                    const localData = {
                        nombre: nuevoLocal.nombre,
                        fechaCreacion: new Date().toISOString().split('T')[0],
                        activo: true,
                        usuarios: {
                            [usuarioAdmin.id]: usuarioAdmin
                        }
                    };

                    await db.collection('locales').doc(nuevoLocal.nombre).set(localData);
                    
                    // Limpiar formulario
                    setNuevoLocal({
                        nombre: '',
                        contrase√±a: ''
                    });
                    setMostrarFormulario(false);
                    
                    // Recargar locales seg√∫n el tipo de usuario
                    if (esUsuarioMaestro) {
                        cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    // Mostrar credenciales
                    alert(`üéâ Local creado exitosamente!\n\nüìç Local: ${nuevoLocal.nombre}\nüë§ Usuario: ${usuarioAdmin.usuario}\nüîë Contrase√±a: ${usuarioAdmin.contrase√±a}\n\n‚ö†Ô∏è Guarda estas credenciales para acceder al local`);
                    
                } catch (error) {
                    console.error('Error creando local:', error);
                    setError('Error creando local: ' + error.message);
                }
            };

            const generarContrase√±a = () => {
                const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                return Array.from({length: 8}, () => caracteres[Math.floor(Math.random() * caracteres.length)]).join('');
            };

            const crearSupervisor = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    // Verificar si el supervisor ya existe
                    const snapshot = await db.collection('supervisores')
                        .where('usuario', '==', nuevoSupervisor.usuario)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El usuario ' + nuevoSupervisor.usuario + ' ya existe');
                        return;
                    }
                    
                    // Crear el supervisor
                    const supervisorData = {
                        nombre: nuevoSupervisor.nombre,
                        usuario: nuevoSupervisor.usuario,
                        contrase√±a: nuevoSupervisor.contrase√±a || generarContrase√±a(),
                        localesAsignados: nuevoSupervisor.localesAsignados,
                        activo: true,
                        fechaCreacion: new Date().toISOString().split('T')[0]
                    };

                    await db.collection('supervisores').doc(nuevoSupervisor.usuario).set(supervisorData);
                    
                    // Limpiar formulario
                    setNuevoSupervisor({
                        nombre: '',
                        usuario: '',
                        contrase√±a: '',
                        localesAsignados: []
                    });
                    setMostrarFormularioSupervisor(false);
                    
                    // Recargar supervisores
                    cargarSupervisores();
                    
                    // Mostrar credenciales
                    alert(`üéâ Supervisor creado exitosamente!\n\nüë§ Nombre: ${nuevoSupervisor.nombre}\nüë§ Usuario: ${nuevoSupervisor.usuario}\nüîë Contrase√±a: ${supervisorData.contrase√±a}\n\n‚ö†Ô∏è Guarda estas credenciales para acceder como supervisor`);
                    
                } catch (error) {
                    console.error('Error creando supervisor:', error);
                    setError('Error creando supervisor: ' + error.message);
                }
            };

            const filtrarLocales = (termino) => {
                if (!termino.trim()) {
                    setLocalesFiltrados(locales);
                    return;
                }
                
                const filtrados = locales.filter(local => 
                    local.nombre.toLowerCase().includes(termino.toLowerCase())
                );
                setLocalesFiltrados(filtrados);
            };

            const filtrarSupervisores = (termino) => {
                if (!termino.trim()) {
                    setSupervisoresFiltrados(supervisores);
                    return;
                }
                
                const filtrados = supervisores.filter(supervisor => 
                    supervisor.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                    supervisor.usuario.toLowerCase().includes(termino.toLowerCase())
                );
                setSupervisoresFiltrados(filtrados);
            };

            const eliminarLocal = async (local) => {
                const contrase√±a = prompt('Para eliminar el local, ingresa la contrase√±a del administrador:');
                if (!contrase√±a) return;
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontr√≥ el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contrase√±a
                    if (usuarioAdmin.contrase√±a !== contrase√±a) {
                        alert('‚ùå Contrase√±a incorrecta. No se puede eliminar el local.');
                        return;
                    }
                    
                    // Confirmaci√≥n final
                    if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar permanentemente el local '${local.nombre}'?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                        return;
                    }
                    
                    // Eliminar el local
                    await db.collection('locales').doc(local.nombre).delete();
                    
                    // Recargar locales seg√∫n el tipo de usuario
                    if (esUsuarioMaestro) {
                        cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    alert('‚úÖ Local eliminado exitosamente');
                    
                } catch (error) {
                    console.error('Error eliminando local:', error);
                    alert('Error eliminando local: ' + error.message);
                }
            };

            const cambiarContrase√±a = async (local) => {
                const contrase√±aActual = prompt('Contrase√±a actual:');
                if (!contrase√±aActual) return;
                
                const contrase√±aNueva = prompt('Nueva contrase√±a:');
                if (!contrase√±aNueva) return;
                
                const confirmarContrase√±a = prompt('Confirmar nueva contrase√±a:');
                if (!confirmarContrase√±a) return;
                
                if (contrase√±aNueva !== confirmarContrase√±a) {
                    alert('Las contrase√±as nuevas no coinciden');
                    return;
                }
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontr√≥ el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contrase√±a actual
                    if (usuarioAdmin.contrase√±a !== contrase√±aActual) {
                        alert('‚ùå Contrase√±a actual incorrecta');
                        return;
                    }
                    
                    // Actualizar contrase√±a
                    const usuarioActualizado = { ...usuarioAdmin, contrase√±a: contrase√±aNueva };
                    const usuariosActualizados = { ...local.usuarios };
                    usuariosActualizados[usuarioAdmin.id] = usuarioActualizado;
                    
                    await db.collection('locales').doc(local.nombre).update({
                        usuarios: usuariosActualizados
                    });
                    
                    // Recargar locales
                    cargarLocales();
                    
                    alert('‚úÖ Contrase√±a actualizada exitosamente');
                    
                } catch (error) {
                    console.error('Error cambiando contrase√±a:', error);
                    alert('Error cambiando contrase√±a: ' + error.message);
                }
            };

            const mostrarUsuarios = (local) => {
                const usuarios = Object.values(local.usuarios);
                const mensaje = usuarios.map(usuario => 
                    `üë§ Usuario: ${usuario.usuario}\nüîë Contrase√±a: ${usuario.contrase√±a}\nüìã Rol: ${usuario.rol}`
                ).join('\n\n');
                
                alert(`Usuarios de ${local.nombre}\n\n${mensaje}`);
            };

            // Funciones de gesti√≥n de supervisores - EXACTAS como GestionLocalesActivity.kt
            
            const mostrarLocalesAsignados = (supervisor) => {
                // Los locales asignados est√°n guardados por nombre, no por ID
                const nombresLocales = supervisor.localesAsignados || [];
                
                const mensaje = nombresLocales.length === 0 
                    ? "Este supervisor no tiene locales asignados"
                    : "Locales asignados:\n\n" + nombresLocales.map(nombre => `üè™ ${nombre}`).join('\n');
                
                alert(`Locales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarContrase√±aSupervisor = (supervisor) => {
                const mensaje = `üë§ Usuario: ${supervisor.usuario}\n\nüîë Contrase√±a: ${supervisor.contrase√±a}\n\nüìÖ Creado: ${supervisor.fechaCreacion}`;
                alert(`Credenciales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarDialogoAsignarLocales = async (supervisor) => {
                try {
                    console.log('üîç Supervisor seleccionado:', supervisor);
                    console.log('üîç Locales asignados del supervisor:', supervisor.localesAsignados);
                    
                    // Recargar locales para asegurar datos actualizados
                    await cargarLocales();
                    
                    console.log('üîç Locales cargados:', locales.map(l => ({id: l.id, nombre: l.nombre})));
                    
                    if (locales.length === 0) {
                        alert('‚ùå No hay locales disponibles para asignar\n\nVerifica que existan locales activos en Firebase');
                        return;
                    }
                    
                    const contenido = `Selecciona los locales que quieres asignar a ${supervisor.usuario}:\n\n‚ÑπÔ∏è Los locales pueden estar asignados a m√∫ltiples supervisores simult√°neamente.`;
                    
                    // Crear modal con checkboxes
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    `;
                    
                    const dialogContent = document.createElement('div');
                    dialogContent.style.cssText = `
                        background: white;
                        padding: 24px;
                        border-radius: 12px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                    `;
                    
                    dialogContent.innerHTML = `
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;">
                            Asignar Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            ${contenido}
                        </p>
                        <div id="checkboxesContainer"></div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                            <button id="cancelBtn" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button id="assignBtn" style="padding: 10px 20px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer;">
                                ASIGNAR
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(dialogContent);
                    document.body.appendChild(modal);
                    
                    const checkboxesContainer = dialogContent.querySelector('#checkboxesContainer');
                    const checkboxes = {};
                    
                    locales.forEach(local => {
                        // Verificar si el local est√° asignado a otros supervisores
                        // Usar local.nombre para la comparaci√≥n ya que los locales asignados est√°n guardados por nombre
                        const otrosSupervisores = supervisores.filter(s => 
                            s.id !== supervisor.id && s.localesAsignados?.includes(local.nombre)
                        );
                        
                        const textoLocal = otrosSupervisores.length > 0
                            ? `üè™ ${local.nombre} (üìã Asignado a: ${otrosSupervisores.map(s => s.usuario).join(', ')})`
                            : `üè™ ${local.nombre}`;
                        
                        // Debug: verificar si el local est√° asignado
                        // Comparar por nombre ya que los locales asignados est√°n guardados por nombre
                        const estaAsignado = supervisor.localesAsignados?.includes(local.nombre) || false;
                        console.log(`üîç Local: ${local.nombre} (ID: ${local.id}), Asignado: ${estaAsignado}, LocalesAsignados:`, supervisor.localesAsignados);
                        
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.cssText = 'margin-bottom: 8px;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `local-${local.id}`;
                        checkbox.checked = estaAsignado;
                        checkbox.style.cssText = 'margin-right: 8px;';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `local-${local.id}`;
                        label.textContent = textoLocal;
                        label.style.cssText = 'font-size: 14px; cursor: pointer;';
                        
                        if (otrosSupervisores.length > 0) {
                            label.style.color = '#FF9800';
                        }
                        
                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(label);
                        checkboxesContainer.appendChild(checkboxDiv);
                        
                        checkboxes[local.id] = checkbox;
                    });
                    
                    // Event listeners
                    dialogContent.querySelector('#cancelBtn').onclick = () => {
                        document.body.removeChild(modal);
                    };
                    
                    dialogContent.querySelector('#assignBtn').onclick = async () => {
                        const localesSeleccionados = Object.keys(checkboxes).filter(localId => 
                            checkboxes[localId].checked
                        );
                        
                        await asignarLocalesASupervisor(supervisor, localesSeleccionados);
                        document.body.removeChild(modal);
                    };
                    
                } catch (error) {
                    console.error('Error mostrando di√°logo de asignaci√≥n:', error);
                    alert('Error cargando locales: ' + error.message);
                }
            };
            
            const asignarLocalesASupervisor = async (supervisor, localesAsignados) => {
                try {
                    // Convertir IDs de locales a nombres para guardar
                    const nombresLocalesAsignados = localesAsignados.map(localId => {
                        const local = locales.find(l => l.id === localId);
                        return local ? local.nombre : localId;
                    });
                    
                    console.log('üîç Guardando locales por nombre:', nombresLocalesAsignados);
                    
                    const supervisorActualizado = {
                        ...supervisor,
                        localesAsignados: nombresLocalesAsignados
                    };
                    
                    // Actualizar en Firebase
                    await db.collection('supervisores').doc(supervisor.id).update({
                        localesAsignados: nombresLocalesAsignados
                    });
                    
                    // Actualizar en el estado local
                    setSupervisores(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    setSupervisoresFiltrados(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    
                    alert(`‚úÖ Locales asignados exitosamente a ${supervisor.usuario}`);
                    
                } catch (error) {
                    console.error('Error asignando locales:', error);
                    alert('Error asignando locales: ' + error.message);
                }
            };
            
            const mostrarDialogoEliminarSupervisor = (supervisor) => {
                if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar permanentemente el supervisor '${supervisor.usuario}'?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                    return;
                }
                
                eliminarSupervisor(supervisor);
            };
            
            const eliminarSupervisor = async (supervisor) => {
                try {
                    // Eliminar de Firebase
                    await db.collection('supervisores').doc(supervisor.id).delete();
                    
                    // Actualizar estado local
                    setSupervisores(prev => prev.filter(s => s.id !== supervisor.id));
                    setSupervisoresFiltrados(prev => prev.filter(s => s.id !== supervisor.id));
                    
                    alert(`‚úÖ Supervisor '${supervisor.usuario}' eliminado exitosamente`);
                    
                } catch (error) {
                    console.error('Error eliminando supervisor:', error);
                    alert('Error eliminando supervisor: ' + error.message);
                }
            };

            if (cargando) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando locales...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '8px'}}>
                    {/* Header con bot√≥n volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={onVolver}
                            className="px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '8px',
                                fontSize: '16px'
                            }}
                        >
                            ‚Üê Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Gesti√≥n de Locales</h1>
                        <div></div>
                    </div>

                    {/* Pesta√±as - Solo visible para usuario maestro */}
                    {esUsuarioMaestro && (
                        <div className="flex mb-4">
                            <button
                                onClick={() => setPestanaActiva('locales')}
                                className="flex-1 py-3 font-bold rounded-l-lg transition-colors"
                                style={{
                                    backgroundColor: pestanaActiva === 'locales' ? '#2196F3' : '#90CAF9',
                                    color: pestanaActiva === 'locales' ? 'white' : '#424242'
                                }}
                            >
                                üè™ Locales
                            </button>
                            <button
                                onClick={() => setPestanaActiva('supervisores')}
                                className="flex-1 py-3 font-bold rounded-r-lg transition-colors"
                                style={{
                                    backgroundColor: pestanaActiva === 'supervisores' ? '#2196F3' : '#90CAF9',
                                    color: pestanaActiva === 'supervisores' ? 'white' : '#424242'
                                }}
                            >
                                üë• Supervisores
                            </button>
                        </div>
                    )}

                    {/* Contenido de Locales */}
                    {pestanaActiva === 'locales' && (
                        <>
                            {/* Bot√≥n Agregar Local - Solo visible para usuario maestro */}
                            {esUsuarioMaestro && (
                                <button
                                    onClick={() => setMostrarFormulario(true)}
                                    className="w-full text-white font-bold text-base py-3 rounded-lg mb-4"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        fontSize: '16px'
                                    }}
                                >
                                    ‚ûï AGREGAR NUEVO LOCAL
                                </button>
                            )}

                    {/* Buscador - EXACTO como l√≠neas 55-63 */}
                    <input
                        type="text"
                        placeholder="üîç Buscar locales por nombre, fecha o usuario..."
                        className="w-full p-3 mb-4 rounded-lg"
                        style={{
                            backgroundColor: 'white',
                            border: '1px solid #E0E0E0',
                            fontSize: '14px'
                        }}
                        onChange={(e) => filtrarLocales(e.target.value)}
                    />

                    {/* Lista de Locales - EXACTO como l√≠neas 100-121 */}
                    <div className="space-y-2" style={{minHeight: 'calc(100vh - 200px)'}}>
                        {(localesFiltrados.length > 0 ? localesFiltrados : locales).map((local, index) => {
                            console.log('Renderizando local', index, local);
                            return (
                            <div 
                                key={local.nombre || `local-${index}`} 
                                className="p-3 rounded-lg"
                                style={{
                                    backgroundColor: '#2196F3',
                                    color: 'white'
                                }}
                            >
                                {/* Nombre del local - EXACTO como l√≠neas 137-143 */}
                                <div className="text-lg font-bold mb-2">
                                    üè™ {local.nombre}
                                </div>
                                
                                {/* Fecha de creaci√≥n - EXACTO como l√≠neas 145-151 */}
                                <div className="text-sm mb-1">
                                    Creado: {local.fechaCreacion}
                                </div>
                                
                                {/* Usuarios - EXACTO como l√≠neas 153-159 */}
                                <div className="text-sm mb-3">
                                    Usuarios: {Object.keys(local.usuarios || {}).length}
                                </div>
                                
                                {/* Bot√≥n de acceso directo - EXACTO como l√≠neas 161-177 */}
                                <button
                                    onClick={() => {
                                        // Crear usuario temporal para el local seleccionado
                                        // Usar el ID del documento de Firebase como localId
                                        const localId = local.id || local.nombre; // Fallback al nombre si no hay id
                                        const usuarioTemporal = {
                                            id: 'temp_' + localId,
                                            usuario: 'admin_' + local.nombre.toLowerCase(),
                                            localId: localId, // Usar el ID del documento de Firebase
                                            localNombre: local.nombre,
                                            rol: 'admin_local',
                                            activo: true
                                        };
                                        
                                        // Guardar en localStorage
                                        localStorage.setItem('usuario', JSON.stringify(usuarioTemporal));
                                        
                                        // Navegar al main usando el sistema de React
                                        console.log('üöÄ Ingresando al local:', local.nombre);
                                        console.log('üîë LocalId asignado:', localId);
                                        console.log('üë§ Usuario temporal creado:', usuarioTemporal);
                                        
                                        // Usar la funci√≥n onLoginSuccess pasada como prop
                                        console.log('üîç onLoginSuccess disponible:', !!onLoginSuccess);
                                        console.log('üîç Tipo de onLoginSuccess:', typeof onLoginSuccess);
                                        
                                        if (onLoginSuccess) {
                                            console.log('‚úÖ Llamando onLoginSuccess con:', usuarioTemporal);
                                            onLoginSuccess(usuarioTemporal);
                                        } else {
                                            console.log('‚ùå onLoginSuccess no disponible, usando fallback');
                                            // Fallback: recargar la p√°gina
                                            window.location.href = window.location.origin + window.location.pathname;
                                        }
                                    }}
                                    className="w-full text-white font-bold text-sm py-2 rounded mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0'
                                    }}
                                >
                                    üöÄ Ingresar al Local
                                </button>
                                
                                {/* Botones de administraci√≥n - EXACTO como l√≠neas 179-233 */}
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => mostrarUsuarios(local)}
                                        className="flex-1 text-white font-bold text-xs py-1 rounded"
                                        style={{
                                            backgroundColor: '#FF9800'
                                        }}
                                    >
                                        üë• Usuarios
                                    </button>
                                    
                                    <button
                                        onClick={() => cambiarContrase√±a(local)}
                                        className="flex-1 text-white font-bold text-xs py-1 rounded"
                                        style={{
                                            backgroundColor: '#4CAF50'
                                        }}
                                    >
                                        üîë Cambiar Contrase√±a
                                    </button>
                                    
                                    {/* Solo mostrar bot√≥n Eliminar para usuarios maestro */}
                                    {esUsuarioMaestro && (
                                        <button
                                            onClick={() => eliminarLocal(local)}
                                            className="flex-1 text-white font-bold text-xs py-1 rounded"
                                            style={{
                                                backgroundColor: '#F44336'
                                            }}
                                        >
                                            üóëÔ∏è Eliminar
                                        </button>
                                    )}
                                </div>
                            </div>
                            );
                        })}
                        
                        {locales.length === 0 && (
                            <div className="text-center p-8">
                                <div className="text-lg text-gray-600 mb-4">üìù No hay locales registrados</div>
                                <button
                                    onClick={() => setMostrarFormulario(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Crear Local
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Texto de estado - EXACTO como l√≠neas 94-97 */}
                    <div 
                        className="text-center mt-4 text-sm"
                        style={{color: '#F44336'}}
                    >
                        {error || `${locales.length} locales encontrados (${localesFiltrados.length} filtrados)`}
                    </div>
                    
                    {/* Debug info */}
                    <div className="text-center mt-2 text-xs text-gray-500">
                        Debug: locales={locales.length}, filtrados={localesFiltrados.length}
                    </div>
                        </>
                    )}

                    {/* Contenido de Supervisores */}
                    {pestanaActiva === 'supervisores' && esUsuarioMaestro && (
                        <>
                            {/* Bot√≥n Agregar Supervisor */}
                            <button
                                onClick={() => setMostrarFormularioSupervisor(true)}
                                className="w-full text-white font-bold text-base py-3 rounded-lg mb-4"
                                style={{
                                    backgroundColor: '#4CAF50',
                                    fontSize: '16px'
                                }}
                            >
                                ‚ûï AGREGAR NUEVO SUPERVISOR
                            </button>

                            {/* Buscador de supervisores */}
                            <input
                                type="text"
                                placeholder="üîç Buscar supervisores por nombre o usuario..."
                                className="w-full p-3 mb-4 rounded-lg"
                                style={{
                                    backgroundColor: 'white',
                                    border: '1px solid #E0E0E0',
                                    fontSize: '14px'
                                }}
                                onChange={(e) => filtrarSupervisores(e.target.value)}
                            />

                            {/* Lista de Supervisores */}
                            <div className="space-y-2" style={{minHeight: 'calc(100vh - 200px)'}}>
                                {(supervisoresFiltrados.length > 0 ? supervisoresFiltrados : supervisores).map((supervisor, index) => (
                                    <div 
                                        key={supervisor.id || `supervisor-${index}`} 
                                        className="p-3 rounded-lg"
                                        style={{
                                            backgroundColor: '#9C27B0',
                                            color: 'white'
                                        }}
                                    >
                                        <div className="text-lg font-bold mb-2">
                                            üë§ {supervisor.nombre}
                                        </div>
                                        
                                        <div className="text-sm mb-1">
                                            Usuario: {supervisor.usuario}
                                        </div>
                                        
                                        <div className="text-sm mb-3">
                                            Locales asignados: {supervisor.localesAsignados?.length || 0}
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => mostrarLocalesAsignados(supervisor)}
                                                className="flex-1 text-white font-bold text-xs py-1 rounded"
                                                style={{
                                                    backgroundColor: '#2196F3'
                                                }}
                                            >
                                                üè™ LOCALES
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoAsignarLocales(supervisor)}
                                                className="flex-1 text-white font-bold text-xs py-1 rounded"
                                                style={{
                                                    backgroundColor: '#4CAF50'
                                                }}
                                            >
                                                ‚ûï ASIGNAR
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarContrase√±aSupervisor(supervisor)}
                                                className="flex-1 text-white font-bold text-xs py-1 rounded"
                                                style={{
                                                    backgroundColor: '#FF9800'
                                                }}
                                            >
                                                üîë CONTRASE√ëA
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoEliminarSupervisor(supervisor)}
                                                className="flex-1 text-white font-bold text-xs py-1 rounded"
                                                style={{
                                                    backgroundColor: '#F44336'
                                                }}
                                            >
                                                üóëÔ∏è ELIMINAR
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                
                                {supervisores.length === 0 && (
                                    <div className="text-center p-8">
                                        <div className="text-lg text-gray-600 mb-4">üë• No hay supervisores registrados</div>
                                        <button
                                            onClick={() => setMostrarFormularioSupervisor(true)}
                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear Supervisor
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div 
                                className="text-center mt-4 text-sm"
                                style={{color: '#F44336'}}
                            >
                                {error || `${supervisores.length} supervisores encontrados (${supervisoresFiltrados.length} filtrados)`}
                            </div>
                        </>
                    )}
                                
                    {/* Modal de nuevo local - EXACTO como l√≠neas 251-295 */}
                    {mostrarFormulario && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Local</h3>
                                    <button
                                        onClick={() => setMostrarFormulario(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <form onSubmit={crearLocal} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Nombre del local (ej: WILDE)
                                        </label>
                                        <input
                                            type="text"
                                            value={nuevoLocal.nombre}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Nombre del local (ej: WILDE)"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Contrase√±a del admin (opcional)
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoLocal.contrase√±a}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, contrase√±a: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Contrase√±a del admin (opcional)"
                                        />
                                    </div>
                                    
                                    <div className="text-sm text-gray-600">
                                        Si no ingresas contrase√±a, se generar√° una autom√°ticamente
                                    </div>
                                    
                                    <div className="flex justify-end space-x-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormulario(false)}
                                            className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal de nuevo supervisor */}
                    {mostrarFormularioSupervisor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Supervisor</h3>
                                    <button
                                        onClick={() => setMostrarFormularioSupervisor(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                <form onSubmit={crearSupervisor}>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre completo
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.nombre}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Nombre del supervisor"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Usuario de acceso
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.usuario}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, usuario: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Usuario para login"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Contrase√±a (opcional)
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoSupervisor.contrase√±a}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, contrase√±a: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Contrase√±a (se generar√° autom√°ticamente si se deja vac√≠o)"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Locales asignados
                                        </label>
                                        <div className="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-2">
                                            {locales.map((local) => (
                                                <div key={local.id} className="flex items-center mb-2">
                                                    <input
                                                        type="checkbox"
                                                        id={`local-${local.id}`}
                                                        checked={nuevoSupervisor.localesAsignados.includes(local.id)}
                                                        onChange={(e) => {
                                                            const localesActualizados = e.target.checked
                                                                ? [...nuevoSupervisor.localesAsignados, local.id]
                                                                : nuevoSupervisor.localesAsignados.filter(id => id !== local.id);
                                                            setNuevoSupervisor({...nuevoSupervisor, localesAsignados: localesActualizados});
                                                        }}
                                                        className="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                    />
                                                    <label htmlFor={`local-${local.id}`} className="text-sm">
                                                        {local.nombre}
                                                    </label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {error && (
                                        <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    
                                    <div className="flex justify-end gap-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormularioSupervisor(false)}
                                            className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // CalendarioPersonalizado Component - EXACTO como MainActivity.kt l√≠neas 279-490
        function CalendarioPersonalizado({ fechaSeleccionada, setFechaSeleccionada, onCerrar, fechasCompletas, fechasParciales, cargando }) {
            const [mesActual, setMesActual] = useState(new Date());

            // Funci√≥n para formatear fecha como yyyy-MM-dd
            const formatearFechaCorta = (fecha) => {
                const a√±o = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                const fechaFormateada = `${a√±o}-${mes}-${dia}`;
                console.log(`üìÖ formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Funci√≥n para obtener el primer d√≠a del mes
            const obtenerPrimerDia = (fecha) => {
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                return primerDia;
            };

            // Funci√≥n para obtener el √∫ltimo d√≠a del mes
            const obtenerUltimoDia = (fecha) => {
                return new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
            };

            // Funci√≥n para obtener d√≠as de la semana
            const obtenerDiasSemana = () => {
                return ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            };

            // Funci√≥n para crear el grid del mes - EXACTO como MainActivity.kt l√≠neas 495-730
            const crearGridMes = () => {
                const a√±o = mesActual.getFullYear();
                const mes = mesActual.getMonth();
                const primerDia = obtenerPrimerDia(mesActual);
                const ultimoDia = obtenerUltimoDia(mesActual);
                const diasEnMes = ultimoDia.getDate();
                const primerDiaSemana = primerDia.getDay(); // 0=Domingo, 1=Lunes, etc.

                const dias = [];
                const diasSemana = obtenerDiasSemana();

                // Crear encabezados de d√≠as
                const encabezados = diasSemana.map((dia, index) => (
                    <div key={index} className="text-center text-xs font-bold text-gray-600 p-1">
                        {dia}
                    </div>
                ));

                // Agregar espacios vac√≠os para los d√≠as anteriores al primer d√≠a del mes
                for (let i = 0; i < primerDiaSemana; i++) {
                    dias.push(
                        <div key={`empty-${i}`} className="h-12 flex items-center justify-center">
                        </div>
                    );
                }

                // Agregar los d√≠as del mes
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const fechaString = `${a√±o}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                    const esHoy = fechaString === formatearFechaCorta(new Date());
                    const esFechaSeleccionada = fechaString === formatearFechaCorta(fechaSeleccionada);
                    
                    // Determinar color seg√∫n datos - EXACTO como l√≠neas 576-589
                    let colorFondo, colorTexto, borde;
                    if (fechasCompletas.has(fechaString)) {
                        colorFondo = '#4CAF50'; // Verde
                        colorTexto = '#FFFFFF';
                    } else if (fechasParciales.has(fechaString)) {
                        colorFondo = '#FF9800'; // Naranja
                        colorTexto = '#FFFFFF';
                    } else {
                        colorFondo = '#757575'; // Gris
                        colorTexto = '#FFFFFF';
                    }

                    // Agregar borde rojo para fecha seleccionada o d√≠a actual - EXACTO como l√≠neas 591-620
                    if (esFechaSeleccionada || (esHoy && !fechasCompletas.has(fechaString) && !fechasParciales.has(fechaString))) {
                        borde = '3px solid #F44336';
                    }

                    dias.push(
                        <button
                            key={dia}
                            onClick={() => {
                                const nuevaFecha = new Date(a√±o, mes, dia);
                                setFechaSeleccionada(nuevaFecha);
                                onCerrar();
                            }}
                            className="h-12 w-full flex items-center justify-center text-lg font-bold rounded-lg transition-all hover:opacity-80"
                            style={{
                                backgroundColor: colorFondo,
                                color: colorTexto,
                                border: borde,
                                minHeight: '48px'
                            }}
                        >
                            {dia}
                        </button>
                    );
                }

                return { encabezados, dias };
            };

            // Funci√≥n para cambiar mes - EXACTO como MainActivity.kt l√≠neas 449-463
            const cambiarMes = (offset) => {
                const nuevoMes = new Date(mesActual);
                nuevoMes.setMonth(nuevoMes.getMonth() + offset);
                setMesActual(nuevoMes);
            };

            const { encabezados, dias } = crearGridMes();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                        {/* Header - EXACTO como l√≠neas 310-318 */}
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-black">üìÖ Seleccionar Fecha</h3>
                            <button
                                onClick={onCerrar}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        {/* Leyenda de colores - EXACTO como l√≠neas 320-344 */}
                        <div className="flex justify-center space-x-4 mb-4 text-xs">
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#4CAF50'}}></div>
                                <span>Completo</span>
                            </div>
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#FF9800'}}></div>
                                <span>Parcial</span>
                            </div>
                        </div>

                        {/* Navegaci√≥n de mes - EXACTO como l√≠neas 346-405 */}
                        <div className="flex items-center justify-between mb-4">
                            <button
                                onClick={() => cambiarMes(-1)}
                                className="w-14 h-12 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                ‚óÄ
                            </button>
                            
                            <div className="text-center">
                                <div className="text-lg font-bold text-black">
                                    {mesActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                                </div>
                            </div>
                            
                            <button
                                onClick={() => cambiarMes(1)}
                                className="w-14 h-12 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                ‚ñ∂
                            </button>
                        </div>

                        {/* Grid del calendario - EXACTO como l√≠neas 424-441 */}
                        <div className="grid grid-cols-7 gap-1 mb-4">
                            {encabezados}
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1">
                            {dias}
                        </div>

                        {/* Indicador de carga */}
                        {cargando && (
                            <div className="text-center mt-4">
                                <div className="text-sm text-gray-600">Cargando calendario...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main Component
        function Main({ usuario, onLogout, onVolverGestion }) {
            const [fechaSeleccionada, setFechaSeleccionada] = useState(new Date());
            const [mostrarCalendario, setMostrarCalendario] = useState(false);
            const [cargandoCalendario, setCargandoCalendario] = useState(false);
            const [fechasCompletas, setFechasCompletas] = useState(new Set());
            const [fechasParciales, setFechasParciales] = useState(new Set());
            
            // Estados para controlar colores de botones - EXACTO como MainActivity.kt l√≠neas 66-70
            const [tieneIngreso, setTieneIngreso] = useState(false);
            const [tieneStock, setTieneStock] = useState(false);
            const [ultimoEstadoIngreso, setUltimoEstadoIngreso] = useState(null);
            const [ultimoEstadoStock, setUltimoEstadoStock] = useState(null);

            const formatearFecha = (fecha) => {
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            const formatearFechaCorta = (fecha) => {
                const a√±o = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                const fechaFormateada = `${a√±o}-${mes}-${dia}`;
                console.log(`üìÖ formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Funci√≥n para cargar datos del calendario - EXACTO como MainActivity.kt l√≠neas 232-273
            const cargarDatosCalendario = async () => {
                if (cargandoCalendario) return;
                
                setCargandoCalendario(true);
                
                try {
                    // Obtener todos los registros del local
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Agrupar registros por fecha
                    const registrosPorFecha = {};
                    registros.forEach(registro => {
                        if (!registrosPorFecha[registro.fecha]) {
                            registrosPorFecha[registro.fecha] = [];
                        }
                        registrosPorFecha[registro.fecha].push(registro);
                    });
                    
                    // Analizar fechas - EXACTO como l√≠neas 244-253
                    const fechasCompletasSet = new Set();
                    const fechasParcialesSet = new Set();
                    
                    Object.entries(registrosPorFecha).forEach(([fecha, registrosFecha]) => {
                        const tieneIngreso = registrosFecha.some(registro => registro.tipo === 'Ingreso de Mercader√≠a');
                        const tieneStock = registrosFecha.some(registro => registro.tipo === 'Stock Final');
                        
                        if (tieneIngreso && tieneStock) {
                            fechasCompletasSet.add(fecha);
                        } else if (tieneIngreso || tieneStock) {
                            fechasParcialesSet.add(fecha);
                        }
                    });
                    
                    setFechasCompletas(fechasCompletasSet);
                    setFechasParciales(fechasParcialesSet);
                    
                } catch (error) {
                    console.error('Error cargando datos del calendario:', error);
                } finally {
                    setCargandoCalendario(false);
                }
            };

            // Funci√≥n para mostrar calendario personalizado - EXACTO como MainActivity.kt l√≠neas 223-274
            const mostrarCalendarioPersonalizado = () => {
                if (cargandoCalendario) return;
                
                setMostrarCalendario(true);
                cargarDatosCalendario();
            };

            // Funci√≥n para verificar registros existentes - EXACTO como MainActivity.kt l√≠neas 992-1003
            const verificarRegistrosExistentes = async () => {
                try {
                    console.log('üîç verificarRegistrosExistentes iniciado');
                    console.log('üë§ Usuario actual:', usuario);
                    console.log('üìÖ Fecha seleccionada:', fechaSeleccionada);
                    
                    if (!usuario || !usuario.localId) {
                        console.log('‚ö†Ô∏è No hay usuario o localId, abortando verificaci√≥n');
                        return;
                    }
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    console.log('üìÖ Fecha string:', fechaString);
                    
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .get();
                    
                    console.log('üìä Snapshot size:', snapshot.size);
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log('üìã Registros encontrados:', registros);
                    
                    // Verificar si hay registros de Ingreso de Mercader√≠a - EXACTO como l√≠neas 1254-1256
                    const tieneIngresoData = registros.some(registro => registro.tipo === 'Ingreso de Mercader√≠a');
                    setTieneIngreso(tieneIngresoData);
                    
                    // Verificar si hay registros de Stock Final - EXACTO como l√≠neas 1258-1260
                    const tieneStockData = registros.some(registro => registro.tipo === 'Stock Final');
                    setTieneStock(tieneStockData);
                    
                    console.log(`üìä Fecha ${fechaString}: Ingreso=${tieneIngresoData}, Stock=${tieneStockData}`);
                    
                } catch (error) {
                    console.error('‚ùå Error verificando registros existentes:', error);
                }
            };

            const [pantallaActual, setPantallaActual] = useState('main');

            // Verificar registros cuando cambie la fecha - EXACTO como MainActivity.kt l√≠neas 153-159
            useEffect(() => {
                console.log('üîÑ useEffect ejecutado - usuario:', usuario, 'fechaSeleccionada:', fechaSeleccionada);
                if (usuario && usuario.localId) {
                    console.log('üìä Ejecutando verificarRegistrosExistentes para usuario:', usuario.localId);
                    verificarRegistrosExistentes();
                } else {
                    console.log('‚ö†Ô∏è No se puede verificar registros - usuario o localId faltante');
                }
            }, [fechaSeleccionada, usuario]);


            // Funci√≥n para verificar si es el d√≠a actual - EXACTO como MainActivity.kt l√≠neas 1219-1227
            const esFechaActual = (fecha) => {
                const fechaString = formatearFechaCorta(fecha);
                const fechaActual = formatearFechaCorta(new Date());
                return fechaString === fechaActual;
            };

            // Estados para datos existentes
            const [datosIngreso, setDatosIngreso] = useState({});
            const [datosStock, setDatosStock] = useState({});
            const [cargandoDatos, setCargandoDatos] = useState(false);


            // Funci√≥n para cargar datos existentes - EXACTO como CargaActivity.kt
            const cargarDatosExistentes = async (tipo) => {
                setCargandoDatos(true);
                try {
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .where('tipo', '==', tipo)
                        .get();
                    
                    if (!snapshot.empty) {
                        console.log(`üìä Total registros encontrados: ${snapshot.docs.length}`);
                        
                        // Ordenar por timestamp descendente para obtener el m√°s reciente
                        const docs = snapshot.docs.sort((a, b) => {
                            const timestampA = a.data().timestamp || '';
                            const timestampB = b.data().timestamp || '';
                            return timestampB.localeCompare(timestampA);
                        });
                        
                        const doc = docs[0]; // El m√°s reciente
                        const data = doc.data();
                        console.log(`üìä Datos ${tipo} encontrados (m√°s reciente):`, data);
                        console.log(`üìÖ Timestamp del registro seleccionado:`, data.timestamp);
                        
                        // Convertir productos a objeto para f√°cil acceso
                        const datosProductos = {};
                        if (data.productos && Array.isArray(data.productos)) {
                            data.productos.forEach(producto => {
                                // Extraer nombre del producto (sin c√≥digo)
                                const nombreCompleto = producto.nombre;
                                const partes = nombreCompleto.split(' - ');
                                const nombre = partes.length > 1 ? partes[1] : nombreCompleto;
                                datosProductos[nombre] = producto.cantidad || 0;
                            });
                        }
                        
                        if (tipo === 'Ingreso de Mercader√≠a') {
                            setDatosIngreso(datosProductos);
                            console.log('Datos de ingreso cargados:', datosProductos);
                        } else if (tipo === 'Stock Final') {
                            setDatosStock(datosProductos);
                            console.log('Datos de stock cargados:', datosProductos);
                        }
                        return true; // Hay datos existentes
                    } else {
                        console.log(`üìä No hay datos ${tipo} para la fecha ${fechaString}`);
                        if (tipo === 'Ingreso de Mercader√≠a') {
                            setDatosIngreso({});
                        } else if (tipo === 'Stock Final') {
                            setDatosStock({});
                        }
                        return false; // No hay datos
                    }
                } catch (error) {
                    console.error(`Error cargando datos ${tipo}:`, error);
                    return false;
                } finally {
                    setCargandoDatos(false);
                }
            };


            const navegarA = async (ruta) => {
                console.log(`Navegando a ${ruta}`);
                if (ruta === 'Ingreso de Mercader√≠a') {
                    setPantallaActual('ingreso');
                    await cargarDatosExistentes('Ingreso de Mercader√≠a');
                } else if (ruta === 'Stock Final') {
                    setPantallaActual('stock');
                    await cargarDatosExistentes('Stock Final');
                } else if (ruta === 'Promedio de Ventas') {
                    setPantallaActual('ventas');
                } else {
                    alert(`Funcionalidad de ${ruta} pr√≥ximamente disponible`);
                }
            };

            const volverAlMenu = () => {
                setPantallaActual('main');
            };

            // Funci√≥n para mostrar previsualizaci√≥n - EXACTO como CargaActivity.kt l√≠neas 375-486
            const mostrarPrevisualizacion = () => {
                console.log('üîç Mostrando previsualizaci√≥n...');
                
                // Lista completa de productos como en CargaActivity.kt
                const todosProductos = [
                    'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                    'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni',
                    'BATATA - Batata', 'MEMBRIL - Membrillo',
                    'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                ];
                
                // Crear mensaje de previsualizaci√≥n - EXACTO como APK
                let mensaje = `üìã PREVISUALIZACI√ìN DE ${pantallaActual === 'stock' ? 'STOCK FINAL' : 'INGRESO DE MERCADER√çA'}\n\n`;
                mensaje += `üìÖ Fecha: ${formatearFecha(fechaSeleccionada)}\n`;
                mensaje += `üè™ Local: ${usuario.localNombre}\n\n`;
                
                // Mostrar TODOS los productos con sus cantidades (incluso 0)
                mensaje += `üì¶ PRODUCTOS:\n`;
                let totalUnidades = 0;
                let productosConCantidad = 0;
                
                todosProductos.forEach(producto => {
                    const [codigo, nombre] = producto.split(' - ');
                    
                    // Leer valor actual del input
                    const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                    const cantidad = input ? parseInt(input.value) || 0 : 0;
                    
                    mensaje += `‚Ä¢ ${codigo} - ${nombre}: ${cantidad}\n`;
                    
                    if (cantidad > 0) {
                        productosConCantidad++;
                        totalUnidades += cantidad;
                    }
                });
                
                // Resumen completo
                mensaje += `\nüìä RESUMEN:\n`;
                mensaje += `‚Ä¢ Total productos: ${todosProductos.length}\n`;
                mensaje += `‚Ä¢ Productos con cantidad: ${productosConCantidad}\n`;
                mensaje += `‚Ä¢ Productos sin cantidad: ${todosProductos.length - productosConCantidad}\n`;
                mensaje += `‚Ä¢ Total unidades: ${totalUnidades}\n\n`;
                
                mensaje += `¬øDeseas guardar estos datos?`;
                
                if (confirm(mensaje)) {
                    guardarDatos();
                }
            };

            // Funci√≥n para guardar datos - EXACTO como CargaActivity.kt l√≠neas 487-520
            const guardarDatos = async () => {
                try {
                    console.log('üíæ Guardando datos...');
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    const tipo = pantallaActual === 'stock' ? 'Stock Final' : 'Ingreso de Mercader√≠a';
                    
                    // Leer valores actuales de los inputs
                    const productos = [];
                    const todosProductos = [
                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni',
                        'BATATA - Batata', 'MEMBRIL - Membrillo',
                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                    ];
                    
                    // Leer valores directamente de los inputs del DOM
                    todosProductos.forEach(producto => {
                        const [codigo, nombre] = producto.split(' - ');
                        
                        // Buscar el input correspondiente en el DOM
                        const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                        const cantidad = input ? parseInt(input.value) || 0 : 0;
                        
                        console.log(`üìù ${codigo} - ${nombre}: ${cantidad} (desde input)`);
                        
                        productos.push({
                            codigo,
                            nombre: producto, // Nombre completo con c√≥digo
                            cantidad: cantidad
                        });
                    });
                    
                    // Crear documento para Firebase - MISMO FORMATO QUE APK
                    const documento = {
                        fecha: fechaString,
                        tipo: tipo,
                        productos: productos,
                        timestamp: new Date().toISOString(),
                        usuario: usuario.usuario || 'admin',
                        localId: usuario.localId
                    };
                    
                    console.log('üìÑ Documento a guardar:', documento);
                    
                    // ID descriptivo como la APK: fecha_tipo
                    const idDocumento = `${fechaString}_${tipo.replace(/\s+/g, '_')}`;
                    console.log('üÜî ID del documento:', idDocumento);
                    
                    // Guardar en Firebase con ID descriptivo
                    await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .doc(idDocumento)
                        .set(documento);
                    
                    console.log('‚úÖ Datos guardados exitosamente');
                    alert(`‚úÖ ${tipo} guardado exitosamente para ${fechaString}`);
                    
                    // Actualizar estados de botones
                    if (tipo === 'Ingreso de Mercader√≠a') {
                        setTieneIngreso(true);
                    } else if (tipo === 'Stock Final') {
                        setTieneStock(true);
                    }
                    
                    // Volver al men√∫ principal
                    volverAlMenu();
                    
                } catch (error) {
                    console.error('‚ùå Error guardando datos:', error);
                    alert(`‚ùå Error guardando datos: ${error.message}`);
                }
            };

            // Mostrar pantalla de gesti√≥n de locales si est√° seleccionada
            if (pantallaActual === 'gestion-locales') {
                return <GestionLocales onVolver={volverAlMenu} onLoginSuccess={onLoginSuccess} />;
            }

            // Mostrar pantalla de promedios si est√° seleccionada
            if (pantallaActual === 'ventas') {
                return <PromedioVentas onVolver={volverAlMenu} usuario={usuario} />;
            }

            // Mostrar pantalla de stock si est√° seleccionada
            if (pantallaActual === 'stock') {
            return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con bot√≥n volver */}
                        <div className="flex justify-between items-center mb-4">
                                    <button
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                                    >
                                ‚Üê Volver
                                    </button>
                            <h1 className="text-xl font-bold text-black">Stock Final</h1>
                            <div></div>
                                    </div>

                        {/* Informaci√≥n de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Stock Final
                            </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                                    </div>
                                </div>
                                
                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                Productos en Stock
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ü EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                    </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üçï PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ß PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üç¨ OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Bot√≥n guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base py-3 rounded-lg"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            üëÅÔ∏è Previsualizar y Guardar
                                    </button>
                                </div>
                );
            }

            // Mostrar pantalla de ingreso si est√° seleccionada
            if (pantallaActual === 'ingreso') {
                return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con bot√≥n volver */}
                        <div className="flex justify-between items-center mb-4">
                            <button 
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                            >
                                ‚Üê Volver
                            </button>
                            <h1 className="text-xl font-bold text-black">Ingreso de Mercader√≠a</h1>
                            <div></div>
                            </div>

                        {/* Informaci√≥n de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Ingreso de Mercader√≠a
                                        </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                        </div>
                    </div>

                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                Productos a Ingresar
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ü EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üçï PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ß PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üç¨ OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                            </div>
                        </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                    </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Bot√≥n guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base py-3 rounded-lg"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            üëÅÔ∏è Previsualizar y Guardar
                                    </button>
                                </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '20px'}}>
                    {/* Header con bot√≥n volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={() => {
                                // Detectar si vino de GestionLocales
                                if (usuario.id && usuario.id.startsWith('temp_')) {
                                    // Vino de GestionLocales, volver ah√≠
                                    if (onVolverGestion) {
                                        onVolverGestion();
                                    } else {
                                        // Fallback: ir a login
                                        onLogout();
                                    }
                                } else {
                                    // Vino del login normal, hacer logout
                                    onLogout();
                                }
                            }}
                            className="px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '8px',
                                fontSize: '16px'
                            }}
                        >
                            ‚Üê Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Men√∫ Principal</h1>
                        <div></div>
                            </div>

                    {/* Header del Local */}
                    <div 
                        className="w-full mb-5 text-center text-lg font-bold text-white"
                        style={{
                            backgroundColor: '#FFD700',
                            padding: '16px',
                            borderRadius: '12px'
                        }}
                    >
                        üè™ {usuario.localNombre}
                                        </div>

                    {/* Selector de Fecha */}
                    <div 
                        className="w-full mb-8 flex items-center justify-between"
                        style={{
                            backgroundColor: '#F5F5F5',
                            padding: '16px',
                            borderRadius: '12px'
                        }}
                    >
                        <button 
                            className="text-2xl font-bold text-black px-3 py-3"
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() - 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ‚óÄ
                        </button>
                        
                        <div 
                            className="flex-1 text-center text-lg font-bold text-black cursor-pointer"
                            onClick={mostrarCalendarioPersonalizado}
                        >
                            {fechaSeleccionada.toLocaleDateString('es-ES', { 
                                weekday: 'long', 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: '2-digit' 
                            })}
                                        </div>
                        
                        <button 
                            className="text-2xl font-bold text-black px-3 py-3"
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() + 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ‚ñ∂
                        </button>
                        
                        <svg className="w-6 h-6 text-black ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                    </div>

                    {/* Botones */}
                    <div className="space-y-5">
                        <button
                            onClick={() => navegarA('Ingreso de Mercader√≠a')}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: tieneIngreso ? '#4CAF50' : (esFechaActual(fechaSeleccionada) ? '#FFD700' : '#FF9800'),
                                color: tieneIngreso ? '#FFFFFF' : (esFechaActual(fechaSeleccionada) ? '#000000' : '#FFFFFF'),
                                height: '56px',
                                borderRadius: '12px',
                                border: tieneIngreso ? '1px solid #388E3C' : (esFechaActual(fechaSeleccionada) ? '1px solid #B8860B' : '1px solid #F57C00')
                            }}
                        >
                            {tieneIngreso ? '‚úÖ Ingreso de Mercader√≠a' : 'Ingreso de Mercader√≠a'}
                        </button>

                                    <button
                                        onClick={() => navegarA('Stock Final')}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: tieneStock ? '#4CAF50' : (esFechaActual(fechaSeleccionada) ? '#FFD700' : '#FF9800'),
                                color: tieneStock ? '#FFFFFF' : (esFechaActual(fechaSeleccionada) ? '#000000' : '#FFFFFF'),
                                height: '56px',
                                borderRadius: '12px',
                                border: tieneStock ? '1px solid #388E3C' : (esFechaActual(fechaSeleccionada) ? '1px solid #B8860B' : '1px solid #F57C00')
                            }}
                        >
                            {tieneStock ? '‚úÖ Stock Final' : 'Stock Final'}
                        </button>

                        <button
                            onClick={() => navegarA('Promedio de Ventas')}
                            className="w-full text-black font-bold text-base"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            Promedio de Ventas
                                    </button>
                                </div>

                    {/* Enlace de descarga de la app Android */}
                    <div className="mt-6 text-center">
                        <a
                            href="https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#4CAF50',
                                border: '1px solid #388E3C',
                                borderRadius: '8px',
                                fontSize: '14px',
                                textDecoration: 'none'
                            }}
                        >
                            üì± Descargar App Android
                        </a>
                    </div>

                    {/* Modal del Calendario Personalizado - EXACTO como MainActivity.kt */}
                    {mostrarCalendario && (
                        <CalendarioPersonalizado 
                            fechaSeleccionada={fechaSeleccionada}
                            setFechaSeleccionada={setFechaSeleccionada}
                            onCerrar={() => setMostrarCalendario(false)}
                            fechasCompletas={fechasCompletas}
                            fechasParciales={fechasParciales}
                            cargando={cargandoCalendario}
                        />
                    )}
                                        </div>
            );
        }

        // Componente de Promedio de Ventas - EXACTO como PromedioVentasActivity.kt
        const PromedioVentas = ({ onVolver, usuario }) => {
            const [promedios, setPromedios] = useState({});
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                calcularPromedios();
            }, []);

            const calcularPromedios = async () => {
                try {
                    setCargando(true);
                    console.log('üîç Calculando promedios de ventas...');
                    
                    // Obtener todos los registros del local
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`üìä Registros encontrados: ${registros.length}`);
                    console.log('üìã Registros:', registros);
                    
                    if (registros.length === 0) {
                        setError('No hay datos para calcular promedios');
                        setCargando(false);
                        return;
                    }
                    
                    // Calcular promedios por d√≠a de la semana
                    const promediosCalculados = calcularPromediosPorDia(registros);
                    setPromedios(promediosCalculados);
                    console.log('‚úÖ Promedios calculados:', promediosCalculados);
                    
                } catch (error) {
                    console.error('‚ùå Error calculando promedios:', error);
                    setError('Error calculando promedios: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const calcularPromediosPorDia = (registros) => {
                console.log('üîÑ calcularPromediosPorDia iniciado con registros:', registros.length);
                
                // Orden EXACTO como en la tabla: ['LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB', 'DOM']
                const diasSemana = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
                const promediosPorDia = {};
                
                // Inicializar estructura
                diasSemana.forEach(dia => {
                    promediosPorDia[dia] = {};
                });

                // Agrupar registros por fecha
                const registrosPorFecha = {};
                
                registros.forEach(registro => {
                    const fecha = registro.fecha;
                    if (!registrosPorFecha[fecha]) {
                        registrosPorFecha[fecha] = { ingreso: null, stock: null };
                    }
                    
                    if (registro.tipo === 'Ingreso de Mercader√≠a') {
                        registrosPorFecha[fecha].ingreso = registro;
                    } else if (registro.tipo === 'Stock Final') {
                        registrosPorFecha[fecha].stock = registro;
                    }
                });

                console.log('üìÖ Registros agrupados por fecha:', registrosPorFecha);

                // Ordenar fechas para poder calcular stock del d√≠a anterior
                const fechasOrdenadas = Object.keys(registrosPorFecha).sort();
                console.log('üìÖ Fechas ordenadas:', fechasOrdenadas);

                // Calcular ventas por d√≠a usando la f√≥rmula correcta:
                // Ventas = (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                const ventasPorDia = {};
                
                // Inicializar todos los d√≠as de la semana
                diasSemana.forEach(dia => {
                    ventasPorDia[dia] = [];
                });
                
                for (let i = 1; i < fechasOrdenadas.length; i++) { // Empezar desde el segundo d√≠a
                    const fechaActual = fechasOrdenadas[i];
                    const fechaAnterior = fechasOrdenadas[i - 1];
                    
                    const registrosActual = registrosPorFecha[fechaActual];
                    const registrosAnterior = registrosPorFecha[fechaAnterior];
                    
                    // Solo calcular si tenemos todos los datos necesarios
                    if (registrosActual.ingreso && registrosActual.stock && registrosAnterior.stock) {
                        const diaSemana = obtenerDiaSemana(fechaActual);
                        
                        // Calcular ventas: (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            registrosAnterior.stock,  // Stock Final d√≠a anterior
                            registrosActual.ingreso,  // Ingreso de Mercader√≠a
                            registrosActual.stock     // Stock Final de hoy
                        );
                        
                        console.log(`üí∞ Ventas del ${diaSemana} (${fechaActual}):`, ventasDia);
                        console.log(`   Stock anterior (${fechaAnterior}):`, registrosAnterior.stock);
                        console.log(`   Ingreso (${fechaActual}):`, registrosActual.ingreso);
                        console.log(`   Stock actual (${fechaActual}):`, registrosActual.stock);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                }
                
                // Tambi√©n calcular ventas para d√≠as que no tienen d√≠a anterior (primer d√≠a)
                // En este caso, asumimos que el stock anterior es 0
                fechasOrdenadas.forEach(fecha => {
                    const registrosDia = registrosPorFecha[fecha];
                    const diaSemana = obtenerDiaSemana(fecha);
                    
                    // Solo si no se calcul√≥ ya para este d√≠a
                    if (registrosDia.ingreso && registrosDia.stock && ventasPorDia[diaSemana].length === 0) {
                        // Crear un registro de stock anterior con valores 0
                        const stockAnteriorCero = {
                            productos: registrosDia.stock.productos.map(p => ({ ...p, cantidad: 0 }))
                        };
                        
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            stockAnteriorCero,        // Stock anterior = 0
                            registrosDia.ingreso,     // Ingreso de Mercader√≠a
                            registrosDia.stock        // Stock Final de hoy
                        );
                        
                        console.log(`üí∞ Ventas del ${diaSemana} (${fecha}) - Primer d√≠a:`, ventasDia);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                });

                console.log('üìä Ventas por d√≠a de la semana:', ventasPorDia);
                console.log('üìä Ventas LUNES:', ventasPorDia['LUNES']);
                console.log('üìä Ventas MARTES:', ventasPorDia['MARTES']);
                console.log('üìä Ventas MIERCOLES:', ventasPorDia['MIERCOLES']);
                console.log('üìä Ventas JUEVES:', ventasPorDia['JUEVES']);
                console.log('üìä Ventas VIERNES:', ventasPorDia['VIERNES']);
                console.log('üìä Ventas SABADO:', ventasPorDia['SABADO']);
                console.log('üìä Ventas DOMINGO:', ventasPorDia['DOMINGO']);

                // Calcular promedios para todos los d√≠as de la semana
                diasSemana.forEach(dia => {
                    const ventasDelDia = ventasPorDia[dia];
                    if (ventasDelDia.length > 0) {
                        // Obtener todos los productos √∫nicos de todas las ventas de este d√≠a
                        const todosProductos = new Set();
                        ventasDelDia.forEach(venta => {
                            Object.keys(venta).forEach(producto => todosProductos.add(producto));
                        });
                        
                        // Calcular promedio para cada producto
                        todosProductos.forEach(producto => {
                            // Filtrar solo los d√≠as donde este producto tiene ventas > 0
                            const ventasConDatos = ventasDelDia.map(venta => venta[producto] || 0).filter(v => v > 0);
                            
                            if (ventasConDatos.length > 0) {
                                const suma = ventasConDatos.reduce((acc, venta) => acc + venta, 0);
                                const promedio = suma / ventasConDatos.length;
                                promediosPorDia[dia][producto] = Math.round(promedio); // Redondear a n√∫mero entero
                                
                                // Log espec√≠fico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠a: ${dia}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Total d√≠as en lista: ${ventasDelDia.length}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠as con ventas > 0: ${ventasConDatos.length}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Ventas encontradas: ${ventasConDatos}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Suma: ${suma}, Promedio: ${promedio}, Redondeado: ${Math.round(promedio)}`);
                                }
                            } else {
                                // Si no hay d√≠as con ventas > 0, el promedio es 0
                                promediosPorDia[dia][producto] = 0.0;
                                
                                // Log espec√≠fico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠a: ${dia} - sin ventas registradas, promedio=0.0`);
                                }
                            }
                        });
                        
                            console.log(`üìä Promedios calculados para ${dia}:`, promediosPorDia[dia]);
                            if (dia === 'LUNES') {
                                console.log('üîç LUNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MARTES') {
                                console.log('üîç MARTES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MIERCOLES') {
                                console.log('üîç MIERCOLES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'JUEVES') {
                                console.log('üîç JUEVES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'VIERNES') {
                                console.log('üîç VIERNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'SABADO') {
                                console.log('üîç SABADO - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'DOMINGO') {
                                console.log('üîç DOMINGO - Promedios individuales:', promediosPorDia[dia]);
                            }
                    } else {
                        console.log(`‚ö†Ô∏è No hay datos para ${dia}`);
                    }
                });

                console.log('‚úÖ Promedios finales calculados:', promediosPorDia);
                return promediosPorDia;
            };

            const obtenerDiaSemana = (fecha) => {
                const date = new Date(fecha);
                const diaIndex = date.getDay();
                
                // Mapeo CORREGIDO seg√∫n los datos reales
                // Los datos muestran que:
                // - 2409 es S√ÅBADO (deber√≠a estar en √≠ndice 5)
                // - 1092 es DOMINGO (deber√≠a estar en √≠ndice 6)
                // - 1609 es LUNES (deber√≠a estar en √≠ndice 0)
                const mapeoDias = {
                    0: 'LUNES',    // JavaScript Sunday (0) -> LUNES (√≠ndice 0)
                    1: 'MARTES',   // JavaScript Monday (1) -> MARTES (√≠ndice 1)
                    2: 'MIERCOLES', // JavaScript Tuesday (2) -> MIERCOLES (√≠ndice 2)
                    3: 'JUEVES',   // JavaScript Wednesday (3) -> JUEVES (√≠ndice 3)
                    4: 'VIERNES',  // JavaScript Thursday (4) -> VIERNES (√≠ndice 4)
                    5: 'SABADO',   // JavaScript Friday (5) -> SABADO (√≠ndice 5)
                    6: 'DOMINGO'   // JavaScript Saturday (6) -> DOMINGO (√≠ndice 6)
                };
                
                const diaResultado = mapeoDias[diaIndex];
                console.log(`üóìÔ∏è Fecha: ${fecha}, getDay(): ${diaIndex}, Mapeado a: ${diaResultado}`);
                return diaResultado;
            };

            const calcularVentasConFormulaCorrecta = (stockAnterior, ingresoActual, stockActual) => {
                // F√≥rmula correcta: Ventas = (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                const ventas = {};
                
                if (!stockAnterior.productos || !ingresoActual.productos || !stockActual.productos) {
                    return ventas;
                }
                
                // Crear mapas de productos para f√°cil acceso
                const stockAnteriorMap = {};
                const ingresoMap = {};
                const stockActualMap = {};
                
                stockAnterior.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    stockAnteriorMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                ingresoActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    ingresoMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                stockActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    stockActualMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                // Calcular ventas para cada producto usando la f√≥rmula correcta
                const todosProductos = new Set([
                    ...Object.keys(stockAnteriorMap), 
                    ...Object.keys(ingresoMap), 
                    ...Object.keys(stockActualMap)
                ]);
                
                todosProductos.forEach(producto => {
                    const stockAnt = stockAnteriorMap[producto] || 0;
                    const ingreso = ingresoMap[producto] || 0;
                    const stockAct = stockActualMap[producto] || 0;
                    
                    // F√≥rmula: (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                    const venta = (stockAnt + ingreso) - stockAct;
                    
                    // Log espec√≠fico para CRIOLLITO
                    if (producto.includes('Criollito') || producto.includes('CRIOLLITO')) {
                        console.log(`üîç CRIOLLITO DEBUG - Producto: ${producto}`);
                        console.log(`üîç CRIOLLITO DEBUG - Stock Ant: ${stockAnt}, Ingreso: ${ingreso}, Stock Act: ${stockAct}`);
                        console.log(`üîç CRIOLLITO DEBUG - Venta calculada: ${venta}`);
                        console.log(`üîç CRIOLLITO DEBUG - Stock Anterior Map keys:`, Object.keys(stockAnteriorMap));
                        console.log(`üîç CRIOLLITO DEBUG - Ingreso Map keys:`, Object.keys(ingresoMap));
                        console.log(`üîç CRIOLLITO DEBUG - Stock Actual Map keys:`, Object.keys(stockActualMap));
                    }
                    
                    // Solo incluir si hay venta positiva
                    if (venta > 0) {
                        ventas[producto] = venta;
                    }
                });
                
                return ventas;
            };

            const procesarProductos = (productos) => {
                const ventas = {};
                if (Array.isArray(productos)) {
                    productos.forEach(producto => {
                        const nombreCompleto = producto.nombre;
                        // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                        ventas[nombreCompleto] = producto.cantidad || 0;
                    });
                }
                return ventas;
            };

            const diasSemana = ['LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB', 'DOM'];
            const diasCompletos = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
            
            const productosPorCategoria = {
                'EMPANADAS': [
                    'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                ],
                'PIZZAS': ['MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'],
                'PASTELITOS': ['BATATA - Batata', 'MEMBRIL - Membrillo'],
                'OTROS': ['DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito']
            };

            if (cargando) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">üìä</div>
                            <div className="text-lg font-bold text-black">Calculando promedios...</div>
                                        </div>
                                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">‚ùå</div>
                            <div className="text-lg font-bold text-red-600 mb-4">{error}</div>
                                    <button
                                onClick={onVolver}
                                className="px-4 py-2 bg-blue-500 text-white rounded"
                                    >
                                Volver
                                    </button>
                                </div>
                            </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '8px'}}>
                    {/* Header con bot√≥n volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={onVolver}
                            className="text-2xl font-bold text-black"
                        >
                            ‚Üê Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Promedio de Ventas</h1>
                        <div></div>
                        </div>

                    {/* Tabla de promedios - EXACTO como PromedioVentasActivity.kt */}
                    <div className="bg-white rounded-lg p-4" style={{minHeight: 'calc(100vh - 200px)'}}>
                        {/* Indicador de local - EXACTO como l√≠nea 273-280 */}
                        <div 
                            className="text-center p-2 mb-4"
                            style={{color: '#2196F3', fontSize: '16px', fontWeight: 'bold'}}
                        >
                            LOCAL: {usuario.localNombre}
                                </div>
                        
                        {/* T√≠tulo principal - EXACTO como l√≠nea 284-291 */}
                        <div 
                            className="text-center p-4 mb-4"
                            style={{color: '#4CAF50', fontSize: '24px', fontWeight: 'bold'}}
                        >
                            PROMEDIO DE VENTA POR D√çA
                                </div>
                            
                        {/* Header de la tabla - EXACTO como l√≠nea 305-331 */}
                        <div 
                            className="flex p-2 text-white text-xs font-bold mb-2"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '4px 4px 0 0'
                            }}
                        >
                            <div className="p-1 border-r border-blue-300" style={{flex: '1.2'}}>TIPO</div>
                            {diasSemana.map((dia, index) => (
                                <div 
                                    key={dia} 
                                    className={`p-1 text-center ${index < diasSemana.length - 1 ? 'border-r border-blue-300' : ''}`} 
                                    style={{flex: '0.8'}}
                                >
                                    {dia}
                            </div>
                            ))}
                        </div>

                        {/* Productos por categor√≠a con iconos y separaciones */}
                        {Object.entries(productosPorCategoria).map(([categoria, productos]) => (
                            <div key={categoria}>
                                {/* Header de categor√≠a con icono - EXACTO como Ingreso de Mercader√≠a */}
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2 mt-4"
                                    style={{
                                        backgroundColor: categoria === 'EMPANADAS' ? '#FF6B6B' : 
                                                       categoria === 'PIZZAS' ? '#4CAF50' : 
                                                       categoria === 'PASTELITOS' ? '#FF9800' : '#9C27B0',
                                        borderRadius: '8px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                    }}
                                >
                                    <span className="text-lg">
                                        {categoria === 'EMPANADAS' ? 'ü•ü' : 
                                         categoria === 'PIZZAS' ? 'üçï' : 
                                         categoria === 'PASTELITOS' ? 'ü•ß' : 'üç¨'} {categoria}
                                    </span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        {productos.length} productos
                                    </span>
                    </div>

                                {/* Productos de la categor√≠a */}
                                <div className="mb-4" style={{backgroundColor: '#F8F9FA', borderRadius: '8px', padding: '8px'}}>
                                    {productos.map((producto, index) => {
                                        const nombre = producto.split(' - ')[1] || producto;
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex text-xs mb-1"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '4px',
                                                    margin: '2px'
                                                }}
                                            >
                                                <div 
                                                    className="p-2 text-left text-black border-r border-gray-300" 
                                                    style={{flex: '1.2'}}
                                                >
                                                    {nombre}
                </div>
                                                {diasCompletos.map((diaCompleto, diaIndex) => {
                                                    const valor = promedios[diaCompleto]?.[producto] || 0;
                                                    
                                                    // Log para debug
                                                    if (producto.includes('CRIOLLITO')) {
                                                        console.log(`üîç CRIOLLITO - ${diaCompleto} (√≠ndice ${diaIndex}): ${valor}`);
                                                        console.log(`üîç Promedios disponibles para ${diaCompleto}:`, promedios[diaCompleto]);
                                                    }
                                                    
                                                    return (
                                                        <div 
                                                            key={diaCompleto} 
                                                            className={`p-2 text-center text-black ${diaIndex < diasCompletos.length - 1 ? 'border-r border-gray-300' : ''}`} 
                                                            style={{flex: '0.8'}}
                                                        >
                                                            {valor > 0 ? valor : '-'}
                </div>
            );
                                                })}
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Total de empanadas - EXACTO como l√≠nea 345-388 */}
                                    {categoria === 'EMPANADAS' && (
                                        <div 
                                            className="flex p-2 text-white text-xs font-bold mt-2"
                                            style={{
                                                backgroundColor: '#4CAF50',
                                                border: '1px solid #388E3C',
                                                borderRadius: '4px'
                                            }}
                                        >
                                            <div className="p-2 border-r border-green-300" style={{flex: '1.2'}}>TOTAL</div>
                                            {diasCompletos.map((diaCompleto, index) => {
                                                const totalDia = productos.reduce((acc, producto) => {
                                                    return acc + (promedios[diaCompleto]?.[producto] || 0);
                                                }, 0);
                                                
                                                // Log para debug del total
                                                console.log(`üîç TOTAL ${diaCompleto} (√≠ndice ${index}): ${totalDia}`);
                                                
                                                return (
                                                    <div 
                                                        key={diaCompleto} 
                                                        className={`p-2 text-center ${index < diasCompletos.length - 1 ? 'border-r border-green-300' : ''}`} 
                                                        style={{flex: '0.8'}}
                                                    >
                                                        {totalDia > 0 ? Math.round(totalDia) : '-'}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // App Component
        function App() {
            const [usuario, setUsuario] = useState(null);
            const [loading, setLoading] = useState(true);
            const [vistaActual, setVistaActual] = useState('login');

            useEffect(() => {
                // Verificar si hay usuario guardado
                const usuarioGuardado = localStorage.getItem('usuario');
                if (usuarioGuardado) {
                    setUsuario(JSON.parse(usuarioGuardado));
                    setVistaActual('main');
                }
                setLoading(false);
            }, []);

            // Manejar navegaci√≥n por hash
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash;
                    console.log('üîó Hash cambiado:', hash, 'Usuario:', usuario, 'VistaActual:', vistaActual);
                    
                    // Manejar navegaci√≥n por hash
                    if (hash === '#gestion-locales') {
                        setVistaActual('gestion-locales');
                    } else if (hash === '#main' || (usuario && vistaActual === 'main')) {
                        setVistaActual('main');
                    } else if (!usuario && hash === '') {
                        setVistaActual('login');
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                handleHashChange(); // Ejecutar al cargar

                return () => window.removeEventListener('hashchange', handleHashChange);
            }, [usuario, vistaActual]);

            const handleLoginSuccess = (usuarioData) => {
                console.log('üöÄ handleLoginSuccess llamado con:', usuarioData);
                setUsuario(usuarioData);
                setVistaActual('main');
                // Cambiar hash para evitar conflicto con useEffect
                window.location.hash = '#main';
                console.log('‚úÖ Vista establecida a main, usuario:', usuarioData);
            };

            const handleLogout = () => {
                localStorage.removeItem('usuario');
                setUsuario(null);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            console.log('üéØ App render - usuario:', usuario, 'vistaActual:', vistaActual);

            if (usuario && vistaActual === 'main') {
                console.log('‚úÖ Renderizando Main');
                return <Main 
                    usuario={usuario} 
                    onLogout={handleLogout} 
                    onVolverGestion={() => {
                        console.log('üîÑ Volviendo a Gesti√≥n de Locales');
                        setVistaActual('gestion-locales');
                        window.location.hash = '#gestion-locales';
                    }}
                />;
            }

            if (vistaActual === 'gestion-locales') {
                console.log('‚úÖ Renderizando GestionLocales');
                return <GestionLocales 
                    onVolver={() => {
                        console.log('üîÑ Volviendo al Login');
                        setVistaActual('login');
                        window.location.hash = '';
                    }} 
                    onLoginSuccess={handleLoginSuccess}
                />;
            }

            return <Login onLoginSuccess={handleLoginSuccess} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>