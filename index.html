<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="logo_sabores_real.png">
    <link rel="shortcut icon" type="image/png" href="logo_sabores_real.png">
    <title>Sabores Express - Product Mix V2 Web v4.8</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js?v=4.8"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js?v=4.8"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js?v=4.8"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js?v=4.8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Funciones de zona horaria de Argentina - DEBEN ESTAR ANTES DE REACT -->
    <script>
      // Funci√≥n para obtener fecha/hora en zona horaria de Argentina (UTC-3)
      window.getFechaArgentina = function() {
        const ahora = new Date();
        // Obtener fecha/hora en zona horaria de Argentina usando Intl.DateTimeFormat
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        const partes = formatter.formatToParts(ahora);
        const a√±o = parseInt(partes.find(p => p.type === 'year').value);
        const mes = parseInt(partes.find(p => p.type === 'month').value) - 1; // Mes es 0-indexed
        const dia = parseInt(partes.find(p => p.type === 'day').value);
        const hora = parseInt(partes.find(p => p.type === 'hour').value);
        const minuto = parseInt(partes.find(p => p.type === 'minute').value);
        const segundo = parseInt(partes.find(p => p.type === 'second').value);
        // Crear nueva fecha con los valores de Argentina (en UTC, pero representando la hora de Argentina)
        return new Date(Date.UTC(a√±o, mes, dia, hora, minuto, segundo));
      };

      // Funci√≥n para obtener la fecha actual en formato ISO (YYYY-MM-DD) en zona horaria de Argentina
      window.getFechaActualArgentina = function() {
        const ahora = new Date();
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const partes = formatter.formatToParts(ahora);
        const a√±o = partes.find(p => p.type === 'year').value;
        const mes = partes.find(p => p.type === 'month').value;
        const dia = partes.find(p => p.type === 'day').value;
        return `${a√±o}-${mes}-${dia}`;
      };

      // Funci√≥n para formatear fecha en zona horaria de Argentina
      window.formatearFechaArgentina = function(fecha) {
        if (!fecha) {
          return window.getFechaArgentina();
        }
        // Si ya es una fecha, convertir a zona horaria de Argentina
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Argentina/Buenos_Aires',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        const partes = formatter.formatToParts(fecha);
        const a√±o = parseInt(partes.find(p => p.type === 'year').value);
        const mes = parseInt(partes.find(p => p.type === 'month').value) - 1;
        const dia = parseInt(partes.find(p => p.type === 'day').value);
        const hora = parseInt(partes.find(p => p.type === 'hour').value);
        const minuto = parseInt(partes.find(p => p.type === 'minute').value);
        const segundo = parseInt(partes.find(p => p.type === 'second').value);
        return new Date(Date.UTC(a√±o, mes, dia, hora, minuto, segundo));
      };

      // Funci√≥n para obtener timestamp ISO en zona horaria de Argentina
      window.getTimestampArgentina = function() {
        const fechaArg = window.getFechaArgentina();
        return fechaArg.toISOString();
      };
    </script>
    
    <style>
        /* Responsive layout for Promedio de Ventas */
        .ventas-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .ventas-grid { min-width: 980px; }
        .ventas-name { white-space: nowrap; }
        .ventas-cell { white-space: nowrap; }

        @media (max-width: 1024px) {
            .ventas-grid { min-width: 900px; }
        }

        @media (max-width: 768px) {
            .ventas-grid { min-width: 780px; }
            .ventas-header, .ventas-row { font-size: 12px; }
        }

        @media (max-width: 480px) {
            .ventas-grid { min-width: 720px; }
            .ventas-header, .ventas-row { font-size: 11px; }
            .ventas-name { min-width: 140px; }
            .ventas-cell { min-width: 60px; padding-left: 6px !important; padding-right: 6px !important; }
        }
    </style>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD6dF6jCibROTO-oXBfKUdAjk9q6g6-Mu0",
            authDomain: "inventario-app-multi-local.firebaseapp.com",
            projectId: "inventario-app-multi-local",
            storageBucket: "inventario-app-multi-local.firebasestorage.app",
            messagingSenderId: "623222993471",
            appId: "1:623222993471:web:48bffda68352403f27be8a"
        };

        // Configuraci√≥n de Regiones (fallback si falla la carga del JSON)
        const REGIONES_CONFIG_FALLBACK = [
            {
                id: "region_1",
                nombre: "Regi√≥n 1",
                proyectoFirebaseId: "inventario-app-multi-local",
                maestroNombre: "Lucas PIARRISTEGUY",
                activo: true,
                firebaseConfig: {
                    apiKey: "AIzaSyD6dF6jCibROTO-oXBfKUdAjk9q6g6-Mu0",
                    authDomain: "inventario-app-multi-local.firebaseapp.com",
                    projectId: "inventario-app-multi-local",
                    storageBucket: "inventario-app-multi-local.firebasestorage.app",
                    messagingSenderId: "623222993471",
                    appId: "1:623222993471:web:48bffda68352403f27be8a"
                }
            },
            {
                id: "region_2",
                nombre: "Regi√≥n 2",
                proyectoFirebaseId: "region2-99f04",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION2",
                    authDomain: "region2-99f04.firebaseapp.com",
                    projectId: "region2-99f04",
                    storageBucket: "region2-99f04.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_3",
                nombre: "Regi√≥n 3",
                proyectoFirebaseId: "region3-e704a",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION3",
                    authDomain: "region3-e704a.firebaseapp.com",
                    projectId: "region3-e704a",
                    storageBucket: "region3-e704a.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_4",
                nombre: "Regi√≥n 4",
                proyectoFirebaseId: "region4-30c0d",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION4",
                    authDomain: "region4-30c0d.firebaseapp.com",
                    projectId: "region4-30c0d",
                    storageBucket: "region4-30c0d.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            },
            {
                id: "region_5",
                nombre: "Regi√≥n 5",
                proyectoFirebaseId: "region5-41627",
                maestroNombre: "",
                activo: true,
                firebaseConfig: {
                    apiKey: "TU_API_KEY_REGION5",
                    authDomain: "region5-41627.firebaseapp.com",
                    projectId: "region5-41627",
                    storageBucket: "region5-41627.firebasestorage.app",
                    messagingSenderId: "TU_MESSAGING_SENDER_ID",
                    appId: "TU_APP_ID"
                }
            }
        ];

        // Cache de regiones cargadas
        let REGIONES_CONFIG_CACHE = null;

        // Gestor de Regiones
        const FirebaseRegionManager = {
            currentRegion: null,
            currentApp: null,
            currentDb: null,
            currentAuth: null,

            async cargarRegiones() {
                // Si ya est√°n en cache, retornar cache
                if (REGIONES_CONFIG_CACHE) {
                    return REGIONES_CONFIG_CACHE.filter(function(r) { return r.activo; });
                }

                try {
                    // Intentar cargar desde regiones.json
                    const response = await fetch('regiones.json');
                    if (!response.ok) {
                        throw new Error('No se pudo cargar regiones.json');
                    }
                    const regiones = await response.json();
                    
                    // Validar que sea un array y tenga la estructura correcta
                    if (Array.isArray(regiones) && regiones.length > 0) {
                        REGIONES_CONFIG_CACHE = regiones;
                        console.log('‚úÖ Regiones cargadas desde regiones.json:', regiones.length);
                        return regiones.filter(function(r) { return r.activo; });
                    } else {
                        throw new Error('Formato inv√°lido en regiones.json');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo cargar regiones.json, usando configuraci√≥n por defecto:', error.message);
                    // Usar fallback
                    REGIONES_CONFIG_CACHE = REGIONES_CONFIG_FALLBACK;
                    return REGIONES_CONFIG_FALLBACK.filter(function(r) { return r.activo; });
                }
            },

            async cargarRegionActual() {
                try {
                    const regionData = localStorage.getItem('firebase_region_prefs');
                    if (regionData) {
                        const parsed = JSON.parse(regionData);
                        const regionId = parsed.regionId;
                        
                        // Asegurar que las regiones est√©n cargadas
                        if (!REGIONES_CONFIG_CACHE) {
                            await this.cargarRegiones();
                        }
                        
                        return REGIONES_CONFIG_CACHE.find(function(r) { return r.id === regionId; });
                    }
                } catch (error) {
                    console.error('Error cargando region guardada:', error);
                }
                return null;
            },

            guardarRegionActual(region) {
                try {
                    localStorage.setItem('firebase_region_prefs', JSON.stringify({
                        regionId: region.id,
                        regionJson: region.proyectoFirebaseId
                    }));
                } catch (error) {
                    console.error('Error guardando region:', error);
                }
            },

            initializeFirebase(region) {
                try {
                    console.log('Inicializando Firebase para region:', region.nombre);
                    
                    if (this.currentApp) {
                        try {
                            this.currentApp.delete();
                            console.log('Firebase anterior cerrado');
                        } catch (e) {
                            console.warn('No se pudo cerrar Firebase anterior:', e.message);
                        }
                    }

                    this.currentApp = firebase.initializeApp(region.firebaseConfig, 'firebase_' + region.id);
                    this.currentDb = firebase.firestore(this.currentApp);
                    this.currentAuth = firebase.auth(this.currentApp);
                    this.currentRegion = region;

                    this.guardarRegionActual(region);

                    console.log('Firebase inicializado para region:', region.nombre, 'Proyecto:', region.proyectoFirebaseId);
                    return true;
                } catch (error) {
                    console.error('Error inicializando Firebase:', error);
                    return false;
                }
            },

            getFirestore() {
                if (!this.currentDb) {
                    throw new Error('Firebase no esta inicializado. Selecciona una region primero.');
                }
                return this.currentDb;
            },

            getAuth() {
                if (!this.currentAuth) {
                    throw new Error('Firebase no esta inicializado. Selecciona una region primero.');
                }
                return this.currentAuth;
            },

            getCurrentRegion() {
                return this.currentRegion;
            }
        };

        // Initialize Firebase (mantener funcionamiento actual)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
</head>
<body>
    <div id="root">
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h1>Cargando Inventario App...</h1>
            <p>Conectando con Firebase...</p>
            <!-- v2.2 - Carga TODOS los locales de Firebase, sin cach√© -->
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Login Component
        function Login({ onLoginSuccess }) {
            const [regiones, setRegiones] = useState([]);
            const [regionSeleccionada, setRegionSeleccionada] = useState(null);
            const [nombresMaestros, setNombresMaestros] = useState([]);
            const [locales, setLocales] = useState([]);
            const [localSeleccionado, setLocalSeleccionado] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [cargandoLocales, setCargandoLocales] = useState(true);
            const [cargandoRegiones, setCargandoRegiones] = useState(true);
            const [recordarDatos, setRecordarDatos] = useState(false);

            useEffect(() => {
                // Resetear estados al montar el componente
                setCargandoRegiones(true);
                setCargandoLocales(false);
                setError('');
                setLocales([]);
                setLocalSeleccionado('');
                setPassword('');
                cargarRegiones();
            }, []);

            useEffect(() => {
                if (regionSeleccionada) {
                    console.log('Region seleccionada cambiada, cargando locales para:', regionSeleccionada.nombre);
                    cargarLocales();
                    cargarDatosGuardados();
                } else {
                    console.log('No hay regi√≥n seleccionada, limpiando locales');
                    setLocales([]);
                    setCargandoLocales(false);
                }
            }, [regionSeleccionada]);

            const cargarRegiones = async () => {
                try {
                    setCargandoRegiones(true);
                    setError('');
                    
                    const regionesDisponibles = await FirebaseRegionManager.cargarRegiones();
                    
                    if (!regionesDisponibles || regionesDisponibles.length === 0) {
                        setError('No se encontraron regiones disponibles');
                        setCargandoRegiones(false);
                        return;
                    }
                    
                    setRegiones(regionesDisponibles);

                    const nombres = [];
                    for (let i = 0; i < regionesDisponibles.length; i++) {
                        const region = regionesDisponibles[i];
                        try {
                            const tempApp = firebase.initializeApp(region.firebaseConfig, 'temp_' + region.id);
                            const tempDb = firebase.firestore(tempApp);
                            
                            const configDoc = await tempDb.collection('configuracion')
                                .doc('admin')
                                .get();
                            
                            const nombreMaestro = configDoc.exists 
                                ? (configDoc.data().maestro_nombre || region.maestroNombre || 'Maestro')
                                : (region.maestroNombre || 'Maestro');
                            
                            tempApp.delete();
                            nombres.push({
                                regionId: region.id,
                                nombre: nombreMaestro
                            });
                        } catch (e) {
                            console.warn('No se pudo cargar nombre del maestro para ' + region.nombre + ':', e.message);
                            nombres.push({
                                regionId: region.id,
                                nombre: region.maestroNombre || 'Maestro'
                            });
                        }
                    }
                    
                    setNombresMaestros(nombres);

                    const regionGuardada = await FirebaseRegionManager.cargarRegionActual();
                    const regionInicial = regionGuardada || regionesDisponibles[0];
                    
                    if (regionInicial) {
                        seleccionarRegion(regionInicial).catch(err => {
                            console.error('Error en seleccionarRegion:', err);
                            setCargandoRegiones(false);
                        });
                    } else {
                        setCargandoRegiones(false);
                    }
                } catch (error) {
                    console.error('Error cargando regiones:', error);
                    setError('Error cargando regiones: ' + error.message);
                    setCargandoRegiones(false);
                }
            };

            const seleccionarRegion = async (region) => {
                try {
                    console.log('Cambiando a region:', region.nombre);
                    
                    setLocales([]);
                    setLocalSeleccionado('');
                    setPassword('');
                    
                    const usuarioData = localStorage.getItem('usuario');
                    if (usuarioData) {
                        try {
                            const usuario = JSON.parse(usuarioData);
                            const regionIdUsuario = localStorage.getItem('region_id');
                            if (regionIdUsuario && regionIdUsuario !== region.id) {
                                console.log('Region cambio, limpiando datos del usuario...');
                                localStorage.removeItem('usuario');
                                localStorage.removeItem('loginData');
                            }
                        } catch (e) {
                            console.warn('Error verificando cambio de region:', e);
                        }
                    }
                    
                    const exito = FirebaseRegionManager.initializeFirebase(region);
                    
                    if (exito) {
                        setRegionSeleccionada(region);
                        localStorage.setItem('region_id', region.id);
                        console.log('Region seleccionada:', region.nombre);
                        // Asegurar que se termine de cargar regiones cuando se selecciona una regi√≥n
                        setCargandoRegiones(false);
                    } else {
                        setError('Error inicializando region: ' + region.nombre);
                        setCargandoRegiones(false);
                    }
                } catch (error) {
                    console.error('Error seleccionando region:', error);
                    setError('Error seleccionando region: ' + error.message);
                    setCargandoRegiones(false);
                }
            };

            const cargarDatosGuardados = () => {
                try {
                    const datosGuardados = localStorage.getItem('loginData');
                    if (datosGuardados) {
                        const { localId, password: savedPassword, recordar } = JSON.parse(datosGuardados);
                        if (recordar) {
                            setLocalSeleccionado(localId);
                            setPassword(savedPassword);
                            setRecordarDatos(true);
                        }
                    }
                } catch (error) {
                    console.error('Error cargando datos guardados:', error);
                }
            };

            const cargarLocales = async () => {
                try {
                    if (!regionSeleccionada) {
                        setCargandoLocales(false);
                        return;
                    }
                    
                    setCargandoLocales(true);
                    setError('');
                    
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (firebaseError) {
                        console.error('Error obteniendo Firestore:', firebaseError);
                        setError('Error: Firebase no est√° inicializado. Por favor, selecciona una regi√≥n primero.');
                        setCargandoLocales(false);
                        return;
                    }
                    
                    // Timeout de seguridad para evitar que se quede cargando indefinidamente
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Timeout cargando locales')), 10000);
                    });
                    
                    const snapshotPromise = db.collection('locales').get();
                    const snapshot = await Promise.race([snapshotPromise, timeoutPromise]);
                    
                    const localesData = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Solo incluir locales activos (o todos si activo no est√° definido)
                        if (data.activo !== false) {
                            localesData.push({ 
                                id: doc.id, 
                                nombre: data.nombre || doc.id,
                                activo: data.activo !== undefined ? data.activo : true
                            });
                        }
                    });
                    
                    console.log('Locales cargados para regi√≥n', regionSeleccionada.nombre, ':', localesData.length, localesData);
                    setLocales(localesData);
                } catch (error) {
                    console.error('Error cargando locales:', error);
                    setError('Error cargando locales: ' + error.message);
                    setLocales([]); // Asegurar que locales est√© vac√≠o si hay error
                } finally {
                    setCargandoLocales(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!regionSeleccionada) {
                    setError('Por favor selecciona una region');
                    return;
                }
                if (!localSeleccionado || !password) {
                    setError('Por favor completa todos los campos');
                    return;
                }

                try {
                    setLoading(true);
                    setError('');
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const localDoc = await db.collection('locales').doc(localSeleccionado).get();
                    const local = localDoc.data();
                    
                    if (!local || !local.usuarios) {
                        throw new Error('Local no encontrado');
                    }

                    const usuario = Object.values(local.usuarios).find(
                        user => user.contrase√±a === password && user.activo
                    );

                    if (!usuario) {
                        throw new Error('Credenciales incorrectas');
                    }

                    const usuarioData = {
                        localId: localSeleccionado,
                        localNombre: local.nombre,
                        usuarioId: usuario.id,
                        usuario: usuario.usuario,
                        rol: usuario.rol,
                        regionId: regionSeleccionada.id
                    };

                    localStorage.setItem('usuario', JSON.stringify(usuarioData));
                    localStorage.setItem('region_id', regionSeleccionada.id);
                    
                    // Guardar datos de login si est√° marcado recordar
                    if (recordarDatos) {
                        localStorage.setItem('loginData', JSON.stringify({
                            localId: localSeleccionado,
                            password: password,
                            recordar: true
                        }));
                    } else {
                        // Limpiar datos guardados si no se quiere recordar
                        localStorage.removeItem('loginData');
                    }
                    
                    onLoginSuccess(usuarioData);
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const mostrarDialogoContrase√±aGestion = () => {
                // Crear modal EXACTO como LoginActivity.kt l√≠neas 380-432
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const dialogContent = document.createElement('div');
                dialogContent.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                `;
                
                dialogContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #333; display: flex; align-items: center;">
                            üîê Gesti√≥n de Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 8px; font-size: 14px;">
                            Acceso administrativo
                        </p>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            Seleccione el usuario y ingrese la contrase√±a para acceder a la gesti√≥n completa de locales:
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 16px; position: relative;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Usuario:
                        </label>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                id="usuarioInput"
                                placeholder="Seleccione un usuario"
                                readonly
                                style="
                                    width: 100%;
                                    padding: 12px 40px 12px 12px;
                                    border: 2px solid #FFD700;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    box-sizing: border-box;
                                    background: white;
                                    cursor: pointer;
                                "
                            />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #FFD700; font-size: 18px;">
                                ‚ñº
                            </div>
                        </div>
                        <div id="usuariosDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1002; max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                            Contrase√±a de administraci√≥n:
                        </label>
                        <div style="position: relative;">
                        <input 
                            type="password" 
                            id="passwordInput"
                            placeholder="Ingrese la contrase√±a"
                            style="
                                width: 100%;
                                    padding: 12px 40px 12px 12px;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                font-size: 16px;
                                box-sizing: border-box;
                            "
                        />
                            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 18px;">
                                üëÅÔ∏è
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; font-size: 14px; color: #666;">
                            <input 
                                type="checkbox" 
                                id="rememberPassword"
                                style="margin-right: 8px; accent-color: #FFD700;"
                            />
                            Recordar contrase√±a en este dispositivo
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button 
                            id="cancelBtn"
                            style="
                                padding: 12px 24px;
                                border: none;
                                background: #FFD700;
                                color: white;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            "
                        >
                            CANCELAR
                        </button>
                        <button 
                            id="accessBtn"
                            style="
                                padding: 12px 24px;
                                border: none;
                                background: #FFD700;
                                color: white;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            "
                        >
                            ACCEDER
                        </button>
                    </div>
                `;
                
                modal.appendChild(dialogContent);
                document.body.appendChild(modal);
                
                // Cargar usuarios disponibles (como en la APK l√≠neas 480-515)
                let closeDropdown; // Declarar fuera del scope
                
                const cargarUsuariosDisponibles = async () => {
                    try {
                        const usuarios = [];
                        
                        // Cargar nombre del maestro desde Firebase de la regi√≥n actual
                        let db;
                        try {
                            db = FirebaseRegionManager.getFirestore();
                        } catch (firebaseInitError) {
                            console.error('Firebase no est√° inicializado:', firebaseInitError);
                            usuarios.push('Maestro'); // Fallback
                            db = null;
                        }
                        
                        if (db) {
                            try {
                                const configDoc = await db.collection('configuracion')
                                    .doc('admin')
                                    .get();
                                
                                const nombreMaestro = configDoc.exists 
                                    ? (configDoc.data().maestro_nombre || 'Maestro')
                                    : 'Maestro';
                                
                                usuarios.push(nombreMaestro);
                                
                                // Cargar supervisores desde Firebase
                                const supervisoresSnapshot = await db.collection('supervisores')
                                    .where('activo', '==', true)
                                    .get();
                                
                                supervisoresSnapshot.forEach(doc => {
                                    const supervisor = doc.data();
                                    usuarios.push(supervisor.usuario);
                                });
                            } catch (firebaseError) {
                                console.error('Error cargando desde Firebase:', firebaseError);
                                if (usuarios.length === 0) {
                                    usuarios.push('Maestro'); // Fallback solo si no hay usuarios
                                }
                            }
                        }
                        
                        // Configurar dropdown solo si tenemos elementos
                        const usuarioInput = dialogContent.querySelector('#usuarioInput');
                        const usuariosDropdown = dialogContent.querySelector('#usuariosDropdown');
                        
                        if (usuarioInput && usuariosDropdown) {
                            if (usuarios.length > 0) {
                                usuariosDropdown.innerHTML = usuarios.map(usuario => {
                                    // Escapar comillas simples para evitar problemas
                                    const usuarioEscapado = usuario.replace(/'/g, "\\'");
                                    return `<div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                                         onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                         onmouseout="this.style.backgroundColor='white'"
                                         onclick="seleccionarUsuario('${usuarioEscapado}')">
                                        ${usuario}
                                     </div>`;
                                }).join('');
                            } else {
                                usuariosDropdown.innerHTML = '<div style="padding: 12px;">No hay usuarios disponibles</div>';
                            }
                            
                            // Mostrar dropdown al hacer click
                            usuarioInput.onclick = (e) => {
                                e.stopPropagation();
                                const isVisible = usuariosDropdown.style.display === 'block';
                                usuariosDropdown.style.display = isVisible ? 'none' : 'block';
                            };
                            
                            // Cerrar dropdown al hacer click fuera
                            closeDropdown = (e) => {
                                if (!dialogContent.contains(e.target)) {
                                    usuariosDropdown.style.display = 'none';
                                }
                            };
                            
                            // Agregar listener temporal
                            setTimeout(() => {
                                document.addEventListener('click', closeDropdown);
                            }, 100);
                            
                            // Cargar credenciales guardadas
                            const savedUsuario = localStorage.getItem('usuario_gestion');
                            const savedPassword = localStorage.getItem('contrase√±a_gestion');
                            const rememberCheckbox = dialogContent.querySelector('#rememberPassword');
                            const passwordInput = dialogContent.querySelector('#passwordInput');
                            
                            if (savedUsuario && savedPassword && rememberCheckbox && passwordInput) {
                                usuarioInput.value = savedUsuario;
                                passwordInput.value = savedPassword;
                                rememberCheckbox.checked = true;
                            }
                        }
                
                    } catch (error) {
                        console.error('Error cargando usuarios:', error);
                    }
                };
                
                // Funci√≥n para seleccionar usuario
                window.seleccionarUsuario = (usuario) => {
                    dialogContent.querySelector('#usuarioInput').value = usuario;
                    dialogContent.querySelector('#usuariosDropdown').style.display = 'none';
                };
                
                // Cargar usuarios
                cargarUsuariosDisponibles();
                
                // Enfocar el campo de usuario
                dialogContent.querySelector('#usuarioInput').focus();
                
                // Event listeners
                dialogContent.querySelector('#cancelBtn').onclick = () => {
                    document.body.removeChild(modal);
                    delete window.seleccionarUsuario;
                    // Limpiar listener si existe
                    if (closeDropdown) {
                        document.removeEventListener('click', closeDropdown);
                    }
                };
                
                dialogContent.querySelector('#accessBtn').onclick = async () => {
                    const usuario = dialogContent.querySelector('#usuarioInput').value.trim();
                    const password = dialogContent.querySelector('#passwordInput').value.trim();
                    const remember = dialogContent.querySelector('#rememberPassword').checked;
                    
                    if (!usuario) {
                        alert('Seleccione un usuario');
                        return;
                    }
                    
                    if (!password) {
                        alert('Ingrese la contrase√±a');
                        return;
                    }
                    
                    try {
                        // Verificar credenciales como en la APK l√≠neas 611-700
                        
                        const db = FirebaseRegionManager.getFirestore();
                        // Primero verificar si es usuario maestro
                        const configDoc = await db.collection('configuracion')
                            .doc('admin')
                            .get();
                        
                        const passwordMaestro = configDoc.data()?.password || 'admin123';
                        const nombreMaestro = configDoc.exists 
                            ? (configDoc.data().maestro_nombre || 'Maestro')
                            : 'Maestro';
                        
                        if (usuario === nombreMaestro && password === passwordMaestro) {
                            // Es usuario maestro
                            console.log('üîë CREDENCIALES DE MAESTRO CORRECTAS');
                            
                            // Guardar credenciales si est√° marcado el checkbox
                        if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                            localStorage.setItem('contrase√±a_gestion', password);
                        } else {
                                localStorage.removeItem('usuario_gestion');
                            localStorage.removeItem('contrase√±a_gestion');
                        }
                            
                            // Guardar datos del usuario maestro en localStorage
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'admin123',
                                rol: 'maestro',
                                usuarioId: 'maestro',
                                usuario: 'maestro'
                            }));
                        
                        document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                        
                            // Ir a gesti√≥n de locales
                        window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no es maestro, verificar si es supervisor
                        const supervisoresSnapshot = await db.collection('supervisores')
                            .where('usuario', '==', usuario)
                            .where('contrase√±a', '==', password)
                            .where('activo', '==', true)
                            .get();
                        
                        if (!supervisoresSnapshot.empty) {
                            const supervisorDoc = supervisoresSnapshot.docs[0];
                            const supervisor = supervisorDoc.data();
                            
                            console.log('üîë SUPERVISOR AUTENTICADO:', supervisor.usuario);
                            
                            // Guardar credenciales si est√° marcado el checkbox
                            if (remember) {
                                localStorage.setItem('usuario_gestion', usuario);
                                localStorage.setItem('contrase√±a_gestion', password);
                    } else {
                                localStorage.removeItem('usuario_gestion');
                                localStorage.removeItem('contrase√±a_gestion');
                            }
                            
                            // Guardar datos del supervisor en localStorage
                            localStorage.setItem('usuario_actual', JSON.stringify({
                                metodoLogin: 'supervisor',
                                rol: 'supervisor',
                                usuarioId: supervisorDoc.id,
                                usuario: supervisor.usuario,
                                localesAsignados: supervisor.localesAsignados || []
                            }));
                            
                            document.body.removeChild(modal);
                            delete window.seleccionarUsuario;
                            // Limpiar listener si existe
                            if (closeDropdown) {
                                document.removeEventListener('click', closeDropdown);
                            }
                            
                            // Ir a gesti√≥n de locales
                            window.location.href = '#gestion-locales';
                            return;
                        }
                        
                        // Si no se encontr√≥ usuario v√°lido
                        alert('Credenciales incorrectas');
                        
                    } catch (error) {
                        console.error('Error verificando credenciales:', error);
                        alert('Error verificando credenciales: ' + error.message);
                    }
                };
            };

            if (cargandoRegiones || cargandoLocales) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">{cargandoRegiones ? 'Cargando regiones...' : 'Cargando locales...'}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0'}}>
                    {/* Header Amarillo */}
                    <div style={{
                        backgroundColor: '#FFD700',
                        padding: '12px 16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        gap: '12px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                    }}>
                        <div 
                            className="text-base font-bold"
                            style={{
                                color: '#000000',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis'
                            }}
                        >
                            Sabores Product Mix v2
                        </div>
                        
                        {/* Contenedor Selector de Regi√≥n */}
                        <div style={{flex: 1, minWidth: 0}}>
                            <select
                                className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                style={{maxWidth: '100%'}}
                                value={regionSeleccionada ? regionSeleccionada.id : ''}
                                disabled={cargandoRegiones || regiones.length === 0}
                                onChange={(e) => {
                                    const regionId = e.target.value;
                                    const region = regiones.find(r => r.id === regionId);
                                    if (region) {
                                        seleccionarRegion(region);
                                    }
                                }}
                            >
                                {cargandoRegiones ? (
                                    <option value="">Cargando regiones...</option>
                                ) : regiones.length === 0 ? (
                                    <option value="">No hay regiones disponibles</option>
                                ) : (
                                    <>
                                        <option value="">Selecciona una regi√≥n</option>
                                        {regiones.map((region) => {
                                            const nombreMaestro = nombresMaestros && nombresMaestros.length > 0 
                                                ? nombresMaestros.find(n => n.regionId === region.id)
                                                : null;
                                            return (
                                                <option key={region.id} value={region.id}>
                                                    {nombreMaestro ? nombreMaestro.nombre : (region.maestroNombre || region.nombre)}
                                                </option>
                                            );
                                        })}
                                    </>
                                )}
                            </select>
                        </div>
                    </div>

                    <div className="flex items-center justify-center p-4" style={{minHeight: 'calc(100vh - 64px)'}}>
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="text-center mb-6">
                                <img 
                                    src="logo_sabores_real.png" 
                                    alt="Sabores Express" 
                                    className="mx-auto"
                                    style={{
                                        maxWidth: '200px',
                                        maxHeight: '120px',
                                        objectFit: 'contain'
                                    }}
                                />
                                <div 
                                    className="text-lg font-bold mt-3"
                                    style={{
                                        color: '#FFD700',
                                        textShadow: '1px 1px 2px rgba(0,0,0,0.3)'
                                    }}
                                >
                                    Sabores Express - Product Mix V2 Web
                            </div>
                            </div>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Seleccionar Local
                                </label>
                                <select 
                                    value={localSeleccionado}
                                    onChange={(e) => setLocalSeleccionado(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    required
                                    disabled={cargandoLocales}
                                >
                                    <option value="">
                                        {cargandoLocales ? 'Cargando locales...' : locales.length === 0 ? 'No hay locales disponibles' : 'Selecciona un local'}
                                    </option>
                                    {locales.map(local => (
                                        <option key={local.id} value={local.id}>
                                            {local.nombre}
                                        </option>
                                    ))}
                                </select>
                                {!cargandoLocales && locales.length === 0 && regionSeleccionada && (
                                    <p className="text-sm text-gray-500 mt-1">
                                        No se encontraron locales para esta regi√≥n. Verifica que la regi√≥n tenga locales configurados en Firebase.
                                    </p>
                                )}
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Contrase√±a
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    placeholder="Ingresa tu contrase√±a"
                                    required
                                />
                            </div>

                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="recordarDatos"
                                    checked={recordarDatos}
                                    onChange={(e) => setRecordarDatos(e.target.checked)}
                                    className="mr-2 h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded"
                                />
                                <label htmlFor="recordarDatos" className="text-sm text-gray-700">
                                    Recordar local y contrase√±a
                                </label>
                            </div>

                            {error && (
                                <div className="text-red-600 text-sm text-center">
                                    {error}
                                </div>
                            )}

                            <button 
                                type="submit"
                                disabled={loading}
                                className="w-full text-black font-bold text-base py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                style={{
                                    backgroundColor: '#FFD700',
                                    height: '56px',
                                    borderRadius: '12px',
                                    border: '1px solid #B8860B'
                                }}
                            >
                                {loading ? 'Verificando...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>

                        {locales.length > 0 && (
                            <button
                                type="button"
                                onClick={() => mostrarDialogoContrase√±aGestion()}
                                className="w-full text-black font-bold text-sm py-3 rounded-lg transition-colors mt-3"
                                style={{
                                    backgroundColor: '#FFD700',
                                    height: '48px',
                                    borderRadius: '12px',
                                    border: '1px solid #B8860B',
                                    fontSize: '14px',
                                    fontWeight: 'bold'
                                }}
                            >
                                GESTIONAR LOCALES
                            </button>
                        )}

                        {/* Enlace de descarga de la app Android */}
                        <div className="mt-6 text-center">
                            <a
                                href="https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                style={{
                                    backgroundColor: '#4CAF50',
                                    border: '1px solid #388E3C',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    textDecoration: 'none'
                                }}
                            >
                                üì± Descargar App Android
                            </a>
                        </div>

                        {/* Bot√≥n de Administraci√≥n */}
                        <div className="mt-4 text-center">
                            <a
                                href="https://administracion-se.netlify.app/"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                                style={{
                                    backgroundColor: '#2196F3',
                                    border: '1px solid #1976D2',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    textDecoration: 'none'
                                }}
                            >
                                üîß Ir a Administraci√≥n
                            </a>
                        </div>
                    </div>
                    </div>
                </div>
            );
        }

        // GestionLocales Component - EXACTO como GestionLocalesActivity.kt
        function GestionLocales({ onVolver, onLoginSuccess }) {
            console.log('üè¢ GestionLocales renderizado con props:', { onVolver: !!onVolver, onLoginSuccess: !!onLoginSuccess });
            
            const [locales, setLocales] = useState([]);
            const [localesFiltrados, setLocalesFiltrados] = useState([]);
            const [supervisores, setSupervisores] = useState([]);
            const [supervisoresFiltrados, setSupervisoresFiltrados] = useState([]);
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState('');
            const [mostrarFormulario, setMostrarFormulario] = useState(false);
            const [mostrarFormularioSupervisor, setMostrarFormularioSupervisor] = useState(false);
            const [pestanaActiva, setPestanaActiva] = useState('locales');
            const [usuarioActual, setUsuarioActual] = useState(null);
            const [esUsuarioMaestro, setEsUsuarioMaestro] = useState(false);
            const [nuevoLocal, setNuevoLocal] = useState({
                nombre: '',
                contrase√±a: ''
            });
            const [nuevoSupervisor, setNuevoSupervisor] = useState({
                nombre: '',
                usuario: '',
                contrase√±a: '',
                localesAsignados: []
            });
            
            // Estados para alertas
            const [badgesVencimientos, setBadgesVencimientos] = useState({}); // {localId: {hoy: 0, manana: 0}}
            const [problemasLocales, setProblemasLocales] = useState({}); // {localId: [problemas]}

            useEffect(() => {
                cargarUsuarioActual();
            }, []);

            useEffect(() => {
                if (usuarioActual) {
                    if (esUsuarioMaestro) {
                        cargarLocales();
                        cargarSupervisores();
                    } else {
                        cargarLocalesAsignados();
                    }
                }
            }, [usuarioActual, esUsuarioMaestro]);
            
            // Cargar badges y verificar problemas cuando cambian los locales
            useEffect(() => {
                if (locales.length > 0 && (esUsuarioMaestro || usuarioActual?.localesAsignados)) {
                    cargarBadgesYProblemas();
                }
            }, [locales, esUsuarioMaestro, usuarioActual]);

            const cargarUsuarioActual = () => {
                try {
                    const usuarioData = localStorage.getItem('usuario_actual');
                    if (usuarioData) {
                        const usuario = JSON.parse(usuarioData);
                        setUsuarioActual(usuario);
                        setEsUsuarioMaestro(usuario.rol === 'maestro');
                        console.log('Usuario cargado:', usuario.usuario, 'Rol:', usuario.rol, 'EsMaestro:', usuario.rol === 'maestro');
                    }
                } catch (error) {
                    console.error('Error cargando usuario actual:', error);
                }
            };

            const cargarLocales = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    // Cargar TODOS los locales sin filtro
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    console.log('Locales encontrados:', snapshot.size);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        console.log('Local:', doc.id, data);
                        localesData.push({ 
                            id: doc.id, 
                            ...data
                        });
                    });
                    
                    console.log('Locales cargados:', localesData);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales:', error);
                    setError('Error cargando locales: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarLocalesAsignados = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    const localesAsignados = usuarioActual?.localesAsignados || [];
                    
                    if (localesAsignados.length === 0) {
                        setError('No tienes locales asignados');
                        setLocales([]);
                        setLocalesFiltrados([]);
                        return;
                    }
                    
                    // Cargar solo los locales asignados
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('locales').get();
                    const localesData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (localesAsignados.includes(doc.id)) {
                            localesData.push({ 
                                id: doc.id, 
                                ...data
                            });
                        }
                    });
                    
                    console.log('Locales asignados cargados:', localesData.length);
                    setLocales(localesData);
                    setLocalesFiltrados(localesData);
                    
                } catch (error) {
                    console.error('Error cargando locales asignados:', error);
                    setError('Error cargando locales asignados: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const cargarSupervisores = async () => {
                try {
                    setCargando(true);
                    setError('');
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const snapshot = await db.collection('supervisores').get();
                    const supervisoresData = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activo) {
                            supervisoresData.push({ 
                                id: doc.id, 
                                ...data
                            });
                        }
                    });
                    
                    console.log('Supervisores cargados:', supervisoresData.length);
                    setSupervisores(supervisoresData);
                    setSupervisoresFiltrados(supervisoresData);
                    
                } catch (error) {
                    console.error('Error cargando supervisores:', error);
                    setError('Error cargando supervisores: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const crearLocal = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    const db = FirebaseRegionManager.getFirestore();
                    // Verificar si el local ya existe
                    const snapshot = await db.collection('locales')
                        .where('nombre', '==', nuevoLocal.nombre)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El local ' + nuevoLocal.nombre + ' ya existe');
                        return;
                    }
                    
                    // Usar contrase√±a personalizada o generar una autom√°ticamente
                    const contrase√±aFinal = nuevoLocal.contrase√±a || generarContrase√±a();
                    
                    // Crear usuario admin para el nuevo local
                    const usuarioAdmin = {
                        id: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        usuario: 'admin_' + nuevoLocal.nombre.toLowerCase(),
                        contrase√±a: contrase√±aFinal,
                        rol: 'admin_local',
                        activo: true
                    };
                    
                    // Crear el local
                    const localData = {
                        nombre: nuevoLocal.nombre,
                        fechaCreacion: window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0],
                        activo: true,
                        usuarios: {
                            [usuarioAdmin.id]: usuarioAdmin
                        }
                    };

                    await db.collection('locales').doc(nuevoLocal.nombre).set(localData);
                    
                    // Limpiar formulario
                    setNuevoLocal({
                        nombre: '',
                        contrase√±a: ''
                    });
                    setMostrarFormulario(false);
                    
                    // Recargar locales seg√∫n el tipo de usuario
                    if (esUsuarioMaestro) {
                    cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    // Mostrar credenciales
                    alert(`üéâ Local creado exitosamente!\n\nüìç Local: ${nuevoLocal.nombre}\nüë§ Usuario: ${usuarioAdmin.usuario}\nüîë Contrase√±a: ${usuarioAdmin.contrase√±a}\n\n‚ö†Ô∏è Guarda estas credenciales para acceder al local`);
                    
                } catch (error) {
                    console.error('Error creando local:', error);
                    setError('Error creando local: ' + error.message);
                }
            };

            const generarContrase√±a = () => {
                const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                return Array.from({length: 8}, () => caracteres[Math.floor(Math.random() * caracteres.length)]).join('');
            };

            const crearSupervisor = async (e) => {
                e.preventDefault();
                try {
                    setError('');
                    
                    const db = FirebaseRegionManager.getFirestore();
                    // Verificar si el supervisor ya existe
                    const snapshot = await db.collection('supervisores')
                        .where('usuario', '==', nuevoSupervisor.usuario)
                        .get();
                    
                    if (!snapshot.empty) {
                        setError('El usuario ' + nuevoSupervisor.usuario + ' ya existe');
                        return;
                    }
                    
                    // Crear el supervisor
                    const supervisorData = {
                        nombre: nuevoSupervisor.nombre,
                        usuario: nuevoSupervisor.usuario,
                        contrase√±a: nuevoSupervisor.contrase√±a || generarContrase√±a(),
                        localesAsignados: nuevoSupervisor.localesAsignados,
                        activo: true,
                        fechaCreacion: new Date().toISOString().split('T')[0]
                    };

                    await db.collection('supervisores').doc(nuevoSupervisor.usuario).set(supervisorData);
                    
                    // Limpiar formulario
                    setNuevoSupervisor({
                        nombre: '',
                        usuario: '',
                        contrase√±a: '',
                        localesAsignados: []
                    });
                    setMostrarFormularioSupervisor(false);
                    
                    // Recargar supervisores
                    cargarSupervisores();
                    
                    // Mostrar credenciales
                    alert(`üéâ Supervisor creado exitosamente!\n\nüë§ Nombre: ${nuevoSupervisor.nombre}\nüë§ Usuario: ${nuevoSupervisor.usuario}\nüîë Contrase√±a: ${supervisorData.contrase√±a}\n\n‚ö†Ô∏è Guarda estas credenciales para acceder como supervisor`);
                    
                } catch (error) {
                    console.error('Error creando supervisor:', error);
                    setError('Error creando supervisor: ' + error.message);
                }
            };

            // Funci√≥n para obtener resumen de vencimientos (similar a VencimientoRepository)
            const obtenerResumenVencimientos = async (localId) => {
                try {
                    // Validar que localId no est√© vac√≠o
                    if (!localId || localId.trim() === '') {
                        console.log('‚ö†Ô∏è LocalId vac√≠o, retornando valores por defecto');
                        return { hoy: 0, manana: 0 };
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    console.log('üîç Obteniendo resumen vencimientos para local:', localId, 'fecha hoy:', fechaHoy);
                    
                    // Obtener todos los lotes del local desde la colecci√≥n 'vencimientos_activos' (igual que en la pantalla de stock)
                    const lotesSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('vencimientos_activos')
                        .get();
                    
                    console.log('üì¶ Lotes encontrados (total):', lotesSnapshot.size, 'para local:', localId);
                    
                    let hoy = 0;
                    let manana = 0;
                    
                    lotesSnapshot.forEach(doc => {
                        const lote = doc.data();
                        
                        // Filtrar solo lotes activos (si tienen el campo activo, debe ser true; si no existe, asumimos activo)
                        const esActivo = lote.activo !== false; // Si no existe o es true, est√° activo
                        
                        if (!esActivo) {
                            console.log('‚è≠Ô∏è Lote inactivo ignorado:', lote.productoCodigo);
                            return;
                        }
                        
                        if (lote.fechaVencimiento) {
                            // Parsear fecha de vencimiento (puede venir como string o timestamp)
                            let fechaVenc;
                            if (lote.fechaVencimiento.toDate) {
                                // Es un Timestamp de Firestore
                                fechaVenc = lote.fechaVencimiento.toDate();
                            } else if (typeof lote.fechaVencimiento === 'string') {
                                // Es un string en formato YYYY-MM-DD
                                fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
                            } else {
                                // Intentar parsear como fecha
                                fechaVenc = new Date(lote.fechaVencimiento);
                            }
                            
                            // Validar que la fecha sea v√°lida
                            if (isNaN(fechaVenc.getTime())) {
                                console.log('‚ö†Ô∏è Fecha inv√°lida para lote:', lote.productoCodigo, 'fechaVencimiento:', lote.fechaVencimiento);
                                return;
                            }
                            
                            const fechaHoyDate = new Date(fechaHoy + 'T00:00:00');
                            fechaVenc.setHours(0, 0, 0, 0);
                            fechaHoyDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = fechaVenc - fechaHoyDate;
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            
                            console.log('üìÖ Lote:', lote.productoCodigo || doc.id, 'fechaVenc:', fechaVenc.toISOString().split('T')[0], 'diffDays:', diffDays, 'activo:', esActivo);
                            
                            if (diffDays === 0) {
                                hoy++;
                                console.log('üî¥ Producto vence HOY:', lote.productoCodigo || doc.id, 'cantidad:', lote.cantidad || 0);
                            } else if (diffDays === 1) {
                                manana++;
                                console.log('üü° Producto vence MA√ëANA:', lote.productoCodigo || doc.id, 'cantidad:', lote.cantidad || 0);
                            }
                        } else {
                            console.log('‚ö†Ô∏è Lote sin fechaVencimiento:', lote.productoCodigo || doc.id);
                        }
                    });
                    
                    console.log('‚úÖ Resumen vencimientos para', localId, ':', { hoy, manana });
                    return { hoy, manana };
                } catch (error) {
                    console.error('‚ùå Error obteniendo resumen vencimientos para', localId, ':', error);
                    return { hoy: 0, manana: 0 };
                }
            };
            
            // Cargar badges de vencimientos y verificar problemas en paralelo
            const cargarBadgesYProblemas = async () => {
                const localesParaVerificar = esUsuarioMaestro 
                    ? locales 
                    : locales.filter(l => usuarioActual?.localesAsignados?.includes(l.id));
                
                // Filtrar locales que tienen ID v√°lido (no vac√≠o)
                const localesConIdValido = localesParaVerificar.filter(l => l.id && l.id.trim() !== '');
                
                console.log('üîÑ Cargando badges y problemas para', localesConIdValido.length, 'locales (de', localesParaVerificar.length, 'totales)');
                
                if (localesConIdValido.length === 0) {
                    console.log('‚ö†Ô∏è No hay locales con ID v√°lido para verificar');
                    return;
                }
                
                // Cargar badges y problemas en paralelo solo para locales con ID v√°lido
                const promesas = localesConIdValido.map(async (local) => {
                    const [badge, problemas] = await Promise.all([
                        obtenerResumenVencimientos(local.id),
                        verificarProblemasLocal(local.id, local.nombre)
                    ]);
                    return { localId: local.id, badge, problemas };
                });
                
                const resultados = await Promise.all(promesas);
                
                const nuevosBadges = {};
                const nuevosProblemas = {};
                
                resultados.forEach(({ localId, badge, problemas }) => {
                    nuevosBadges[localId] = badge;
                    console.log('üìä Badge para', localId, ':', badge);
                    if (problemas.length > 0) {
                        nuevosProblemas[localId] = problemas;
                    }
                });
                
                console.log('‚úÖ Badges cargados:', nuevosBadges);
                console.log('‚úÖ Problemas cargados:', nuevosProblemas);
                
                setBadgesVencimientos(nuevosBadges);
                setProblemasLocales(nuevosProblemas);
            };
            
            // Verificar problemas de datos en cero y d√≠as faltantes
            const verificarProblemasLocal = async (localId, nombreLocal) => {
                const problemas = [];
                try {
                    // Validar que localId no est√© vac√≠o
                    if (!localId || localId.trim() === '') {
                        console.log('‚ö†Ô∏è LocalId vac√≠o para verificar problemas, retornando array vac√≠o');
                        return [];
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    // Obtener todos los registros hist√≥ricos
                    const registrosSnapshot = await db.collection('locales')
                        .doc(localId)
                        .collection('registros')
                        .get();
                    
                    const registrosPorFecha = {};
                    
                    registrosSnapshot.forEach(doc => {
                        const registro = doc.data();
                        if (!registrosPorFecha[registro.fecha]) {
                            registrosPorFecha[registro.fecha] = new Set();
                        }
                        registrosPorFecha[registro.fecha].add(registro.tipo);
                        
                        // Verificar datos en cero
                        const todosEnCero = registro.productos?.every(p => p.cantidad === 0) || false;
                        
                        if (registro.tipo === 'Ingreso de Mercader√≠a' && todosEnCero && !registro.noRecibioMercaderia) {
                            const fecha = new Date(registro.fecha);
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][fecha.getDay()];
                            const fechaFormateada = fecha.toLocaleDateString('es-AR');
                            problemas.push(`üì¶ ${diaSemana} ${fechaFormateada}:\n Ingreso de Mercader√≠a\n   ‚ö†Ô∏è Todos los productos en 0`);
                        } else if (registro.tipo === 'Stock Final' && todosEnCero) {
                            const fecha = new Date(registro.fecha);
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][fecha.getDay()];
                            const fechaFormateada = fecha.toLocaleDateString('es-AR');
                            problemas.push(`üìä ${diaSemana} ${fechaFormateada} - Stock Final\n   ‚ö†Ô∏è Todos los productos en 0`);
                        }
                    });
                    
                    // Verificar d√≠as faltantes en los √∫ltimos 7 d√≠as (excluyendo hoy)
                    const fechaHoyDate = new Date(fechaHoy);
                    for (let i = 1; i <= 7; i++) {
                        const fechaCheck = new Date(fechaHoyDate);
                        fechaCheck.setDate(fechaCheck.getDate() - i);
                        const fechaCheckStr = fechaCheck.toISOString().split('T')[0];
                        
                        const tiposExistentes = registrosPorFecha[fechaCheckStr] || new Set();
                        const faltantes = [];
                        
                        if (!tiposExistentes.has('Ingreso de Mercader√≠a')) {
                            faltantes.push('Ingreso de Mercader√≠a');
                        }
                        if (!tiposExistentes.has('Stock Final')) {
                            faltantes.push('Stock Final');
                        }
                        
                        if (faltantes.length > 0) {
                            const diaSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][fechaCheck.getDay()];
                            const fechaFormateada = fechaCheck.toLocaleDateString('es-AR');
                            problemas.push(`üìÖ ${diaSemana} ${fechaFormateada}\n   ‚ö†Ô∏è Faltan: ${faltantes.join(', ')}`);
                        }
                    }
                    
                } catch (error) {
                    console.error('Error verificando problemas:', error);
                }
                
                return problemas;
            };
            
            // Mostrar popup de vencimientos
            const mostrarPopupVencimientos = async (local) => {
                try {
                    // Validar que local.id no est√© vac√≠o
                    if (!local.id || local.id.trim() === '') {
                        alert('‚ö†Ô∏è Este local no tiene un ID v√°lido');
                        return;
                    }
                    
                    const db = FirebaseRegionManager.getFirestore();
                    const fechaHoy = window.getFechaActualArgentina ? window.getFechaActualArgentina() : new Date().toISOString().split('T')[0];
                    
                    // Usar la colecci√≥n 'vencimientos_activos' (igual que en la pantalla de stock)
                    const lotesSnapshot = await db.collection('locales')
                        .doc(local.id)
                        .collection('vencimientos_activos')
                        .get();
                    
                    const lotesHoy = [];
                    lotesSnapshot.forEach(doc => {
                        const lote = doc.data();
                        if (lote.fechaVencimiento) {
                            // Parsear fecha de vencimiento (igual que en obtenerResumenVencimientos)
                            let fechaVenc;
                            if (lote.fechaVencimiento.toDate) {
                                fechaVenc = lote.fechaVencimiento.toDate();
                            } else if (typeof lote.fechaVencimiento === 'string') {
                                fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
                            } else {
                                fechaVenc = new Date(lote.fechaVencimiento);
                            }
                            
                            if (isNaN(fechaVenc.getTime())) {
                                return; // Fecha inv√°lida, saltar
                            }
                            
                            const fechaHoyDate = new Date(fechaHoy + 'T00:00:00');
                            fechaVenc.setHours(0, 0, 0, 0);
                            fechaHoyDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = fechaVenc - fechaHoyDate;
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays === 0) {
                                lotesHoy.push(lote);
                            }
                        }
                    });
                    
                    if (lotesHoy.length === 0) {
                        alert('No hay productos que venzan hoy');
                        return;
                    }
                    
                    // Agrupar por producto
                    const lotesPorProducto = {};
                    lotesHoy.forEach(lote => {
                        if (!lotesPorProducto[lote.productoCodigo]) {
                            lotesPorProducto[lote.productoCodigo] = [];
                        }
                        lotesPorProducto[lote.productoCodigo].push(lote);
                    });
                    
                    let mensaje = 'üî¥ Productos que vencen HOY:\n\n';
                    Object.keys(lotesPorProducto).forEach(codigo => {
                        const total = lotesPorProducto[codigo].reduce((sum, l) => sum + (l.cantidad || 0), 0);
                        mensaje += `${codigo}: ${total} unidades\n`;
                    });
                    
                    alert(mensaje);
                } catch (error) {
                    console.error('Error mostrando popup vencimientos:', error);
                    alert('Error cargando vencimientos: ' + error.message);
                }
            };
            
            // Mostrar popup de problemas
            const mostrarPopupProblemas = (nombreLocal, problemas) => {
                const mensaje = `‚ö†Ô∏è Problemas encontrados en ${nombreLocal}:\n\n${problemas.join('\n\n')}`;
                alert(mensaje);
            };
            
            const filtrarLocales = (termino) => {
                if (!termino.trim()) {
                    setLocalesFiltrados(locales);
                    return;
                }
                
                const filtrados = locales.filter(local => 
                    local.nombre.toLowerCase().includes(termino.toLowerCase())
                );
                setLocalesFiltrados(filtrados);
            };

            const filtrarSupervisores = (termino) => {
                if (!termino.trim()) {
                    setSupervisoresFiltrados(supervisores);
                    return;
                }
                
                const filtrados = supervisores.filter(supervisor => 
                    supervisor.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                    supervisor.usuario.toLowerCase().includes(termino.toLowerCase())
                );
                setSupervisoresFiltrados(filtrados);
            };

            const eliminarLocal = async (local) => {
                const contrase√±a = prompt('Para eliminar el local, ingresa la contrase√±a del administrador:');
                if (!contrase√±a) return;
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontr√≥ el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contrase√±a
                    if (usuarioAdmin.contrase√±a !== contrase√±a) {
                        alert('‚ùå Contrase√±a incorrecta. No se puede eliminar el local.');
                        return;
                    }
                    
                    // Confirmaci√≥n final
                    if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar permanentemente el local '${local.nombre}'?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                        return;
                    }
                    
                    // Eliminar el local
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('locales').doc(local.nombre).delete();
                    
                    // Recargar locales seg√∫n el tipo de usuario
                    if (esUsuarioMaestro) {
                    cargarLocales();
                    } else {
                        cargarLocalesAsignados();
                    }
                    
                    alert('‚úÖ Local eliminado exitosamente');
                    
                } catch (error) {
                    console.error('Error eliminando local:', error);
                    alert('Error eliminando local: ' + error.message);
                }
            };

            const cambiarContrase√±a = async (local) => {
                const contrase√±aActual = prompt('Contrase√±a actual:');
                if (!contrase√±aActual) return;
                
                const contrase√±aNueva = prompt('Nueva contrase√±a:');
                if (!contrase√±aNueva) return;
                
                const confirmarContrase√±a = prompt('Confirmar nueva contrase√±a:');
                if (!confirmarContrase√±a) return;
                
                if (contrase√±aNueva !== confirmarContrase√±a) {
                    alert('Las contrase√±as nuevas no coinciden');
                    return;
                }
                
                try {
                    // Buscar el usuario administrador del local
                    const usuarioAdmin = Object.values(local.usuarios).find(u => u.rol === 'admin_local');
                    if (!usuarioAdmin) {
                        alert('No se encontr√≥ el usuario administrador del local');
                        return;
                    }
                    
                    // Verificar contrase√±a actual
                    if (usuarioAdmin.contrase√±a !== contrase√±aActual) {
                        alert('‚ùå Contrase√±a actual incorrecta');
                        return;
                    }
                    
                    // Actualizar contrase√±a
                    const db = FirebaseRegionManager.getFirestore();
                    const usuarioActualizado = { ...usuarioAdmin, contrase√±a: contrase√±aNueva };
                    const usuariosActualizados = { ...local.usuarios };
                    usuariosActualizados[usuarioAdmin.id] = usuarioActualizado;
                    
                    await db.collection('locales').doc(local.nombre).update({
                        usuarios: usuariosActualizados
                    });
                    
                    // Recargar locales
                    cargarLocales();
                    
                    alert('‚úÖ Contrase√±a actualizada exitosamente');
                    
                } catch (error) {
                    console.error('Error cambiando contrase√±a:', error);
                    alert('Error cambiando contrase√±a: ' + error.message);
                }
            };

            const mostrarUsuarios = (local) => {
                const usuarios = Object.values(local.usuarios);
                const mensaje = usuarios.map(usuario => 
                    `üë§ Usuario: ${usuario.usuario}\nüîë Contrase√±a: ${usuario.contrase√±a}\nüìã Rol: ${usuario.rol}`
                ).join('\n\n');
                
                alert(`Usuarios de ${local.nombre}\n\n${mensaje}`);
            };

            // Funciones de gesti√≥n de supervisores - EXACTAS como GestionLocalesActivity.kt
            
            const mostrarLocalesAsignados = (supervisor) => {
                // Los locales asignados est√°n guardados por nombre, no por ID
                const nombresLocales = supervisor.localesAsignados || [];
                
                const mensaje = nombresLocales.length === 0 
                    ? "Este supervisor no tiene locales asignados"
                    : "Locales asignados:\n\n" + nombresLocales.map(nombre => `üè™ ${nombre}`).join('\n');
                
                alert(`Locales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarContrase√±aSupervisor = (supervisor) => {
                const mensaje = `üë§ Usuario: ${supervisor.usuario}\n\nüîë Contrase√±a: ${supervisor.contrase√±a}\n\nüìÖ Creado: ${supervisor.fechaCreacion}`;
                alert(`Credenciales de ${supervisor.usuario}\n\n${mensaje}`);
            };
            
            const mostrarDialogoAsignarLocales = async (supervisor) => {
                try {
                    console.log('üîç Supervisor seleccionado:', supervisor);
                    console.log('üîç Locales asignados del supervisor:', supervisor.localesAsignados);
                    
                    // Recargar locales para asegurar datos actualizados
                    await cargarLocales();
                    
                    console.log('üîç Locales cargados:', locales.map(l => ({id: l.id, nombre: l.nombre})));
                    
                    if (locales.length === 0) {
                        alert('‚ùå No hay locales disponibles para asignar\n\nVerifica que existan locales activos en Firebase');
                    return;
                }
                
                    const contenido = `Selecciona los locales que quieres asignar a ${supervisor.usuario}:\n\n‚ÑπÔ∏è Los locales pueden estar asignados a m√∫ltiples supervisores simult√°neamente.`;
                    
                    // Crear modal con checkboxes
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    `;
                    
                    const dialogContent = document.createElement('div');
                    dialogContent.style.cssText = `
                        background: white;
                        padding: 24px;
                        border-radius: 12px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                    `;
                    
                    dialogContent.innerHTML = `
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;">
                            Asignar Locales
                        </h3>
                        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                            ${contenido}
                        </p>
                        <div id="checkboxesContainer"></div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                            <button id="cancelBtn" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button id="assignBtn" style="padding: 10px 20px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer;">
                                ASIGNAR
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(dialogContent);
                    document.body.appendChild(modal);
                    
                    const checkboxesContainer = dialogContent.querySelector('#checkboxesContainer');
                    const checkboxes = {};
                    
                    locales.forEach(local => {
                        // Verificar si el local est√° asignado a otros supervisores
                        // Usar local.nombre para la comparaci√≥n ya que los locales asignados est√°n guardados por nombre
                        const otrosSupervisores = supervisores.filter(s => 
                            s.id !== supervisor.id && s.localesAsignados?.includes(local.nombre)
                        );
                        
                        const textoLocal = otrosSupervisores.length > 0
                            ? `üè™ ${local.nombre} (üìã Asignado a: ${otrosSupervisores.map(s => s.usuario).join(', ')})`
                            : `üè™ ${local.nombre}`;
                        
                        // Debug: verificar si el local est√° asignado
                        // Comparar por nombre ya que los locales asignados est√°n guardados por nombre
                        const estaAsignado = supervisor.localesAsignados?.includes(local.nombre) || false;
                        console.log(`üîç Local: ${local.nombre} (ID: ${local.id}), Asignado: ${estaAsignado}, LocalesAsignados:`, supervisor.localesAsignados);
                        
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.cssText = 'margin-bottom: 8px;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `local-${local.id}`;
                        checkbox.checked = estaAsignado;
                        checkbox.style.cssText = 'margin-right: 8px;';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `local-${local.id}`;
                        label.textContent = textoLocal;
                        label.style.cssText = 'font-size: 14px; cursor: pointer;';
                        
                        if (otrosSupervisores.length > 0) {
                            label.style.color = '#FF9800';
                        }
                        
                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(label);
                        checkboxesContainer.appendChild(checkboxDiv);
                        
                        checkboxes[local.id] = checkbox;
                    });
                    
                    // Event listeners
                    dialogContent.querySelector('#cancelBtn').onclick = () => {
                        document.body.removeChild(modal);
                    };
                    
                    dialogContent.querySelector('#assignBtn').onclick = async () => {
                        const localesSeleccionados = Object.keys(checkboxes).filter(localId => 
                            checkboxes[localId].checked
                        );
                        
                        await asignarLocalesASupervisor(supervisor, localesSeleccionados);
                        document.body.removeChild(modal);
                    };
                    
                } catch (error) {
                    console.error('Error mostrando di√°logo de asignaci√≥n:', error);
                    alert('Error cargando locales: ' + error.message);
                }
            };
            
            const asignarLocalesASupervisor = async (supervisor, localesAsignados) => {
                try {
                    // Convertir IDs de locales a nombres para guardar
                    const nombresLocalesAsignados = localesAsignados.map(localId => {
                        const local = locales.find(l => l.id === localId);
                        return local ? local.nombre : localId;
                    });
                    
                    console.log('üîç Guardando locales por nombre:', nombresLocalesAsignados);
                    
                    const supervisorActualizado = {
                        ...supervisor,
                        localesAsignados: nombresLocalesAsignados
                    };
                    
                    // Actualizar en Firebase
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('supervisores').doc(supervisor.id).update({
                        localesAsignados: nombresLocalesAsignados
                    });
                    
                    // Actualizar en el estado local
                    setSupervisores(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    setSupervisoresFiltrados(prev => prev.map(s => 
                        s.id === supervisor.id ? supervisorActualizado : s
                    ));
                    
                    alert(`‚úÖ Locales asignados exitosamente a ${supervisor.usuario}`);
                    
                } catch (error) {
                    console.error('Error asignando locales:', error);
                    alert('Error asignando locales: ' + error.message);
                }
            };
            
            const mostrarDialogoEliminarSupervisor = (supervisor) => {
                if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar permanentemente el supervisor '${supervisor.usuario}'?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                    return;
                }
                
                eliminarSupervisor(supervisor);
            };
            
            const eliminarSupervisor = async (supervisor) => {
                try {
                    // Eliminar de Firebase
                    const db = FirebaseRegionManager.getFirestore();
                    await db.collection('supervisores').doc(supervisor.id).delete();
                    
                    // Actualizar estado local
                    setSupervisores(prev => prev.filter(s => s.id !== supervisor.id));
                    setSupervisoresFiltrados(prev => prev.filter(s => s.id !== supervisor.id));
                    
                    alert(`‚úÖ Supervisor '${supervisor.usuario}' eliminado exitosamente`);
                    
                } catch (error) {
                    console.error('Error eliminando supervisor:', error);
                    alert('Error eliminando supervisor: ' + error.message);
                }
            };

            if (cargando) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando locales...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '8px', maxWidth: '100%', overflowX: 'hidden'}}>
                    {/* Header con bot√≥n volver */}
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', width: '100%'}}>
                        <button 
                            onClick={onVolver}
                            style={{
                                padding: '8px 16px',
                                color: '#FFFFFF',
                                fontWeight: 'bold',
                                borderRadius: '8px',
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                fontSize: '16px',
                                cursor: 'pointer',
                                whiteSpace: 'nowrap'
                            }}
                        >
                            ‚Üê Volver
                        </button>
                        <div style={{flex: 1}}></div>
                    </div>

                    {/* T√≠tulo - EXACTO como APK */}
                    <h1 style={{
                        textAlign: 'center',
                        fontSize: 'clamp(18px, 5vw, 24px)',
                        fontWeight: 'bold',
                        color: '#000000',
                        padding: '16px',
                        marginBottom: '8px',
                        width: '100%',
                        boxSizing: 'border-box'
                    }}>
                        GESTI√ìN DE LOCALES
                    </h1>

                    {/* Pesta√±as - EXACTO como APK */}
                    {esUsuarioMaestro && (
                        <div style={{
                            display: 'flex',
                            backgroundColor: '#FFD700',
                            padding: '4px',
                            marginLeft: 'max(8px, calc((100% - 400px) / 2))',
                            marginRight: 'max(8px, calc((100% - 400px) / 2))',
                            marginBottom: '16px',
                            borderRadius: '8px',
                            maxWidth: 'calc(100% - 16px)',
                            boxSizing: 'border-box'
                        }}>
                            <button
                                onClick={() => setPestanaActiva('locales')}
                                style={{
                                    flex: 1,
                                    height: '48px',
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    backgroundColor: pestanaActiva === 'locales' ? '#FFD700' : 'transparent',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    borderRadius: '8px',
                                    marginRight: '2px',
                                    cursor: 'pointer'
                                }}
                            >
                                üè™ LOCALES
                            </button>
                            <button
                                onClick={() => setPestanaActiva('supervisores')}
                                style={{
                                    flex: 1,
                                    height: '48px',
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    backgroundColor: pestanaActiva === 'supervisores' ? '#FFD700' : 'transparent',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    borderRadius: '8px',
                                    marginLeft: '2px',
                                    cursor: 'pointer'
                                }}
                            >
                                üë• SUPERVISORES
                            </button>
                        </div>
                    )}

                    {/* Contenido de Locales - EXACTO como APK */}
                    {pestanaActiva === 'locales' && (
                        <div style={{padding: 'max(8px, 16px)', width: '100%', boxSizing: 'border-box'}}>
                            {/* Bot√≥n Agregar Local - EXACTO como APK */}
                            {esUsuarioMaestro && (
                    <button
                        onClick={() => setMostrarFormulario(true)}
                        style={{
                            width: '100%',
                            fontWeight: 'bold',
                            marginBottom: '16px',
                            backgroundColor: '#FFD700',
                            fontSize: 'clamp(14px, 4vw, 16px)',
                            padding: '16px',
                            borderRadius: '12px',
                            border: '2px solid #FFA500',
                            color: '#000000',
                            cursor: 'pointer',
                            boxSizing: 'border-box',
                            textAlign: 'center'
                        }}
                    >
                        ‚ûï AGREGAR NUEVO LOCAL
                    </button>
                            )}

                    {/* Buscador - EXACTO como APK */}
                    <input
                        type="text"
                        placeholder="üîç Buscar locales por nombre, fecha o usuario..."
                        style={{
                            width: '100%',
                            marginBottom: '16px',
                            backgroundColor: 'white',
                            border: '1px solid #E0E0E0',
                            fontSize: 'clamp(12px, 3.5vw, 14px)',
                            padding: '12px',
                            borderRadius: '8px',
                            boxSizing: 'border-box'
                        }}
                        onChange={(e) => filtrarLocales(e.target.value)}
                    />

                    {/* Lista de Locales - EXACTO como APK */}
                    <div style={{minHeight: 'calc(100vh - 200px)'}}>
                        {(localesFiltrados.length > 0 ? localesFiltrados : locales).map((local, index) => {
                            console.log('Renderizando local', index, local);
                            return (
                            <div 
                                key={local.nombre || `local-${index}`} 
                                style={{
                                    backgroundColor: '#E3F2FD',
                                    border: '2px solid #BBDEFB',
                                    borderRadius: '16px',
                                    padding: 'max(12px, 20px)',
                                    marginLeft: 'max(8px, 16px)',
                                    marginRight: 'max(8px, 16px)',
                                    marginTop: '8px',
                                    marginBottom: '16px',
                                    color: '#000000',
                                    width: 'calc(100% - max(16px, 32px))',
                                    boxSizing: 'border-box'
                                }}
                            >
                                {/* Nombre del local con badge de vencimientos - EXACTO como APK */}
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    marginBottom: '8px',
                                    gap: '8px'
                                }}>
                                    <div 
                                        style={{
                                            fontSize: 'clamp(16px, 5vw, 20px)',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            wordBreak: 'break-word',
                                            textAlign: 'left',
                                            flex: 1,
                                            cursor: problemasLocales[local.id] ? 'pointer' : 'default'
                                        }}
                                        onClick={() => {
                                            if (problemasLocales[local.id]) {
                                                mostrarPopupProblemas(local.nombre, problemasLocales[local.id]);
                                            }
                                        }}
                                    >
                                        üè™ {local.nombre} {problemasLocales[local.id] ? '‚ö†Ô∏è' : ''}
                                    </div>
                                    
                                    {/* Badge de vencimientos */}
                                    {(() => {
                                        const badge = badgesVencimientos[local.id];
                                        const tieneBadge = badge && (badge.hoy > 0 || badge.manana > 0);
                                        
                                        // Debug en consola
                                        if (badge) {
                                            console.log('üéØ Renderizando badge para', local.nombre, ':', badge, 'tieneBadge:', tieneBadge);
                                        }
                                        
                                        if (!tieneBadge) {
                                            return null;
                                        }
                                        
                                        return (
                                            <div
                                                onClick={() => mostrarPopupVencimientos(local)}
                                                style={{
                                                    fontSize: '12px',
                                                    fontWeight: 'bold',
                                                    color: '#FFFFFF',
                                                    padding: '4px 12px',
                                                    borderRadius: '12px',
                                                    backgroundColor: badge.hoy > 0 ? '#F44336' : '#FF9800',
                                                    cursor: 'pointer',
                                                    whiteSpace: 'nowrap',
                                                    minWidth: '40px',
                                                    textAlign: 'center',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}
                                            >
                                                {badge.hoy > 0 
                                                    ? `üî¥ ${badge.hoy}` 
                                                    : `üü° ${badge.manana}`}
                                            </div>
                                        );
                                    })()}
                                </div>
                                
                                {/* Fecha de creaci√≥n - EXACTO como APK */}
                                <div style={{
                                    fontSize: 'clamp(11px, 3vw, 12px)',
                                    color: '#000000',
                                    paddingTop: '4px',
                                    paddingBottom: '4px',
                                    textAlign: 'left'
                                }}>
                                    Creado: {local.fechaCreacion}
                                </div>
                                
                                {/* Usuarios - EXACTO como APK */}
                                <div style={{
                                    fontSize: 'clamp(11px, 3vw, 12px)',
                                    color: '#000000',
                                    paddingTop: '4px',
                                    paddingBottom: '8px',
                                    textAlign: 'left'
                                }}>
                                    Usuarios: {Object.keys(local.usuarios || {}).length}
                                </div>
                                
                                {/* Bot√≥n de acceso directo - EXACTO como APK */}
                                <button
                                    onClick={() => {
                                        // Crear usuario temporal para el local seleccionado
                                        // Usar el ID del documento de Firebase como localId
                                        const localId = local.id || local.nombre; // Fallback al nombre si no hay id
                                        const usuarioTemporal = {
                                            id: 'temp_' + localId,
                                            usuario: 'admin_' + local.nombre.toLowerCase(),
                                            localId: localId, // Usar el ID del documento de Firebase
                                            localNombre: local.nombre,
                                            rol: 'admin_local',
                                            activo: true
                                        };
                                        
                                        // Guardar en localStorage
                                        localStorage.setItem('usuario', JSON.stringify(usuarioTemporal));
                                        
                                        // Navegar al main usando el sistema de React
                                        console.log('üöÄ Ingresando al local:', local.nombre);
                                        console.log('üîë LocalId asignado:', localId);
                                        console.log('üë§ Usuario temporal creado:', usuarioTemporal);
                                        
                                        // Usar la funci√≥n onLoginSuccess pasada como prop
                                        console.log('üîç onLoginSuccess disponible:', !!onLoginSuccess);
                                        console.log('üîç Tipo de onLoginSuccess:', typeof onLoginSuccess);
                                        
                                        if (onLoginSuccess) {
                                            console.log('‚úÖ Llamando onLoginSuccess con:', usuarioTemporal);
                                            onLoginSuccess(usuarioTemporal);
                                        } else {
                                            console.log('‚ùå onLoginSuccess no disponible, usando fallback');
                                            // Fallback: recargar la p√°gina
                                            window.location.href = window.location.origin + window.location.pathname;
                                        }
                                    }}
                                    style={{
                                        width: '100%',
                                        color: '#FFFFFF',
                                        fontWeight: 'bold',
                                        fontSize: 'clamp(12px, 3.5vw, 14px)',
                                        backgroundColor: '#9C27B0',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: 'max(8px, 10px)',
                                        marginTop: '8px',
                                        marginBottom: '8px',
                                        cursor: 'pointer',
                                        textAlign: 'center',
                                        boxSizing: 'border-box'
                                    }}
                                >
                                    üöÄ Ingresar al Local
                                </button>

                                {/* VER STOCK Y VENCIMIENTOS - EXACTO como APK */}
                                <button
                                    onClick={() => {
                                        if (window.openVencimientosHistorial) {
                                            window.openVencimientosHistorial(local.id, local.nombre);
                                        } else if (window.openVencLocal) {
                                            window.openVencLocal();
                                        }
                                    }}
                                    style={{
                                        width: '100%',
                                        color: '#FFFFFF',
                                        fontWeight: 'bold',
                                        fontSize: 'clamp(12px, 3.5vw, 14px)',
                                        backgroundColor: '#1976D2',
                                        border: 'none',
                                        borderRadius: '8px',
                                        padding: 'max(8px, 10px)',
                                        marginTop: '8px',
                                        marginBottom: '8px',
                                        cursor: 'pointer',
                                        textAlign: 'center',
                                        boxSizing: 'border-box'
                                    }}
                                >
                                    üì¶ Ver Stock y Vencimientos
                                </button>
                                
                                {/* Botones de administraci√≥n - EXACTO como APK */}
                                <div style={{
                                    display: 'flex',
                                    gap: 'max(2px, 4px)',
                                    marginTop: '8px',
                                    flexWrap: 'wrap',
                                    width: '100%'
                                }}>
                                    <button
                                        onClick={() => mostrarUsuarios(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#2196F3',
                                            border: '2px solid #1976D2',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        üë• USUARIOS
                                    </button>
                                    
                                    <button
                                        onClick={() => cambiarContrase√±a(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#4CAF50',
                                            border: '2px solid #45A049',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            marginLeft: 'max(2px, 4px)',
                                            marginRight: 'max(2px, 4px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        üîë CONTRASE√ëA
                                    </button>
                                    
                                    {/* Solo mostrar bot√≥n Eliminar para usuarios maestro */}
                                    {esUsuarioMaestro && (
                                    <button
                                        onClick={() => eliminarLocal(local)}
                                        style={{
                                            flex: '1 1 calc(33.333% - 4px)',
                                            minWidth: '80px',
                                            color: '#FFFFFF',
                                            fontWeight: 'bold',
                                            fontSize: 'clamp(9px, 2.5vw, 11px)',
                                            backgroundColor: '#F44336',
                                            border: '2px solid #D32F2F',
                                            borderRadius: '12px',
                                            padding: 'max(6px, 8px)',
                                            marginLeft: 'max(2px, 4px)',
                                            cursor: 'pointer',
                                            textAlign: 'center',
                                            whiteSpace: 'nowrap',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis'
                                        }}
                                    >
                                        üóëÔ∏è ELIMINAR
                                    </button>
                                    )}
                                </div>
                            </div>
                            );
                        })}
                        
                        {locales.length === 0 && (
                            <div className="text-center p-8">
                                <div className="text-lg text-gray-600 mb-4">üìù No hay locales registrados</div>
                                <button
                                    onClick={() => setMostrarFormulario(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Crear Local
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Texto de estado - EXACTO como l√≠neas 94-97 */}
                    <div 
                        className="text-center mt-4 text-sm"
                        style={{color: '#F44336'}}
                    >
                        {error || `${locales.length} locales encontrados (${localesFiltrados.length} filtrados)`}
                    </div>
                    
                    {/* Debug info */}
                    <div className="text-center mt-2 text-xs text-gray-500">
                        Debug: locales={locales.length}, filtrados={localesFiltrados.length}
                    </div>
                        </div>
                    )}

                    {/* Contenido de Supervisores - EXACTO como APK */}
                    {pestanaActiva === 'supervisores' && esUsuarioMaestro && (
                        <div style={{padding: 'max(8px, 16px)', width: '100%', boxSizing: 'border-box'}}>
                            {/* Bot√≥n Agregar Supervisor - EXACTO como APK */}
                            <button
                                onClick={() => setMostrarFormularioSupervisor(true)}
                                style={{
                                    width: '100%',
                                    fontWeight: 'bold',
                                    marginBottom: '16px',
                                    backgroundColor: '#FFD700',
                                    fontSize: 'clamp(14px, 4vw, 16px)',
                                    padding: '16px',
                                    borderRadius: '12px',
                                    border: '2px solid #FFA500',
                                    color: '#000000',
                                    cursor: 'pointer',
                                    boxSizing: 'border-box',
                                    textAlign: 'center'
                                }}
                            >
                                ‚ûï AGREGAR NUEVO SUPERVISOR
                            </button>

                            {/* Buscador de supervisores - EXACTO como APK */}
                            <input
                                type="text"
                                placeholder="üîç Buscar supervisores por nombre..."
                                style={{
                                    width: '100%',
                                    marginBottom: '16px',
                                    backgroundColor: 'white',
                                    border: '1px solid #E0E0E0',
                                    fontSize: 'clamp(12px, 3.5vw, 14px)',
                                    padding: '12px',
                                    borderRadius: '8px',
                                    boxSizing: 'border-box'
                                }}
                                onChange={(e) => filtrarSupervisores(e.target.value)}
                            />

                            {/* Lista de Supervisores - EXACTO como APK */}
                            <div style={{minHeight: 'calc(100vh - 200px)'}}>
                                {(supervisoresFiltrados.length > 0 ? supervisoresFiltrados : supervisores).map((supervisor, index) => {
                                    // Obtener nombres de locales asignados
                                    const nombresLocales = (supervisor.localesAsignados || []).map(localNombre => {
                                        const local = locales.find(l => l.nombre === localNombre);
                                        return local ? local.nombre : localNombre;
                                    });
                                    
                                    return (
                                    <div 
                                        key={supervisor.id || `supervisor-${index}`} 
                                        style={{
                                            backgroundColor: '#E3F2FD',
                                            border: '2px solid #BBDEFB',
                                            borderRadius: '16px',
                                            padding: 'max(12px, 20px)',
                                            marginLeft: 'max(8px, 16px)',
                                            marginRight: 'max(8px, 16px)',
                                            marginTop: '8px',
                                            marginBottom: '16px',
                                            color: '#000000',
                                            width: 'calc(100% - max(16px, 32px))',
                                            boxSizing: 'border-box'
                                        }}
                                    >
                                        {/* Nombre del supervisor - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(16px, 5vw, 20px)',
                                            fontWeight: 'bold',
                                            color: '#000000',
                                            marginBottom: '8px',
                                            wordBreak: 'break-word',
                                            textAlign: 'left'
                                        }}>
                                            üë®‚Äçüíº {supervisor.usuario}
                                        </div>
                                        
                                        {/* Fecha de creaci√≥n - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(11px, 3vw, 12px)',
                                            color: '#000000',
                                            paddingTop: '4px',
                                            paddingBottom: '4px',
                                            textAlign: 'left'
                                        }}>
                                            Creado: {supervisor.fechaCreacion || 'N/A'}
                                        </div>
                                        
                                        {/* Locales asignados - EXACTO como APK */}
                                        <div style={{
                                            fontSize: 'clamp(11px, 3vw, 12px)',
                                            color: '#000000',
                                            paddingTop: '4px',
                                            paddingBottom: '8px',
                                            textAlign: 'left',
                                            wordBreak: 'break-word'
                                        }}>
                                            Locales asignados: {nombresLocales.length} {nombresLocales.length > 0 ? `(${nombresLocales.join(', ')})` : ''}
                                        </div>
                                        
                                        {/* Botones de administraci√≥n - EXACTO como APK */}
                                        <div style={{
                                            display: 'flex',
                                            gap: 'max(2px, 4px)',
                                            marginTop: '8px',
                                            flexWrap: 'wrap',
                                            width: '100%'
                                        }}>
                                            <button
                                                onClick={() => mostrarLocalesAsignados(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#2196F3',
                                                    border: '2px solid #1976D2',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                üè™ LOCALES
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoAsignarLocales(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#4CAF50',
                                                    border: '2px solid #45A049',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    marginRight: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                ‚ûï ASIGNAR
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarContrase√±aSupervisor(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#2196F3',
                                                    border: '2px solid #1976D2',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    marginRight: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                üîë CONTRASE√ëA
                                            </button>
                                            
                                            <button
                                                onClick={() => mostrarDialogoEliminarSupervisor(supervisor)}
                                                style={{
                                                    flex: '1 1 calc(25% - 6px)',
                                                    minWidth: '70px',
                                                    color: '#FFFFFF',
                                                    fontWeight: 'bold',
                                                    fontSize: 'clamp(9px, 2.5vw, 11px)',
                                                    backgroundColor: '#F44336',
                                                    border: '2px solid #D32F2F',
                                                    borderRadius: '12px',
                                                    padding: 'max(6px, 8px)',
                                                    marginLeft: 'max(2px, 4px)',
                                                    cursor: 'pointer',
                                                    textAlign: 'center',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}
                                            >
                                                üóëÔ∏è ELIMINAR
                                            </button>
                                        </div>
                                    </div>
                                    );
                                })}
                                
                                {supervisores.length === 0 && (
                                    <div className="text-center p-8">
                                        <div className="text-lg text-gray-600 mb-4">üë• No hay supervisores registrados</div>
                                        <button
                                            onClick={() => setMostrarFormularioSupervisor(true)}
                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear Supervisor
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div 
                                className="text-center mt-4 text-sm"
                                style={{color: '#F44336'}}
                            >
                                {error || `${supervisores.length} supervisores encontrados (${supervisoresFiltrados.length} filtrados)`}
                            </div>
                        </div>
                    )}
                                
                    {/* Modal de nuevo local - EXACTO como l√≠neas 251-295 */}
                    {mostrarFormulario && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Local</h3>
                                    <button
                                        onClick={() => setMostrarFormulario(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <form onSubmit={crearLocal} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Nombre del local (ej: WILDE)
                                        </label>
                                        <input
                                            type="text"
                                            value={nuevoLocal.nombre}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Nombre del local (ej: WILDE)"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Contrase√±a del admin (opcional)
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoLocal.contrase√±a}
                                            onChange={(e) => setNuevoLocal({...nuevoLocal, contrase√±a: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Contrase√±a del admin (opcional)"
                                        />
                                    </div>
                                    
                                    <div className="text-sm text-gray-600">
                                        Si no ingresas contrase√±a, se generar√° una autom√°ticamente
                                    </div>
                                    
                                    <div className="flex justify-end space-x-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormulario(false)}
                                            className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal de nuevo supervisor */}
                    {mostrarFormularioSupervisor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Agregar Nuevo Supervisor</h3>
                                    <button
                                        onClick={() => setMostrarFormularioSupervisor(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                <form onSubmit={crearSupervisor}>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre completo
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.nombre}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, nombre: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Nombre del supervisor"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Usuario de acceso
                                        </label>
                                        <input
                                            type="text"
                                            required
                                            value={nuevoSupervisor.usuario}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, usuario: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Usuario para login"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Contrase√±a (opcional)
                                        </label>
                                        <input
                                            type="password"
                                            value={nuevoSupervisor.contrase√±a}
                                            onChange={(e) => setNuevoSupervisor({...nuevoSupervisor, contrase√±a: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Contrase√±a (se generar√° autom√°ticamente si se deja vac√≠o)"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Locales asignados
                                        </label>
                                        <div className="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-2">
                                            {locales.map((local) => (
                                                <div key={local.id} className="flex items-center mb-2">
                                                    <input
                                                        type="checkbox"
                                                        id={`local-${local.id}`}
                                                        checked={nuevoSupervisor.localesAsignados.includes(local.id)}
                                                        onChange={(e) => {
                                                            const localesActualizados = e.target.checked
                                                                ? [...nuevoSupervisor.localesAsignados, local.id]
                                                                : nuevoSupervisor.localesAsignados.filter(id => id !== local.id);
                                                            setNuevoSupervisor({...nuevoSupervisor, localesAsignados: localesActualizados});
                                                        }}
                                                        className="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                    />
                                                    <label htmlFor={`local-${local.id}`} className="text-sm">
                                                        {local.nombre}
                                                    </label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {error && (
                                        <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    
                                    <div className="flex justify-end gap-2">
                                        <button
                                            type="button"
                                            onClick={() => setMostrarFormularioSupervisor(false)}
                                            className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            Crear
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // CalendarioPersonalizado Component - EXACTO como MainActivity.kt l√≠neas 279-490
        function CalendarioPersonalizado({ fechaSeleccionada, setFechaSeleccionada, onCerrar, fechasCompletas, fechasParciales, cargando }) {
            const [mesActual, setMesActual] = useState(window.getFechaArgentina ? window.getFechaArgentina() : new Date());

            // Funci√≥n para formatear fecha como yyyy-MM-dd
            const formatearFechaCorta = (fecha) => {
                // Convertir a zona horaria de Argentina si es necesario
                if (!fecha) fecha = window.getFechaArgentina ? window.getFechaArgentina() : new Date();
                const fechaArg = window.formatearFechaArgentina ? window.formatearFechaArgentina(fecha) : fecha;
                const a√±o = fechaArg.getFullYear();
                const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaArg.getDate()).padStart(2, '0');
                const fechaFormateada = `${a√±o}-${mes}-${dia}`;
                console.log(`üìÖ formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Funci√≥n para obtener el primer d√≠a del mes
            const obtenerPrimerDia = (fecha) => {
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                return primerDia;
            };

            // Funci√≥n para obtener el √∫ltimo d√≠a del mes
            const obtenerUltimoDia = (fecha) => {
                return new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
            };

            // Funci√≥n para obtener d√≠as de la semana
            const obtenerDiasSemana = () => {
                return ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            };

            // Funci√≥n para crear el grid del mes - EXACTO como MainActivity.kt l√≠neas 495-730
            const crearGridMes = () => {
                const a√±o = mesActual.getFullYear();
                const mes = mesActual.getMonth();
                const primerDia = obtenerPrimerDia(mesActual);
                const ultimoDia = obtenerUltimoDia(mesActual);
                const diasEnMes = ultimoDia.getDate();
                const primerDiaSemana = primerDia.getDay(); // 0=Domingo, 1=Lunes, etc.

                const dias = [];
                const diasSemana = obtenerDiasSemana();

                // Crear encabezados de d√≠as
                const encabezados = diasSemana.map((dia, index) => (
                    <div key={index} className="text-center text-xs font-bold text-gray-600 p-1">
                        {dia}
                    </div>
                ));

                // Agregar espacios vac√≠os para los d√≠as anteriores al primer d√≠a del mes
                for (let i = 0; i < primerDiaSemana; i++) {
                    dias.push(
                        <div key={`empty-${i}`} className="h-12 flex items-center justify-center">
                        </div>
                    );
                }

                // Agregar los d√≠as del mes
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const fechaString = `${a√±o}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                    const esHoy = fechaString === formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                    const esFechaSeleccionada = fechaString === formatearFechaCorta(fechaSeleccionada);
                    
                    // Determinar color seg√∫n datos - EXACTO como l√≠neas 576-589
                    let colorFondo, colorTexto, borde;
                    if (fechasCompletas.has(fechaString)) {
                        colorFondo = '#4CAF50'; // Verde
                        colorTexto = '#FFFFFF';
                    } else if (fechasParciales.has(fechaString)) {
                        colorFondo = '#FF9800'; // Naranja
                        colorTexto = '#FFFFFF';
                    } else {
                        colorFondo = '#757575'; // Gris
                        colorTexto = '#FFFFFF';
                    }

                    // Agregar borde rojo para fecha seleccionada o d√≠a actual - EXACTO como l√≠neas 591-620
                    if (esFechaSeleccionada || (esHoy && !fechasCompletas.has(fechaString) && !fechasParciales.has(fechaString))) {
                        borde = '3px solid #F44336';
                    }

                    dias.push(
                        <button
                            key={dia}
                            onClick={() => {
                                const nuevaFecha = new Date(a√±o, mes, dia);
                                setFechaSeleccionada(nuevaFecha);
                                onCerrar();
                            }}
                            className="h-12 w-full flex items-center justify-center text-lg font-bold rounded-lg transition-all hover:opacity-80"
                            style={{
                                backgroundColor: colorFondo,
                                color: colorTexto,
                                border: borde,
                                minHeight: '48px'
                            }}
                        >
                            {dia}
                        </button>
                    );
                }

                return { encabezados, dias };
            };

            // Funci√≥n para cambiar mes - EXACTO como MainActivity.kt l√≠neas 449-463
            const cambiarMes = (offset) => {
                const nuevoMes = new Date(mesActual);
                nuevoMes.setMonth(nuevoMes.getMonth() + offset);
                setMesActual(nuevoMes);
            };

            const { encabezados, dias } = crearGridMes();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                        {/* Header - EXACTO como l√≠neas 310-318 */}
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-black">üìÖ Seleccionar Fecha</h3>
                            <button
                                onClick={onCerrar}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        {/* Leyenda de colores - EXACTO como l√≠neas 320-344 */}
                        <div className="flex justify-center space-x-4 mb-4 text-xs">
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#4CAF50'}}></div>
                                <span>Completo</span>
                            </div>
                            <div className="flex items-center">
                                <div className="w-3 h-3 rounded-full mr-1" style={{backgroundColor: '#FF9800'}}></div>
                                <span>Parcial</span>
                            </div>
                        </div>

                        {/* Navegaci√≥n de mes - EXACTO como l√≠neas 346-405 */}
                        <div className="flex items-center justify-between mb-4">
                            <button
                                onClick={() => cambiarMes(-1)}
                                className="w-14 h-12 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                ‚óÄ
                            </button>
                            
                            <div className="text-center">
                                <div className="text-lg font-bold text-black">
                                    {mesActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                                </div>
                            </div>
                            
                            <button
                                onClick={() => cambiarMes(1)}
                                className="w-14 h-12 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                ‚ñ∂
                            </button>
                        </div>

                        {/* Grid del calendario - EXACTO como l√≠neas 424-441 */}
                        <div className="grid grid-cols-7 gap-1 mb-4">
                            {encabezados}
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1">
                            {dias}
                        </div>

                        {/* Indicador de carga */}
                        {cargando && (
                            <div className="text-center mt-4">
                                <div className="text-sm text-gray-600">Cargando calendario...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main Component
        function Main({ usuario, onLogout, onVolverGestion }) {
            const [fechaSeleccionada, setFechaSeleccionada] = useState(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
            const [mostrarCalendario, setMostrarCalendario] = useState(false);
            const [cargandoCalendario, setCargandoCalendario] = useState(false);
            const [fechasCompletas, setFechasCompletas] = useState(new Set());
            const [fechasParciales, setFechasParciales] = useState(new Set());
            
            // Estados para controlar colores de botones - EXACTO como MainActivity.kt l√≠neas 66-70
            const [tieneIngreso, setTieneIngreso] = useState(false);
            const [tieneStock, setTieneStock] = useState(false);
            const [ultimoEstadoIngreso, setUltimoEstadoIngreso] = useState(null);
            const [ultimoEstadoStock, setUltimoEstadoStock] = useState(null);

            const formatearFecha = (fecha) => {
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            const formatearFechaCorta = (fecha) => {
                // Convertir a zona horaria de Argentina si es necesario
                if (!fecha) fecha = window.getFechaArgentina ? window.getFechaArgentina() : new Date();
                const fechaArg = window.formatearFechaArgentina ? window.formatearFechaArgentina(fecha) : fecha;
                const a√±o = fechaArg.getFullYear();
                const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaArg.getDate()).padStart(2, '0');
                const fechaFormateada = `${a√±o}-${mes}-${dia}`;
                console.log(`üìÖ formatearFechaCorta: ${fecha.toString()} -> ${fechaFormateada}`);
                return fechaFormateada;
            };

            // Funci√≥n para cargar datos del calendario - EXACTO como MainActivity.kt l√≠neas 232-273
            const cargarDatosCalendario = async () => {
                if (cargandoCalendario) return;
                
                setCargandoCalendario(true);
                
                try {
                    // Obtener todos los registros del local usando la regi√≥n actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        setCargandoCalendario(false);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Agrupar registros por fecha
                    const registrosPorFecha = {};
                    registros.forEach(registro => {
                        if (!registrosPorFecha[registro.fecha]) {
                            registrosPorFecha[registro.fecha] = [];
                        }
                        registrosPorFecha[registro.fecha].push(registro);
                    });
                    
                    // Analizar fechas - EXACTO como l√≠neas 244-253
                    const fechasCompletasSet = new Set();
                    const fechasParcialesSet = new Set();
                    
                    Object.entries(registrosPorFecha).forEach(([fecha, registrosFecha]) => {
                        const tieneIngreso = registrosFecha.some(registro => registro.tipo === 'Ingreso de Mercader√≠a');
                        const tieneStock = registrosFecha.some(registro => registro.tipo === 'Stock Final');
                        
                        if (tieneIngreso && tieneStock) {
                            fechasCompletasSet.add(fecha);
                        } else if (tieneIngreso || tieneStock) {
                            fechasParcialesSet.add(fecha);
                        }
                    });
                    
                    setFechasCompletas(fechasCompletasSet);
                    setFechasParciales(fechasParcialesSet);
                    
                } catch (error) {
                    console.error('Error cargando datos del calendario:', error);
                } finally {
                    setCargandoCalendario(false);
                }
            };

            // Funci√≥n para mostrar calendario personalizado - EXACTO como MainActivity.kt l√≠neas 223-274
            const mostrarCalendarioPersonalizado = () => {
                if (cargandoCalendario) return;
                
                setMostrarCalendario(true);
                cargarDatosCalendario();
            };

            // Funci√≥n para verificar registros existentes - EXACTO como MainActivity.kt l√≠neas 992-1003
            const verificarRegistrosExistentes = async () => {
                try {
                    console.log('üîç verificarRegistrosExistentes iniciado');
                    console.log('üë§ Usuario actual:', usuario);
                    console.log('üìÖ Fecha seleccionada:', fechaSeleccionada);
                    
                    if (!usuario || !usuario.localId) {
                        console.log('‚ö†Ô∏è No hay usuario o localId, abortando verificaci√≥n');
                        return;
                    }
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    console.log('üìÖ Fecha string:', fechaString);
                    
                    // Usar la regi√≥n actual de Firebase
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .get();
                    
                    console.log('üìä Snapshot size:', snapshot.size);
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log('üìã Registros encontrados:', registros);
                    
                    // Verificar si hay registros de Ingreso de Mercader√≠a - EXACTO como l√≠neas 1254-1256
                    const tieneIngresoData = registros.some(registro => registro.tipo === 'Ingreso de Mercader√≠a');
                    setTieneIngreso(tieneIngresoData);
                    
                    // Verificar si hay registros de Stock Final - EXACTO como l√≠neas 1258-1260
                    const tieneStockData = registros.some(registro => registro.tipo === 'Stock Final');
                    setTieneStock(tieneStockData);
                    
                    console.log(`üìä Fecha ${fechaString}: Ingreso=${tieneIngresoData}, Stock=${tieneStockData}`);
                    
                } catch (error) {
                    console.error('‚ùå Error verificando registros existentes:', error);
                }
            };

            const [pantallaActual, setPantallaActual] = useState('main');

            // Verificar registros cuando cambie la fecha - EXACTO como MainActivity.kt l√≠neas 153-159
            useEffect(() => {
                console.log('üîÑ useEffect ejecutado - usuario:', usuario, 'fechaSeleccionada:', fechaSeleccionada);
                if (usuario && usuario.localId) {
                    console.log('üìä Ejecutando verificarRegistrosExistentes para usuario:', usuario.localId);
                    verificarRegistrosExistentes();
                } else {
                    console.log('‚ö†Ô∏è No se puede verificar registros - usuario o localId faltante');
                }
            }, [fechaSeleccionada, usuario]);


            // Funci√≥n para verificar si es el d√≠a actual - EXACTO como MainActivity.kt l√≠neas 1219-1227
            const esFechaActual = (fecha) => {
                const fechaString = formatearFechaCorta(fecha);
                const fechaActual = formatearFechaCorta(window.getFechaArgentina ? window.getFechaArgentina() : new Date());
                return fechaString === fechaActual;
            };

            // Estados para datos existentes
            const [datosIngreso, setDatosIngreso] = useState({});
            const [datosStock, setDatosStock] = useState({});
            const [cargandoDatos, setCargandoDatos] = useState(false);


            // Funci√≥n para cargar datos existentes - EXACTO como CargaActivity.kt
            const cargarDatosExistentes = async (tipo) => {
                setCargandoDatos(true);
                try {
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    // Usar la regi√≥n actual de Firebase
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        console.error('Firestore no disponible:', e);
                        setCargandoDatos(false);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .where('fecha', '==', fechaString)
                        .where('tipo', '==', tipo)
                        .get();
                    
                    if (!snapshot.empty) {
                        console.log(`üìä Total registros encontrados: ${snapshot.docs.length}`);
                        
                        // Ordenar por timestamp descendente para obtener el m√°s reciente
                        const docs = snapshot.docs.sort((a, b) => {
                            const timestampA = a.data().timestamp || '';
                            const timestampB = b.data().timestamp || '';
                            return timestampB.localeCompare(timestampA);
                        });
                        
                        const doc = docs[0]; // El m√°s reciente
                        const data = doc.data();
                        console.log(`üìä Datos ${tipo} encontrados (m√°s reciente):`, data);
                        console.log(`üìÖ Timestamp del registro seleccionado:`, data.timestamp);
                        
                        // Convertir productos a objeto para f√°cil acceso
                        const datosProductos = {};
                        if (data.productos && Array.isArray(data.productos)) {
                            data.productos.forEach(producto => {
                                // Extraer nombre del producto (sin c√≥digo)
                                const nombreCompleto = producto.nombre;
                                const partes = nombreCompleto.split(' - ');
                                const nombre = partes.length > 1 ? partes[1] : nombreCompleto;
                                datosProductos[nombre] = producto.cantidad || 0;
                            });
                        }
                        
                        if (tipo === 'Ingreso de Mercader√≠a') {
                            setDatosIngreso(datosProductos);
                            console.log('Datos de ingreso cargados:', datosProductos);
                        } else if (tipo === 'Stock Final') {
                            setDatosStock(datosProductos);
                            console.log('Datos de stock cargados:', datosProductos);
                        }
                        return true; // Hay datos existentes
                    } else {
                        console.log(`üìä No hay datos ${tipo} para la fecha ${fechaString}`);
                        if (tipo === 'Ingreso de Mercader√≠a') {
                            setDatosIngreso({});
                        } else if (tipo === 'Stock Final') {
                            setDatosStock({});
                        }
                        return false; // No hay datos
                    }
                } catch (error) {
                    console.error(`Error cargando datos ${tipo}:`, error);
                    return false;
                } finally {
                    setCargandoDatos(false);
                }
            };


            const navegarA = async (ruta) => {
                console.log(`Navegando a ${ruta}`);
                if (ruta === 'Ingreso de Mercader√≠a') {
                    setPantallaActual('ingreso');
                    await cargarDatosExistentes('Ingreso de Mercader√≠a');
                } else if (ruta === 'Stock Final') {
                    setPantallaActual('stock');
                    await cargarDatosExistentes('Stock Final');
                } else if (ruta === 'Promedio de Ventas') {
                    setPantallaActual('ventas');
                } else {
                    alert(`Funcionalidad de ${ruta} pr√≥ximamente disponible`);
                }
            };

            const volverAlMenu = () => {
                setPantallaActual('main');
            };

            // Funci√≥n para mostrar previsualizaci√≥n - EXACTO como CargaActivity.kt l√≠neas 375-486
            const mostrarPrevisualizacion = () => {
                console.log('üîç Mostrando previsualizaci√≥n...');
                
                // Lista completa de productos como en CargaActivity.kt
                const todosProductos = [
                    'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                    'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni',
                    'BATATA - Batata', 'MEMBRIL - Membrillo',
                    'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                ];
                
                // Crear mensaje de previsualizaci√≥n - EXACTO como APK
                let mensaje = `üìã PREVISUALIZACI√ìN DE ${pantallaActual === 'stock' ? 'STOCK FINAL' : 'INGRESO DE MERCADER√çA'}\n\n`;
                mensaje += `üìÖ Fecha: ${formatearFecha(fechaSeleccionada)}\n`;
                mensaje += `üè™ Local: ${usuario.localNombre}\n\n`;
                
                // Mostrar TODOS los productos con sus cantidades (incluso 0)
                mensaje += `üì¶ PRODUCTOS:\n`;
                let totalUnidades = 0;
                let productosConCantidad = 0;
                
                todosProductos.forEach(producto => {
                    const [codigo, nombre] = producto.split(' - ');
                    
                    // Leer valor actual del input
                    const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                    const cantidad = input ? parseInt(input.value) || 0 : 0;
                    
                    mensaje += `‚Ä¢ ${codigo} - ${nombre}: ${cantidad}\n`;
                    
                    if (cantidad > 0) {
                        productosConCantidad++;
                        totalUnidades += cantidad;
                    }
                });
                
                // Resumen completo
                mensaje += `\nüìä RESUMEN:\n`;
                mensaje += `‚Ä¢ Total productos: ${todosProductos.length}\n`;
                mensaje += `‚Ä¢ Productos con cantidad: ${productosConCantidad}\n`;
                mensaje += `‚Ä¢ Productos sin cantidad: ${todosProductos.length - productosConCantidad}\n`;
                mensaje += `‚Ä¢ Total unidades: ${totalUnidades}\n\n`;
                
                mensaje += `¬øDeseas guardar estos datos?`;
                
                if (confirm(mensaje)) {
                    guardarDatos();
                }
            };

            // Funci√≥n para guardar datos - EXACTO como CargaActivity.kt l√≠neas 487-520
            const guardarDatos = async () => {
                try {
                    console.log('üíæ Guardando datos...');
                    
                    const fechaString = formatearFechaCorta(fechaSeleccionada);
                    const tipo = pantallaActual === 'stock' ? 'Stock Final' : 'Ingreso de Mercader√≠a';
                    
                    // Leer valores actuales de los inputs
                    const productos = [];
                    const todosProductos = [
                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger',
                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni',
                        'BATATA - Batata', 'MEMBRIL - Membrillo',
                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                    ];
                    
                    // Leer valores directamente de los inputs del DOM
                    todosProductos.forEach(producto => {
                        const [codigo, nombre] = producto.split(' - ');
                        
                        // Buscar el input correspondiente en el DOM
                        const input = document.querySelector(`input[data-nombre="${nombre}"]`);
                        const cantidad = input ? parseInt(input.value) || 0 : 0;
                        
                        console.log(`üìù ${codigo} - ${nombre}: ${cantidad} (desde input)`);
                        
                        productos.push({
                            codigo,
                            nombre: producto, // Nombre completo con c√≥digo
                            cantidad: cantidad
                        });
                    });
                    
                    // Crear documento para Firebase - MISMO FORMATO QUE APK
                    const documento = {
                        fecha: fechaString,
                        tipo: tipo,
                        productos: productos,
                        timestamp: window.getTimestampArgentina ? window.getTimestampArgentina() : new Date().toISOString(),
                        usuario: usuario.usuario || 'admin',
                        localId: usuario.localId
                    };
                    
                    console.log('üìÑ Documento a guardar:', documento);
                    
                    // ID descriptivo como la APK: fecha_tipo
                    const idDocumento = `${fechaString}_${tipo.replace(/\s+/g, '_')}`;
                    console.log('üÜî ID del documento:', idDocumento);
                    
                    // Guardar en Firebase con ID descriptivo usando la regi√≥n actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        alert('Error: Firebase no est√° inicializado. Por favor, selecciona una regi√≥n primero.');
                        return;
                    }
                    await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .doc(idDocumento)
                        .set(documento);
                    
                    console.log('‚úÖ Datos guardados exitosamente');
                    alert(`‚úÖ ${tipo} guardado exitosamente para ${fechaString}`);
                    
                    // Actualizar estados de botones
                    if (tipo === 'Ingreso de Mercader√≠a') {
                        setTieneIngreso(true);
                    } else if (tipo === 'Stock Final') {
                        setTieneStock(true);
                    }
                    
                    // Volver al men√∫ principal
                    volverAlMenu();
                    
                } catch (error) {
                    console.error('‚ùå Error guardando datos:', error);
                    alert(`‚ùå Error guardando datos: ${error.message}`);
                }
            };

            // Mostrar pantalla de gesti√≥n de locales si est√° seleccionada
            if (pantallaActual === 'gestion-locales') {
                return <GestionLocales onVolver={volverAlMenu} onLoginSuccess={onLoginSuccess} />;
            }

            // Mostrar pantalla de promedios si est√° seleccionada
            if (pantallaActual === 'ventas') {
                return <PromedioVentas onVolver={volverAlMenu} usuario={usuario} />;
            }

            // Mostrar pantalla de stock si est√° seleccionada
            if (pantallaActual === 'stock') {
            return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con bot√≥n volver */}
                        <div className="flex justify-between items-center mb-4">
                                    <button
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                                    >
                                ‚Üê Volver
                                    </button>
                            <h1 className="text-xl font-bold text-black">Stock Final</h1>
                            <div></div>
                                    </div>

                        {/* Informaci√≥n de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Stock Final
                            </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                                    </div>
                                </div>
                                
                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                Productos en Stock
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ü EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                    </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üçï PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ß PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üç¨ OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Bot√≥n guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base py-3 rounded-lg"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            üëÅÔ∏è Previsualizar y Guardar
                                    </button>
                                </div>
                );
            }

            // Mostrar pantalla de ingreso si est√° seleccionada
            if (pantallaActual === 'ingreso') {
                return (
                    <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '16px'}}>
                        {/* Header con bot√≥n volver */}
                        <div className="flex justify-between items-center mb-4">
                            <button 
                                onClick={volverAlMenu}
                                className="text-2xl font-bold text-black"
                            >
                                ‚Üê Volver
                            </button>
                            <h1 className="text-xl font-bold text-black">Ingreso de Mercader√≠a</h1>
                            <div></div>
                            </div>

                        {/* Informaci√≥n de fecha */}
                        <div 
                            className="w-full mb-4 p-3 rounded-lg"
                            style={{
                                backgroundColor: '#F5F5F5',
                                padding: '12px',
                                borderRadius: '8px'
                            }}
                        >
                            <div 
                                className="text-lg font-bold text-black mb-1"
                                style={{color: '#3700B3'}}
                            >
                                Ingreso de Mercader√≠a
                                        </div>
                            <div 
                                className="text-sm"
                                style={{color: '#6200EE'}}
                            >
                                {formatearFecha(fechaSeleccionada)}
                        </div>
                    </div>

                        {/* Lista de productos */}
                        <div className="bg-white rounded-lg mb-4 p-4">
                            <h2 className="text-lg font-semibold mb-4 text-black">
                                Productos a Ingresar
                                {cargandoDatos && <span className="text-sm text-gray-500 ml-2">(Cargando datos...)</span>}
                                        </h2>
                            
                            {/* EMPANADAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF6B6B',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ü EMPANADAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        12 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                                        'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                                        'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                                    </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                                
                            {/* PIZZAS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#4CAF50',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üçï PIZZAS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* PASTELITOS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#FF9800',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">ü•ß PASTELITOS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                        </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'BATATA - Batata', 'MEMBRIL - Membrillo'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                        </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                                    </div>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                                            </div>
                                        );
                                    })}
                            </div>
                        </div>

                            {/* OTROS */}
                            <div className="mb-4">
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2"
                                    style={{
                                        backgroundColor: '#9C27B0',
                                        borderRadius: '8px'
                                    }}
                                >
                                    <span className="text-lg">üç¨ OTROS</span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        3 productos
                                    </span>
                                </div>
                                
                                <div className="p-2" style={{backgroundColor: '#F8F9FA'}}>
                                    {[
                                        'DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito'
                                    ].map((producto, index) => {
                                        const [codigo, nombre] = producto.split(' - ');
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex items-center justify-between p-3 mb-2 rounded"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '6px'
                                                }}
                                            >
                                                <div className="flex-1">
                                                    <div className="text-sm font-bold" style={{color: '#3700B3'}}>
                                                        {codigo}
                                </div>
                                                    <div className="text-base text-black mt-1">
                                                        {nombre}
                            </div>
                        </div>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    className="w-20 h-10 text-center font-bold rounded"
                                                    style={{
                                                        backgroundColor: 'white',
                                                        border: '1px solid #E0E0E0',
                                                        color: '#3700B3',
                                                        fontSize: '16px'
                                                    }}
                                                    placeholder="0"
                                                    value={pantallaActual === 'stock' ? (datosStock[nombre] || 0) : (datosIngreso[nombre] || 0)}
                                                    onChange={(e) => {
                                                        const valor = parseInt(e.target.value) || 0;
                                                        if (pantallaActual === 'stock') {
                                                            setDatosStock(prev => ({...prev, [nombre]: valor}));
                                                        } else {
                                                            setDatosIngreso(prev => ({...prev, [nombre]: valor}));
                                                        }
                                                    }}
                                                    data-nombre={nombre}
                                                />
                    </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Bot√≥n guardar */}
                                    <button
                            onClick={mostrarPrevisualizacion}
                            className="w-full text-black font-bold text-base py-3 rounded-lg"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            üëÅÔ∏è Previsualizar y Guardar
                                    </button>
                                </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '20px'}}>
                    {/* Header con bot√≥n volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={() => {
                                // Detectar si vino de GestionLocales
                                if (usuario.id && usuario.id.startsWith('temp_')) {
                                    // Vino de GestionLocales, volver ah√≠
                                    if (onVolverGestion) {
                                        onVolverGestion();
                                    } else {
                                        // Fallback: ir a login
                                        onLogout();
                                    }
                                } else {
                                    // Vino del login normal, hacer logout
                                    onLogout();
                                }
                            }}
                            className="px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '8px',
                                fontSize: '16px'
                            }}
                        >
                            ‚Üê Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Men√∫ Principal</h1>
                        <div></div>
                            </div>

                    {/* Header del Local */}
                    <div 
                        className="w-full mb-5 text-center text-lg font-bold text-white"
                        style={{
                            backgroundColor: '#FFD700',
                            padding: '16px',
                            borderRadius: '12px'
                        }}
                    >
                        üè™ {usuario.localNombre}
                                        </div>

                    {/* Selector de Fecha */}
                    <div 
                        className="w-full mb-8 flex items-center justify-between"
                        style={{
                            backgroundColor: '#F5F5F5',
                            padding: '16px',
                            borderRadius: '12px'
                        }}
                    >
                        <button 
                            className="text-2xl font-bold text-black px-3 py-3"
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() - 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ‚óÄ
                        </button>
                        
                        <div 
                            className="flex-1 text-center text-lg font-bold text-black cursor-pointer"
                            onClick={mostrarCalendarioPersonalizado}
                        >
                            {fechaSeleccionada.toLocaleDateString('es-ES', { 
                                weekday: 'long', 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: '2-digit' 
                            })}
                                        </div>
                        
                        <button 
                            className="text-2xl font-bold text-black px-3 py-3"
                            onClick={() => {
                                const nuevaFecha = new Date(fechaSeleccionada);
                                nuevaFecha.setDate(nuevaFecha.getDate() + 1);
                                setFechaSeleccionada(nuevaFecha);
                            }}
                        >
                            ‚ñ∂
                        </button>
                        
                        <svg className="w-6 h-6 text-black ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                    </div>

                    {/* Botones */}
                    <div className="space-y-5">
                        <button
                            onClick={() => navegarA('Ingreso de Mercader√≠a')}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: tieneIngreso ? '#4CAF50' : (esFechaActual(fechaSeleccionada) ? '#FFD700' : '#FF9800'),
                                color: tieneIngreso ? '#FFFFFF' : (esFechaActual(fechaSeleccionada) ? '#000000' : '#FFFFFF'),
                                height: '56px',
                                borderRadius: '12px',
                                border: tieneIngreso ? '1px solid #388E3C' : (esFechaActual(fechaSeleccionada) ? '1px solid #B8860B' : '1px solid #F57C00')
                            }}
                        >
                            {tieneIngreso ? '‚úÖ Ingreso de Mercader√≠a' : 'Ingreso de Mercader√≠a'}
                        </button>

                                    <button
                                        onClick={() => navegarA('Stock Final')}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: tieneStock ? '#4CAF50' : (esFechaActual(fechaSeleccionada) ? '#FFD700' : '#FF9800'),
                                color: tieneStock ? '#FFFFFF' : (esFechaActual(fechaSeleccionada) ? '#000000' : '#FFFFFF'),
                                height: '56px',
                                borderRadius: '12px',
                                border: tieneStock ? '1px solid #388E3C' : (esFechaActual(fechaSeleccionada) ? '1px solid #B8860B' : '1px solid #F57C00')
                            }}
                        >
                            {tieneStock ? '‚úÖ Stock Final' : 'Stock Final'}
                        </button>

                        {/* Separador visual entre botones principales y extras */}
                        <div style={{
                            height: '3px',
                            backgroundColor: '#FFD700',
                            margin: '20px 0',
                            borderRadius: '2px',
                            position: 'relative',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <span style={{
                                backgroundColor: '#fff',
                                padding: '0 12px',
                                fontSize: '12px',
                                fontWeight: 'bold',
                                color: '#000000',
                                position: 'absolute'
                            }}>
                                Extras
                            </span>
                        </div>

                        <button
                            onClick={() => {
                                if (window.openVencLocal) {
                                    window.openVencLocal();
                                } else {
                                    alert('Funci√≥n de vencimientos no disponible');
                                }
                            }}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: '#2563eb',
                                color: '#FFFFFF',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #1e40af'
                            }}
                        >
                            üìÖ Vencimientos
                        </button>

                        <button
                            onClick={() => {
                                if (window.openPedidoFabrica) {
                                    window.openPedidoFabrica();
                                } else {
                                    alert('Funci√≥n de pedido a f√°brica no disponible');
                                }
                            }}
                            className="w-full font-bold text-base"
                            style={{
                                backgroundColor: '#059669',
                                color: '#FFFFFF',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #047857',
                                marginBottom: '10px'
                            }}
                        >
                            üè≠ Pedido a F√°brica
                        </button>

                        <button
                            onClick={() => navegarA('Promedio de Ventas')}
                            className="w-full text-black font-bold text-base"
                            style={{
                                backgroundColor: '#FFD700',
                                height: '56px',
                                borderRadius: '12px',
                                border: '1px solid #B8860B'
                            }}
                        >
                            Promedio de Ventas
                                    </button>
                                </div>

                    {/* Enlace de descarga de la app Android */}
                    <div className="mt-6 text-center">
                        <a
                            href="https://github.com/solanosaboresexpress-hash/inventario-app-updates/raw/main/inventario_app.apk"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center px-4 py-2 text-white font-bold rounded-lg hover:opacity-80 transition-all"
                            style={{
                                backgroundColor: '#4CAF50',
                                border: '1px solid #388E3C',
                                borderRadius: '8px',
                                fontSize: '14px',
                                textDecoration: 'none'
                            }}
                        >
                            üì± Descargar App Android
                        </a>
                    </div>

                    {/* Modal del Calendario Personalizado - EXACTO como MainActivity.kt */}
                    {mostrarCalendario && (
                        <CalendarioPersonalizado 
                            fechaSeleccionada={fechaSeleccionada}
                            setFechaSeleccionada={setFechaSeleccionada}
                            onCerrar={() => setMostrarCalendario(false)}
                            fechasCompletas={fechasCompletas}
                            fechasParciales={fechasParciales}
                            cargando={cargandoCalendario}
                        />
                    )}
                                        </div>
            );
        }

        // Componente de Promedio de Ventas - EXACTO como PromedioVentasActivity.kt
        const PromedioVentas = ({ onVolver, usuario }) => {
            const [promedios, setPromedios] = useState({});
            const [cargando, setCargando] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                calcularPromedios();
            }, []);

            const calcularPromedios = async () => {
                try {
                    setCargando(true);
                    console.log('üîç Calculando promedios de ventas...');
                    
                    // Obtener todos los registros del local usando la regi√≥n actual
                    let db;
                    try {
                        db = FirebaseRegionManager.getFirestore();
                    } catch (e) {
                        setError('Error: Firebase no est√° inicializado');
                        setCargando(false);
                        return;
                    }
                    const snapshot = await db.collection('locales')
                        .doc(usuario.localId)
                        .collection('registros')
                        .get();
                    
                    const registros = [];
                    snapshot.forEach(doc => {
                        registros.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`üìä Registros encontrados: ${registros.length}`);
                    console.log('üìã Registros:', registros);
                    
                    if (registros.length === 0) {
                        setError('No hay datos para calcular promedios');
                        setCargando(false);
                        return;
                    }
                    
                    // Calcular promedios por d√≠a de la semana
                    const promediosCalculados = calcularPromediosPorDia(registros);
                    setPromedios(promediosCalculados);
                    console.log('‚úÖ Promedios calculados:', promediosCalculados);
                    
                } catch (error) {
                    console.error('‚ùå Error calculando promedios:', error);
                    setError('Error calculando promedios: ' + error.message);
                } finally {
                    setCargando(false);
                }
            };

            const calcularPromediosPorDia = (registros) => {
                console.log('üîÑ calcularPromediosPorDia iniciado con registros:', registros.length);
                
                // Orden EXACTO como en la tabla: ['LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB', 'DOM']
                const diasSemana = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
                const promediosPorDia = {};
                
                // Inicializar estructura
                diasSemana.forEach(dia => {
                    promediosPorDia[dia] = {};
                });

                // Agrupar registros por fecha
                const registrosPorFecha = {};
                
                registros.forEach(registro => {
                    const fecha = registro.fecha;
                    if (!registrosPorFecha[fecha]) {
                        registrosPorFecha[fecha] = { ingreso: null, stock: null };
                    }
                    
                    if (registro.tipo === 'Ingreso de Mercader√≠a') {
                        registrosPorFecha[fecha].ingreso = registro;
                    } else if (registro.tipo === 'Stock Final') {
                        registrosPorFecha[fecha].stock = registro;
                    }
                });

                console.log('üìÖ Registros agrupados por fecha:', registrosPorFecha);

                // Ordenar fechas para poder calcular stock del d√≠a anterior
                const fechasOrdenadas = Object.keys(registrosPorFecha).sort();
                console.log('üìÖ Fechas ordenadas:', fechasOrdenadas);

                // Calcular ventas por d√≠a usando la f√≥rmula correcta:
                // Ventas = (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                const ventasPorDia = {};
                
                // Inicializar todos los d√≠as de la semana
                diasSemana.forEach(dia => {
                    ventasPorDia[dia] = [];
                });
                
                for (let i = 1; i < fechasOrdenadas.length; i++) { // Empezar desde el segundo d√≠a
                    const fechaActual = fechasOrdenadas[i];
                    const fechaAnterior = fechasOrdenadas[i - 1];
                    
                    const registrosActual = registrosPorFecha[fechaActual];
                    const registrosAnterior = registrosPorFecha[fechaAnterior];
                    
                    // Solo calcular si tenemos todos los datos necesarios
                    if (registrosActual.ingreso && registrosActual.stock && registrosAnterior.stock) {
                        const diaSemana = obtenerDiaSemana(fechaActual);
                        
                        // Calcular ventas: (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            registrosAnterior.stock,  // Stock Final d√≠a anterior
                            registrosActual.ingreso,  // Ingreso de Mercader√≠a
                            registrosActual.stock     // Stock Final de hoy
                        );
                        
                        console.log(`üí∞ Ventas del ${diaSemana} (${fechaActual}):`, ventasDia);
                        console.log(`   Stock anterior (${fechaAnterior}):`, registrosAnterior.stock);
                        console.log(`   Ingreso (${fechaActual}):`, registrosActual.ingreso);
                        console.log(`   Stock actual (${fechaActual}):`, registrosActual.stock);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                }
                
                // Tambi√©n calcular ventas para d√≠as que no tienen d√≠a anterior (primer d√≠a)
                // En este caso, asumimos que el stock anterior es 0
                fechasOrdenadas.forEach(fecha => {
                    const registrosDia = registrosPorFecha[fecha];
                    const diaSemana = obtenerDiaSemana(fecha);
                    
                    // Solo si no se calcul√≥ ya para este d√≠a
                    if (registrosDia.ingreso && registrosDia.stock && ventasPorDia[diaSemana].length === 0) {
                        // Crear un registro de stock anterior con valores 0
                        const stockAnteriorCero = {
                            productos: registrosDia.stock.productos.map(p => ({ ...p, cantidad: 0 }))
                        };
                        
                        const ventasDia = calcularVentasConFormulaCorrecta(
                            stockAnteriorCero,        // Stock anterior = 0
                            registrosDia.ingreso,     // Ingreso de Mercader√≠a
                            registrosDia.stock        // Stock Final de hoy
                        );
                        
                        console.log(`üí∞ Ventas del ${diaSemana} (${fecha}) - Primer d√≠a:`, ventasDia);
                        
                        if (ventasDia && Object.keys(ventasDia).length > 0) {
                            ventasPorDia[diaSemana].push(ventasDia);
                        }
                    }
                });

                console.log('üìä Ventas por d√≠a de la semana:', ventasPorDia);
                console.log('üìä Ventas LUNES:', ventasPorDia['LUNES']);
                console.log('üìä Ventas MARTES:', ventasPorDia['MARTES']);
                console.log('üìä Ventas MIERCOLES:', ventasPorDia['MIERCOLES']);
                console.log('üìä Ventas JUEVES:', ventasPorDia['JUEVES']);
                console.log('üìä Ventas VIERNES:', ventasPorDia['VIERNES']);
                console.log('üìä Ventas SABADO:', ventasPorDia['SABADO']);
                console.log('üìä Ventas DOMINGO:', ventasPorDia['DOMINGO']);

                // Calcular promedios para todos los d√≠as de la semana
                diasSemana.forEach(dia => {
                    const ventasDelDia = ventasPorDia[dia];
                    if (ventasDelDia.length > 0) {
                        // Obtener todos los productos √∫nicos de todas las ventas de este d√≠a
                        const todosProductos = new Set();
                        ventasDelDia.forEach(venta => {
                            Object.keys(venta).forEach(producto => todosProductos.add(producto));
                        });
                        
                        // Calcular promedio para cada producto
                        todosProductos.forEach(producto => {
                            // Filtrar solo los d√≠as donde este producto tiene ventas > 0
                            const ventasConDatos = ventasDelDia.map(venta => venta[producto] || 0).filter(v => v > 0);
                            
                            if (ventasConDatos.length > 0) {
                                const suma = ventasConDatos.reduce((acc, venta) => acc + venta, 0);
                                const promedio = suma / ventasConDatos.length;
                                promediosPorDia[dia][producto] = Math.round(promedio); // Redondear a n√∫mero entero
                                
                                // Log espec√≠fico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠a: ${dia}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Total d√≠as en lista: ${ventasDelDia.length}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠as con ventas > 0: ${ventasConDatos.length}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Ventas encontradas: ${ventasConDatos}`);
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - Suma: ${suma}, Promedio: ${promedio}, Redondeado: ${Math.round(promedio)}`);
                                }
                            } else {
                                // Si no hay d√≠as con ventas > 0, el promedio es 0
                                promediosPorDia[dia][producto] = 0.0;
                                
                                // Log espec√≠fico para CRIOLLITO
                                if (producto.includes('CRIOLLITO')) {
                                    console.log(`üîç CRIOLLITO PROMEDIO DEBUG - D√≠a: ${dia} - sin ventas registradas, promedio=0.0`);
                                }
                            }
                        });
                        
                            console.log(`üìä Promedios calculados para ${dia}:`, promediosPorDia[dia]);
                            if (dia === 'LUNES') {
                                console.log('üîç LUNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MARTES') {
                                console.log('üîç MARTES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'MIERCOLES') {
                                console.log('üîç MIERCOLES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'JUEVES') {
                                console.log('üîç JUEVES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'VIERNES') {
                                console.log('üîç VIERNES - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'SABADO') {
                                console.log('üîç SABADO - Promedios individuales:', promediosPorDia[dia]);
                            }
                            if (dia === 'DOMINGO') {
                                console.log('üîç DOMINGO - Promedios individuales:', promediosPorDia[dia]);
                            }
                    } else {
                        console.log(`‚ö†Ô∏è No hay datos para ${dia}`);
                    }
                });

                console.log('‚úÖ Promedios finales calculados:', promediosPorDia);
                return promediosPorDia;
            };

            const obtenerDiaSemana = (fecha) => {
                const date = new Date(fecha);
                const diaIndex = date.getDay();
                
                // Mapeo CORREGIDO seg√∫n los datos reales
                // Los datos muestran que:
                // - 2409 es S√ÅBADO (deber√≠a estar en √≠ndice 5)
                // - 1092 es DOMINGO (deber√≠a estar en √≠ndice 6)
                // - 1609 es LUNES (deber√≠a estar en √≠ndice 0)
                const mapeoDias = {
                    0: 'LUNES',    // JavaScript Sunday (0) -> LUNES (√≠ndice 0)
                    1: 'MARTES',   // JavaScript Monday (1) -> MARTES (√≠ndice 1)
                    2: 'MIERCOLES', // JavaScript Tuesday (2) -> MIERCOLES (√≠ndice 2)
                    3: 'JUEVES',   // JavaScript Wednesday (3) -> JUEVES (√≠ndice 3)
                    4: 'VIERNES',  // JavaScript Thursday (4) -> VIERNES (√≠ndice 4)
                    5: 'SABADO',   // JavaScript Friday (5) -> SABADO (√≠ndice 5)
                    6: 'DOMINGO'   // JavaScript Saturday (6) -> DOMINGO (√≠ndice 6)
                };
                
                const diaResultado = mapeoDias[diaIndex];
                console.log(`üóìÔ∏è Fecha: ${fecha}, getDay(): ${diaIndex}, Mapeado a: ${diaResultado}`);
                return diaResultado;
            };

            const calcularVentasConFormulaCorrecta = (stockAnterior, ingresoActual, stockActual) => {
                // F√≥rmula correcta: Ventas = (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                const ventas = {};
                
                if (!stockAnterior.productos || !ingresoActual.productos || !stockActual.productos) {
                    return ventas;
                }
                
                // Crear mapas de productos para f√°cil acceso
                const stockAnteriorMap = {};
                const ingresoMap = {};
                const stockActualMap = {};
                
                stockAnterior.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    stockAnteriorMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                ingresoActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    ingresoMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                stockActual.productos.forEach(producto => {
                    const nombreCompleto = producto.nombre;
                    // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                    stockActualMap[nombreCompleto] = producto.cantidad || 0;
                });
                
                // Calcular ventas para cada producto usando la f√≥rmula correcta
                const todosProductos = new Set([
                    ...Object.keys(stockAnteriorMap), 
                    ...Object.keys(ingresoMap), 
                    ...Object.keys(stockActualMap)
                ]);
                
                todosProductos.forEach(producto => {
                    const stockAnt = stockAnteriorMap[producto] || 0;
                    const ingreso = ingresoMap[producto] || 0;
                    const stockAct = stockActualMap[producto] || 0;
                    
                    // F√≥rmula: (Stock Final d√≠a anterior + Ingreso de Mercader√≠a) - Stock Final de hoy
                    const venta = (stockAnt + ingreso) - stockAct;
                    
                    // Log espec√≠fico para CRIOLLITO
                    if (producto.includes('Criollito') || producto.includes('CRIOLLITO')) {
                        console.log(`üîç CRIOLLITO DEBUG - Producto: ${producto}`);
                        console.log(`üîç CRIOLLITO DEBUG - Stock Ant: ${stockAnt}, Ingreso: ${ingreso}, Stock Act: ${stockAct}`);
                        console.log(`üîç CRIOLLITO DEBUG - Venta calculada: ${venta}`);
                        console.log(`üîç CRIOLLITO DEBUG - Stock Anterior Map keys:`, Object.keys(stockAnteriorMap));
                        console.log(`üîç CRIOLLITO DEBUG - Ingreso Map keys:`, Object.keys(ingresoMap));
                        console.log(`üîç CRIOLLITO DEBUG - Stock Actual Map keys:`, Object.keys(stockActualMap));
                    }
                    
                    // Solo incluir si hay venta positiva
                    if (venta > 0) {
                        ventas[producto] = venta;
                    }
                });
                
                return ventas;
            };

            const procesarProductos = (productos) => {
                const ventas = {};
                if (Array.isArray(productos)) {
                    productos.forEach(producto => {
                        const nombreCompleto = producto.nombre;
                        // Usar el nombre completo como en la APK, no extraer solo la parte despu√©s del " - "
                        ventas[nombreCompleto] = producto.cantidad || 0;
                    });
                }
                return ventas;
            };

            const diasSemana = ['LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB', 'DOM'];
            const diasCompletos = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
            
            const productosPorCategoria = {
                'EMPANADAS': [
                    'JQ - Jam√≥n y Queso', 'PB - Pollo BBQ', 'CS - Carne Suave', 'PO - Pollo',
                    'CP - Carne Picante', 'HU - Humita', 'ES - Espinaca', 'CQ - Calabaza y Queso',
                    'RJ - Roquefort y Jam√≥n', 'QC - Queso y Cebolla', 'CB - Cerdo y Barbacoa', 'CH - Cheeseburger'
                ],
                'PIZZAS': ['MUZZARE - Muzzarella', 'JAMON - Jam√≥n', 'PEPPERO - Pepperoni'],
                'PASTELITOS': ['BATATA - Batata', 'MEMBRIL - Membrillo'],
                'OTROS': ['DULCES - Dulces', 'CHIPA - Chipa', 'CRIOLLITO - Criollito']
            };

            if (cargando) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">üìä</div>
                            <div className="text-lg font-bold text-black">Calculando promedios...</div>
                                        </div>
                                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{backgroundColor: '#E0E0E0'}}>
                        <div className="text-center">
                            <div className="text-2xl mb-4">‚ùå</div>
                            <div className="text-lg font-bold text-red-600 mb-4">{error}</div>
                                    <button
                                onClick={onVolver}
                                className="px-4 py-2 bg-blue-500 text-white rounded"
                                    >
                                Volver
                                    </button>
                                </div>
                            </div>
                );
            }

            return (
                <div className="min-h-screen" style={{backgroundColor: '#E0E0E0', padding: '8px'}}>
                    {/* Header con bot√≥n volver */}
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={onVolver}
                            className="text-2xl font-bold text-black"
                        >
                            ‚Üê Volver
                        </button>
                        <h1 className="text-xl font-bold text-black">Promedio de Ventas</h1>
                        <div></div>
                        </div>

                    {/* Tabla de promedios - EXACTO como PromedioVentasActivity.kt */}
                    <div className="bg-white rounded-lg p-4" style={{minHeight: 'calc(100vh - 200px)'}}>
                        {/* Indicador de local - EXACTO como l√≠nea 273-280 */}
                        <div 
                            className="text-center p-2 mb-4"
                            style={{color: '#2196F3', fontSize: '16px', fontWeight: 'bold'}}
                        >
                            LOCAL: {usuario.localNombre}
                                </div>
                        
                        {/* T√≠tulo principal - EXACTO como l√≠nea 284-291 */}
                        <div 
                            className="text-center p-4 mb-4"
                            style={{color: '#4CAF50', fontSize: '24px', fontWeight: 'bold'}}
                        >
                            PROMEDIO DE VENTA POR D√çA
                                </div>
                            
                        <div className="ventas-scroll"><div className="ventas-grid">
                        {/* Header de la tabla - EXACTO como l√≠nea 305-331 */}
                        <div 
                            className="flex p-2 text-white text-xs font-bold mb-2 ventas-header"
                            style={{
                                backgroundColor: '#2196F3',
                                border: '1px solid #1976D2',
                                borderRadius: '4px 4px 0 0'
                            }}
                        >
                            <div className="p-1 border-r border-blue-300 ventas-name" style={{flex: '1.2'}}>TIPO</div>
                            {diasSemana.map((dia, index) => (
                                <div 
                                    key={dia} 
                                    className={`p-1 text-center ventas-cell ${index < diasSemana.length - 1 ? 'border-r border-blue-300' : ''}`} 
                                    style={{flex: '0.8'}}
                                >
                                    {dia}
                            </div>
                            ))}
                        </div>

                        {/* Productos por categor√≠a con iconos y separaciones */}
                        {Object.entries(productosPorCategoria).map(([categoria, productos]) => (
                            <div key={categoria}>
                                {/* Header de categor√≠a con icono - EXACTO como Ingreso de Mercader√≠a */}
                                <div 
                                    className="flex items-center justify-between p-3 text-white font-bold mb-2 mt-4"
                                    style={{
                                        backgroundColor: categoria === 'EMPANADAS' ? '#FF6B6B' : 
                                                       categoria === 'PIZZAS' ? '#4CAF50' : 
                                                       categoria === 'PASTELITOS' ? '#FF9800' : '#9C27B0',
                                        borderRadius: '8px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                    }}
                                >
                                    <span className="text-lg">
                                        {categoria === 'EMPANADAS' ? 'ü•ü' : 
                                         categoria === 'PIZZAS' ? 'üçï' : 
                                         categoria === 'PASTELITOS' ? 'ü•ß' : 'üç¨'} {categoria}
                                    </span>
                                    <span className="text-xs px-2 py-1 rounded" style={{backgroundColor: 'rgba(255,255,255,0.2)'}}>
                                        {productos.length} productos
                                    </span>
                    </div>

                                {/* Productos de la categor√≠a */}
                                <div className="mb-4" style={{backgroundColor: '#F8F9FA', borderRadius: '8px', padding: '8px'}}>
                                    {productos.map((producto, index) => {
                                        const nombre = producto.split(' - ')[1] || producto;
                                        return (
                                            <div 
                                                key={producto} 
                                                className="flex text-xs mb-1 ventas-row"
                                                style={{
                                                    backgroundColor: 'white',
                                                    border: '1px solid #E0E0E0',
                                                    borderRadius: '4px',
                                                    margin: '2px'
                                                }}
                                            >
                                                <div 
                                                    className="p-2 text-left text-black border-r border-gray-300 ventas-name" 
                                                    style={{flex: '1.2'}}
                                                >
                                                    {nombre}
                </div>
                                                {diasCompletos.map((diaCompleto, diaIndex) => {
                                                    const valor = promedios[diaCompleto]?.[producto] || 0;
                                                    
                                                    // Log para debug
                                                    if (producto.includes('CRIOLLITO')) {
                                                        console.log(`üîç CRIOLLITO - ${diaCompleto} (√≠ndice ${diaIndex}): ${valor}`);
                                                        console.log(`üîç Promedios disponibles para ${diaCompleto}:`, promedios[diaCompleto]);
                                                    }
                                                    
                                                    return (
                                                        <div 
                                                            key={diaCompleto} 
                                                            className={`p-2 text-center text-black ventas-cell ${diaIndex < diasCompletos.length - 1 ? 'border-r border-gray-300' : ''}`} 
                                                            style={{flex: '0.8'}}
                                                        >
                                                            {valor > 0 ? valor : '-'}
                </div>
            );
                                                })}
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Total de empanadas - EXACTO como l√≠nea 345-388 */}
                                    {categoria === 'EMPANADAS' && (
                                        <div 
                                            className="flex p-2 text-white text-xs font-bold mt-2"
                                            style={{
                                                backgroundColor: '#4CAF50',
                                                border: '1px solid #388E3C',
                                                borderRadius: '4px'
                                            }}
                                        >
                                            <div className="p-2 border-r border-green-300" style={{flex: '1.2'}}>TOTAL</div>
                                            {diasCompletos.map((diaCompleto, index) => {
                                                const totalDia = productos.reduce((acc, producto) => {
                                                    return acc + (promedios[diaCompleto]?.[producto] || 0);
                                                }, 0);
                                                
                                                // Log para debug del total
                                                console.log(`üîç TOTAL ${diaCompleto} (√≠ndice ${index}): ${totalDia}`);
                                                
                                                return (
                                                    <div 
                                                        key={diaCompleto} 
                                                        className={`p-2 text-center ${index < diasCompletos.length - 1 ? 'border-r border-green-300' : ''}`} 
                                                        style={{flex: '0.8'}}
                                                    >
                                                        {totalDia > 0 ? Math.round(totalDia) : '-'}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        </div></div>
                    </div>
                </div>
            );
        };

        // App Component
        function App() {
            const [usuario, setUsuario] = useState(null);
            const [loading, setLoading] = useState(true);
            const [vistaActual, setVistaActual] = useState('login');

            useEffect(() => {
                // Verificar si hay usuario guardado
                const usuarioGuardado = localStorage.getItem('usuario');
                const regionIdActual = localStorage.getItem('region_id');
                
                if (usuarioGuardado) {
                    try {
                        const usuarioData = JSON.parse(usuarioGuardado);
                        // Verificar que la regi√≥n del usuario coincida con la regi√≥n actual
                        if (usuarioData.regionId && regionIdActual && usuarioData.regionId === regionIdActual) {
                            setUsuario(usuarioData);
                            setVistaActual('main');
                        } else {
                            // Si la regi√≥n cambi√≥, limpiar el usuario guardado
                            console.log('‚ö†Ô∏è Regi√≥n cambi√≥, limpiando usuario guardado');
                            localStorage.removeItem('usuario');
                            localStorage.removeItem('loginData');
                        }
                    } catch (error) {
                        console.error('Error parseando usuario guardado:', error);
                        localStorage.removeItem('usuario');
                    }
                }
                setLoading(false);
            }, []);

            // Manejar navegaci√≥n por hash
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash;
                    console.log('üîó Hash cambiado:', hash, 'Usuario:', usuario, 'VistaActual:', vistaActual);
                    
                    // Manejar navegaci√≥n por hash
                    if (hash === '#gestion-locales') {
                        setVistaActual('gestion-locales');
                    } else if (hash === '#main' || (usuario && vistaActual === 'main')) {
                        setVistaActual('main');
                    } else if (!usuario && hash === '') {
                        setVistaActual('login');
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                handleHashChange(); // Ejecutar al cargar

                return () => window.removeEventListener('hashchange', handleHashChange);
            }, [usuario, vistaActual]);

            const handleLoginSuccess = (usuarioData) => {
                console.log('üöÄ handleLoginSuccess llamado con:', usuarioData);
                setUsuario(usuarioData);
                setVistaActual('main');
                // Cambiar hash para evitar conflicto con useEffect
                window.location.hash = '#main';
                console.log('‚úÖ Vista establecida a main, usuario:', usuarioData);
            };

            const handleLogout = () => {
                localStorage.removeItem('usuario');
                localStorage.removeItem('loginData');
                setUsuario(null);
                setVistaActual('login');
                window.location.hash = '';
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            console.log('üéØ App render - usuario:', usuario, 'vistaActual:', vistaActual);

            if (usuario && vistaActual === 'main') {
                console.log('‚úÖ Renderizando Main');
                return <Main 
                    usuario={usuario} 
                    onLogout={handleLogout} 
                    onVolverGestion={() => {
                        console.log('üîÑ Volviendo a Gesti√≥n de Locales');
                        setVistaActual('gestion-locales');
                        window.location.hash = '#gestion-locales';
                    }}
                />;
            }

            if (vistaActual === 'gestion-locales') {
                console.log('‚úÖ Renderizando GestionLocales');
                return <GestionLocales 
                    onVolver={() => {
                        console.log('üîÑ Volviendo al Login');
                        setVistaActual('login');
                        window.location.hash = '';
                    }} 
                    onLoginSuccess={handleLoginSuccess}
                />;
            }

            return <Login onLoginSuccess={handleLoginSuccess} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
<script>
// Inline Vencimientos (sin archivo externo)
(function () {
  // Utils
  const normalizar = (c) => {
    if (!c) return c;
    const up = String(c).toUpperCase();
    if (up === 'PEPPERO') return 'PEPPER';
    if (up === 'MUZZARE') return 'MUZZA';
    return up;
  };
  // Usar las funciones globales definidas arriba
  const getFechaArgentina = window.getFechaArgentina || (() => new Date());
  const getFechaActualArgentina = window.getFechaActualArgentina || (() => new Date().toISOString().split('T')[0]);
  const formatearFechaArgentina = window.formatearFechaArgentina || ((f) => f || new Date());
  const getTimestampArgentina = window.getTimestampArgentina || (() => new Date().toISOString());

  const fechaISO = (d) => {
    if (!d) d = getFechaArgentina();
    // Asegurar que trabajamos con fecha en zona horaria de Argentina
    const fechaArg = formatearFechaArgentina(d);
    const a√±o = fechaArg.getFullYear();
    const mes = String(fechaArg.getMonth() + 1).padStart(2, '0');
    const dia = String(fechaArg.getDate()).padStart(2, '0');
    return `${a√±o}-${mes}-${dia}`;
  };

  // Orden de productos igual a la APK (lista desplegable de productos del local)
  const orderCache = {};
  async function getProductosOrder(localId) {
    if (orderCache[localId]) return orderCache[localId];
    try {
      const snap = await db
        .collection('locales')
        .doc(localId)
        .collection('productos')
        .get();
      const arr = [];
      snap.forEach((d) => arr.push(d.data()?.nombre || d.id));
      const map = {};
      arr.forEach((nombre, i) => (map[normalizar(nombre)] = i));
      orderCache[localId] = map;
      return map;
    } catch (e) {
      orderCache[localId] = {};
      return {};
    }
  }

  async function getHistorial(localId, fecha) {
    try {
      if (!localId || !fecha) {
        console.warn('‚ö†Ô∏è getHistorial: localId o fecha vac√≠os', { localId, fecha });
        return { lotesIniciales: [], lotesFinales: [] };
      }
      console.log('üîç Buscando historial en: locales/' + localId + '/vencimientos_historial_diario/' + fecha);
      const doc = await db
        .collection('locales')
        .doc(localId)
        .collection('vencimientos_historial_diario')
        .doc(fecha)
        .get();
      
      if (!doc.exists) {
        console.log('üì≠ No existe registro para fecha:', fecha);
        return { lotesIniciales: [], lotesFinales: [] };
      }
      
      const data = { id: doc.id, ...doc.data() };
      console.log('‚úÖ Registro encontrado:', data);
      
      if (data) {
        data.lotesIniciales = Array.isArray(data.lotesIniciales)
          ? data.lotesIniciales.map((l) => {
              const codigoRaw = l.productoCodigo || l.codigo || '';
              return { ...l, codigo: normalizar(codigoRaw) };
            })
          : [];
        data.lotesFinales = Array.isArray(data.lotesFinales)
          ? data.lotesFinales.map((l) => {
              const codigoRaw = l.productoCodigo || l.codigo || '';
              return { ...l, codigo: normalizar(codigoRaw) };
            })
          : [];
        console.log('üì¶ Lotes iniciales:', data.lotesIniciales.length, 'Lotes finales:', data.lotesFinales.length);
      }
      return data || { lotesIniciales: [], lotesFinales: [] };
    } catch (e) {
      console.error('‚ùå Error obteniendo historial:', e);
      return { lotesIniciales: [], lotesFinales: [] };
    }
  }

  function groupAndSort(lotes, fecha, soloHoy, orderMap) {
    const byProd = {};
    lotes.forEach((l) => {
      if (soloHoy) {
        if (!l.fechaVencimiento) return;
        const f = fechaISO(new Date(l.fechaVencimiento));
        if (f !== fecha) return;
      }
      const key = l.codigo || 'DESCONOCIDO';
      (byProd[key] = byProd[key] || []).push(l);
    });
    return Object.keys(byProd)
      .sort((a, b) => {
        const ia = (orderMap && (a in orderMap)) ? orderMap[a] : Number.MAX_SAFE_INTEGER;
        const ib = (orderMap && (b in orderMap)) ? orderMap[b] : Number.MAX_SAFE_INTEGER;
        if (ia !== ib) return ia - ib;
        return a.localeCompare(b);
      })
      .map((codigo) => ({
        codigo,
        lotes: byProd[codigo].sort((a, b) => {
          const ta = a.fechaVencimiento ? new Date(a.fechaVencimiento).getTime() : 0;
          const tb = b.fechaVencimiento ? new Date(b.fechaVencimiento).getTime() : 0;
          return ta - tb;
        }),
      }));
  }

  function renderSection(container, title, groups) {
    const wrap = document.createElement('div');
    wrap.style.cssText = 'border:1px solid #e5e7eb;border-radius:6px;margin:8px 0;';
    const header = document.createElement('button');
    header.type = 'button';
    header.textContent = '‚ñ∂ ' + title;
    header.style.cssText = 'width:100%;text-align:left;background:#f3f4f6;font-weight:600;padding:8px 12px;border-bottom:1px solid #e5e7eb;cursor:pointer';
    wrap.appendChild(header);
    const content = document.createElement('div');
    content.style.cssText = 'padding:8px;display:none;';
    if (groups.length === 0) {
      const empty = document.createElement('div');
      empty.textContent = 'Sin datos';
      empty.style.cssText = 'color:#6b7280';
      content.appendChild(empty);
    } else {
      groups.forEach(({ codigo, lotes }) => {
        const card = document.createElement('div');
        card.style.cssText = 'border:1px solid #e5e7eb;border-radius:6px;margin:6px 0;';
        const head = document.createElement('div');
        head.textContent = codigo;
        head.style.cssText = 'padding:6px 10px;background:#fafafa;border-bottom:1px solid #e5e7eb;font-weight:500';
        card.appendChild(head);
        lotes.forEach((l) => {
          const row = document.createElement('div');
          row.style.cssText =
            'display:flex;justify-content:space-between;padding:6px 10px;border-bottom:1px solid #f3f4f6;font-size:14px';
          row.innerHTML = '<span>Vence: ' + (l.fechaVencimiento || '-') + '</span><span style="font-weight:600">' + (l.cantidad || 0) + '</span>';
          card.appendChild(row);
        });
        content.appendChild(card);
      });
    }
    wrap.appendChild(content);
    header.onclick = () => {
      const visible = content.style.display !== 'none';
      content.style.display = visible ? 'none' : 'block';
      header.textContent = (visible ? '‚ñ∂ ' : '‚ñº ') + title;
    };
    container.appendChild(wrap);
  }

  // Vista de STOCK Y VENCIMIENTOS ACTUALES (como StockVencimientosActivity en la APK)
  async function openStockVencimientosModal(localId, localNombre) {
    const overlay = document.createElement('div');
    overlay.style.cssText =
      'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText =
      'background:#fff;width:95%;max-width:1000px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)';
    overlay.appendChild(modal);

    const header = document.createElement('div');
    header.style.cssText =
      'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb';
    header.innerHTML =
      '<div style="font-weight:700;font-size:18px">üì¶ Stock y Vencimientos - ' + (localNombre || 'Local') + '</div>' +
      '<div style="display:flex;gap:8px">' +
      '<select id="venc-filtro" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff">' +
      '<option value="ORDEN_DEFECTO">Orden por defecto</option>' +
      '<option value="POR_VENCIMIENTO">Por vencimiento</option>' +
      '<option value="POR_CANTIDAD">Por cantidad</option>' +
      '</select>' +
      '<button id="venc-historial" style="padding:6px 12px;background:#0ea5e9;color:#fff;border:none;border-radius:6px;font-weight:600">üìÖ Historial</button>' +
      '<button id="venc-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px">Cerrar</button>' +
      '</div>';
    modal.appendChild(header);

    const body = document.createElement('div');
    body.style.cssText = 'padding:16px;overflow:auto;max-height:calc(92vh - 70px)';
    modal.appendChild(body);

    let filtroSeleccionado = 'ORDEN_DEFECTO';
    const categorias = {
      EMPANADAS: ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
      PIZZAS: ['MUZZA', 'JAMON', 'PEPPER'],
      PASTELITOS: ['BATATA', 'MEMBRIL']
    };

    async function calcularStockActual() {
      const hoy = getFechaActualArgentina();
      const fechaAyer = getFechaArgentina();
      fechaAyer.setDate(fechaAyer.getDate() - 1);
      const ayer = fechaISO(fechaAyer);
      const stockMap = {};
      try {
        const db = FirebaseRegionManager.getFirestore();
        
        // PRIMERO: Verificar si existe Stock Final de HOY (si existe, usarlo directamente)
        const stockHoy = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', hoy).where('tipo', '==', 'Stock Final').get();
        
        if (!stockHoy.empty) {
          // Si existe Stock Final de hoy, usarlo directamente (igual que en gesti√≥n de locales)
          console.log('üìä Usando Stock Final de HOY (existe)');
          stockHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        } else {
          // Si NO existe Stock Final de hoy, calcular: Stock Final de ayer + Ingreso de hoy
          console.log('üìä Calculando stock: Stock Final ayer + Ingreso hoy');
          const stockAyer = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', ayer).where('tipo', '==', 'Stock Final').get();
          stockAyer.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
          const ingresoHoy = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', hoy).where('tipo', '==', 'Ingreso de Mercader√≠a').get();
          ingresoHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = normalizar(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        }
      } catch (e) {
        console.warn('Error calculando stock:', e);
      }
      return stockMap;
    }

    async function render() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      try {
        console.log('üîç Buscando lotes para localId:', localId);
        const db = FirebaseRegionManager.getFirestore();
        const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
        console.log('üì¶ Lotes encontrados:', lotesSnap.size);
        const stockMap = await calcularStockActual();
        console.log('üìä Stock calculado:', stockMap);
        const lotes = [];
        lotesSnap.forEach(d => {
          const data = d.data();
          console.log('üìã Lote raw:', data);
          const codigoRaw = data.productoCodigo || data.codigo || '';
          lotes.push({
            id: d.id,
            codigo: normalizar(codigoRaw),
            fechaVencimiento: data.fechaVencimiento || '',
            cantidad: Number(data.cantidad) || 0,
            productoNombre: data.productoNombre || codigoRaw || ''
          });
        });
        console.log('‚úÖ Lotes normalizados:', lotes);
        if (lotes.length === 0) {
          body.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;font-size:16px">üì≠ No hay vencimientos cargados para este local<br><small style="color:#9ca3af">LocalId: ' + localId + '</small></div>';
          return;
        }
        body.innerHTML = '';
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const lotesCategoria = lotes.filter(l => codigosCategoria.includes(l.codigo));
          if (lotesCategoria.length === 0) return;
          const lotesPorProducto = {};
          lotesCategoria.forEach(l => {
            if (!lotesPorProducto[l.codigo]) lotesPorProducto[l.codigo] = [];
            lotesPorProducto[l.codigo].push(l);
          });
          let productosOrdenados = [];
          if (filtroSeleccionado === 'ORDEN_DEFECTO') {
            productosOrdenados = codigosCategoria.map(codigo => lotesPorProducto[codigo] ? [codigo, lotesPorProducto[codigo]] : null).filter(Boolean);
          } else if (filtroSeleccionado === 'POR_VENCIMIENTO') {
            productosOrdenados = Object.keys(lotesPorProducto).map(codigo => {
              const minVenc = Math.min(...lotesPorProducto[codigo].map(l => {
                try { return new Date(l.fechaVencimiento).getTime(); } catch { return Infinity; }
              }));
              return [codigo, lotesPorProducto[codigo], minVenc];
            }).sort((a, b) => a[2] - b[2]).map(([codigo, lotes]) => [codigo, lotes]);
          } else if (filtroSeleccionado === 'POR_CANTIDAD') {
            productosOrdenados = Object.keys(lotesPorProducto).map(codigo => {
              const total = lotesPorProducto[codigo].reduce((sum, l) => sum + l.cantidad, 0);
              return [codigo, lotesPorProducto[codigo], total];
            }).sort((a, b) => b[2] - a[2]).map(([codigo, lotes]) => [codigo, lotes]);
          }
          let totalCategoria = 0;
          productosOrdenados.forEach(([codigo, lotesProducto]) => {
            const stockRegistrado = stockMap[codigo];
            const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
            const stockReal = stockRegistrado != null ? stockRegistrado : sumaLotes;
            totalCategoria += stockReal;
          });
          const catDiv = document.createElement('div');
          catDiv.style.cssText = 'margin:24px 0';
          catDiv.innerHTML = '<div style="font-size:20px;font-weight:700;color:#0ea5e9;margin-bottom:8px">üìä ' + categoria + '</div>' +
            '<div style="font-size:16px;font-weight:700;color:#059669;margin-bottom:12px">üì¶ TOTAL: ' + totalCategoria + ' unidades</div>' +
            '<div style="height:2px;background:#81d4fa;margin-bottom:16px"></div>';
          body.appendChild(catDiv);
          productosOrdenados.forEach(([codigo, lotesProducto]) => {
            const stockRegistrado = stockMap[codigo];
            const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
            const stockReal = stockRegistrado != null ? stockRegistrado : sumaLotes;
            const productoNombre = lotesProducto[0]?.productoNombre || codigo;
            const prodDiv = document.createElement('div');
            prodDiv.style.cssText = 'margin:16px 0;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden';
            prodDiv.innerHTML = '<div style="background:#0ea5e9;color:#fff;font-weight:700;padding:12px 16px;font-size:15px">' + productoNombre + '</div>' +
              '<div style="padding:8px 16px;font-size:14px">   Stock actual: ' + stockReal + ' uds</div>' +
              '<div style="padding:4px 16px;font-size:14px;color:#6b7280">   Lotes con vencimiento:</div>';
            const lotesOrdenados = lotesProducto.sort((a, b) => (a.fechaVencimiento || '').localeCompare(b.fechaVencimiento || ''));
            lotesOrdenados.forEach(l => {
              const fechaVenc = new Date(l.fechaVencimiento);
              const hoy = getFechaArgentina();
              const diasHasta = Math.ceil((fechaVenc - hoy) / 86400000);
              const icono = diasHasta <= 0 ? 'üî¥' : diasHasta === 1 ? 'üü°' : diasHasta <= 3 ? 'üü†' : 'üü¢';
              const urgencia = diasHasta <= 0 ? ' (¬°HOY!)' : diasHasta === 1 ? ' (Ma√±ana)' : diasHasta <= 3 ? ' (' + diasHasta + ' d√≠as)' : '';
              const fechaDisplay = l.fechaVencimiento ? l.fechaVencimiento.split('-').reverse().slice(0, 2).join('/') : '-';
              const color = diasHasta <= 0 ? '#c62828' : diasHasta === 1 ? '#f57c00' : '#000';
              const loteDiv = document.createElement('div');
              loteDiv.style.cssText = 'padding:4px 32px;font-size:14px;color:' + color;
              loteDiv.textContent = '   ' + icono + ' ' + l.cantidad + ' uds ‚Üí Vence ' + fechaDisplay + urgencia;
              prodDiv.appendChild(loteDiv);
            });
            const coincide = sumaLotes === stockReal;
            const iconoValidacion = coincide ? '‚úÖ' : '‚ö†Ô∏è';
            const colorValidacion = coincide ? '#059669' : '#f57c00';
            const diferencia = stockReal - sumaLotes;
            prodDiv.innerHTML += '<div style="height:1px;background:#d1d5db;margin:8px 32px"></div>' +
              '<div style="padding:4px 32px;font-size:14px;font-weight:700;color:' + colorValidacion + '">   ' + iconoValidacion + ' Subtotal lotes: ' + sumaLotes + ' uds</div>' +
              (!coincide ? '<div style="padding:0 32px 8px;font-size:12px;color:#f57c00">   ‚ö†Ô∏è Diferencia: ' + (diferencia > 0 ? '+' : '') + diferencia + ' uds</div>' : '');
            body.appendChild(prodDiv);
          });
        });
      } catch (e) {
        console.error('Error renderizando:', e);
        body.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626">Error cargando datos: ' + e.message + '</div>';
      }
    }

    document.body.appendChild(overlay);
    document.addEventListener('keydown', function esc(e) {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
    });
    modal.querySelector('#venc-close').onclick = () => overlay.remove();
    modal.querySelector('#venc-filtro').onchange = (e) => {
      filtroSeleccionado = e.target.value;
      render();
    };
    modal.querySelector('#venc-historial').onclick = () => {
      overlay.remove();
      openHistorialModal(localId, localNombre);
    };
    await render();
  }

  // Historial (modal separado, llamado desde el bot√≥n dentro de Stock y Vencimientos)
  async function openHistorialModal(localId, localNombre) {
    let fecha = getFechaActualArgentina();
    let soloHoy = false;
    const overlay = document.createElement('div');
    overlay.style.cssText =
      'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText =
      'background:#fff;width:90%;max-width:900px;max-height:90vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)';
    overlay.appendChild(modal);
    const header = document.createElement('div');
    header.style.cssText =
      'display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb';
    header.innerHTML =
      '<div style="display:flex;gap:8px;align-items:center;font-weight:600">' +
      (localNombre ? (localNombre + ' ¬∑ ') : '') +
      '<button id="venc-prev" style="padding:4px 8px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px">‚óÄ</button>' +
      '<div id="venc-fecha">' + fecha + '</div>' +
      '<button id="venc-next" style="padding:4px 8px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px">‚ñ∂</button>' +
      '<label style="margin-left:10px;font-size:14px;display:flex;align-items:center;gap:6px">' +
      '<input type="checkbox" id="venc-solohoy"/> Mostrar solo los que vencen este d√≠a' +
      '</label></div>' +
      '<button id="venc-close" style="padding:6px 10px;background:#2563eb;color:#fff;border:none;border-radius:6px">Cerrar</button>';
    modal.appendChild(header);
    const body = document.createElement('div');
    body.style.cssText = 'padding:10px;overflow:auto;max-height:calc(90vh - 54px)';
    modal.appendChild(body);
    let orderMap = {};
    function render(registro) {
      body.innerHTML = '';
      const inicio = groupAndSort(registro.lotesIniciales || [], fecha, soloHoy, orderMap);
      const fin = groupAndSort(registro.lotesFinales || [], fecha, soloHoy, orderMap);
      renderSection(body, 'INICIO DEL D√çA', inicio);
      renderSection(body, 'FIN DEL D√çA', fin);
    }
    async function loadAndRender() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      if (!orderMap || Object.keys(orderMap).length === 0) {
        orderMap = await getProductosOrder(localId);
      }
      const reg = await getHistorial(localId, fecha);
      if ((!reg.lotesIniciales || reg.lotesIniciales.length === 0) && 
          (!reg.lotesFinales || reg.lotesFinales.length === 0)) {
        body.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;font-size:16px">üì≠ No hay datos hist√≥ricos para el ' + fecha + '</div>';
      } else {
        render(reg);
      }
      modal.querySelector('#venc-fecha').textContent = fecha;
    }
    document.body.appendChild(overlay);
    document.addEventListener('keydown', function esc(e) {
      if (e.key === 'Escape') {
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
    });
    modal.querySelector('#venc-close').onclick = () => overlay.remove();
    modal.querySelector('#venc-prev').onclick = () => {
      const [y, m, d] = fecha.split('-').map(Number);
      const dObj = new Date(y, m - 1, d);
      dObj.setDate(dObj.getDate() - 1);
      fecha = fechaISO(dObj);
      loadAndRender();
    };
    modal.querySelector('#venc-next').onclick = () => {
      const [y, m, d] = fecha.split('-').map(Number);
      const dObj = new Date(y, m - 1, d);
      dObj.setDate(dObj.getDate() + 1);
      fecha = fechaISO(dObj);
      loadAndRender();
    };
    modal.querySelector('#venc-solohoy').onchange = (e) => {
      soloHoy = e.target.checked;
      loadAndRender();
    };
    await loadAndRender();
  }

  // Vista de Vencimientos para LOCAL (carga/edici√≥n de lotes) - igual que VencimientosActivity.kt
  async function openVencLocalModal() {
    const u = localStorage.getItem('usuario');
    if (!u) {
      alert('Inicie sesi√≥n primero.');
      return;
    }
    const usuario = JSON.parse(u);
    const localId = usuario.localId || '';
    const localNombre = usuario.localNombre || 'Local';
    
    if (!localId) {
      alert('Error: No se encontr√≥ el local');
      return;
    }

    const productos = {
      'JQ': 'JQ - Jam√≥n y Queso',
      'PB': 'PB - Pollo BBQ',
      'CS': 'CS - Carne Suave',
      'PO': 'PO - Pollo',
      'CP': 'CP - Carne Picante',
      'HU': 'HU - Humita',
      'ES': 'ES - Espinaca',
      'CQ': 'CQ - Calabaza y Queso',
      'RJ': 'RJ - Roquefort y Jam√≥n',
      'QC': 'QC - Queso y Cebolla',
      'CB': 'CB - Cerdo y Barbacoa',
      'CH': 'CH - Cheeseburger',
      'MUZZA': 'Pizza Muzzarella',
      'JAMON': 'Pizza Jam√≥n',
      'PEPPER': 'Pizza Pepperoni',
      'BATATA': 'Pastelito Batata',
      'MEMBRIL': 'Pastelito Membrillo'
    };

    const categorias = {
      'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
      'PIZZAS': ['MUZZA', 'JAMON', 'PEPPER'],
      'PASTELITOS': ['BATATA', 'MEMBRIL']
    };

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;width:95%;max-width:1000px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column';
    overlay.appendChild(modal);

    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb';
    header.innerHTML = '<div style="font-weight:700;font-size:18px">üìÖ Vencimientos - ' + localNombre + '</div><button id="vloc-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px">Cerrar</button>';
    modal.appendChild(header);

    const body = document.createElement('div');
    body.style.cssText = 'display:flex;flex-direction:column;gap:12px;padding:12px;overflow-y:auto;max-height:calc(92vh - 60px)';
    modal.appendChild(body);

    const colLeft = document.createElement('div');
    colLeft.style.cssText = 'width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:12px;overflow-y:visible';
    const colRight = document.createElement('div');
    colRight.style.cssText = 'width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:12px;overflow-y:visible';
    body.appendChild(colLeft);
    body.appendChild(colRight);

    let fechaVencimientoSeleccionada = '';
    const hoy = getFechaArgentina();
    hoy.setDate(hoy.getDate() + 1);
    fechaVencimientoSeleccionada = fechaISO(hoy);

    colLeft.innerHTML = '<div style="font-weight:600;margin-bottom:12px;font-size:16px">Agregar Lote</div>' +
      '<div style="display:grid;gap:10px">' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Producto</label>' +
      '<div style="display:flex;gap:4px;align-items:center">' +
      '<button id="vl-prod-prev" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:16px;line-height:1">‚ñ≤</button>' +
      '<select id="vl-prod" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px"></select>' +
      '<button id="vl-prod-next" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:16px;line-height:1">‚ñº</button>' +
      '</div></div>' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Fecha de Vencimiento</label>' +
      '<div style="display:flex;gap:4px;align-items:center"><button id="vl-fecha-prev" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px">‚óÄ</button>' +
      '<button id="vl-fecha-btn" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;background:#fff;text-align:center;font-size:14px">üìÖ Seleccionar Fecha</button>' +
      '<button id="vl-fecha-next" style="padding:6px 10px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px">‚ñ∂</button></div>' +
      '<input type="date" id="vl-fecha" style="display:none"/></div>' +
      '<div><label style="font-size:13px;color:#374151;display:block;margin-bottom:4px">Cantidad</label>' +
      '<input type="number" min="1" id="vl-cant" placeholder="0" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px"/></div>' +
      '<button id="vl-add" style="padding:10px;background:#10b981;color:#fff;border:none;border-radius:6px;font-weight:600;font-size:14px">Agregar Lote</button>' +
      '<div id="vl-msg" style="font-size:12px;min-height:20px"></div></div>';

    colRight.innerHTML = '<div style="font-weight:600;margin-bottom:12px;font-size:16px">Lotes Cargados</div><div id="vl-list"></div><div id="vl-whatsapp-container" style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb"></div>';

    function actualizarTextoFecha() {
      try {
        const [y, m, d] = fechaVencimientoSeleccionada.split('-').map(Number);
        const fechaObj = new Date(y, m - 1, d);
        const fechaDisplay = fechaObj.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        colLeft.querySelector('#vl-fecha-btn').textContent = 'üìÖ Vence: ' + fechaDisplay;
        colLeft.querySelector('#vl-fecha').value = fechaVencimientoSeleccionada;
      } catch (e) {
        colLeft.querySelector('#vl-fecha-btn').textContent = 'üìÖ Seleccionar Fecha';
      }
    }

    function cambiarFecha(dias) {
      try {
        const [y, m, d] = fechaVencimientoSeleccionada.split('-').map(Number);
        const fechaObj = new Date(y, m - 1, d);
        fechaObj.setDate(fechaObj.getDate() + dias);
        fechaVencimientoSeleccionada = fechaISO(fechaObj);
        actualizarTextoFecha();
      } catch (e) {
        console.error('Error cambiando fecha:', e);
      }
    }

    function obtenerCodigoProducto(nombre) {
      // Extraer c√≥digo del nombre (formato: "JQ - Jam√≥n y Queso" -> "JQ")
      let codigo = '';
      if (nombre && nombre.includes(' - ')) {
        codigo = nombre.split(' - ')[0].trim();
      } else if (nombre && nombre.startsWith('Pizza ')) {
        if (nombre.includes('Muzzarella')) codigo = 'MUZZA';
        else if (nombre.includes('Jam√≥n')) codigo = 'JAMON';
        else if (nombre.includes('Pepperoni')) codigo = 'PEPPER';
        else codigo = nombre;
      } else if (nombre && nombre.startsWith('Pastelito ')) {
        if (nombre.includes('Batata')) codigo = 'BATATA';
        else if (nombre.includes('Membrillo')) codigo = 'MEMBRIL';
        else codigo = nombre;
      } else {
        codigo = nombre || '';
      }
      return normalizar(codigo);
    }

    async function calcularStockActual() {
      const hoy = getFechaActualArgentina();
      const fechaAyer = getFechaArgentina();
      fechaAyer.setDate(fechaAyer.getDate() - 1);
      const ayer = fechaISO(fechaAyer);
      const stockMap = {};
      try {
        const db = FirebaseRegionManager.getFirestore();
        
        // PRIMERO: Verificar si existe Stock Final de HOY (si existe, usarlo directamente)
        const stockHoy = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', hoy).where('tipo', '==', 'Stock Final').get();
        
        if (!stockHoy.empty) {
          // Si existe Stock Final de hoy, usarlo directamente (igual que en gesti√≥n de locales)
          console.log('üìä [VencLocalModal] Usando Stock Final de HOY (existe)');
          stockHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        } else {
          // Si NO existe Stock Final de hoy, calcular: Stock Final de ayer + Ingreso de hoy
          console.log('üìä [VencLocalModal] Calculando stock: Stock Final ayer + Ingreso hoy');
          const stockAyer = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', ayer).where('tipo', '==', 'Stock Final').get();
          stockAyer.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
          const ingresoHoy = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', hoy).where('tipo', '==', 'Ingreso de Mercader√≠a').get();
          ingresoHoy.forEach(d => {
            const productos = d.data().productos || [];
            productos.forEach(p => {
              const codigo = obtenerCodigoProducto(p.nombre || p.codigo || '');
              stockMap[codigo] = (stockMap[codigo] || 0) + (Number(p.cantidad) || 0);
            });
          });
        }
      } catch (e) {
        console.warn('Error calculando stock:', e);
      }
      return stockMap;
    }

    async function renderProductos() {
      const sel = colLeft.querySelector('#vl-prod');
      sel.innerHTML = '';
      Object.entries(productos).forEach(([codigo, nombre]) => {
        const opt = document.createElement('option');
        opt.value = codigo;
        opt.textContent = nombre;
        sel.appendChild(opt);
      });
    }

    function cambiarProducto(direccion) {
      const sel = colLeft.querySelector('#vl-prod');
      const opciones = Array.from(sel.options);
      const indiceActual = sel.selectedIndex;
      let nuevoIndice = indiceActual + direccion;
      
      if (nuevoIndice < 0) {
        nuevoIndice = opciones.length - 1; // Ir al √∫ltimo
      } else if (nuevoIndice >= opciones.length) {
        nuevoIndice = 0; // Ir al primero
      }
      
      sel.selectedIndex = nuevoIndice;
      actualizarCantidadFaltante();
    }

    async function actualizarCantidadFaltante() {
      const sel = colLeft.querySelector('#vl-prod');
      const codigo = sel.value;
      if (!codigo) return;

      try {
        const stockMap = await calcularStockActual();
        const codigoNorm = normalizar(codigo);
        const stockActual = stockMap[codigoNorm] || 0;

        // Calcular cu√°nto ya est√° lotado
        const db = FirebaseRegionManager.getFirestore();
        const lotesSnap = await db.collection('locales').doc(localId).collection('vencimientos_activos').get();
        let cantidadLoteada = 0;
        lotesSnap.forEach(d => {
          const data = d.data();
          const codigoLote = normalizar(data.productoCodigo || data.codigo || '');
          if (codigoLote === codigoNorm) {
            cantidadLoteada += Number(data.cantidad) || 0;
          }
        });

        // Calcular lo que falta lotear
        const faltante = Math.max(0, stockActual - cantidadLoteada);
        
        // Actualizar el campo cantidad solo si hay stock y falta lotear
        const campoCantidad = colLeft.querySelector('#vl-cant');
        if (faltante > 0) {
          campoCantidad.value = faltante;
        } else {
          campoCantidad.value = '';
        }
      } catch (e) {
        console.warn('Error calculando cantidad faltante:', e);
      }
    }

    async function renderLotes() {
      const list = colRight.querySelector('#vl-list');
      list.innerHTML = '';
      try {
        const db = FirebaseRegionManager.getFirestore();
        const [lotesSnap, stockMap] = await Promise.all([
          db.collection('locales').doc(localId).collection('vencimientos_activos').get(),
          calcularStockActual()
        ]);
        const lotes = [];
        lotesSnap.forEach(d => {
          const data = d.data();
          lotes.push({
            id: d.id,
            codigo: normalizar(data.productoCodigo || data.codigo || ''),
            fechaVencimiento: data.fechaVencimiento || '',
            cantidad: Number(data.cantidad) || 0,
            productoNombre: data.productoNombre || productos[data.productoCodigo] || data.codigo || ''
          });
        });

        const lotesPorProducto = {};
        lotes.forEach(l => {
          if (!lotesPorProducto[l.codigo]) lotesPorProducto[l.codigo] = [];
          lotesPorProducto[l.codigo].push(l);
        });

        // Lista de productos que forman parte del control de vencimientos
        const productosVencimientos = [
          'JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH', // Empanadas
          'MUZZA', 'JAMON', 'PEPPER', // Pizzas
          'BATATA', 'MEMBRIL' // Pastelitos
        ];
        const productosVencimientosNormalizados = productosVencimientos.map(c => normalizar(c));

        // Filtrar solo productos que forman parte del control de vencimientos
        const productosConStockSinLotes = {};
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          // Solo considerar productos que est√°n en la lista de vencimientos
          if (productosVencimientosNormalizados.includes(codigoNorm)) {
            if (stockMap[codigo] > 0 && (!lotesPorProducto[codigoNorm] || lotesPorProducto[codigoNorm].length === 0)) {
              productosConStockSinLotes[codigoNorm] = stockMap[codigo];
            }
          }
        });

        // Verificar si hay productos con lotes
        let hayProductosConLotes = false;
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const lotesCategoria = lotes.filter(l => codigosCategoria.includes(l.codigo));
          if (lotesCategoria.length > 0) {
            hayProductosConLotes = true;
          }
        });

        // Verificar si todos los productos con stock tienen lotes y coinciden (solo productos de vencimientos)
        let todosEnOrden = true;
        let hayProductosVencimientosConStock = false;
        Object.keys(stockMap).forEach(codigo => {
          const codigoNorm = normalizar(codigo);
          // Solo considerar productos que est√°n en la lista de vencimientos
          if (productosVencimientosNormalizados.includes(codigoNorm) && stockMap[codigo] > 0) {
            hayProductosVencimientosConStock = true;
            const lotesProducto = lotesPorProducto[codigoNorm] || [];
            if (lotesProducto.length === 0) {
              todosEnOrden = false;
            } else {
              const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
              if (sumaLotes !== stockMap[codigo]) {
                todosEnOrden = false;
              }
            }
          }
        });

        // PRIMERO: Mostrar mensaje "TODO EN ORDEN" si no hay productos con stock sin lotes y todo coincide
        if (Object.keys(productosConStockSinLotes).length === 0 && hayProductosConLotes && hayProductosVencimientosConStock && todosEnOrden) {
          const okDiv = document.createElement('div');
          okDiv.style.cssText = 'background:#059669;color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:16px;font-weight:700;font-size:14px;text-align:center';
          okDiv.textContent = '‚úÖ TODO EN ORDEN - Todos los productos con stock tienen lotes cargados';
          list.appendChild(okDiv);
          const sep = document.createElement('div');
          sep.style.cssText = 'height:8px';
          list.appendChild(sep);
        }

        // SEGUNDO: Mostrar advertencia solo si hay productos con stock sin lotes
        if (Object.keys(productosConStockSinLotes).length > 0) {
          const advDiv = document.createElement('div');
          advDiv.style.cssText = 'background:#dc2626;color:#fff;padding:12px;border-radius:6px;margin-bottom:16px;font-weight:700;font-size:14px';
          advDiv.textContent = '‚ö†Ô∏è PRODUCTOS CON STOCK SIN LOTES CARGADOS';
          list.appendChild(advDiv);

          Object.keys(categorias).forEach(categoria => {
            const codigosCategoria = categorias[categoria];
            let hayProductos = false;
            codigosCategoria.forEach(codigo => {
              const codigoNorm = normalizar(codigo);
              if (productosConStockSinLotes[codigoNorm]) hayProductos = true;
            });
            if (hayProductos) {
              const catDiv = document.createElement('div');
              catDiv.style.cssText = 'margin:8px 0';
              catDiv.innerHTML = '<div style="font-size:15px;font-weight:700;color:#f57c00;margin:8px 0">üìä ' + categoria + '</div>';
              codigosCategoria.forEach(codigo => {
                const codigoNorm = normalizar(codigo);
                const stock = productosConStockSinLotes[codigoNorm];
                if (stock) {
                  const prodDiv = document.createElement('div');
                  prodDiv.style.cssText = 'margin:8px 0;border:1px solid #dc2626;border-radius:6px;overflow:hidden';
                  prodDiv.innerHTML = '<div style="background:#dc2626;color:#fff;font-weight:700;padding:8px 12px;font-size:14px">' + (productos[codigo] || codigo) + '</div>' +
                    '<div style="padding:8px 12px;font-size:12px;font-weight:700;color:#dc2626;background:#fee2e2">‚ö†Ô∏è Stock: ' + stock + ' uds | Lotes: 0 uds | FALTAN CARGAR LOTES</div>';
                  catDiv.appendChild(prodDiv);
                }
              });
              list.appendChild(catDiv);
            }
          });
          const sep = document.createElement('div');
          sep.style.cssText = 'height:16px';
          list.appendChild(sep);
        }

        // TERCERO: Mostrar productos con lotes
        Object.keys(categorias).forEach(categoria => {
          const codigosCategoria = categorias[categoria];
          const lotesCategoria = lotes.filter(l => codigosCategoria.includes(l.codigo));
          if (lotesCategoria.length > 0) {
            const catDiv = document.createElement('div');
            catDiv.style.cssText = 'margin:16px 0';
            catDiv.innerHTML = '<div style="font-size:18px;font-weight:700;color:#0ea5e9;margin:8px 0">üìä ' + categoria + '</div>';
            codigosCategoria.forEach(codigo => {
              const codigoNorm = normalizar(codigo);
              const lotesProducto = lotesPorProducto[codigoNorm] || [];
              if (lotesProducto.length > 0) {
                const sumaLotes = lotesProducto.reduce((sum, l) => sum + l.cantidad, 0);
                // Buscar stock usando el c√≥digo normalizado (igual que en la APK)
                const stockActual = stockMap[codigoNorm] || null;
                const coincide = stockActual != null && sumaLotes === stockActual;
                const diferencia = stockActual != null ? stockActual - sumaLotes : null;
                const prodDiv = document.createElement('div');
                prodDiv.style.cssText = 'margin:8px 0;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden';
                let validacionText = '';
                let validacionColor = '#6b7280';
                if (stockActual == null) {
                  validacionText = '‚ÑπÔ∏è Lotes: ' + sumaLotes + ' uds (sin comparar - no hay stock registrado a√∫n)';
                } else if (coincide) {
                  validacionText = '‚úÖ Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds (Coincide)';
                  validacionColor = '#059669';
                } else if (diferencia > 0) {
                  validacionText = '‚ö†Ô∏è Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds | Faltan: +' + diferencia + ' uds';
                  validacionColor = '#f57c00';
                } else {
                  validacionText = '‚ö†Ô∏è Stock: ' + stockActual + ' uds | Lotes: ' + sumaLotes + ' uds | Sobran: ' + (-diferencia) + ' uds';
                  validacionColor = '#dc2626';
                }
                prodDiv.innerHTML = '<div style="background:#0ea5e9;color:#fff;font-weight:700;padding:8px 12px;font-size:14px">' + lotesProducto[0].productoNombre + '</div>' +
                  '<div style="padding:4px 12px;font-size:12px;font-weight:700;color:' + validacionColor + '">   ' + validacionText + '</div>';
                const lotesOrdenados = lotesProducto.sort((a, b) => (a.fechaVencimiento || '').localeCompare(b.fechaVencimiento || ''));
                lotesOrdenados.forEach(l => {
                  const fechaVenc = new Date(l.fechaVencimiento);
              const hoy = getFechaArgentina();
              const diasHasta = Math.ceil((fechaVenc - hoy) / 86400000);
                  const icono = diasHasta <= 0 ? 'üî¥' : diasHasta === 1 ? 'üü°' : 'üü¢';
                  const urgencia = diasHasta <= 0 ? ' (¬°HOY!)' : diasHasta === 1 ? ' (Ma√±ana)' : '';
                  const fechaDisplay = l.fechaVencimiento ? l.fechaVencimiento.split('-').reverse().slice(0, 2).join('/') : '-';
                  const fila = document.createElement('div');
                  fila.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:4px 24px;font-size:14px';
                  fila.innerHTML = '<span>' + icono + ' ' + l.cantidad + ' uds ‚Üí ' + fechaDisplay + urgencia + '</span>' +
                    '<button data-lote-id="' + l.id + '" style="padding:4px 8px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px">‚ùå</button>';
                  prodDiv.appendChild(fila);
                });
                catDiv.appendChild(prodDiv);
              }
            });
            list.appendChild(catDiv);
          }
        });

        if (!hayProductosConLotes && Object.keys(productosConStockSinLotes).length === 0) {
          const empty = document.createElement('div');
          empty.style.cssText = 'text-align:center;padding:40px;color:#6b7280;font-size:14px';
          empty.textContent = 'No hay lotes cargados';
          list.appendChild(empty);
        }

        // Actualizar bot√≥n de WhatsApp despu√©s de renderizar lotes
        actualizarBotonWhatsApp(lotes);

        list.querySelectorAll('[data-lote-id]').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('¬øEliminar este lote?')) return;
            try {
              const db = FirebaseRegionManager.getFirestore();
              await db.collection('locales').doc(localId).collection('vencimientos_activos').doc(btn.getAttribute('data-lote-id')).delete();
              await renderLotes();
              // Actualizar cantidad faltante despu√©s de eliminar el lote
              await actualizarCantidadFaltante();
            } catch (e) {
              alert('Error al eliminar lote: ' + e.message);
            }
          };
        });
      } catch (e) {
        console.error('Error renderizando lotes:', e);
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626">Error cargando lotes: ' + e.message + '</div>';
      }
    }

    function actualizarBotonWhatsApp(lotes) {
      const container = colRight.querySelector('#vl-whatsapp-container');
      container.innerHTML = '';
      
      if (!lotes || lotes.length === 0) {
        return;
      }

      const btn = document.createElement('button');
      btn.style.cssText = 'width:100%;padding:12px;background:#25D366;color:#fff;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px';
      btn.innerHTML = 'üì± Enviar Informe por WhatsApp';
      btn.onclick = () => generarInformeWhatsApp(lotes);
      container.appendChild(btn);
    }

    function generarInformeWhatsApp(lotes) {
      const hoy = getFechaActualArgentina();
      const fechaHoy = new Date(hoy + 'T00:00:00');
      const fechaManana = new Date(fechaHoy);
      fechaManana.setDate(fechaManana.getDate() + 1);
      
      const hoyStr = fechaISO(fechaHoy);
      const mananaStr = fechaISO(fechaManana);
      
      const vencimientosHoy = [];
      const vencimientosManana = [];
      const vencimientosProximos = [];
      
      lotes.forEach(lote => {
        if (!lote.fechaVencimiento) return;
        
        const fechaVenc = new Date(lote.fechaVencimiento + 'T00:00:00');
        const fechaVencStr = fechaISO(fechaVenc);
        const diasHasta = Math.floor((fechaVenc - fechaHoy) / (1000 * 60 * 60 * 24));
        
        const item = {
          nombre: lote.productoNombre || productos[lote.codigo] || lote.codigo || 'Producto',
          cantidad: lote.cantidad,
          fecha: lote.fechaVencimiento.split('-').reverse().slice(0, 2).join('/'),
          dias: diasHasta
        };
        
        if (fechaVencStr === hoyStr) {
          vencimientosHoy.push(item);
        } else if (fechaVencStr === mananaStr) {
          vencimientosManana.push(item);
        } else if (diasHasta > 1 && diasHasta <= 7) {
          vencimientosProximos.push(item);
        }
      });
      
      // Ordenar pr√≥ximos por fecha
      vencimientosProximos.sort((a, b) => a.dias - b.dias);
      
      // Calcular totales
      const totalHoy = vencimientosHoy.reduce((sum, v) => sum + v.cantidad, 0);
      const totalManana = vencimientosManana.reduce((sum, v) => sum + v.cantidad, 0);
      
      // Construir mensaje usando s√≠mbolos ASCII que siempre funcionan
      let mensaje = '*INFORME DE VENCIMIENTOS*\n';
      mensaje += 'Local: ' + (localNombre || 'Local') + '\n';
      mensaje += 'Fecha: ' + fechaHoy.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + '\n\n';
      
      if (vencimientosHoy.length > 0) {
        mensaje += '>>> *VENCEN HOY (URGENTE):*\n';
        vencimientosHoy.forEach(v => {
          mensaje += '  ‚Ä¢ ' + v.nombre + ': ' + v.cantidad + ' uds\n';
        });
        mensaje += '\n';
      }
      
      if (vencimientosManana.length > 0) {
        mensaje += '>>> *VENCEN MA√ëANA (ATENCION):*\n';
        vencimientosManana.forEach(v => {
          mensaje += '  ‚Ä¢ ' + v.nombre + ': ' + v.cantidad + ' uds\n';
        });
        mensaje += '\n';
      }
      
      if (vencimientosProximos.length > 0) {
        mensaje += '>>> *PROXIMOS VENCIMIENTOS (7 dias):*\n';
        vencimientosProximos.forEach(v => {
          mensaje += '  ‚Ä¢ ' + v.nombre + ': ' + v.cantidad + ' uds (vence ' + v.fecha + ')\n';
        });
        mensaje += '\n';
      }
      
      if (vencimientosHoy.length === 0 && vencimientosManana.length === 0 && vencimientosProximos.length === 0) {
        mensaje += 'OK - No hay vencimientos proximos en los proximos 7 dias.\n\n';
      }
      
      mensaje += '================================\n';
      if (totalHoy > 0) mensaje += 'TOTAL vencen hoy: ' + totalHoy + ' uds\n';
      if (totalManana > 0) mensaje += 'TOTAL vencen manana: ' + totalManana + ' uds\n';
      
      // Funci√≥n para escapar HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Mostrar modal de vista previa
      const previewOverlay = document.createElement('div');
      previewOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10000';
      const previewModal = document.createElement('div');
      previewModal.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:20px;max-height:80vh;overflow:auto';
      
      const previewTitle = document.createElement('div');
      previewTitle.style.cssText = 'font-weight:700;font-size:18px;margin-bottom:16px';
      previewTitle.textContent = 'Vista Previa del Mensaje';
      
      const previewContent = document.createElement('div');
      previewContent.style.cssText = 'background:#f9fafb;padding:16px;border-radius:6px;font-family:monospace;white-space:pre-wrap;font-size:14px;line-height:1.6;border:1px solid #e5e7eb;word-wrap:break-word';
      previewContent.textContent = mensaje;
      
      const previewButtons = document.createElement('div');
      previewButtons.style.cssText = 'display:flex;gap:8px;margin-top:16px';
      
      const btnCopy = document.createElement('button');
      btnCopy.id = 'preview-copy';
      btnCopy.style.cssText = 'flex:1;padding:10px;background:#10b981;color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer';
      btnCopy.textContent = 'Copiar y Abrir WhatsApp';
      
      const btnCancel = document.createElement('button');
      btnCancel.id = 'preview-cancel';
      btnCancel.style.cssText = 'padding:10px;background:#6b7280;color:#fff;border:none;border-radius:6px;cursor:pointer';
      btnCancel.textContent = 'Cancelar';
      
      previewButtons.appendChild(btnCopy);
      previewButtons.appendChild(btnCancel);
      
      previewModal.appendChild(previewTitle);
      previewModal.appendChild(previewContent);
      previewModal.appendChild(previewButtons);
      previewOverlay.appendChild(previewModal);
      document.body.appendChild(previewOverlay);
      
      previewOverlay.querySelector('#preview-cancel').onclick = () => previewOverlay.remove();
      previewOverlay.querySelector('#preview-copy').onclick = () => {
        // Copiar mensaje al portapapeles
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(mensaje).then(() => {
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          }).catch(() => {
            alert('Error copiando al portapapeles. Abriendo WhatsApp...');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          });
        } else {
          // Fallback
          const textarea = document.createElement('textarea');
          textarea.value = mensaje;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          } catch (e) {
            alert('Error copiando. Abriendo WhatsApp...');
            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            previewOverlay.remove();
          }
          document.body.removeChild(textarea);
        }
      };
    }

    header.querySelector('#vloc-close').onclick = () => overlay.remove();
    colLeft.querySelector('#vl-prod-prev').onclick = () => cambiarProducto(-1);
    colLeft.querySelector('#vl-prod-next').onclick = () => cambiarProducto(1);
    colLeft.querySelector('#vl-prod').onchange = () => actualizarCantidadFaltante();
    colLeft.querySelector('#vl-fecha-prev').onclick = () => cambiarFecha(-1);
    colLeft.querySelector('#vl-fecha-next').onclick = () => cambiarFecha(1);
    colLeft.querySelector('#vl-fecha-btn').onclick = () => colLeft.querySelector('#vl-fecha').showPicker();
    colLeft.querySelector('#vl-fecha').onchange = (e) => {
      fechaVencimientoSeleccionada = e.target.value;
      actualizarTextoFecha();
    };
    colLeft.querySelector('#vl-add').onclick = async () => {
      const codigo = colLeft.querySelector('#vl-prod').value;
      const fecha = fechaVencimientoSeleccionada;
      const cant = parseInt(colLeft.querySelector('#vl-cant').value);
      const msg = colLeft.querySelector('#vl-msg');
      if (!codigo || !fecha || !cant || cant <= 0) {
        msg.style.color = '#dc2626';
        msg.textContent = 'Complete producto, fecha y cantidad v√°lida';
        return;
      }
      try {
        const fechaActual = getFechaActualArgentina();
        const nuevoLote = {
          id: Date.now().toString(36) + Math.random().toString(36).substr(2),
          localId: localId,
          productoCodigo: codigo,
          productoNombre: productos[codigo] || codigo,
          cantidad: cant,
          cantidadInicial: cant,
          fechaVencimiento: fecha,
          fechaCarga: fechaActual,
          timestamp: Date.now()
        };
        const db = FirebaseRegionManager.getFirestore();
        await db.collection('locales').doc(localId).collection('vencimientos_activos').doc(nuevoLote.id).set(nuevoLote);
        msg.style.color = '#059669';
        msg.textContent = 'Lote agregado exitosamente';
        await renderLotes();
        // Actualizar cantidad faltante despu√©s de agregar el lote
        await actualizarCantidadFaltante();
      } catch (e) {
        msg.style.color = '#dc2626';
        msg.textContent = 'Error: ' + e.message;
      }
    };

    document.body.appendChild(overlay);
    actualizarTextoFecha();
    await renderProductos();
    await renderLotes();
    // Actualizar cantidad faltante para el producto seleccionado por defecto
    await actualizarCantidadFaltante();
  }

  // ============================================
  // SISTEMA DE PEDIDO A F√ÅBRICA
  // ============================================

  // Modelos de datos
  const productosFabrica = {
    'JQ': { codigo: 'JQ', nombre: 'JQ - Jam√≥n y Queso', categoria: 'EMPANADAS' },
    'PB': { codigo: 'PB', nombre: 'PB - Pollo BBQ', categoria: 'EMPANADAS' },
    'CS': { codigo: 'CS', nombre: 'CS - Carne Suave', categoria: 'EMPANADAS' },
    'PO': { codigo: 'PO', nombre: 'PO - Pollo', categoria: 'EMPANADAS' },
    'CP': { codigo: 'CP', nombre: 'CP - Carne Picante', categoria: 'EMPANADAS' },
    'HU': { codigo: 'HU', nombre: 'HU - Humita', categoria: 'EMPANADAS' },
    'ES': { codigo: 'ES', nombre: 'ES - Espinaca', categoria: 'EMPANADAS' },
    'CQ': { codigo: 'CQ', nombre: 'CQ - Calabaza y Queso', categoria: 'EMPANADAS' },
    'RJ': { codigo: 'RJ', nombre: 'RJ - Roquefort y Jam√≥n', categoria: 'EMPANADAS' },
    'QC': { codigo: 'QC', nombre: 'QC - Queso y Cebolla', categoria: 'EMPANADAS' },
    'CB': { codigo: 'CB', nombre: 'CB - Cerdo y Barbacoa', categoria: 'EMPANADAS' },
    'CH': { codigo: 'CH', nombre: 'CH - Cheeseburger', categoria: 'EMPANADAS' },
    'MUZZARE': { codigo: 'MUZZARE', nombre: 'Pizza Muzzarella', categoria: 'PIZZAS' },
    'JAMON': { codigo: 'JAMON', nombre: 'Pizza Jam√≥n', categoria: 'PIZZAS' },
    'PEPPERO': { codigo: 'PEPPERO', nombre: 'Pizza Pepperoni', categoria: 'PIZZAS' },
    'BATATA': { codigo: 'BATATA', nombre: 'Pastelito Batata', categoria: 'PASTELITOS' },
    'MEMBRIL': { codigo: 'MEMBRIL', nombre: 'Pastelito Membrillo', categoria: 'PASTELITOS' },
    'DULCES': { codigo: 'DULCES', nombre: 'Medialuna Dulce', categoria: 'OTROS' },
    'CHIPA': { codigo: 'CHIPA', nombre: 'Medialuna Chipa', categoria: 'OTROS' },
    'CRIOLLITO': { codigo: 'CRIOLLITO', nombre: 'Criollito', categoria: 'OTROS' }
  };

  const ordenProductos = [
    'JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH',
    'MUZZARE', 'JAMON', 'PEPPERO',
    'BATATA', 'MEMBRIL',
    'DULCES', 'CHIPA', 'CRIOLLITO'
  ];

  const categorias = {
    'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
    'PIZZAS': ['MUZZARE', 'JAMON', 'PEPPERO'],
    'PASTELITOS': ['BATATA', 'MEMBRIL'],
    'OTROS': ['DULCES', 'CHIPA', 'CRIOLLITO']
  };

  // Funci√≥n principal para abrir el modal de Pedido a F√°brica
  async function openPedidoFabricaModal() {
    const u = localStorage.getItem('usuario');
    if (!u) {
      alert('Inicie sesi√≥n primero.');
      return;
    }
    const usuario = JSON.parse(u);
    const localId = usuario.localId || '';
    const localNombre = usuario.localNombre || 'Local';
    
    if (!localId) {
      alert('Error: No se encontr√≥ el local');
      return;
    }
    
    // Verificar que Firebase est√© inicializado, si no, inicializarlo con la regi√≥n guardada
    try {
      FirebaseRegionManager.getFirestore();
    } catch (e) {
      // Firebase no est√° inicializado, intentar inicializarlo con la regi√≥n guardada
      const regionIdGuardada = localStorage.getItem('region_id');
      if (regionIdGuardada && usuario.regionId) {
        try {
          // Cargar regiones disponibles
          const regiones = await FirebaseRegionManager.cargarRegiones();
          const regionGuardada = regiones.find(r => r.id === regionIdGuardada || r.id === usuario.regionId);
          if (regionGuardada) {
            FirebaseRegionManager.initializeFirebase(regionGuardada);
            console.log('Firebase inicializado para Pedido a F√°brica con regi√≥n:', regionGuardada.nombre);
          } else {
            throw new Error('No se encontr√≥ la regi√≥n guardada');
          }
        } catch (error) {
          console.error('Error inicializando Firebase:', error);
          alert('Error: No se pudo inicializar Firebase. Por favor, selecciona una regi√≥n primero.');
          return;
        }
      } else {
        alert('Error: No se encontr√≥ la regi√≥n. Por favor, selecciona una regi√≥n primero.');
        return;
      }
    }

    // Obtener fecha actual (Argentina UTC-3)
    const hoy = new Date();
    const offsetArgentina = -3 * 60; // UTC-3 en minutos
    const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
    let fechaSeleccionada = fechaISO(fechaArgentina);
    let modoSoloLectura = false;
    let modoAdmin = false; // TODO: Detectar si es admin desde usuario

    // Crear overlay y modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;width:95%;max-width:1200px;max-height:92vh;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column';
    overlay.appendChild(modal);

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;position:relative';
    header.innerHTML = '<div style="display:flex;align-items:center;gap:12px;flex:1">' +
      '<button id="pf-volver" style="padding:8px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:700">‚Üê</button>' +
      '<button id="pf-config" style="padding:8px 12px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:16px">‚öôÔ∏è</button>' +
      '</div>' +
      '<div style="position:absolute;left:50%;transform:translateX(-50%);font-weight:700;font-size:18px;text-align:center">üè≠ Pedido F√°brica</div>' +
      '<button id="pf-close" style="padding:6px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;margin-left:auto">Cerrar</button>';
    modal.appendChild(header);

    // Navegaci√≥n de fechas
    const navFecha = document.createElement('div');
    navFecha.style.cssText = 'display:flex;justify-content:center;align-items:center;gap:8px;padding:8px;background:#f3f4f6;border-bottom:1px solid #e5e7eb';
    navFecha.innerHTML = '<button id="pf-fecha-prev" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">‚Üê</button>' +
      '<div id="pf-fecha-actual" style="padding:8px 16px;font-weight:700;font-size:14px">' + fechaSeleccionada + '</div>' +
      '<button id="pf-fecha-next" style="padding:6px 10px;background:#fff;border:1px solid #d1d5db;border-radius:6px;font-weight:700">‚Üí</button>';
    modal.appendChild(navFecha);

    // Informaci√≥n del d√≠a (replica exacta del layout de la APK)
    const infoDia = document.createElement('div');
    infoDia.style.cssText = 'background:#f3f4f6;padding:6px;border-bottom:1px solid #e5e7eb';
    
    // Primera fila: D√≠a y % Extra
    const fila1 = document.createElement('div');
    fila1.style.cssText = 'display:flex;justify-content:space-between;align-items:center;font-size:12px';
    fila1.innerHTML = '<div id="pf-dia-actual" style="font-weight:700;flex:1">D√≠a: LUNES</div>' +
      '<div id="pf-porcentaje" style="font-weight:700;flex:1;text-align:right">% Extra: 30%</div>';
    infoDia.appendChild(fila1);
    
    // Segunda fila: D√≠as extra (inicialmente oculto)
    const fila2 = document.createElement('div');
    fila2.id = 'pf-dias-extra';
    fila2.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:2px;display:none';
    fila2.textContent = 'üìÖ Pedido para: Ma√±ana';
    infoDia.appendChild(fila2);
    
    // Tercera fila: Hora de alerta
    const fila3 = document.createElement('div');
    fila3.id = 'pf-hora-alerta';
    fila3.style.cssText = 'font-size:10px;color:#6b7280;font-style:italic;text-align:center;margin-top:4px';
    fila3.textContent = 'üîî Alerta: 15:30';
    infoDia.appendChild(fila3);
    
    modal.appendChild(infoDia);

    // Contenido principal
    const body = document.createElement('div');
    body.style.cssText = 'flex:1;overflow-y:auto;padding:16px';
    body.id = 'pf-body';
    modal.appendChild(body);

    // Variables de estado
    let configuracion = { porcentajeExtra: 30, horaAlerta: '15:30', activarAlerta: true };
    let diasEntrega = { lunes: 'Ma√±ana', martes: 'Ma√±ana', miercoles: 'Ma√±ana', jueves: 'Ma√±ana', viernes: 'S√°bado + Domingo', sabado: 'Domingo', domingo: 'Ma√±ana' };
    let productos = [];
    let promediosVenta = {}; // {codigo: {LUNES: 100, MARTES: 120, ...}}

    // Funci√≥n helper para obtener Firestore de la regi√≥n actual
    function obtenerFirestore() {
      try {
        return FirebaseRegionManager.getFirestore();
      } catch (e) {
        console.error('Error obteniendo Firestore:', e);
        throw new Error('Firebase no est√° inicializado. Por favor, selecciona una regi√≥n primero.');
      }
    }

    // Funci√≥n para obtener d√≠a de la semana
    function obtenerDiaSemana(fecha) {
      const [y, m, d] = fecha.split('-').map(Number);
      const date = new Date(y, m - 1, d);
      const dias = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'];
      return dias[date.getDay()];
    }

    // Funci√≥n para cargar configuraci√≥n desde Firebase
    async function cargarConfiguracion() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarConfiguracion, usando valores por defecto');
          actualizarUI();
          return;
        }
        const configDoc = await db.collection('locales').doc(localId).collection('configuracion_pedido_fabrica').doc('config').get();
        if (configDoc.exists) {
          const data = configDoc.data();
          configuracion = {
            porcentajeExtra: data.porcentajeExtra || 30,
            horaAlerta: data.horaAlerta || '15:30',
            activarAlerta: data.activarAlerta !== false
          };
        }
        const diasDoc = await db.collection('locales').doc(localId).collection('configuracion_dias_entrega').doc('config').get();
        if (diasDoc.exists) {
          const data = diasDoc.data();
          diasEntrega = {
            lunes: data.lunes !== false,
            martes: data.martes !== false,
            miercoles: data.miercoles !== false,
            jueves: data.jueves !== false,
            viernes: data.viernes !== false,
            sabado: data.sabado !== false,
            domingo: data.domingo !== false
          };
        } else {
          // Valores por defecto: todos los d√≠as habilitados
          diasEntrega = {
            lunes: true,
            martes: true,
            miercoles: true,
            jueves: true,
            viernes: true,
            sabado: true,
            domingo: true
          };
        }
        actualizarUI();
      } catch (e) {
        console.warn('Error cargando configuraci√≥n:', e);
      }
    }

    // Funci√≥n para actualizar UI con configuraci√≥n
    function actualizarUI() {
      const porcentajeEl = document.getElementById('pf-porcentaje');
      const horaAlertaEl = document.getElementById('pf-hora-alerta');
      const diaActualEl = document.getElementById('pf-dia-actual');
      
      if (porcentajeEl) porcentajeEl.textContent = '% Extra: ' + configuracion.porcentajeExtra + '%';
      if (horaAlertaEl) horaAlertaEl.textContent = 'üîî Alerta: ' + configuracion.horaAlerta;
      
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      if (diaActualEl) diaActualEl.textContent = 'D√≠a: ' + diaActual;
      
      // Actualizar informaci√≥n de d√≠as extra
      actualizarInformacionDiasExtra();
    }

    // Funci√≥n para cargar promedios de ventas
    async function cargarPromediosVenta() {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPromediosVenta');
          return;
        }
        const registrosSnap = await db.collection('locales').doc(localId).collection('registros').orderBy('fecha', 'desc').limit(100).get();
        const registros = [];
        registrosSnap.forEach(d => {
          const data = d.data();
          registros.push({ 
            fecha: data.fecha, 
            tipo: data.tipo, 
            productos: data.productos || [] 
          });
        });

        // Agrupar por d√≠a de la semana
        const ventasPorDia = { LUNES: {}, MARTES: {}, MIERCOLES: {}, JUEVES: {}, VIERNES: {}, SABADO: {}, DOMINGO: {} };
        
        // Procesar cada fecha
        const fechasProcesadas = new Set();
        registros.forEach(registro => {
          if (fechasProcesadas.has(registro.fecha)) return;
          fechasProcesadas.add(registro.fecha);
          
          const dia = obtenerDiaSemana(registro.fecha);
          if (!(dia in ventasPorDia)) return;
          
          const ingreso = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Ingreso de Mercader√≠a');
          const stockFinal = registros.find(r => r.fecha === registro.fecha && r.tipo === 'Stock Final');
          
          if (!stockFinal || !stockFinal.productos) return;
          
          // Calcular fecha anterior
          const [y, m, d] = registro.fecha.split('-').map(Number);
          const fechaAnterior = new Date(y, m - 1, d);
          fechaAnterior.setDate(fechaAnterior.getDate() - 1);
          const fechaAnteriorStr = fechaISO(fechaAnterior);
          const stockAnterior = registros.find(r => r.fecha === fechaAnteriorStr && r.tipo === 'Stock Final');
          
          // Calcular ventas por producto
          stockFinal.productos.forEach(p => {
            const ingresoCant = (ingreso?.productos || []).find(ip => ip.nombre === p.nombre)?.cantidad || 0;
            const stockAntCant = (stockAnterior?.productos || []).find(sp => sp.nombre === p.nombre)?.cantidad || 0;
            const venta = stockAntCant + ingresoCant - p.cantidad;
            
            if (venta > 0) {
              if (!ventasPorDia[dia][p.nombre]) {
                ventasPorDia[dia][p.nombre] = [];
              }
              ventasPorDia[dia][p.nombre].push(venta);
            }
          });
        });

        // Calcular promedios por c√≥digo de producto (replica de calcularPromediosPorDia de la APK)
        ordenProductos.forEach(codigo => {
          promediosVenta[codigo] = {};
          const nombreCompleto = obtenerNombreProducto(codigo);
          const claveCompleta = codigo + ' - ' + nombreCompleto;
          
          ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'].forEach(dia => {
            const ventas = [];
            
            // Buscar ventas que coincidan con este producto (igual que la APK)
            Object.keys(ventasPorDia[dia] || {}).forEach(nombreProducto => {
              // Buscar por clave completa "C√ìDIGO - Nombre"
              if (nombreProducto === claveCompleta) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // Si no se encuentra, intentar con nombre del producto
              else if (nombreProducto === nombreCompleto) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // Si no se encuentra, intentar con el c√≥digo directamente
              else if (nombreProducto === codigo) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
              // Tambi√©n buscar por formato "C√ìDIGO -"
              else if (nombreProducto.startsWith(codigo + ' -')) {
                ventas.push(...(ventasPorDia[dia][nombreProducto] || []));
              }
            });
            
            // Filtrar solo los d√≠as donde este producto tiene ventas > 0
            const ventasConDatos = ventas.filter(v => v > 0);
            
            if (ventasConDatos.length > 0) {
              const suma = ventasConDatos.reduce((sum, v) => sum + v, 0);
              promediosVenta[codigo][dia] = suma / ventasConDatos.length;
            } else {
              promediosVenta[codigo][dia] = 0;
            }
          });
        });
        
        console.log('‚úÖ Promedios cargados:', promediosVenta);
      } catch (e) {
        console.error('Error cargando promedios:', e);
      }
    }

    // Funci√≥n para obtener nombre del producto (replica de obtenerNombreProducto de la APK)
    function obtenerNombreProducto(codigo) {
      return productosFabrica[codigo]?.nombre || codigo;
    }

    // Funci√≥n para cargar pedido existente (replica de cargarPedidoExistente de la APK)
    async function cargarPedidoExistente(fecha) {
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarPedidoExistente');
          return false;
        }
        const pedidoDoc = await db.collection('locales').doc(localId).collection('pedidos_fabrica').doc(fecha).get();
        if (pedidoDoc.exists) {
          const data = pedidoDoc.data();
          
          // Si hay productos guardados, usarlos
          if (data.productos && data.productos.length > 0) {
            productos = ordenProductos.map(codigo => {
              const prodData = (data.productos || []).find(p => p.codigo === codigo);
              return {
                codigo: codigo,
                nombre: obtenerNombreProducto(codigo),
                categoria: productosFabrica[codigo]?.categoria || 'OTROS',
                promediosVenta: promediosVenta[codigo] || {},
                stockActual: prodData?.stock || 0,
                pedidoSugerido: prodData?.sugerencia || 0,
                pedidoFinal: prodData?.pedido || 0
              };
            });
          } else {
            // Si no hay productos guardados, cargar stock actual desde registros
            const stockActualMap = await cargarStockActualDesdeRegistros();
            productos = ordenProductos.map(codigo => ({
              codigo: codigo,
              nombre: obtenerNombreProducto(codigo),
              categoria: productosFabrica[codigo]?.categoria || 'OTROS',
              promediosVenta: promediosVenta[codigo] || {},
              stockActual: stockActualMap[codigo] || 0,
              pedidoSugerido: 0,
              pedidoFinal: 0
            }));
          }
          
          if (data.configuracion) {
            configuracion.porcentajeExtra = data.configuracion.porcentajeExtra || 30;
            configuracion.horaAlerta = data.configuracion.horaAlerta || '15:30';
            configuracion.activarAlerta = data.configuracion.activarAlerta !== false;
            if (data.configuracion.diasEntrega) {
              diasEntrega = data.configuracion.diasEntrega;
            }
          }
          return true;
        }
        return false;
      } catch (e) {
        console.error('Error cargando pedido existente:', e);
        return false;
      }
    }

    // Funci√≥n para inicializar productos si no hay pedido existente
    async function inicializarProductos() {
      // Cargar stock actual desde registros de inventario
      const stockActualMap = await cargarStockActualDesdeRegistros();
      
      productos = ordenProductos.map(codigo => ({
        codigo: codigo,
        nombre: productosFabrica[codigo]?.nombre || codigo,
        categoria: productosFabrica[codigo]?.categoria || 'OTROS',
        promediosVenta: promediosVenta[codigo] || {},
        stockActual: stockActualMap[codigo] || 0,
        pedidoSugerido: 0,
        pedidoFinal: 0
      }));
    }

    // Funci√≥n para cargar stock actual desde registros (replica de la APK)
    async function cargarStockActualDesdeRegistros() {
      const stockMap = {};
      try {
        let db;
        try {
          db = obtenerFirestore();
        } catch (e) {
          console.warn('Firebase no inicializado en cargarStockActualDesdeRegistros');
          return stockMap;
        }
        // Obtener fecha de HOY (no fechaSeleccionada, sino la fecha actual)
        const hoy = new Date();
        const offsetArgentina = -3 * 60;
        const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
        const fechaHoy = fechaISO(fechaArgentina);
        
        // Obtener fecha anterior
        const [y, m, d] = fechaHoy.split('-').map(Number);
        const fechaAnterior = new Date(y, m - 1, d);
        fechaAnterior.setDate(fechaAnterior.getDate() - 1);
        const fechaAnteriorStr = fechaISO(fechaAnterior);
        
        // Obtener ingreso de HOY (no de fechaSeleccionada)
        const ingresoHoySnap = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', fechaHoy)
          .where('tipo', '==', 'Ingreso de Mercader√≠a')
          .get();
        
        // Obtener stock final del d√≠a anterior
        const stockFinalAnteriorSnap = await db.collection('locales').doc(localId).collection('registros')
          .where('fecha', '==', fechaAnteriorStr)
          .where('tipo', '==', 'Stock Final')
          .get();
        
        const ingresoHoy = ingresoHoySnap.docs[0]?.data()?.productos || [];
        const stockFinalAnterior = stockFinalAnteriorSnap.docs[0]?.data()?.productos || [];
        
        // Calcular stock actual para cada producto
        ordenProductos.forEach(codigo => {
          const nombreProducto = productosFabrica[codigo]?.nombre || codigo;
          const ingresoCant = ingresoHoy.find(p => 
            p.nombre === nombreProducto || 
            p.nombre.startsWith(codigo + ' -') ||
            p.nombre === codigo
          )?.cantidad || 0;
          const stockAnteriorCant = stockFinalAnterior.find(p => 
            p.nombre === nombreProducto || 
            p.nombre.startsWith(codigo + ' -') ||
            p.nombre === codigo
          )?.cantidad || 0;
          
          stockMap[codigo] = stockAnteriorCant + ingresoCant;
        });
      } catch (e) {
        console.error('Error cargando stock actual:', e);
      }
      return stockMap;
    }

    // Funci√≥n para obtener datos de venta parcial (replica de obtenerDatosVentaParcial de la APK)
    async function obtenerDatosVentaParcial(codigo) {
      try {
        const db = obtenerFirestore();
        const nombreProducto = productosFabrica[codigo]?.nombre || codigo;
        // Usar fecha de HOY, no fechaSeleccionada
        const hoy = new Date();
        const offsetArgentina = -3 * 60;
        const fechaArgentina = new Date(hoy.getTime() + (offsetArgentina - hoy.getTimezoneOffset()) * 60000);
        const fechaHoy = fechaISO(fechaArgentina);
        
        // Calcular fecha anterior
        const [y, m, d] = fechaHoy.split('-').map(Number);
        const fechaAnterior = new Date(y, m - 1, d);
        fechaAnterior.setDate(fechaAnterior.getDate() - 1);
        const fechaAnteriorStr = fechaISO(fechaAnterior);
        
        // Obtener registros
        const registrosSnap = await db.collection('locales').doc(localId).collection('registros').get();
        const registros = [];
        registrosSnap.forEach(d => {
          const data = d.data();
          registros.push({
            fecha: data.fecha,
            tipo: data.tipo,
            productos: data.productos || []
          });
        });
        
        // Obtener stock anterior (stock final del d√≠a anterior)
        const stockAnteriorReg = registros.find(r => r.fecha === fechaAnteriorStr && r.tipo === 'Stock Final');
        const stockAnterior = stockAnteriorReg?.productos?.find(p => 
          p.nombre === nombreProducto || 
          p.nombre.startsWith(codigo + ' -') ||
          p.nombre === codigo
        )?.cantidad || 0;
        
        // Obtener ingreso del d√≠a actual
        const ingresoHoyReg = registros.find(r => r.fecha === fechaHoy && r.tipo === 'Ingreso de Mercader√≠a');
        const ingresoHoy = ingresoHoyReg?.productos?.find(p => 
          p.nombre === nombreProducto || 
          p.nombre.startsWith(codigo + ' -') ||
          p.nombre === codigo
        )?.cantidad || 0;
        
        return [stockAnterior, ingresoHoy];
      } catch (e) {
        console.error('Error obteniendo datos venta parcial:', e);
        return [0, 0];
      }
    }

    // Funci√≥n para obtener promedios hasta pr√≥xima entrega (replica de obtenerPromediosHastaProximaEntrega de la APK)
    function obtenerPromediosHastaProximaEntrega(codigo) {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diaSiguiente = obtenerDiaSiguiente(diaActual);
      
      // Siempre incluir el d√≠a siguiente
      let suma = promediosVenta[codigo]?.[diaSiguiente] || 0;
      
      // Obtener d√≠as extra seg√∫n configuraci√≥n
      const diasExtra = obtenerDiasExtraSegunTexto();
      diasExtra.forEach(dia => {
        suma += promediosVenta[codigo]?.[dia] || 0;
      });
      
      return suma;
    }

    // Funci√≥n para obtener d√≠as extra seg√∫n texto (replica de obtenerDiasExtraSegunTexto de la APK)
    function obtenerDiasExtraSegunTexto() {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diasExtra = [];
      
      // Obtener la lista de pr√≥ximos d√≠as con sus configuraciones (usando booleanos)
      const proximosDias = {
        'LUNES': [['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes]],
        'MARTES': [['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado]],
        'MIERCOLES': [['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo]],
        'JUEVES': [['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes]],
        'VIERNES': [['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes]],
        'SABADO': [['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles]],
        'DOMINGO': [['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves]]
      };
      
      const lista = proximosDias[diaActual] || [];
      if (lista.length === 0) return diasExtra;
      
      // Verificar que el primer d√≠a (ma√±ana) tenga entrega
      const [primerDia, tieneEntregaPrimerDia] = lista[0];
      if (!tieneEntregaPrimerDia) {
        return diasExtra; // No se puede hacer pedido
      }
      
      // Revisar d√≠as despu√©s de ma√±ana
      for (let i = 1; i < lista.length; i++) {
        const [nombreDia, tieneEntrega] = lista[i];
        if (!tieneEntrega) {
          diasExtra.push(nombreDia);
        } else {
          break; // Parar al encontrar d√≠a con entrega
        }
      }
      
      return diasExtra;
    }

    // Funci√≥n para obtener d√≠a siguiente
    function obtenerDiaSiguiente(dia) {
      const dias = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
      const index = dias.indexOf(dia);
      return dias[(index + 1) % 7];
    }

    // Funci√≥n para redondear sugerencia seg√∫n tipo de producto (replica exacta de redondearSugerencia de la APK)
    function redondearSugerencia(sugerencia, codigo) {
      if (sugerencia <= 0) return 0;
      
      const porcentajeMultiplo = 1.0; // Por defecto 100% del m√∫ltiplo
      
      // Empanadas: redondear a m√∫ltiplo de 50
      if (categorias.EMPANADAS.includes(codigo)) {
        const multiplo = 50;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Pizzas: redondear a m√∫ltiplo de 5
      if (categorias.PIZZAS.includes(codigo)) {
        const multiplo = 5;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        const cociente = Math.floor(sugerencia / multiplo);
        const resto = sugerencia % multiplo;
        return resto > 0 ? (cociente + 1) * multiplo : Math.round(sugerencia);
      }
      
      // Pastelitos: redondear a m√∫ltiplo de 35
      if (categorias.PASTELITOS.includes(codigo)) {
        const multiplo = 35;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Medialunas: redondear a m√∫ltiplo de 180
      if (codigo === 'DULCES') {
        const multiplo = 180;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Chipa: redondear a m√∫ltiplo de 120
      if (codigo === 'CHIPA') {
        const multiplo = 120;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Criollito: redondear a m√∫ltiplo de 120
      if (codigo === 'CRIOLLITO') {
        const multiplo = 120;
        const umbral = multiplo * porcentajeMultiplo;
        if (sugerencia < umbral) return 0;
        return Math.ceil(sugerencia / multiplo) * multiplo;
      }
      
      // Por defecto: redondear normalmente
      return Math.round(sugerencia);
    }

    // Funci√≥n para verificar si un d√≠a tiene entrega
    function diaTieneEntrega(dia, tieneEntrega) {
      // Si tieneEntrega es un booleano, retornarlo directamente
      if (typeof tieneEntrega === 'boolean') {
        return tieneEntrega;
      }
      
      // Compatibilidad con c√≥digo antiguo que usaba strings
      if (typeof tieneEntrega === 'string') {
        // Si el texto es "Ma√±ana", significa que ese d√≠a tiene entrega
        if (tieneEntrega === 'Ma√±ana') return true;
        
        // Si el texto incluye el nombre del d√≠a, significa que ese d√≠a tiene entrega
        const diaLower = dia.toLowerCase();
        const textoLower = tieneEntrega.toLowerCase();
        if (textoLower.includes(diaLower)) return true;
      }
      
      // Mapeo de d√≠as en espa√±ol
      const diasMap = {
        'LUNES': ['lunes', 'lun'],
        'MARTES': ['martes', 'mar'],
        'MIERCOLES': ['miercoles', 'mi√©rcoles', 'mier', 'mi√©'],
        'JUEVES': ['jueves', 'jue'],
        'VIERNES': ['viernes', 'vie'],
        'SABADO': ['sabado', 's√°bado', 'sab', 's√°b'],
        'DOMINGO': ['domingo', 'dom']
      };
      
      const variantes = diasMap[dia] || [];
      return variantes.some(v => textoLower.includes(v));
    }

    // Funci√≥n para calcular sugerencia de pedido (replica exacta de calcularSugerenciaPedido de la APK)
    async function calcularSugerencia(codigo, stockActual) {
      try {
        const diaActual = obtenerDiaSemana(fechaSeleccionada);
        const promedioHoy = promediosVenta[codigo]?.[diaActual] || 0;
        
        if (promedioHoy <= 0) return 0;

        // Obtener datos de venta parcial
        const [stockAnterior, ingresoHoy] = await obtenerDatosVentaParcial(codigo);
        
        // Calcular venta parcial y venta restante
        let ventaRestanteHoy, ventaParcial;
        
        if (stockAnterior > 0 || ingresoHoy > 0) {
          // HAY datos hist√≥ricos - usar l√≥gica completa
          ventaParcial = stockAnterior + ingresoHoy - stockActual;
          const porcentajeAvance = promedioHoy > 0 ? Math.min(1, Math.max(0, ventaParcial / promedioHoy)) : 0;
          ventaRestanteHoy = promedioHoy * (1 - porcentajeAvance);
        } else {
          // NO hay datos hist√≥ricos - NO sugerir pedidos
          return 0;
        }

        // Porcentaje extra configurado
        const porcentajeExtra = configuracion.porcentajeExtra / 100.0;

        // Sumar todos los promedios hasta la pr√≥xima entrega
        const sumaPromedios = obtenerPromediosHastaProximaEntrega(codigo);

        // Calcular stock al final de hoy
        const stockFinalHoy = stockActual - ventaRestanteHoy;

        // F√≥rmula correcta: necesito cubrir los pr√≥ximos d√≠as MENOS lo que me va a quedar hoy
        const porcentajeExtraValor = sumaPromedios * porcentajeExtra;
        const sugerenciaBase = sumaPromedios - stockFinalHoy;
        const sugerenciaFinal = sugerenciaBase + porcentajeExtraValor;

        // Evitar negativos
        const sugerenciaPositiva = Math.max(0, sugerenciaFinal);

        // Redondear seg√∫n tipo de producto (replica exacta de redondearSugerencia de la APK)
        return redondearSugerencia(sugerenciaPositiva, codigo);
      } catch (e) {
        console.error('Error calculando sugerencia:', e);
        return 0;
      }
    }

    // Funci√≥n para mostrar contenido del pedido (replica exacta de la APK)
    async function mostrarContenidoPedido() {
      body.innerHTML = '';
      
      // Agregar indicador de local (como en la APK)
      const indicadorLocal = document.createElement('div');
      indicadorLocal.style.cssText = 'text-align:center;font-size:16px;font-weight:700;color:#1976d2;padding:5px 0 15px 0';
      indicadorLocal.textContent = 'LOCAL: ' + localNombre;
      body.appendChild(indicadorLocal);

      // Banner de modo admin si est√° activo
      if (modoAdmin) {
        const bannerAdmin = document.createElement('div');
        bannerAdmin.style.cssText = 'background:#ff9800;color:#fff;text-align:center;padding:12px;font-weight:700;font-size:14px;margin-bottom:16px';
        bannerAdmin.textContent = 'üîß MODO ADMINISTRADOR - EDICI√ìN HABILITADA';
        body.appendChild(bannerAdmin);
      }

      // Verificar si es hora de alerta (solo a las 15:30 o despu√©s) Y solo para la fecha actual
      const ahora = getFechaArgentina();
      const hoy = fechaISO(ahora);
      const esFechaActual = fechaSeleccionada === hoy;
      
      // Obtener hora y minuto en zona horaria de Argentina
      const formatterHora = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Argentina/Buenos_Aires',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      const partesHora = formatterHora.formatToParts(new Date());
      const hora = parseInt(partesHora.find(p => p.type === 'hour').value);
      const minuto = parseInt(partesHora.find(p => p.type === 'minute').value);
      const [horaAlerta, minutoAlerta] = configuracion.horaAlerta.split(':').map(Number);
      const esHoraAlerta = hora === horaAlerta && minuto >= minutoAlerta;

      // NO mostrar alertas aqu√≠ - se muestran dentro de mostrarSeccionCargarStockIntegrada() solo cuando corresponde

      // Si no hay productos, mostrar mensaje
      if (productos.length === 0) {
        if (modoSoloLectura) {
          const mensaje = document.createElement('div');
          mensaje.style.cssText = 'text-align:center;padding:32px;color:#6b7280';
          mensaje.innerHTML = '<div style="font-size:48px;margin-bottom:16px">üìã</div>' +
            '<div style="font-size:18px;font-weight:700;color:#1976d2;margin-bottom:8px">No hay datos para esta fecha</div>' +
            '<div style="font-size:14px;color:#6b7280">No se encontr√≥ ning√∫n pedido guardado para el ' + fechaSeleccionada + '.</div>';
          body.appendChild(mensaje);
        } else {
          const mensaje = document.createElement('div');
          mensaje.style.cssText = 'text-align:center;padding:32px;color:#6b7280';
          mensaje.innerHTML = '<div style="font-size:48px;margin-bottom:16px">üìä</div>' +
            '<div style="font-size:18px;font-weight:700;color:#1976d2;margin-bottom:8px">Sin datos hist√≥ricos de ventas</div>' +
            '<div style="font-size:14px;color:#6b7280;margin-bottom:16px">Para generar sugerencias de pedido necesitas tener registros de inventario hist√≥ricos.</div>';
          body.appendChild(mensaje);
        }
        return;
      }

      // Mostrar secci√≥n "CARGAR STOCK 15:30" integrada (como en la APK)
      mostrarSeccionCargarStockIntegrada();
    }

    // Funci√≥n para mostrar secci√≥n de carga de stock integrada (replica exacta de mostrarSeccionCargarStockIntegrada de la APK)
    function mostrarSeccionCargarStockIntegrada() {
      // T√≠tulo de la secci√≥n
      const tituloSeccion = document.createElement('div');
      tituloSeccion.style.cssText = 'font-size:20px;font-weight:700;color:#1976d2;padding:16px;text-align:center;background:#f3f4f6;margin-bottom:16px';
      tituloSeccion.textContent = 'üìä CARGAR STOCK 15:30';
      body.appendChild(tituloSeccion);

      // Orden de categor√≠as (igual que la APK)
      const ordenCategorias = ['EMPANADAS', 'PIZZAS', 'PASTELITOS', 'OTROS'];
      
      ordenCategorias.forEach(categoria => {
        const codigosCategoria = categorias[categoria] || [];
        const productosCategoria = productos.filter(p => codigosCategoria.includes(p.codigo));
        
        if (productosCategoria.length > 0) {
          mostrarCategoriaIntegrada(categoria, productosCategoria);
        }
      });

      // Bot√≥n de WhatsApp
      const btnWhatsApp = document.createElement('button');
      btnWhatsApp.style.cssText = 'width:100%;padding:16px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:16px;margin-top:24px;cursor:pointer';
      if (modoAdmin) {
        btnWhatsApp.textContent = 'üì± Enviar por WhatsApp (Admin)';
      } else if (modoSoloLectura) {
        btnWhatsApp.textContent = 'üì± Ver Pedido (Solo Lectura)';
        btnWhatsApp.style.background = '#6b7280';
      } else {
        btnWhatsApp.textContent = 'üì± Enviar por WhatsApp';
      }
      btnWhatsApp.onclick = () => {
        if (!modoSoloLectura || modoAdmin) {
          guardarPedido();
        }
        generarYEnviarWhatsApp();
      };
      body.appendChild(btnWhatsApp);
    }

    // Funci√≥n para mostrar categor√≠a integrada (replica exacta de mostrarCategoriaIntegrada de la APK)
    function mostrarCategoriaIntegrada(categoria, productosCategoria) {
      // Contenedor de categor√≠a
      const categoriaDiv = document.createElement('div');
      categoriaDiv.style.cssText = 'margin-bottom:16px';

      // Header de categor√≠a con color
      const headerDiv = document.createElement('div');
      const coloresHeader = {
        'EMPANADAS': '#8b4513',
        'PIZZAS': '#ff6b6b',
        'PASTELITOS': '#ffd93d',
        'OTROS': '#6c757d'
      };
      headerDiv.style.cssText = 'background:' + (coloresHeader[categoria] || '#6c757d') + ';color:#fff;padding:12px;display:flex;align-items:center;gap:12px;font-weight:700';
      
      const iconoCategoria = categoria === 'EMPANADAS' ? 'ü•ü' : categoria === 'PIZZAS' ? 'üçï' : categoria === 'PASTELITOS' ? 'ü•ß' : 'üì¶';
      headerDiv.innerHTML = '<span style="font-size:24px">' + iconoCategoria + '</span>' +
        '<span style="flex:1;font-size:18px">' + categoria + '</span>' +
        '<span style="background:rgba(255,255,255,.3);padding:4px 8px;border-radius:4px;font-size:12px">' + productosCategoria.length + ' productos</span>';
      categoriaDiv.appendChild(headerDiv);

      // Contenedor de productos
      const productosDiv = document.createElement('div');
      productosDiv.style.cssText = 'background:#fff;padding:8px';

      // Ordenar productos seg√∫n orden espec√≠fico
      const ordenEspecifico = {
        'EMPANADAS': ['JQ', 'PB', 'CS', 'PO', 'CP', 'HU', 'ES', 'CQ', 'RJ', 'QC', 'CB', 'CH'],
        'PIZZAS': ['MUZZARE', 'JAMON', 'PEPPERO'],
        'PASTELITOS': ['BATATA', 'MEMBRIL'],
        'OTROS': ['DULCES', 'CHIPA', 'CRIOLLITO']
      };
      const orden = ordenEspecifico[categoria] || [];
      const productosOrdenados = orden.map(codigo => productosCategoria.find(p => p.codigo === codigo)).filter(p => p);

      for (const prod of productosOrdenados) {

        // Crear fila de producto (dise√±o de 3 columnas como el layout XML)
        const filaDiv = document.createElement('div');
        filaDiv.style.cssText = 'display:flex;align-items:center;padding:12px;background:#f9fafb;margin:2px 0;gap:4px';
        filaDiv.id = 'pf-row-' + prod.codigo;

        // Columna 1: C√≥digo del producto
        const codigoDiv = document.createElement('div');
        codigoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column';
        const codigoSpan = document.createElement('span');
        codigoSpan.id = 'pf-codigo-' + prod.codigo;
        codigoSpan.style.cssText = 'font-size:13px;font-weight:700;color:#7b2cbf';
        codigoSpan.textContent = prod.codigo;
        codigoDiv.appendChild(codigoSpan);
        filaDiv.appendChild(codigoDiv);

        // Columna 2: Stock 15:30
        const stockDiv = document.createElement('div');
        stockDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px';
        const stockLabel = document.createElement('span');
        stockLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        stockLabel.textContent = 'Stock';
        stockDiv.appendChild(stockLabel);
        const inputStock = document.createElement('input');
        inputStock.type = 'number';
        inputStock.id = 'pf-stock-' + prod.codigo;
        inputStock.setAttribute('data-codigo', prod.codigo);
        inputStock.setAttribute('data-tipo', 'stock');
        inputStock.value = prod.stockActual;
        inputStock.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#7b2cbf';
        if (modoSoloLectura && !modoAdmin) {
          inputStock.disabled = true;
          inputStock.style.background = '#d1d5db';
        } else {
          inputStock.onfocus = function() { this.select(); };
        }
        stockDiv.appendChild(inputStock);
        filaDiv.appendChild(stockDiv);

        // Columna 3: Sugerencia
        const sugerenciaDiv = document.createElement('div');
        sugerenciaDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;margin-right:4px';
        const sugerenciaLabel = document.createElement('span');
        sugerenciaLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        sugerenciaLabel.textContent = 'Sugerencia';
        sugerenciaDiv.appendChild(sugerenciaLabel);
        const spanSugerencia = document.createElement('span');
        spanSugerencia.id = 'pf-sugerencia-' + prod.codigo;
        spanSugerencia.setAttribute('data-codigo', prod.codigo);
        spanSugerencia.setAttribute('data-tipo', 'sugerencia');
        spanSugerencia.textContent = '...';
        spanSugerencia.style.cssText = 'width:60px;height:35px;padding:4px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#7b2cbf;display:flex;align-items:center;justify-content:center';
        sugerenciaDiv.appendChild(spanSugerencia);
        
        // Calcular sugerencia de forma as√≠ncrona y actualizar
        calcularSugerencia(prod.codigo, prod.stockActual).then(sug => {
          spanSugerencia.textContent = sug;
          prod.pedidoSugerido = sug;
        });
        filaDiv.appendChild(sugerenciaDiv);

        // Columna 4: Pedido Final
        const pedidoDiv = document.createElement('div');
        pedidoDiv.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center';
        const pedidoLabel = document.createElement('span');
        pedidoLabel.style.cssText = 'font-size:9px;font-weight:700;color:#7b2cbf;margin-bottom:2px';
        pedidoLabel.textContent = 'Pedido Final';
        pedidoDiv.appendChild(pedidoLabel);
        const inputPedido = document.createElement('input');
        inputPedido.type = 'number';
        inputPedido.id = 'pf-pedido-' + prod.codigo;
        inputPedido.setAttribute('data-codigo', prod.codigo);
        inputPedido.setAttribute('data-tipo', 'pedido');
        inputPedido.value = prod.pedidoFinal;
        inputPedido.style.cssText = 'width:60px;height:35px;padding:4px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:14px;font-weight:700;color:#ff6b00';
        if (modoSoloLectura && !modoAdmin) {
          inputPedido.disabled = true;
          inputPedido.style.background = '#d1d5db';
        } else {
          inputPedido.onfocus = function() { this.select(); };
        }
        pedidoDiv.appendChild(inputPedido);
        filaDiv.appendChild(pedidoDiv);

        productosDiv.appendChild(filaDiv);

        // Configurar listeners
        inputStock.addEventListener('input', async () => {
          const stock = parseInt(inputStock.value) || 0;
          const sugerencia = await calcularSugerencia(prod.codigo, stock);
          spanSugerencia.textContent = sugerencia;
          prod.stockActual = stock;
          prod.pedidoSugerido = sugerencia;
        });

        // Cargar historial de stock bajo de forma as√≠ncrona
        obtenerHistorialStockBajo(prod.codigo).then(historial => {
          if (historial.length > 0) {
            codigoSpan.innerHTML = prod.codigo + ' <span style="color:#dc2626;cursor:pointer" data-codigo="' + prod.codigo + '">‚ö†Ô∏è</span>';
            const iconoAlerta = codigoSpan.querySelector('[data-codigo="' + prod.codigo + '"]');
            if (iconoAlerta) {
              iconoAlerta.addEventListener('click', () => {
                mostrarReporteStockBajo(prod.codigo, prod.nombre, historial);
              });
            }
          }
        });
      }

      categoriaDiv.appendChild(productosDiv);
      body.appendChild(categoriaDiv);
    }

    // Funci√≥n para obtener historial de stock bajo
    async function obtenerHistorialStockBajo(codigo) {
      try {
        const historial = [];
        const hoy = new Date();
        for (let i = 1; i <= 7; i++) {
          const fecha = new Date(hoy);
          fecha.setDate(fecha.getDate() - i);
          const fechaStr = fechaISO(fecha);
          
          const registrosSnap = await db.collection('locales').doc(localId).collection('registros')
            .where('fecha', '==', fechaStr).where('tipo', '==', 'Stock Final').get();
          
          registrosSnap.forEach(d => {
            const productos = d.data().productos || [];
            const producto = productos.find(p => p.nombre && (p.nombre.startsWith(codigo + ' -') || p.nombre === productosFabrica[codigo]?.nombre));
            if (producto) {
              const umbral = (codigo.startsWith('MUZZA') || codigo.startsWith('JAMON') || codigo.startsWith('PEPPER')) ? 0 : 15;
              if (producto.cantidad <= umbral) {
                historial.push({ fecha: fechaStr, stock: producto.cantidad });
              }
            }
          });
        }
        return historial;
      } catch (e) {
        console.error('Error obteniendo historial:', e);
        return [];
      }
    }

    // Funci√≥n para mostrar reporte de stock bajo
    function mostrarReporteStockBajo(codigo, nombre, historial) {
      const overlayReporte = document.createElement('div');
      overlayReporte.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalReporte = document.createElement('div');
      modalReporte.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:80vh;overflow-y:auto';
      
      const fechaFormateada = (fecha) => {
        const [y, m, d] = fecha.split('-').map(Number);
        return d + '/' + m + '/' + y;
      };

      modalReporte.innerHTML = '<div style="font-weight:700;font-size:18px;color:#dc2626;text-align:center;margin-bottom:16px">‚ö†Ô∏è Stock Bajo Detectado</div>' +
        '<div style="font-weight:700;font-size:16px;text-align:center;margin-bottom:16px">' + codigo + ' - ' + nombre + '</div>' +
        '<div style="font-size:14px;margin-bottom:16px;text-align:center">En los √∫ltimos 7 d√≠as, este producto qued√≥ con stock bajo (‚â§ 15 unidades):</div>' +
        '<div style="max-height:300px;overflow-y:auto;margin-bottom:16px">' +
        (historial.length > 0 ? historial.map(h => '<div style="padding:12px;background:#f5f5f5;border-radius:4px;margin-bottom:8px">üìÖ ' + fechaFormateada(h.fecha) + ' ‚Üí ' + h.stock + ' unidades restantes</div>').join('') : '<div style="text-align:center;color:#6b7280;padding:16px">No se encontraron registros de stock bajo</div>') +
        '</div>' +
        '<div style="font-weight:700;font-size:14px;color:#f57c00;text-align:center;margin-bottom:16px">üí° Considera reforzar el pedido para evitar quedarte sin stock.</div>' +
        '<button style="width:100%;padding:10px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:700">Entendido</button>';
      
      overlayReporte.appendChild(modalReporte);
      document.body.appendChild(overlayReporte);
      
      modalReporte.querySelector('button').onclick = () => overlayReporte.remove();
    }

    // Funci√≥n para guardar pedido (replica de guardarPedidoEnFirestore de la APK)
    async function guardarPedido() {
      if (modoSoloLectura && !modoAdmin) {
        alert('No se puede guardar en fechas anteriores');
        return;
      }

      try {
        const productosParaGuardar = [];
        
        ordenProductos.forEach(codigo => {
          const stockInput = document.getElementById('pf-stock-' + codigo);
          const pedidoInput = document.getElementById('pf-pedido-' + codigo);
          const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
          
          if (!stockInput || !pedidoInput) return;
          
          const stock = parseInt(stockInput.value) || 0;
          const pedido = parseInt(pedidoInput.value) || 0;
          const sugerencia = parseInt(sugerenciaSpan?.textContent) || 0;
          
          if (stock > 0 || pedido > 0) {
            productosParaGuardar.push({
              codigo: codigo,
              nombre: productosFabrica[codigo]?.nombre || codigo,
              stock: stock,
              sugerencia: sugerencia,
              pedido: pedido
            });
          }
        });

        const diaActual = obtenerDiaSemana(fechaSeleccionada);
        const textoDiasExtra = actualizarInformacionDiasExtra();

        const pedidoData = {
          productos: productosParaGuardar,
          configuracion: {
            porcentajeExtra: configuracion.porcentajeExtra,
            horaAlerta: configuracion.horaAlerta,
            activarAlerta: configuracion.activarAlerta,
            diasEntrega: diasEntrega,
            paraFecha: textoDiasExtra
          },
          fecha: fechaSeleccionada,
          localId: localId,
          timestamp: new Date().toISOString()
        };

        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('pedidos_fabrica').doc(fechaSeleccionada).set(pedidoData);
        console.log('‚úÖ Pedido guardado exitosamente');
      } catch (e) {
        console.error('Error guardando pedido:', e);
        alert('Error guardando pedido: ' + e.message);
      }
    }

    // Funci√≥n para actualizar informaci√≥n de d√≠as extra (replica de actualizarInformacionDiasExtra de la APK)
    function actualizarInformacionDiasExtra() {
      const diaActual = obtenerDiaSemana(fechaSeleccionada);
      const diaSiguiente = obtenerDiaSiguiente(diaActual);
      
      const proximosDias = {
        'LUNES': [['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes]],
        'MARTES': [['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado]],
        'MIERCOLES': [['JUEVES', diasEntrega.jueves], ['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo]],
        'JUEVES': [['VIERNES', diasEntrega.viernes], ['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes]],
        'VIERNES': [['SABADO', diasEntrega.sabado], ['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes]],
        'SABADO': [['DOMINGO', diasEntrega.domingo], ['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles]],
        'DOMINGO': [['LUNES', diasEntrega.lunes], ['MARTES', diasEntrega.martes], ['MIERCOLES', diasEntrega.miercoles], ['JUEVES', diasEntrega.jueves]]
      };
      
      const lista = proximosDias[diaActual] || [];
      if (lista.length === 0) {
        const diasExtraEl = document.getElementById('pf-dias-extra');
        if (diasExtraEl) diasExtraEl.textContent = 'üìÖ Pedido para: ' + diaSiguiente;
        return diaSiguiente;
      }
      
      // Verificar que el primer d√≠a (ma√±ana) tenga entrega
      const [primerDia, tieneEntregaPrimerDia] = lista[0];
      if (!tieneEntregaPrimerDia) {
        const diasExtraEl = document.getElementById('pf-dias-extra');
        if (diasExtraEl) diasExtraEl.textContent = '‚ö†Ô∏è No se puede hacer pedido - ' + primerDia + ' sin entrega';
        return diaSiguiente;
      }
      
      // Revisar d√≠as despu√©s de ma√±ana
      const diasExtra = [];
      for (let i = 1; i < lista.length; i++) {
        const [nombreDia, tieneEntrega] = lista[i];
        if (!tieneEntrega) {
          diasExtra.push(nombreDia);
        } else {
          break;
        }
      }
      
      // Construir el texto
      const textoPedido = diasExtra.length === 0 
        ? 'üìÖ Pedido para: ' + diaSiguiente
        : 'üìÖ Pedido para: ' + diaSiguiente + ' + ' + diasExtra.join(' + ');
      
      const diasExtraEl = document.getElementById('pf-dias-extra');
      if (diasExtraEl) {
        diasExtraEl.textContent = textoPedido;
        diasExtraEl.style.display = 'block';
      }
      
      return textoPedido;
    }

    // Funci√≥n para generar y enviar por WhatsApp
    function generarYEnviarWhatsApp() {
      const texto = generarTextoPedido();
      const url = 'https://wa.me/?text=' + encodeURIComponent(texto);
      window.open(url, '_blank');
    }

    // Funci√≥n para generar texto del pedido (replica exacta de generarTextoPedido de la APK)
    function generarTextoPedido() {
      const pedido = [];
      
      // Contadores para agregar espacios entre secciones
      let contadorEmpanadas = 0;
      let contadorPizzas = 0;
      let contadorPastelitos = 0;
      let contadorOtros = 0;
      
      pedido.push('üìã PEDIDO F√ÅBRICA - ' + fechaSeleccionada + '\n\n');
      
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const pedidoInput = document.getElementById('pf-pedido-' + codigo);
        if (!stockInput || !pedidoInput) return;
        
        const stock = parseInt(stockInput.value) || 0;
        const pedidoFinal = parseInt(pedidoInput.value) || 0;
        
        // Agregar espacio antes de cada secci√≥n
        if (categorias.EMPANADAS.includes(codigo)) {
          if (contadorEmpanadas === 0) {
            pedido.push('\n');
          }
          contadorEmpanadas++;
        } else if (categorias.PIZZAS.includes(codigo)) {
          if (contadorPizzas === 0) {
            pedido.push('\n');
          }
          contadorPizzas++;
        } else if (categorias.PASTELITOS.includes(codigo)) {
          if (contadorPastelitos === 0) {
            pedido.push('\n');
          }
          contadorPastelitos++;
        } else if (categorias.OTROS.includes(codigo)) {
          if (contadorOtros === 0) {
            pedido.push('\n');
          }
          contadorOtros++;
        }
        
        // Formatear seg√∫n tipo de producto (igual que la APK)
        const pedidoFormateado = (() => {
          // Pizzas: mostrar literal
          if (categorias.PIZZAS.includes(codigo)) {
            return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-nopido`;
          }
          // Pastelitos: mostrar literal
          if (categorias.PASTELITOS.includes(codigo)) {
            return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-0`;
          }
          // Medialunas
          if (codigo === 'DULCES') {
            return pedidoFinal > 0 ? `mdl dulce ${stock}-${pedidoFinal}` : `mdl dulce ${stock}-no pido`;
          }
          // Chipa
          if (codigo === 'CHIPA') {
            return pedidoFinal > 0 ? `chipa ${stock}-${pedidoFinal}` : `chipa ${stock}-0`;
          }
          // Criollito
          if (codigo === 'CRIOLLITO') {
            return pedidoFinal > 0 ? `criollito ${stock}-${pedidoFinal}` : `criollito ${stock}-0`;
          }
          // Empanadas: usar pedido final directamente
          return pedidoFinal > 0 ? `${codigo.toLowerCase()} ${stock}-${pedidoFinal}` : `${codigo.toLowerCase()} ${stock}-no pido`;
        })();
        
        pedido.push(pedidoFormateado + '\n');
      });

      return pedido.join('');
    }

    // Funci√≥n para navegar fechas
    function navegarFecha(dias) {
      const [y, m, d] = fechaSeleccionada.split('-').map(Number);
      const fecha = new Date(y, m - 1, d);
      fecha.setDate(fecha.getDate() + dias);
      fechaSeleccionada = fechaISO(fecha);
      document.getElementById('pf-fecha-actual').textContent = fechaSeleccionada;
      
      const hoy = fechaISO(new Date());
      modoSoloLectura = (fechaSeleccionada !== hoy) && !modoAdmin;
      
      actualizarUI();
      cargarDatos();
    }

    // Funci√≥n para cargar datos
    async function cargarDatos() {
      body.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280">Cargando...</div>';
      
      await cargarPromediosVenta();
      const existePedido = await cargarPedidoExistente(fechaSeleccionada);
      if (!existePedido) {
        await inicializarProductos();
      }
      
      await mostrarContenidoPedido();
    }

    // Agregar overlay al DOM primero
    document.body.appendChild(overlay);

    // Event listeners (despu√©s de agregar al DOM)
    const btnClose = document.getElementById('pf-close');
    const btnVolver = document.getElementById('pf-volver');
    const btnFechaPrev = document.getElementById('pf-fecha-prev');
    const btnFechaNext = document.getElementById('pf-fecha-next');
    const btnConfig = document.getElementById('pf-config');

    if (btnClose) btnClose.onclick = () => overlay.remove();
    if (btnVolver) btnVolver.onclick = () => overlay.remove();
    if (btnFechaPrev) btnFechaPrev.onclick = () => navegarFecha(-1);
    if (btnFechaNext) btnFechaNext.onclick = () => navegarFecha(1);
    if (btnConfig) btnConfig.onclick = () => {
      mostrarConfiguracion();
    };

    // Funci√≥n para mostrar configuraci√≥n (replica exacta de mostrarConfiguracion de la APK)
    function mostrarConfiguracion() {
      const overlayConfig = document.createElement('div');
      overlayConfig.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalConfig = document.createElement('div');
      modalConfig.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      // T√≠tulo
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:24px;text-align:center';
      titulo.textContent = '‚öôÔ∏è Configuraci√≥n';
      modalConfig.appendChild(titulo);
      
      // Porcentaje Extra
      const porcentajeDiv = document.createElement('div');
      porcentajeDiv.style.cssText = 'margin-bottom:24px';
      
      const txtPorcentaje = document.createElement('div');
      txtPorcentaje.id = 'config-porcentaje-text';
      txtPorcentaje.style.cssText = 'font-size:16px;font-weight:600;color:#1976d2;padding:8px 16px;margin-bottom:8px';
      const porcentajeActual = parseInt(document.getElementById('pf-porcentaje')?.textContent.replace('% Extra: ', '').replace('%', '') || '30');
      txtPorcentaje.textContent = 'Porcentaje Extra: ' + porcentajeActual + '%';
      porcentajeDiv.appendChild(txtPorcentaje);
      
      const seekBar = document.createElement('input');
      seekBar.type = 'range';
      seekBar.min = '0';
      seekBar.max = '100';
      seekBar.value = porcentajeActual;
      seekBar.style.cssText = 'width:100%;height:8px;margin:16px 0';
      seekBar.oninput = function() {
        txtPorcentaje.textContent = 'Porcentaje Extra: ' + this.value + '%';
        // Actualizar sugerencias en tiempo real
        actualizarSugerenciasEnTiempoReal(parseInt(this.value));
      };
      porcentajeDiv.appendChild(seekBar);
      modalConfig.appendChild(porcentajeDiv);
      
      // Hora de Alerta
      const horaDiv = document.createElement('div');
      horaDiv.style.cssText = 'margin-bottom:24px';
      
      const txtHora = document.createElement('div');
      txtHora.style.cssText = 'font-size:16px;padding:8px 16px;margin-bottom:8px';
      txtHora.textContent = 'Hora de Alerta:';
      horaDiv.appendChild(txtHora);
      
      const editHora = document.createElement('input');
      editHora.type = 'text';
      editHora.id = 'config-hora-input';
      const horaActual = document.getElementById('pf-hora-alerta')?.textContent.replace('üîî Alerta: ', '') || '15:30';
      editHora.value = horaActual;
      editHora.style.cssText = 'width:100%;padding:16px;border:1px solid #d1d5db;border-radius:4px;font-size:16px;cursor:pointer';
      editHora.readOnly = true;
      editHora.onclick = function() {
        mostrarSelectorHora(editHora);
      };
      horaDiv.appendChild(editHora);
      modalConfig.appendChild(horaDiv);
      
      // Bot√≥n para configurar d√≠as de entrega
      const btnDiasEntrega = document.createElement('button');
      btnDiasEntrega.style.cssText = 'width:100%;padding:16px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:16px;margin-bottom:24px;cursor:pointer';
      btnDiasEntrega.textContent = 'üìÖ Configurar D√≠as de Entrega';
      btnDiasEntrega.onclick = () => {
        overlayConfig.remove();
        mostrarConfiguracionDiasEntrega();
      };
      modalConfig.appendChild(btnDiasEntrega);
      
      // Botones
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        const nuevoPorcentaje = parseInt(seekBar.value);
        const nuevaHora = editHora.value;
        
        configuracion.porcentajeExtra = nuevoPorcentaje;
        configuracion.horaAlerta = nuevaHora;
        
        // Guardar en Firebase
        await guardarConfiguracionEnFirebase();
        
        // Actualizar UI
        actualizarUI();
        
        // Actualizar sugerencias
        actualizarSugerenciasEnTiempoReal(nuevoPorcentaje);
        
        overlayConfig.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayConfig.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalConfig.appendChild(botonesDiv);
      
      overlayConfig.appendChild(modalConfig);
      document.body.appendChild(overlayConfig);
    }

    // Funci√≥n para mostrar selector de hora (replica de mostrarSelectorHoraTemporal de la APK)
    function mostrarSelectorHora(editHora) {
      const horaActual = editHora.value || '15:30';
      const [h, m] = horaActual.split(':').map(Number);
      
      // Crear overlay para selector de hora
      const overlayHora = document.createElement('div');
      overlayHora.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10001';
      const modalHora = document.createElement('div');
      modalHora.style.cssText = 'background:#fff;padding:24px;border-radius:8px;min-width:300px';
      
      modalHora.innerHTML = '<div style="font-size:18px;font-weight:700;margin-bottom:16px;text-align:center">Seleccionar Hora</div>' +
        '<div style="display:flex;gap:16px;justify-content:center;align-items:center;margin-bottom:24px">' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Hora</label>' +
        '<input type="number" id="hora-picker-h" min="0" max="23" value="' + h + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '<div style="font-size:24px;font-weight:700">:</div>' +
        '<div style="display:flex;flex-direction:column;align-items:center">' +
        '<label style="font-size:14px;margin-bottom:8px">Minuto</label>' +
        '<input type="number" id="hora-picker-m" min="0" max="59" value="' + m + '" style="width:80px;padding:8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;font-size:18px">' +
        '</div>' +
        '</div>' +
        '<div style="display:flex;gap:12px">' +
        '<button id="hora-ok" style="flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Aceptar</button>' +
        '<button id="hora-cancel" style="flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer">Cancelar</button>' +
        '</div>';
      
      overlayHora.appendChild(modalHora);
      document.body.appendChild(overlayHora);
      
      document.getElementById('hora-ok').onclick = () => {
        const hora = String(document.getElementById('hora-picker-h').value).padStart(2, '0');
        const minuto = String(document.getElementById('hora-picker-m').value).padStart(2, '0');
        editHora.value = hora + ':' + minuto;
        overlayHora.remove();
      };
      
      document.getElementById('hora-cancel').onclick = () => overlayHora.remove();
    }

    // Funci√≥n para mostrar configuraci√≥n de d√≠as de entrega (replica de mostrarConfiguracionDiasEntrega de la APK)
    function mostrarConfiguracionDiasEntrega() {
      const overlayDias = document.createElement('div');
      overlayDias.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const modalDias = document.createElement('div');
      modalDias.style.cssText = 'background:#fff;width:90%;max-width:500px;border-radius:8px;padding:24px;max-height:90vh;overflow-y:auto';
      
      // T√≠tulo
      const titulo = document.createElement('div');
      titulo.style.cssText = 'font-size:18px;font-weight:700;color:#000;margin-bottom:16px;text-align:center';
      titulo.textContent = '‚öôÔ∏è D√≠as de Entrega';
      modalDias.appendChild(titulo);
      
      // Subt√≠tulo
      const subtitulo = document.createElement('div');
      subtitulo.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      subtitulo.textContent = 'üìÖ Configurar D√≠as de Entrega';
      modalDias.appendChild(subtitulo);
      
      // Descripci√≥n
      const descripcion = document.createElement('div');
      descripcion.style.cssText = 'font-size:14px;color:#6b7280;margin-bottom:24px;text-align:center';
      descripcion.textContent = 'Marca los d√≠as en que la f√°brica entrega mercader√≠a a tu local. Esto afectar√° el c√°lculo de sugerencias de pedido.';
      modalDias.appendChild(descripcion);
      
      // Checkboxes
      const checkboxes = {};
      const dias = [
        ['lunes', 'Lunes'],
        ['martes', 'Martes'],
        ['miercoles', 'Mi√©rcoles'],
        ['jueves', 'Jueves'],
        ['viernes', 'Viernes'],
        ['sabado', 'S√°bado'],
        ['domingo', 'Domingo']
      ];
      
      dias.forEach(([clave, nombre]) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = 'display:flex;align-items:center;padding:8px 16px;margin-bottom:8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'dias-' + clave;
        checkbox.checked = diasEntrega[clave] || false;
        checkbox.style.cssText = 'width:20px;height:20px;margin-right:12px;cursor:pointer';
        
        const label = document.createElement('label');
        label.htmlFor = 'dias-' + clave;
        label.style.cssText = 'font-size:16px;color:#000;cursor:pointer;flex:1';
        label.textContent = nombre;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        modalDias.appendChild(checkboxDiv);
        
        checkboxes[clave] = checkbox;
      });
      
      // Botones
      const botonesDiv = document.createElement('div');
      botonesDiv.style.cssText = 'display:flex;gap:12px;margin-top:24px';
      
      const btnGuardar = document.createElement('button');
      btnGuardar.style.cssText = 'flex:1;padding:12px;background:#25d366;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = async () => {
        // Actualizar configuraci√≥n
        diasEntrega = {
          lunes: checkboxes.lunes.checked,
          martes: checkboxes.martes.checked,
          miercoles: checkboxes.miercoles.checked,
          jueves: checkboxes.jueves.checked,
          viernes: checkboxes.viernes.checked,
          sabado: checkboxes.sabado.checked,
          domingo: checkboxes.domingo.checked
        };
        
        // Guardar en Firebase
        await guardarDiasEntregaEnFirebase();
        
        // Actualizar informaci√≥n de d√≠as extra
        actualizarInformacionDiasExtra();
        
        // Recalcular todas las sugerencias
        recalcularTodasLasSugerencias();
        
        overlayDias.remove();
      };
      
      const btnCancelar = document.createElement('button');
      btnCancelar.style.cssText = 'flex:1;padding:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.onclick = () => overlayDias.remove();
      
      botonesDiv.appendChild(btnGuardar);
      botonesDiv.appendChild(btnCancelar);
      modalDias.appendChild(botonesDiv);
      
      overlayDias.appendChild(modalDias);
      document.body.appendChild(overlayDias);
    }

    // Funci√≥n para guardar configuraci√≥n en Firebase
    async function guardarConfiguracionEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_pedido_fabrica').doc('config').set({
          porcentajeExtra: configuracion.porcentajeExtra,
          horaAlerta: configuracion.horaAlerta,
          activarAlerta: configuracion.activarAlerta,
          timestamp: new Date().toISOString()
        });
        console.log('‚úÖ Configuraci√≥n guardada en Firebase');
      } catch (e) {
        console.error('Error guardando configuraci√≥n:', e);
        alert('Error guardando configuraci√≥n: ' + e.message);
      }
    }

    // Funci√≥n para guardar d√≠as de entrega en Firebase
    async function guardarDiasEntregaEnFirebase() {
      try {
        const db = obtenerFirestore();
        await db.collection('locales').doc(localId).collection('configuracion_dias_entrega').doc('config').set({
          lunes: diasEntrega.lunes,
          martes: diasEntrega.martes,
          miercoles: diasEntrega.miercoles,
          jueves: diasEntrega.jueves,
          viernes: diasEntrega.viernes,
          sabado: diasEntrega.sabado,
          domingo: diasEntrega.domingo,
          timestamp: new Date().toISOString()
        });
        console.log('‚úÖ D√≠as de entrega guardados en Firebase');
      } catch (e) {
        console.error('Error guardando d√≠as de entrega:', e);
        alert('Error guardando d√≠as de entrega: ' + e.message);
      }
    }

    // Funci√≥n para actualizar sugerencias en tiempo real (replica de actualizarSugerenciasEnTiempoReal de la APK)
    function actualizarSugerenciasEnTiempoReal(nuevoPorcentaje) {
      // Actualizar porcentaje en configuraci√≥n temporalmente
      const porcentajeAnterior = configuracion.porcentajeExtra;
      configuracion.porcentajeExtra = nuevoPorcentaje;
      
      // Recalcular todas las sugerencias visibles
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
        
        if (stockInput && sugerenciaSpan) {
          const stock = parseInt(stockInput.value) || 0;
          calcularSugerencia(codigo, stock).then(sug => {
            sugerenciaSpan.textContent = sug;
          });
        }
      });
      
      // Restaurar porcentaje anterior (se guardar√° cuando se guarde la configuraci√≥n)
      configuracion.porcentajeExtra = porcentajeAnterior;
    }

    // Funci√≥n para recalcular todas las sugerencias (replica de recalcularTodasLasSugerencias de la APK)
    async function recalcularTodasLasSugerencias() {
      ordenProductos.forEach(codigo => {
        const stockInput = document.getElementById('pf-stock-' + codigo);
        const sugerenciaSpan = document.getElementById('pf-sugerencia-' + codigo);
        
        if (stockInput && sugerenciaSpan) {
          const stock = parseInt(stockInput.value) || 0;
          calcularSugerencia(codigo, stock).then(sug => {
            sugerenciaSpan.textContent = sug;
            const prod = productos.find(p => p.codigo === codigo);
            if (prod) prod.pedidoSugerido = sug;
          });
        }
      });
    }

    await cargarConfiguracion();
    await cargarDatos();
  }

  // API global para botones del HTML
  window.openVencimientosHistorial = function (localId, localNombre) {
    return openStockVencimientosModal(localId, localNombre);
  };
  window.openVencLocal = function () {
    return openVencLocalModal();
  };
  window.openPedidoFabrica = function () {
    return openPedidoFabricaModal();
  };
})();
</script>